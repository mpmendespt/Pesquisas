<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sistema de Pesquisas</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .profile-info {
            margin: 15px 0;
        }
        .profile-info p {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .profile-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .status-verified {
            color: #27ae60;
            font-weight: bold;
        }
        .status-pending {
            color: #e67e22;
            font-weight: bold;
        }
        .admin-badge {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 8px;
        }
    </style>
</head>
<body class="dashboard-page">
    <div class="container">
        <header class="header">
            <h1>üè† Dashboard Principal</h1>
            <div class="user-info">
                <span id="userWelcome">Bem-vindo!</span>
                <button onclick="logout()" class="btn-secondary">Sair</button>
            </div>
        </header>
        
        <main class="main-content">
            <div class="welcome-section">
                <h2>Ol√°, <span id="usernameDisplay"></span><span id="adminBadge" class="admin-badge" style="display:none;">ADMIN</span>!</h2>
                <p>Voc√™ est√° logado no sistema de pesquisas.</p>
            </div>
            
            <div class="actions-section">
                <!-- Card de Perfil -->
                <div class="card">
                    <h3>üë§ Meu Perfil</h3>
                    <div class="profile-info">
                        <p><strong>Username:</strong> <span id="profileUsername"></span></p>
                        <p><strong>Email:</strong> <span id="profileEmail"></span></p>
                        <p><strong>Estado:</strong> <span id="profileStatus"></span></p>
                        <p><strong>Registro:</strong> <span id="profileCreated"></span></p>
                    </div>
                    <div class="profile-actions">
                        <button onclick="openProfileModal()" class="btn-secondary">Editar Perfil</button>
                        <button onclick="openPasswordModal()" class="btn-secondary">Alterar Password</button>
                        <button onclick="resendConfirmation()" class="btn-secondary" id="resendConfirmationBtn" style="display:none;">Reenviar Confirma√ß√£o</button>
                    </div>
                </div>
                
                <!-- Card de Dados Protegidos -->
                <div class="card">
                    <h3>üìä Dados Protegidos</h3>
                    <p>Acesse informa√ß√µes restritas do sistema.</p>
                    <button onclick="fetchProtectedData()" class="btn-primary">Buscar Dados</button>
                </div>
                
                <!-- Card de Configura√ß√µes -->
                <div class="card">
                    <h3>‚öôÔ∏è Configura√ß√µes</h3>
                    <p>Configure suas prefer√™ncias.</p>
                    <button onclick="showSettings()" class="btn-secondary">Configura√ß√µes</button>
                </div>

                <!-- Card de Administra√ß√£o (apenas para admins) -->
                <div id="adminCard" class="card" style="display:none;">
                    <h3>üëë Administra√ß√£o</h3>
                    <p>Painel de controle administrativo.</p>
                    <button onclick="window.location.href='admin.html'" class="btn-primary">Painel Admin</button>
                </div>
            </div>
            
            <!-- √Årea para mostrar dados -->
            <div id="protectedData" class="data-section"></div>
        </main>
    </div>

    <!-- Modal de Edi√ß√£o de Perfil -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProfileModal()">&times;</span>
            <h3>üë§ Editar Perfil</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label for="editUsername">Username:</label>
                    <input type="text" id="editUsername" required>
                </div>
                <div class="form-group">
                    <label for="editEmail">Email:</label>
                    <input type="email" id="editEmail" required>
                </div>
                <button type="submit" class="btn-primary">Guardar Altera√ß√µes</button>
                <button type="button" onclick="closeProfileModal()" class="btn-secondary">Cancelar</button>
            </form>
            <div id="profileMessage" class="message"></div>
        </div>
    </div>

    <!-- Modal de Altera√ß√£o de Password -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePasswordModal()">&times;</span>
            <h3>üîê Alterar Password</h3>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="currentPassword">Password Atual:</label>
                    <input type="password" id="currentPassword" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">Nova Password:</label>
                    <input type="password" id="newPassword" minlength="8" required>
                    <small>M√≠nimo 8 caracteres</small>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirmar Nova Password:</label>
                    <input type="password" id="confirmPassword" minlength="8" required>
                </div>
                <button type="submit" class="btn-primary">Alterar Password</button>
                <button type="button" onclick="closePasswordModal()" class="btn-secondary">Cancelar</button>
            </form>
            <div id="passwordMessage" class="message"></div>
        </div>
    </div>

    <script>
        const WORKER_URL = 'https://worker-ds.mpmendespt.workers.dev';
        
        // Verificar autentica√ß√£o ao carregar a p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('jwt');
            const userData = localStorage.getItem('user');
            
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            if (userData) {
                const user = JSON.parse(userData);
                updateUserDisplay(user);
                loadUserProfile();
            }
        });
        
        // Atualizar display do usu√°rio
        function updateUserDisplay(user) {
            document.getElementById('usernameDisplay').textContent = user.username;
            document.getElementById('userWelcome').textContent = `Bem-vindo, ${user.username}!`;
            
            // Mostrar badge de admin se for administrador
            if (user.role === 'admin') {
                document.getElementById('adminBadge').style.display = 'inline';
                document.getElementById('adminCard').style.display = 'block';
            }
        }
        
        // Carregar dados completos do perfil
        async function loadUserProfile() {
            try {
                const token = localStorage.getItem('jwt');
                const response = await fetch(`${WORKER_URL}/api/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateProfileDisplay(data.user);
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }
        
        // Atualizar informa√ß√µes do perfil na p√°gina
        function updateProfileDisplay(user) {
            document.getElementById('profileUsername').textContent = user.username;
            document.getElementById('profileEmail').textContent = user.email;
            document.getElementById('profileStatus').textContent = user.is_email_verified ? '‚úì Email verificado' : '‚úó Email n√£o verificado';
            document.getElementById('profileStatus').className = user.is_email_verified ? 'status-verified' : 'status-pending';
            document.getElementById('profileCreated').textContent = new Date(user.created_at).toLocaleDateString('pt-PT');
            
            // Mostrar/ocultar bot√£o de reenviar confirma√ß√£o
            const resendBtn = document.getElementById('resendConfirmationBtn');
            resendBtn.style.display = user.is_email_verified ? 'none' : 'block';
        }

        // Fun√ß√µes do perfil
        function openProfileModal() {
            const user = JSON.parse(localStorage.getItem('user'));
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('profileModal').style.display = 'block';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
            document.getElementById('profileMessage').innerHTML = '';
        }

        function openPasswordModal() {
            document.getElementById('passwordModal').style.display = 'block';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('passwordMessage').innerHTML = '';
            document.getElementById('passwordForm').reset();
        }

        // Formul√°rio de edi√ß√£o de perfil
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('editUsername').value;
            const email = document.getElementById('editEmail').value;
            const messageDiv = document.getElementById('profileMessage');
            
            try {
                const token = localStorage.getItem('jwt');
                const response = await fetch(`${WORKER_URL}/api/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ username, email })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // Atualizar localStorage
                    const user = JSON.parse(localStorage.getItem('user'));
                    user.username = username;
                    user.email = email;
                    if (data.requires_email_verification) {
                        user.is_email_verified = false;
                    }
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // Atualizar display
                    updateUserDisplay(user);
                    updateProfileDisplay({...user, ...data.user});
                    
                    messageDiv.innerHTML = '<div class="success">‚úÖ Perfil atualizado com sucesso!</div>';
                    if (data.requires_email_verification) {
                        messageDiv.innerHTML += '<div class="info">üìß Email alterado. Verifique seu novo email.</div>';
                    }
                    
                    setTimeout(() => {
                        closeProfileModal();
                    }, 3000);
                } else {
                    messageDiv.innerHTML = `<div class="error">‚ùå ${data.error}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="error">‚ùå Erro de conex√£o</div>';
            }
        });

        // Formul√°rio de altera√ß√£o de password
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const messageDiv = document.getElementById('passwordMessage');
            
            if (newPassword !== confirmPassword) {
                messageDiv.innerHTML = '<div class="error">‚ùå As novas passwords n√£o coincidem</div>';
                return;
            }
            
            try {
                const token = localStorage.getItem('jwt');
                const response = await fetch(`${WORKER_URL}/api/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    messageDiv.innerHTML = '<div class="success">‚úÖ Password alterada com sucesso!</div>';
                    setTimeout(() => {
                        closePasswordModal();
                    }, 2000);
                } else {
                    messageDiv.innerHTML = `<div class="error">‚ùå ${data.error}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="error">‚ùå Erro de conex√£o</div>';
            }
        });
        
        // Reenviar confirma√ß√£o de email
        async function resendConfirmation() {
            try {
                const token = localStorage.getItem('jwt');
                const response = await fetch(`${WORKER_URL}/api/resend-confirmation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Email de confirma√ß√£o reenviado! Verifique sua caixa de entrada.');
                    if (data.debug_token) {
                        console.log('Debug token:', data.debug_token);
                    }
                } else {
                    alert('‚ùå Erro ao reenviar confirma√ß√£o: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Erro de conex√£o');
            }
        }
        
        // Buscar dados protegidos
        async function fetchProtectedData() {
            const token = localStorage.getItem('jwt');
            const dataDiv = document.getElementById('protectedData');
            
            dataDiv.innerHTML = '<div class="loading">üîÑ Carregando dados protegidos...</div>';
            
            try {
                const response = await fetch(`${WORKER_URL}/api/protected`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    dataDiv.innerHTML = `
                        <div class="success-data">
                            <h3>‚úÖ Dados Protegidos Acessados</h3>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    dataDiv.innerHTML = `<div class="error">‚ùå ${data.error}</div>`;
                    
                    // Se o token estiver inv√°lido, faz logout
                    if (response.status === 401) {
                        setTimeout(logout, 2000);
                    }
                }
            } catch (error) {
                dataDiv.innerHTML = '<div class="error">‚ùå Erro ao carregar dados</div>';
            }
        }
        
        function showSettings() {
            const dataDiv = document.getElementById('protectedData');
            dataDiv.innerHTML = `
                <div class="user-data">
                    <h3>‚öôÔ∏è Configura√ß√µes</h3>
                    <div class="user-details">
                        <p><strong>Token JWT:</strong> ${localStorage.getItem('jwt')?.substring(0, 20)}...</p>
                        <p><strong>Sess√£o expira em:</strong> <span id="sessionExpires"></span></p>
                        <button onclick="clearAllData()" class="btn-secondary">Limpar Dados Locais</button>
                        <button onclick="testConnection()" class="btn-secondary">Testar Conex√£o</button>
                    </div>
                </div>
            `;
            
            // Calcular expira√ß√£o da sess√£o
            const token = localStorage.getItem('jwt');
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const expires = new Date(payload.exp * 1000);
                    document.getElementById('sessionExpires').textContent = expires.toLocaleString('pt-PT');
                } catch (e) {
                    document.getElementById('sessionExpires').textContent = 'Desconhecido';
                }
            }
        }
        
        async function testConnection() {
            try {
                const response = await fetch(`${WORKER_URL}/api/health`);
                const data = await response.json();
                alert(`‚úÖ Conex√£o OK\nStatus: ${data.status}\nServi√ßo: ${data.service}`);
            } catch (error) {
                alert('‚ùå Erro na conex√£o com o servidor');
            }
        }
        
        function clearAllData() {
            if (confirm('Tem certeza que deseja limpar todos os dados locais? Ser√° necess√°rio fazer login novamente.')) {
                localStorage.clear();
                alert('Dados locais limpos! Redirecionando para login...');
                window.location.href = 'login.html';
            }
        }
        
        function logout() {
            localStorage.removeItem('jwt');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }
        
        // Verificar autentica√ß√£o a cada 30 segundos
        setInterval(() => {
            if (!localStorage.getItem('jwt')) {
                logout();
            }
        }, 30000);
    </script>
</body>
</html>