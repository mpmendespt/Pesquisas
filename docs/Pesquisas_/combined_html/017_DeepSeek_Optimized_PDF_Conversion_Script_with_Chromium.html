<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>

        <style id="fixed-toc-styles">
        /* === ESTILOS PRINCIPAIS - TOC FIXO √Ä DIREITA === */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            scroll-behavior: smooth;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            position: relative;
        }
        /* === TOC FIXO √Ä DIREITA - POSI√á√ÉO CORRIGIDA === */
        #TOC {
            position: fixed !important;
            top: 50% !important;
            right: 20px !important;
            transform: translateY(-50%) !important;
            width: 320px !important;
            max-height: 80vh !important;
            overflow-y: auto !important;
            z-index: 1000 !important;
            background: rgba(255, 255, 255, 0.98) !important;
            padding: 20px !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15) !important;
            border: 1px solid #e0e0e0 !important;
            backdrop-filter: blur(10px) !important;
            transition: all 0.3s ease-in-out !important;
        }
        #TOC.toc-minimized {
            transform: translateY(-50%) translateX(calc(320px - 50px)) !important;
            opacity: 0.3;
            width: 50px !important;
            overflow: hidden;
        }
        #TOC.toc-minimized > *:not(.toc-toggle-btn) {
            display: none !important;
        }
        #TOC h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            font-size: 1.2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toc-toggle-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .toc-toggle-btn:hover {
            background-color: rgba(0,0,0,0.1);
        }
        #TOC ul {
            list-style-type: none;
            padding-left: 15px;
            margin: 10px 0;
        }
        #TOC ul ul {
            padding-left: 20px;
        }
        #TOC li {
            margin: 8px 0;
            line-height: 1.4;
        }
        #TOC a {
            text-decoration: none;
            color: #495057;
            font-weight: 500;
            transition: all 0.2s ease;
            display: block;
            padding: 6px 10px;
            border-radius: 6px;
            border-left: 3px solid transparent;
        }
        #TOC a:hover {
            color: #007bff;
            background-color: rgba(0, 123, 255, 0.1);
            border-left-color: #007bff;
        }
        #TOC a.active {
            background-color: #007bff !important;
            color: white !important;
            font-weight: bold;
            border-left-color: #0056b3;
        }
        /* Conte√∫do principal com margem para o TOC */
        .main-content {
            margin-right: calc(320px + 40px) !important;
        }
        /* Barra de scroll personalizada APENAS para TOC */
        #TOC::-webkit-scrollbar {
            width: 8px;
        }
        #TOC::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        #TOC::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        #TOC::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        /* === BOT√ÉO VOLTAR AO TOPO (HTMLs individuais) === */
        .back-to-top-content {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .back-to-top-content.show {
            opacity: 1;
            transform: translateY(0);
        }
        .back-to-top-content:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        /* === RESPONSIVIDADE === */
        @media (max-width: 1400px) {
            .container {
                max-width: 95%;
                padding: 30px;
            }
            #TOC {
                width: 280px !important;
            }
            .main-content {
                margin-right: 320px !important;
            }
        }
        @media (max-width: 1200px) {
            #TOC {
                width: 260px !important;
                right: 15px !important;
            }
            .main-content {
                margin-right: 300px !important;
            }
        }
        @media (max-width: 992px) {
            #TOC {
                position: relative !important;
                width: 100% !important;
                right: 0 !important;
                top: 0 !important;
                transform: none !important;
                margin: 20px 0;
                max-height: 300px !important;
            }
            .main-content {
                margin-right: 0 !important;
            }
            .back-to-top-content {
                right: 20px;
                bottom: 20px;
            }
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px;
                max-width: 100%;
            }
            #TOC {
                max-height: 250px !important;
                padding: 15px !important;
            }
        }
        </style>
        
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>017_DeepSeek_Optimized_PDF_Conversion_Script_with_Chromium</title>
  <style>

html {
color: #1a1a1a;
background-color: #fdfdfd;
}
body {
margin: 0 auto;
max-width: 36em;
padding-left: 50px;
padding-right: 50px;
padding-top: 50px;
padding-bottom: 50px;
hyphens: auto;
overflow-wrap: break-word;
text-rendering: optimizeLegibility;
font-kerning: normal;
}
@media (max-width: 600px) {
body {
font-size: 0.9em;
padding: 12px;
}
h1 {
font-size: 1.8em;
}
}
@media print {
html {
background-color: white;
}
body {
background-color: transparent;
color: black;
font-size: 12pt;
}
p, h2, h3 {
orphans: 3;
widows: 3;
}
h2, h3, h4 {
page-break-after: avoid;
}
}
p {
margin: 1em 0;
}
a {
color: #1a1a1a;
}
a:visited {
color: #1a1a1a;
}
img {
max-width: 100%;
}
svg {
height: auto;
max-width: 100%;
}
h1, h2, h3, h4, h5, h6 {
margin-top: 1.4em;
}
h5, h6 {
font-size: 1em;
font-style: italic;
}
h6 {
font-weight: normal;
}
ol, ul {
padding-left: 1.7em;
margin-top: 1em;
}
li > ol, li > ul {
margin-top: 0;
}
blockquote {
margin: 1em 0 1em 1.7em;
padding-left: 1em;
border-left: 2px solid #e6e6e6;
color: #606060;
}
code {
font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
font-size: 85%;
margin: 0;
hyphens: manual;
}
pre {
margin: 1em 0;
overflow: auto;
}
pre code {
padding: 0;
overflow: visible;
overflow-wrap: normal;
}
.sourceCode {
background-color: transparent;
overflow: visible;
}
hr {
border: none;
border-top: 1px solid #1a1a1a;
height: 1px;
margin: 1em 0;
}
table {
margin: 1em 0;
border-collapse: collapse;
width: 100%;
overflow-x: auto;
display: block;
font-variant-numeric: lining-nums tabular-nums;
}
table caption {
margin-bottom: 0.75em;
}
tbody {
margin-top: 0.5em;
border-top: 1px solid #1a1a1a;
border-bottom: 1px solid #1a1a1a;
}
th {
border-top: 1px solid #1a1a1a;
padding: 0.25em 0.5em 0.25em 0.5em;
}
td {
padding: 0.125em 0.5em 0.25em 0.5em;
}
header {
margin-bottom: 4em;
text-align: center;
}
#TOC li {
list-style: none;
}
#TOC ul {
padding-left: 1.3em;
}
#TOC > ul {
padding-left: 0;
}
#TOC a:not(:hover) {
text-decoration: none;
}
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}

ul.task-list[class]{list-style: none;}
ul.task-list li input[type="checkbox"] {
font-size: inherit;
width: 0.8em;
margin: 0 0.8em 0.2em -1.6em;
vertical-align: middle;
}

html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#optimized-pdf-conversion-script-with-chromium" id="toc-optimized-pdf-conversion-script-with-chromium"><span class="toc-section-number">1</span> Optimized PDF Conversion Script with
Chromium</a>
<ul>
<li><a href="#informa√ß√µes" id="toc-informa√ß√µes"><span class="toc-section-number">1.1</span> üìä Informa√ß√µes</a></li>
<li><a href="#conversa" id="toc-conversa"><span class="toc-section-number">1.2</span> üí¨ Conversa</a></li>
<li><a href="#principais-otimiza√ß√µes-implementadas" id="toc-principais-otimiza√ß√µes-implementadas"><span class="toc-section-number">1.3</span> Principais Otimiza√ß√µes
Implementadas:</a></li>
<li><a href="#adi√ß√£o-principal-realizada" id="toc-adi√ß√£o-principal-realizada"><span class="toc-section-number">1.4</span> Adi√ß√£o Principal
Realizada:</a></li>
<li><a href="#caracter√≠sticas-do-m√©todo-explicado" id="toc-caracter√≠sticas-do-m√©todo-explicado"><span class="toc-section-number">1.5</span> Caracter√≠sticas do M√©todo
Explicado:</a></li>
<li><a href="#principais-melhorias-na-interrup√ß√£o-ctrlc" id="toc-principais-melhorias-na-interrup√ß√£o-ctrlc"><span class="toc-section-number">1.6</span> Principais Melhorias na
Interrup√ß√£o Ctrl+C:</a></li>
<li><a href="#principais-adi√ß√µes" id="toc-principais-adi√ß√µes"><span class="toc-section-number">1.7</span> Principais Adi√ß√µes:</a></li>
<li><a href="#funcionamento" id="toc-funcionamento"><span class="toc-section-number">1.8</span> Funcionamento:</a></li>
<li><a href="#principais-melhorias" id="toc-principais-melhorias"><span class="toc-section-number">1.9</span> Principais Melhorias:</a></li>
<li><a href="#principais-corre√ß√µes" id="toc-principais-corre√ß√µes"><span class="toc-section-number">1.10</span> Principais Corre√ß√µes:</a></li>
<li><a href="#principais-mudan√ßas" id="toc-principais-mudan√ßas"><span class="toc-section-number">1.11</span> Principais Mudan√ßas:</a></li>
</ul></li>
</ul>
</nav>
<h1 data-number="1" id="optimized-pdf-conversion-script-with-chromium"><span class="header-section-number">1</span> Optimized PDF Conversion Script
with Chromium</h1>
<h2 data-number="1.1" id="informa√ß√µes"><span class="header-section-number">1.1</span> üìä Informa√ß√µes</h2>
<ul>
<li><strong>N√∫mero:</strong> #17</li>
<li><strong>Origem:</strong> DeepSeek</li>
<li><strong>Categoria:</strong> Programa√ß√£o</li>
<li><strong>ID:</strong> 40ecd2f0-3893-4b6b-9579-6bedc83dc8ea</li>
<li><strong>Criada em:</strong> 2025-11-07 04:59:56</li>
<li><strong>Atualizada em:</strong> 2025-11-07 18:52:23</li>
<li><strong>Total de mensagens:</strong> 18</li>
<li><strong>Resumo:</strong> Optimiza√ß√£o
comb_pdf_direct6_html_based_optimized_live_benchmark.py Pretende-se
optimiza√ß√£o do file ‚Ä¶</li>
</ul>
<hr />
<h2 data-number="1.2" id="conversa"><span class="header-section-number">1.2</span> üí¨ Conversa</h2>
<h3 data-number="1.2.1" id="utilizador-2025-11-07-045957-deepseek-reasoner"><span class="header-section-number">1.2.1</span> üë§ Utilizador <em>(2025-11-07
04:59:57)</em> <em>[deepseek-reasoner]</em></h3>
<p>Optimiza√ß√£o comb_pdf_direct6_html_based_optimized_live_benchmark.py
Pretende-se optimiza√ß√£o do file
comb_pdf_direct6_html_based_optimized_live_benchmark.py Pretendo:
Reutiliza√ß√£o de uma inst√¢ncia do Chromium por processo (abre/fecha
browser por batch).</p>
<p>Paralelismo seguro via multiprocessing.Pool. Retry por arquivo (2
tentativas padr√£o). Tratamento de para cancelamento limpo via Ctrl+C
Limite de workers: 3‚Äì4 √© √≥timo em 4 n√∫cleos / 8 GB RAM. Pretendo que
sejam analisados so dois files. E se for possivel optimizar para
aperfei√ßoar algo recomendado que seja apresentado um file
comb_pdf_direct6_html_based_optimized_live_benchmark.py completo</p>
<hr />
<h3 data-number="1.2.2" id="deepseek-2025-11-07-045957-deepseek-reasoner"><span class="header-section-number">1.2.2</span> ü§ñ DeepSeek <em>(2025-11-07
04:59:57)</em> <em>[deepseek-reasoner]</em></h3>
<p>Vamos analisar os dois arquivos fornecidos e focar na otimiza√ß√£o do
<code>comb_pdf_direct6_html_based_optimized_live_benchmark.py</code> com
base nos requisitos:</p>
<ol type="1">
<li>Reutiliza√ß√£o de uma inst√¢ncia do Chromium por processo (abre/fecha
browser por batch).</li>
<li>Paralelismo seguro via multiprocessing.Pool.</li>
<li>Retry por arquivo (2 tentativas padr√£o).</li>
<li>Tratamento de cancelamento limpo via Ctrl+C.</li>
<li>Limite de workers: 3‚Äì4 √© √≥timo em 4 n√∫cleos / 8 GB RAM.</li>
</ol>
<p>Al√©m disso, vamos considerar as melhores pr√°ticas do segundo arquivo
(<code>comb_pdf_direct6_html_based.py</code>) que usa ThreadPoolExecutor
e tem uma estrutura de classe, mas o foco ser√° no primeiro arquivo que
j√° est√° mais orientado a multiprocessamento.</p>
<p>Observa√ß√µes sobre o primeiro arquivo
(comb_pdf_direct6_html_based_optimized_live_benchmark.py):</p>
<ul>
<li>J√° usa multiprocessing.Pool.</li>
<li>J√° tem um sistema de interrup√ß√£o com sinal.</li>
<li>J√° faz a abertura e fechamento do browser por batch (no worker
<code>worker_process_batch_simple</code>).</li>
</ul>
<p>No entanto, note que no worker atual, o browser √© aberto e fechado
para cada batch, o que est√° de acordo com a reutiliza√ß√£o por processo
(cada processo do pool abre um browser e processa um batch, depois
fecha). Mas note que o batch √© um conjunto de arquivos, ent√£o estamos
reutilizando o browser para v√°rios arquivos no mesmo batch, o que √©
bom.</p>
<p>O que podemos melhorar:</p>
<ol type="1">
<li><p>No worker atual, o browser √© lan√ßado com op√ß√µes m√≠nimas. Podemos
adicionar op√ß√µes de linha de comando para melhor desempenho e
confiabilidade, semelhantes √†s do segundo arquivo.</p></li>
<li><p>No worker, a cada arquivo √© criado um novo context e uma nova
page. Isso √© o ideal para isolar cada convers√£o.</p></li>
<li><p>O segundo arquivo usa <code>wait_for_function</code> para
garantir que a p√°gina est√° carregada e uma espera adicional de 1
segundo. No primeiro arquivo, usamos
<code>wait_until=&#39;networkidle&#39;</code> e
<code>page.wait_for_timeout(1000)</code>. Podemos considerar adicionar o
<code>wait_for_function</code> para maior confiabilidade.</p></li>
<li><p>O segundo arquivo tem mais op√ß√µes de PDF (como
<code>prefer_css_page_size</code> e <code>scale</code>). Podemos adotar
essas op√ß√µes.</p></li>
<li><p>No primeiro arquivo, o retry √© feito por arquivo, mas o browser √©
recriado a cada tentativa? N√£o, o browser √© o mesmo para o batch, mas
para cada arquivo √© criado um context. Em caso de falha, o context √©
fechado e tentamos novamente com um novo context. Isso √©
aceit√°vel.</p></li>
<li><p>O primeiro arquivo j√° usa uma fila de mensagens e um listener em
thread para reportar o progresso.</p></li>
<li><p>O primeiro arquivo j√° tem um sistema de interrup√ß√£o que tenta
matar processos √≥rf√£os.</p></li>
</ol>
<p>Vamos ent√£o ajustar o worker para usar op√ß√µes de browser semelhantes
√†s do segundo arquivo, e adicionar as op√ß√µes de PDF do segundo
arquivo.</p>
<p>Altera√ß√µes propostas:</p>
<ol type="1">
<li><p>Ao lan√ßar o browser, adicionar argumentos para desabilitar
features desnecess√°rias e melhorar a estabilidade.</p></li>
<li><p>No PDF, adicionar <code>prefer_css_page_size</code> e
<code>scale</code>.</p></li>
<li><p>Considerar adicionar <code>wait_for_function</code> para garantir
que a p√°gina est√° pronta.</p></li>
<li><p>Manter o retry por arquivo (j√° est√° implementado).</p></li>
<li><p>Manter o mesmo sistema de interrup√ß√£o.</p></li>
<li><p>Ajustar o n√∫mero de workers para um padr√£o de 3, mas permitir que
o usu√°rio configure.</p></li>
</ol>
<p>Vamos modificar o worker
<code>worker_process_batch_simple</code>:</p>
<ul>
<li>Adicionar args ao lan√ßar o browser.</li>
<li>Adicionar <code>wait_for_function</code> ap√≥s o
<code>wait_for_timeout</code> (ou em vez dele) para garantir que a
p√°gina est√° carregada.</li>
<li>Ajustar as op√ß√µes do PDF.</li>
</ul>
<p>Al√©m disso, note que o primeiro arquivo j√° est√° usando
<code>page.goto</code> com <code>wait_until=&#39;networkidle&#39;</code> e um
timeout de 30 segundos. Isso √© bom.</p>
<p>Vamos tamb√©m ajustar o n√∫mero padr√£o de workers para 3, j√° que √© um
bom valor para 4 n√∫cleos.</p>
<p>Outra otimiza√ß√£o: no primeiro arquivo, o batch size √© 3. Isso
significa que cada worker processa 3 arquivos. Podemos manter, mas note
que o batch size √© o n√∫mero de arquivos por batch, e cada batch √©
atribu√≠do a um worker. Com 3 workers e batch size 3, ter√≠amos 9 arquivos
sendo processados simultaneamente? N√£o, porque o pool tem 3 workers e
cada worker pega um batch de 3 arquivos, ent√£o s√£o 3 workers * 1 batch
cada, mas cada batch tem 3 arquivos, ent√£o 3 workers * 3 arquivos = 9
arquivos em paralelo? N√£o, porque cada worker processa um batch de 3
arquivos sequencialmente. Portanto, o paralelismo real √© o n√∫mero de
workers (3) e cada worker processa um arquivo por vez (mas o batch √© uma
lista de arquivos que o worker processa em sequ√™ncia). Portanto, o batch
size n√£o afeta o paralelismo, apenas a granularidade da tarefa. Um batch
size muito pequeno pode aumentar a sobrecarga de comunica√ß√£o, e um muito
grande pode tornar a interrup√ß√£o menos responsiva. Podemos manter o
batch size 3.</p>
<p>Vamos ent√£o reescrever o worker com as otimiza√ß√µes:</p>
<ul>
<li>Browser launch com args.</li>
<li>Contexto com viewport (como no segundo arquivo).</li>
<li>wait_for_function para readyState.</li>
<li>Op√ß√µes de PDF completas.</li>
</ul>
<p>Al√©m disso, vamos ajustar o n√∫mero padr√£o de workers para 3.</p>
<p>Vamos tamb√©m ajustar o timeout para o goto e wait_for_function para
30 segundos (j√° est√°).</p>
<p>Vamos ao c√≥digo:</p>
<ol type="1">
<li><p>Modificar a fun√ß√£o <code>worker_process_batch_simple</code>:</p>
<ul>
<li>Adicionar args ao browser.</li>
<li>Adicionar viewport no contexto.</li>
<li>Adicionar wait_for_function.</li>
<li>Ajustar op√ß√µes do PDF.</li>
</ul></li>
<li><p>Alterar o n√∫mero padr√£o de workers para 3.</p></li>
<li><p>Manter o retry_count padr√£o como 2.</p></li>
<li><p>Manter o batch_size padr√£o como 3.</p></li>
</ol>
<p>Vamos tamb√©m remover o <code>page.wait_for_timeout(1000)</code> e
substituir pelo <code>wait_for_function</code>? Ou manter ambos? O
wait_for_function j√° espera pelo readyState, ent√£o talvez o timeout
extra n√£o seja necess√°rio. Mas o segundo arquivo usa um sleep de 1
segundo ap√≥s o wait_for_function. Vamos manter o wait_for_function e
remover o wait_for_timeout, pois o wait_for_function j√° espera at√© que a
p√°gina esteja pronta.</p>
<p>No entanto, note que o wait_for_function pode falhar se a p√°gina n√£o
tiver o JavaScript habilitado? Mas como estamos convertendo HTML, √©
razo√°vel supor que tenhamos um ambiente com JavaScript. Vamos tentar
usar apenas o wait_for_function.</p>
<p>Outro ponto: o segundo arquivo usa <code>page.goto</code> com
<code>wait_until=&#39;networkidle&#39;</code> e depois
<code>wait_for_function</code> para readyState. Isso √© redundante? O
<code>networkidle</code> j√° espera pela rede, mas o readyState pode ser
verificado para garantir que a p√°gina est√° pronta. Vamos manter
ambos.</p>
<p>Vamos tamb√©m adicionar um try-except para o wait_for_function, e em
caso de timeout, podemos tentar prosseguir ou falhar? Vamos manter a
mesma l√≥gica de retry: se qualquer passo falhar, vamos para a pr√≥xima
tentativa.</p>
<p>Vamos reescrever a parte de convers√£o no worker:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dentro do for attempt...</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>context <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    context <span class="op">=</span> browser.new_context(</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        viewport<span class="op">=</span>{<span class="st">&#39;width&#39;</span>: <span class="dv">1920</span>, <span class="st">&#39;height&#39;</span>: <span class="dv">1080</span>},</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        ignore_https_errors<span class="op">=</span><span class="va">True</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    page <span class="op">=</span> context.new_page()</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    page.set_default_timeout(<span class="dv">30000</span>)  <span class="co"># 30 segundos</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    full_path <span class="op">=</span> <span class="ss">f&quot;file:///</span><span class="sc">{</span>html_path<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    page.goto(full_path, wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>, timeout<span class="op">=</span><span class="dv">30000</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Wait for complete load</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    page.wait_for_function(</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;document.readyState === &quot;complete&quot;&#39;</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span><span class="dv">30000</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generate PDF with optimized settings</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    pdf_params <span class="op">=</span> {</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;path&#39;</span>: <span class="bu">str</span>(pdf_path),</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;format&#39;</span>: <span class="st">&#39;A4&#39;</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;print_background&#39;</span>: <span class="va">True</span>,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;margin&#39;</span>: {<span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span>},</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;prefer_css_page_size&#39;</span>: <span class="va">True</span>,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;display_header_footer&#39;</span>: <span class="va">False</span>,</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;scale&#39;</span>: <span class="fl">1.0</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    page.pdf(<span class="op">**</span>pdf_params)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    msg_queue.put((<span class="st">&quot;ok&quot;</span>, pdf_path.name))</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    last_error <span class="op">=</span> <span class="bu">str</span>(e)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="cf">finally</span>:</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> context:</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>            context.close()</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span></code></pre></div>
<p>Al√©m disso, ao lan√ßar o browser, vamos adicionar os args:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    headless<span class="op">=</span>headless,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    args<span class="op">=</span>[</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;--disable-renderer-backgrounding&#39;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Vamos tamb√©m ajustar o n√∫mero padr√£o de workers para 3 no argument
parser.</p>
<p>Outra melhoria: no segundo arquivo, o PDF √© gerado com
<code>prefer_css_page_size</code> e <code>scale</code>. Vamos adicionar
essas op√ß√µes.</p>
<p>Vamos agora gerar o c√≥digo completo com as altera√ß√µes.</p>
<p>Nota: O c√≥digo atual do worker j√° faz retry por arquivo. Vamos
manter.</p>
<p>Vamos tamb√©m ajustar o timeout para o wait_for_function para 30
segundos.</p>
<p>Vamos ao c√≥digo completo do arquivo otimizado: Aqui est√° a vers√£o
otimizada do
<code>comb_pdf_direct6_html_based_optimized_live_benchmark.py</code> com
as melhorias solicitadas:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">comb_pdf_direct6_html_based_optimized_live_benchmark.py</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">Vers√£o ALTAMENTE OTIMIZADA com:</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">- Reutiliza√ß√£o de inst√¢ncia do Chromium por processo</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">- Paralelismo seguro via multiprocessing.Pool</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">- Retry por arquivo (2 tentativas padr√£o)</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">- Cancelamento limpo via Ctrl+C</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">- Workers otimizados (3-4 para 4 n√∫cleos/8GB RAM)</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">- Browser management aprimorado</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> signal</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psutil</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Optional</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright, <span class="pp">TimeoutError</span> <span class="im">as</span> PlaywrightTimeoutError</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Vari√°veis globais para controle de interrup√ß√£o</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>_active_processes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>_should_stop <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Fun√ß√µes utilit√°rias OTIMIZADAS</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kill_orphaned_chromium():</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Encerra processos Chromium √≥rf√£os de forma agressiva.&quot;&quot;&quot;</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Limpando processos Chromium √≥rf√£os...&quot;</span>)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>            subprocess.run(</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chrome.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;msedge.exe&quot;</span>],</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>                stdout<span class="op">=</span>subprocess.DEVNULL, </span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>                stderr<span class="op">=</span>subprocess.DEVNULL,</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>                timeout<span class="op">=</span><span class="dv">10</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chrome&quot;</span>], </span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;playwright&quot;</span>], </span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è Aviso na limpeza: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunkify(seq: List[<span class="bu">str</span>], size: <span class="bu">int</span>) <span class="op">-&gt;</span> List[List[<span class="bu">str</span>]]:</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [seq[i:i <span class="op">+</span> size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(seq), size)]</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_playwright_available(headless_test: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o Playwright + Chromium est√£o instalados.&quot;&quot;&quot;</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless_test,</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> emergency_stop_handler(signum, frame):</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handler de emerg√™ncia para Ctrl+C - para TUDO imediatamente&quot;&quot;&quot;</span></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">!!! EMERGENCY STOP !!!&quot;</span>)</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üö® INTERRUP√á√ÉO DE EMERG√äNCIA - Terminando </span><span class="sc">{</span><span class="bu">len</span>(_active_processes)<span class="sc">}</span><span class="ss"> processos...&quot;</span>)</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Terminar processos de forma agressiva</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pid <span class="kw">in</span> <span class="bu">list</span>(_active_processes):</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>            parent <span class="op">=</span> psutil.Process(pid)</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> child <span class="kw">in</span> parent.children(recursive<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>                    child.kill()</span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span>:</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">pass</span></span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>            parent.kill()</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üíÄ TODOS OS PROCESSOS FORAM TERMINADOS&quot;</span>)</span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>    os._exit(<span class="dv">1</span>)  <span class="co"># Sa√≠da de emerg√™ncia</span></span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Worker de processamento OTIMIZADO - REUTILIZA BROWSER POR PROCESSO</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_process_batch_optimized(batch_files, pdf_dir, timeout, headless, force_overwrite, retry_count, stop_event, msg_queue):</span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Worker OTIMIZADO que reutiliza uma inst√¢ncia do Chromium por processo&quot;&quot;&quot;</span></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>    my_pid <span class="op">=</span> os.getpid()</span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>    _active_processes.add(my_pid)</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>        out_dir <span class="op">=</span> Path(pdf_dir)</span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>        out_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verificar parada ANTES de iniciar o browser</span></span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Configura√ß√£o OTIMIZADA do browser - UMA INST√ÇNCIA POR PROCESSO</span></span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless,</span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span>,</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-first-run&#39;</span>,</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-default-browser-check&#39;</span>,</span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-default-apps&#39;</span>,</span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-translate&#39;</span>,</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-extensions&#39;</span></span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_path_str <span class="kw">in</span> batch_files:</span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Verificar parada ANTES de cada arquivo</span></span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a>                html_path <span class="op">=</span> Path(html_path_str)</span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a>                pdf_path <span class="op">=</span> out_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> pdf_path.exists() <span class="kw">and</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;J√° existe&quot;</span>))</span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;skip&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>                success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>                last_error <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>                context <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(retry_count):</span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Verificar parada ANTES de cada tentativa</span></span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># NOVO CONTEXT por arquivo (mas mesmo browser)</span></span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a>                        context <span class="op">=</span> browser.new_context(</span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a>                            viewport<span class="op">=</span>{<span class="st">&#39;width&#39;</span>: <span class="dv">1920</span>, <span class="st">&#39;height&#39;</span>: <span class="dv">1080</span>},</span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a>                            ignore_https_errors<span class="op">=</span><span class="va">True</span></span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>                        page <span class="op">=</span> context.new_page()</span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Timeouts otimizados</span></span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a>                        page.set_default_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>                        page.set_default_navigation_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>                        full_path <span class="op">=</span> <span class="ss">f&quot;file:///</span><span class="sc">{</span>html_path<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a>                        page.goto(full_path, wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>, timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Wait for complete load - MAIS CONFI√ÅVEL</span></span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_function(</span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;document.readyState === &quot;complete&quot;&#39;</span>,</span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a>                            timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Pequena espera para conte√∫do din√¢mico</span></span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_timeout(<span class="dv">500</span>)</span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Gera√ß√£o de PDF com configura√ß√µes OTIMIZADAS</span></span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a>                        page.pdf(</span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a>                            path<span class="op">=</span><span class="bu">str</span>(pdf_path),</span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>,</span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a>                            print_background<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a>                            margin<span class="op">=</span>{<span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span>},</span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a>                            prefer_css_page_size<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a>                            display_header_footer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a>                            scale<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a>                        success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;ok&quot;</span>, pdf_path.name))</span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true" tabindex="-1"></a>                        last_error <span class="op">=</span> <span class="bu">str</span>(e)</span>
<span id="cb3-212"><a href="#cb3-212" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;retry&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb3-213"><a href="#cb3-213" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb3-214"><a href="#cb3-214" aria-hidden="true" tabindex="-1"></a>                            time.sleep(<span class="dv">1</span>)  <span class="co"># Pequena pausa entre tentativas</span></span>
<span id="cb3-215"><a href="#cb3-215" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">finally</span>:</span>
<span id="cb3-216"><a href="#cb3-216" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> context:</span>
<span id="cb3-217"><a href="#cb3-217" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">try</span>:</span>
<span id="cb3-218"><a href="#cb3-218" aria-hidden="true" tabindex="-1"></a>                                context.close()</span>
<span id="cb3-219"><a href="#cb3-219" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">except</span>:</span>
<span id="cb3-220"><a href="#cb3-220" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">pass</span></span>
<span id="cb3-221"><a href="#cb3-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-222"><a href="#cb3-222" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> success:</span>
<span id="cb3-223"><a href="#cb3-223" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;fail&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>last_error<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb3-224"><a href="#cb3-224" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">False</span>, last_error))</span>
<span id="cb3-225"><a href="#cb3-225" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb3-226"><a href="#cb3-226" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;Sucesso&quot;</span>))</span>
<span id="cb3-227"><a href="#cb3-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-228"><a href="#cb3-228" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fechar browser ao final do batch</span></span>
<span id="cb3-229"><a href="#cb3-229" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb3-230"><a href="#cb3-230" aria-hidden="true" tabindex="-1"></a>                browser.close()</span>
<span id="cb3-231"><a href="#cb3-231" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb3-232"><a href="#cb3-232" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb3-233"><a href="#cb3-233" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb3-234"><a href="#cb3-234" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb3-235"><a href="#cb3-235" aria-hidden="true" tabindex="-1"></a>        msg_queue.put((<span class="st">&quot;error&quot;</span>, <span class="ss">f&quot;Erro no worker: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb3-236"><a href="#cb3-236" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb3-237"><a href="#cb3-237" aria-hidden="true" tabindex="-1"></a>        _active_processes.discard(my_pid)</span>
<span id="cb3-238"><a href="#cb3-238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-239"><a href="#cb3-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb3-240"><a href="#cb3-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-241"><a href="#cb3-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-242"><a href="#cb3-242" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_wrapper_optimized(args):</span>
<span id="cb3-243"><a href="#cb3-243" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Wrapper para o worker otimizado&quot;&quot;&quot;</span></span>
<span id="cb3-244"><a href="#cb3-244" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb3-245"><a href="#cb3-245" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> worker_process_batch_optimized(<span class="op">*</span>args)</span>
<span id="cb3-246"><a href="#cb3-246" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb3-247"><a href="#cb3-247" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb3-248"><a href="#cb3-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-249"><a href="#cb3-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-250"><a href="#cb3-250" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-251"><a href="#cb3-251" aria-hidden="true" tabindex="-1"></a><span class="co"># Listener de mensagens APRIMORADO</span></span>
<span id="cb3-252"><a href="#cb3-252" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-253"><a href="#cb3-253" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> queue_listener_optimized(msg_queue, listener_stop_flag, total_files):</span>
<span id="cb3-254"><a href="#cb3-254" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Listener com barra de progresso e estat√≠sticas&quot;&quot;&quot;</span></span>
<span id="cb3-255"><a href="#cb3-255" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb3-256"><a href="#cb3-256" aria-hidden="true" tabindex="-1"></a>    processed <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-257"><a href="#cb3-257" aria-hidden="true" tabindex="-1"></a>    successes <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-258"><a href="#cb3-258" aria-hidden="true" tabindex="-1"></a>    skips <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-259"><a href="#cb3-259" aria-hidden="true" tabindex="-1"></a>    failures <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb3-260"><a href="#cb3-260" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-261"><a href="#cb3-261" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> listener_stop_flag.is_set():</span>
<span id="cb3-262"><a href="#cb3-262" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb3-263"><a href="#cb3-263" aria-hidden="true" tabindex="-1"></a>            obj <span class="op">=</span> msg_queue.get(timeout<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb3-264"><a href="#cb3-264" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb3-265"><a href="#cb3-265" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb3-266"><a href="#cb3-266" aria-hidden="true" tabindex="-1"></a>            typ, text <span class="op">=</span> obj</span>
<span id="cb3-267"><a href="#cb3-267" aria-hidden="true" tabindex="-1"></a>            processed <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-268"><a href="#cb3-268" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-269"><a href="#cb3-269" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> typ <span class="op">==</span> <span class="st">&quot;ok&quot;</span>:</span>
<span id="cb3-270"><a href="#cb3-270" aria-hidden="true" tabindex="-1"></a>                successes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-271"><a href="#cb3-271" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-272"><a href="#cb3-272" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;skip&quot;</span>:</span>
<span id="cb3-273"><a href="#cb3-273" aria-hidden="true" tabindex="-1"></a>                skips <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-274"><a href="#cb3-274" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚è≠Ô∏è </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-275"><a href="#cb3-275" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;fail&quot;</span>:</span>
<span id="cb3-276"><a href="#cb3-276" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-277"><a href="#cb3-277" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚ùå </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-278"><a href="#cb3-278" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;error&quot;</span>:</span>
<span id="cb3-279"><a href="#cb3-279" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-280"><a href="#cb3-280" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üö´ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-281"><a href="#cb3-281" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;retry&quot;</span>:</span>
<span id="cb3-282"><a href="#cb3-282" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üîÑ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-283"><a href="#cb3-283" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-284"><a href="#cb3-284" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Mostrar progresso a cada 10 arquivos ou no final</span></span>
<span id="cb3-285"><a href="#cb3-285" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> processed <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> processed <span class="op">==</span> total_files:</span>
<span id="cb3-286"><a href="#cb3-286" aria-hidden="true" tabindex="-1"></a>                elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb3-287"><a href="#cb3-287" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> successes <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-288"><a href="#cb3-288" aria-hidden="true" tabindex="-1"></a>                    rate <span class="op">=</span> successes <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb3-289"><a href="#cb3-289" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f&quot;üìä Progresso: </span><span class="sc">{</span>successes<span class="op">+</span>skips<span class="op">+</span>failures<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_files<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb3-290"><a href="#cb3-290" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;‚úÖ</span><span class="sc">{</span>successes<span class="sc">}</span><span class="ss"> ‚è≠Ô∏è</span><span class="sc">{</span>skips<span class="sc">}</span><span class="ss"> ‚ùå</span><span class="sc">{</span>failures<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb3-291"><a href="#cb3-291" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;</span><span class="sc">{</span>rate<span class="sc">:.1f}</span><span class="ss"> PDFs/min&quot;</span>)</span>
<span id="cb3-292"><a href="#cb3-292" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb3-293"><a href="#cb3-293" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb3-294"><a href="#cb3-294" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb3-295"><a href="#cb3-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-296"><a href="#cb3-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-297"><a href="#cb3-297" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-298"><a href="#cb3-298" aria-hidden="true" tabindex="-1"></a><span class="co"># Convers√£o principal - VERS√ÉO ALTAMENTE OTIMIZADA</span></span>
<span id="cb3-299"><a href="#cb3-299" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-300"><a href="#cb3-300" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_pdfs_optimized(source_dir, output_dir, workers, batch_size, headless, timeout,</span>
<span id="cb3-301"><a href="#cb3-301" aria-hidden="true" tabindex="-1"></a>                           force_overwrite, dry_run, single_file<span class="op">=</span><span class="va">None</span>, retry_count<span class="op">=</span><span class="dv">2</span>, benchmark<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb3-302"><a href="#cb3-302" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Fun√ß√£o principal OTIMIZADA com interrup√ß√£o robusta e performance m√°xima&quot;&quot;&quot;</span></span>
<span id="cb3-303"><a href="#cb3-303" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop</span>
<span id="cb3-304"><a href="#cb3-304" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-305"><a href="#cb3-305" aria-hidden="true" tabindex="-1"></a>    src <span class="op">=</span> Path(source_dir)</span>
<span id="cb3-306"><a href="#cb3-306" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> Path(output_dir)</span>
<span id="cb3-307"><a href="#cb3-307" aria-hidden="true" tabindex="-1"></a>    out.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-308"><a href="#cb3-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-309"><a href="#cb3-309" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> single_file:</span>
<span id="cb3-310"><a href="#cb3-310" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [<span class="bu">str</span>(src <span class="op">/</span> single_file)]</span>
<span id="cb3-311"><a href="#cb3-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> Path(html_files[<span class="dv">0</span>]).exists():</span>
<span id="cb3-312"><a href="#cb3-312" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Arquivo n√£o encontrado: </span><span class="sc">{</span>single_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-313"><a href="#cb3-313" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb3-314"><a href="#cb3-314" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-315"><a href="#cb3-315" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> <span class="bu">sorted</span>([<span class="bu">str</span>(p) <span class="cf">for</span> p <span class="kw">in</span> src.glob(<span class="st">&quot;*.html&quot;</span>)])</span>
<span id="cb3-316"><a href="#cb3-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-317"><a href="#cb3-317" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb3-318"><a href="#cb3-318" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Nenhum arquivo HTML encontrado.&quot;</span>)</span>
<span id="cb3-319"><a href="#cb3-319" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb3-320"><a href="#cb3-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-321"><a href="#cb3-321" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üéØ Encontrados </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos HTML&quot;</span>)</span>
<span id="cb3-322"><a href="#cb3-322" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>workers<span class="sc">}</span><span class="ss"> | Batch: </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb3-323"><a href="#cb3-323" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss"> tentativas por arquivo&quot;</span>)</span>
<span id="cb3-324"><a href="#cb3-324" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;‚èπÔ∏è  Pressione Ctrl+C para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb3-325"><a href="#cb3-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-326"><a href="#cb3-326" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dry_run:</span>
<span id="cb3-327"><a href="#cb3-327" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ MODO SIMULA√á√ÉO - Nenhum arquivo ser√° criado&quot;</span>)</span>
<span id="cb3-328"><a href="#cb3-328" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> html_files[:<span class="dv">5</span>]:</span>
<span id="cb3-329"><a href="#cb3-329" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   üìÑ </span><span class="sc">{</span>Path(f)<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-330"><a href="#cb3-330" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(html_files) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb3-331"><a href="#cb3-331" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(html_files) <span class="op">-</span> <span class="dv">5</span><span class="sc">}</span><span class="ss"> arquivos&quot;</span>)</span>
<span id="cb3-332"><a href="#cb3-332" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb3-333"><a href="#cb3-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-334"><a href="#cb3-334" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb3-335"><a href="#cb3-335" aria-hidden="true" tabindex="-1"></a>        original_count <span class="op">=</span> <span class="bu">len</span>(html_files)</span>
<span id="cb3-336"><a href="#cb3-336" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> html_files <span class="cf">if</span> <span class="kw">not</span> (out <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>Path(f)<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span>).exists()]</span>
<span id="cb3-337"><a href="#cb3-337" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üÜï </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos novos para processar (de </span><span class="sc">{</span>original_count<span class="sc">}</span><span class="ss"> total)&quot;</span>)</span>
<span id="cb3-338"><a href="#cb3-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-339"><a href="#cb3-339" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb3-340"><a href="#cb3-340" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Nenhum arquivo novo para processar&quot;</span>)</span>
<span id="cb3-341"><a href="#cb3-341" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb3-342"><a href="#cb3-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-343"><a href="#cb3-343" aria-hidden="true" tabindex="-1"></a>    batches <span class="op">=</span> chunkify(html_files, batch_size)</span>
<span id="cb3-344"><a href="#cb3-344" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üì¶ </span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> batches preparados&quot;</span>)</span>
<span id="cb3-345"><a href="#cb3-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-346"><a href="#cb3-346" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sistema de comunica√ß√£o OTIMIZADO</span></span>
<span id="cb3-347"><a href="#cb3-347" aria-hidden="true" tabindex="-1"></a>    manager <span class="op">=</span> multiprocessing.Manager()</span>
<span id="cb3-348"><a href="#cb3-348" aria-hidden="true" tabindex="-1"></a>    stop_event <span class="op">=</span> manager.Event()</span>
<span id="cb3-349"><a href="#cb3-349" aria-hidden="true" tabindex="-1"></a>    msg_queue <span class="op">=</span> manager.Queue()</span>
<span id="cb3-350"><a href="#cb3-350" aria-hidden="true" tabindex="-1"></a>    listener_stop_flag <span class="op">=</span> threading.Event()</span>
<span id="cb3-351"><a href="#cb3-351" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-352"><a href="#cb3-352" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Listener COM ESTAT√çSTICAS</span></span>
<span id="cb3-353"><a href="#cb3-353" aria-hidden="true" tabindex="-1"></a>    listener_thread <span class="op">=</span> threading.Thread(</span>
<span id="cb3-354"><a href="#cb3-354" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>queue_listener_optimized, </span>
<span id="cb3-355"><a href="#cb3-355" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(msg_queue, listener_stop_flag, <span class="bu">len</span>(html_files)), </span>
<span id="cb3-356"><a href="#cb3-356" aria-hidden="true" tabindex="-1"></a>        daemon<span class="op">=</span><span class="va">True</span></span>
<span id="cb3-357"><a href="#cb3-357" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-358"><a href="#cb3-358" aria-hidden="true" tabindex="-1"></a>    listener_thread.start()</span>
<span id="cb3-359"><a href="#cb3-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-360"><a href="#cb3-360" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparar argumentos</span></span>
<span id="cb3-361"><a href="#cb3-361" aria-hidden="true" tabindex="-1"></a>    args_list <span class="op">=</span> [</span>
<span id="cb3-362"><a href="#cb3-362" aria-hidden="true" tabindex="-1"></a>        (batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, stop_event, msg_queue) </span>
<span id="cb3-363"><a href="#cb3-363" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> batches</span>
<span id="cb3-364"><a href="#cb3-364" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb3-365"><a href="#cb3-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-366"><a href="#cb3-366" aria-hidden="true" tabindex="-1"></a>    success_count, failed <span class="op">=</span> <span class="dv">0</span>, []</span>
<span id="cb3-367"><a href="#cb3-367" aria-hidden="true" tabindex="-1"></a>    pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb3-368"><a href="#cb3-368" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb3-369"><a href="#cb3-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-370"><a href="#cb3-370" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb3-371"><a href="#cb3-371" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Criar pool com n√∫mero OTIMIZADO de workers</span></span>
<span id="cb3-372"><a href="#cb3-372" aria-hidden="true" tabindex="-1"></a>        pool <span class="op">=</span> multiprocessing.Pool(processes<span class="op">=</span>workers)</span>
<span id="cb3-373"><a href="#cb3-373" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-374"><a href="#cb3-374" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üîÑ Iniciando convers√£o OTIMIZADA...&quot;</span>)</span>
<span id="cb3-375"><a href="#cb3-375" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-376"><a href="#cb3-376" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Processar batches - com verifica√ß√£o CONSTANTE de parada</span></span>
<span id="cb3-377"><a href="#cb3-377" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, result <span class="kw">in</span> <span class="bu">enumerate</span>(pool.imap_unordered(worker_wrapper_optimized, args_list)):</span>
<span id="cb3-378"><a href="#cb3-378" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> stop_event.is_set():</span>
<span id="cb3-379"><a href="#cb3-379" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üõë Parada de emerg√™ncia ativada!&quot;</span>)</span>
<span id="cb3-380"><a href="#cb3-380" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb3-381"><a href="#cb3-381" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb3-382"><a href="#cb3-382" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Relat√≥rio de progresso por batch</span></span>
<span id="cb3-383"><a href="#cb3-383" aria-hidden="true" tabindex="-1"></a>            batch_progress <span class="op">=</span> <span class="ss">f&quot;üì¶ Batch </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> processado&quot;</span></span>
<span id="cb3-384"><a href="#cb3-384" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(result) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-385"><a href="#cb3-385" aria-hidden="true" tabindex="-1"></a>                batch_success <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> _, success, _ <span class="kw">in</span> result <span class="cf">if</span> success)</span>
<span id="cb3-386"><a href="#cb3-386" aria-hidden="true" tabindex="-1"></a>                batch_progress <span class="op">+=</span> <span class="ss">f&quot; - ‚úÖ </span><span class="sc">{</span>batch_success<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(result)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb3-387"><a href="#cb3-387" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(batch_progress)</span>
<span id="cb3-388"><a href="#cb3-388" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-389"><a href="#cb3-389" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_file, success, msg <span class="kw">in</span> result:</span>
<span id="cb3-390"><a href="#cb3-390" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> success:</span>
<span id="cb3-391"><a href="#cb3-391" aria-hidden="true" tabindex="-1"></a>                    success_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb3-392"><a href="#cb3-392" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb3-393"><a href="#cb3-393" aria-hidden="true" tabindex="-1"></a>                    failed.append((Path(html_file).name, msg))</span>
<span id="cb3-394"><a href="#cb3-394" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb3-395"><a href="#cb3-395" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verificar parada entre batches</span></span>
<span id="cb3-396"><a href="#cb3-396" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> stop_event.is_set():</span>
<span id="cb3-397"><a href="#cb3-397" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb3-398"><a href="#cb3-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-399"><a href="#cb3-399" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb3-400"><a href="#cb3-400" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO RECEBIDA !!!&quot;</span>)</span>
<span id="cb3-401"><a href="#cb3-401" aria-hidden="true" tabindex="-1"></a>        _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb3-402"><a href="#cb3-402" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb3-403"><a href="#cb3-403" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb3-404"><a href="#cb3-404" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Erro no pool principal: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-405"><a href="#cb3-405" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb3-406"><a href="#cb3-406" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb3-407"><a href="#cb3-407" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ LIMPEZA FINAL...&quot;</span>)</span>
<span id="cb3-408"><a href="#cb3-408" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-409"><a href="#cb3-409" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parar listener</span></span>
<span id="cb3-410"><a href="#cb3-410" aria-hidden="true" tabindex="-1"></a>        listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb3-411"><a href="#cb3-411" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb3-412"><a href="#cb3-412" aria-hidden="true" tabindex="-1"></a>            msg_queue.put(<span class="va">None</span>)</span>
<span id="cb3-413"><a href="#cb3-413" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb3-414"><a href="#cb3-414" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb3-415"><a href="#cb3-415" aria-hidden="true" tabindex="-1"></a>        listener_thread.join(timeout<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb3-416"><a href="#cb3-416" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-417"><a href="#cb3-417" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Terminar pool AGressivamente</span></span>
<span id="cb3-418"><a href="#cb3-418" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pool:</span>
<span id="cb3-419"><a href="#cb3-419" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb3-420"><a href="#cb3-420" aria-hidden="true" tabindex="-1"></a>                pool.terminate()</span>
<span id="cb3-421"><a href="#cb3-421" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb3-422"><a href="#cb3-422" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb3-423"><a href="#cb3-423" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb3-424"><a href="#cb3-424" aria-hidden="true" tabindex="-1"></a>                pool.join(timeout<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb3-425"><a href="#cb3-425" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb3-426"><a href="#cb3-426" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb3-427"><a href="#cb3-427" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-428"><a href="#cb3-428" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final agressiva</span></span>
<span id="cb3-429"><a href="#cb3-429" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb3-430"><a href="#cb3-430" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-431"><a href="#cb3-431" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pequena pausa para garantir que tudo foi limpo</span></span>
<span id="cb3-432"><a href="#cb3-432" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb3-433"><a href="#cb3-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-434"><a href="#cb3-434" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Relat√≥rio DETALHADO</span></span>
<span id="cb3-435"><a href="#cb3-435" aria-hidden="true" tabindex="-1"></a>    elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb3-436"><a href="#cb3-436" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;=&quot;</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb3-437"><a href="#cb3-437" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üìä RELAT√ìRIO FINAL OTIMIZADO:&quot;</span>)</span>
<span id="cb3-438"><a href="#cb3-438" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot; ‚úÖ Sucessos: </span><span class="sc">{</span>success_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-439"><a href="#cb3-439" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot; ‚ùå Falhas: </span><span class="sc">{</span><span class="bu">len</span>(failed)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-440"><a href="#cb3-440" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-441"><a href="#cb3-441" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> failed:</span>
<span id="cb3-442"><a href="#cb3-442" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üìã Arquivos com falha (primeiros 10):&quot;</span>)</span>
<span id="cb3-443"><a href="#cb3-443" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> fname, error <span class="kw">in</span> failed[:<span class="dv">10</span>]:</span>
<span id="cb3-444"><a href="#cb3-444" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   ‚Ä£ </span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-445"><a href="#cb3-445" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(failed) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb3-446"><a href="#cb3-446" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(failed) <span class="op">-</span> <span class="dv">10</span><span class="sc">}</span><span class="ss"> falhas&quot;</span>)</span>
<span id="cb3-447"><a href="#cb3-447" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-448"><a href="#cb3-448" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> benchmark <span class="kw">and</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-449"><a href="#cb3-449" aria-hidden="true" tabindex="-1"></a>        rate_total <span class="op">=</span> <span class="bu">len</span>(html_files) <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb3-450"><a href="#cb3-450" aria-hidden="true" tabindex="-1"></a>        rate_success <span class="op">=</span> success_count <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb3-451"><a href="#cb3-451" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚è±Ô∏è  Tempo total: </span><span class="sc">{</span>elapsed<span class="sc">:.1f}</span><span class="ss">s&quot;</span>)</span>
<span id="cb3-452"><a href="#cb3-452" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_total<span class="sc">:.1f}</span><span class="ss"> PDFs/min (total)&quot;</span>)</span>
<span id="cb3-453"><a href="#cb3-453" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_success<span class="sc">:.1f}</span><span class="ss"> PDFs/min (sucessos)&quot;</span>)</span>
<span id="cb3-454"><a href="#cb3-454" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-455"><a href="#cb3-455" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> success_count <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb3-456"><a href="#cb3-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-457"><a href="#cb3-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-458"><a href="#cb3-458" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-459"><a href="#cb3-459" aria-hidden="true" tabindex="-1"></a><span class="co"># CLI OTIMIZADA</span></span>
<span id="cb3-460"><a href="#cb3-460" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-461"><a href="#cb3-461" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args():</span>
<span id="cb3-462"><a href="#cb3-462" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(</span>
<span id="cb3-463"><a href="#cb3-463" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">&quot;Convers√£o HTML ‚Üí PDF ALTAMENTE OTIMIZADA com INTERRUP√á√ÉO IMEDIATA&quot;</span></span>
<span id="cb3-464"><a href="#cb3-464" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-465"><a href="#cb3-465" aria-hidden="true" tabindex="-1"></a>    group <span class="op">=</span> parser.add_mutually_exclusive_group()</span>
<span id="cb3-466"><a href="#cb3-466" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--force&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Sobrescreve PDFs j√° existentes&quot;</span>)</span>
<span id="cb3-467"><a href="#cb3-467" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--only-new&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, default<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Apenas novos (padr√£o)&quot;</span>)</span>
<span id="cb3-468"><a href="#cb3-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-469"><a href="#cb3-469" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--dry-run&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Simula sem criar arquivos&quot;</span>)</span>
<span id="cb3-470"><a href="#cb3-470" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--source&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_html&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta com arquivos .html&quot;</span>)</span>
<span id="cb3-471"><a href="#cb3-471" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--output&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_pdfs&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta de sa√≠da para PDFs&quot;</span>)</span>
<span id="cb3-472"><a href="#cb3-472" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">3</span>, </span>
<span id="cb3-473"><a href="#cb3-473" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos (padr√£o: 3 otimizado para 4 n√∫cleos)&quot;</span>)</span>
<span id="cb3-474"><a href="#cb3-474" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--batch-size&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">4</span>, </span>
<span id="cb3-475"><a href="#cb3-475" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Arquivos por batch (padr√£o: 4 para balanceamento)&quot;</span>)</span>
<span id="cb3-476"><a href="#cb3-476" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--no-headless&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra navegador (debug)&quot;</span>)</span>
<span id="cb3-477"><a href="#cb3-477" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--single-file&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Converte apenas um arquivo HTML espec√≠fico&quot;</span>)</span>
<span id="cb3-478"><a href="#cb3-478" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--timeout&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">45</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Timeout por p√°gina (segundos)&quot;</span>)</span>
<span id="cb3-479"><a href="#cb3-479" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--retry-count&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Tentativas por arquivo (padr√£o: 2)&quot;</span>)</span>
<span id="cb3-480"><a href="#cb3-480" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--benchmark&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra tempo total e PDFs/minuto&quot;</span>)</span>
<span id="cb3-481"><a href="#cb3-481" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parser.parse_args()</span>
<span id="cb3-482"><a href="#cb3-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-483"><a href="#cb3-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-484"><a href="#cb3-484" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-485"><a href="#cb3-485" aria-hidden="true" tabindex="-1"></a><span class="co"># Main OTIMIZADA</span></span>
<span id="cb3-486"><a href="#cb3-486" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb3-487"><a href="#cb3-487" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb3-488"><a href="#cb3-488" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configurar handler de EMERG√äNCIA para Ctrl+C</span></span>
<span id="cb3-489"><a href="#cb3-489" aria-hidden="true" tabindex="-1"></a>    signal.signal(signal.SIGINT, emergency_stop_handler)</span>
<span id="cb3-490"><a href="#cb3-490" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-491"><a href="#cb3-491" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args()</span>
<span id="cb3-492"><a href="#cb3-492" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-493"><a href="#cb3-493" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üöÄ PDF GENERATOR - VERS√ÉO ALTAMENTE OTIMIZADA&quot;</span>)</span>
<span id="cb3-494"><a href="#cb3-494" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;!!! EMERGENCY STOP ENABLED - Ctrl+C para PARAR TUDO !!!&quot;</span>)</span>
<span id="cb3-495"><a href="#cb3-495" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;=&quot;</span> <span class="op">*</span> <span class="dv">65</span>)</span>
<span id="cb3-496"><a href="#cb3-496" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>args<span class="sc">.</span>workers<span class="sc">}</span><span class="ss"> (OTIMIZADO) | Batch: </span><span class="sc">{</span>args<span class="sc">.</span>batch_size<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-497"><a href="#cb3-497" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>args<span class="sc">.</span>retry_count<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>args<span class="sc">.</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb3-498"><a href="#cb3-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-499"><a href="#cb3-499" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza inicial agressiva</span></span>
<span id="cb3-500"><a href="#cb3-500" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb3-501"><a href="#cb3-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-502"><a href="#cb3-502" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verifica√ß√µes</span></span>
<span id="cb3-503"><a href="#cb3-503" aria-hidden="true" tabindex="-1"></a>    source_dir <span class="op">=</span> Path(args.source)</span>
<span id="cb3-504"><a href="#cb3-504" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> source_dir.exists():</span>
<span id="cb3-505"><a href="#cb3-505" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Pasta n√£o encontrada: </span><span class="sc">{</span>source_dir<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-506"><a href="#cb3-506" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb3-507"><a href="#cb3-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-508"><a href="#cb3-508" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_playwright_available(headless_test<span class="op">=</span><span class="kw">not</span> args.no_headless):</span>
<span id="cb3-509"><a href="#cb3-509" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Playwright n√£o dispon√≠vel.&quot;</span>)</span>
<span id="cb3-510"><a href="#cb3-510" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   pip install playwright psutil&quot;</span>)</span>
<span id="cb3-511"><a href="#cb3-511" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   playwright install chromium&quot;</span>)</span>
<span id="cb3-512"><a href="#cb3-512" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb3-513"><a href="#cb3-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-514"><a href="#cb3-514" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Executar vers√£o OTIMIZADA</span></span>
<span id="cb3-515"><a href="#cb3-515" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> generate_pdfs_optimized(</span>
<span id="cb3-516"><a href="#cb3-516" aria-hidden="true" tabindex="-1"></a>        source_dir<span class="op">=</span><span class="bu">str</span>(args.source),</span>
<span id="cb3-517"><a href="#cb3-517" aria-hidden="true" tabindex="-1"></a>        output_dir<span class="op">=</span><span class="bu">str</span>(args.output),</span>
<span id="cb3-518"><a href="#cb3-518" aria-hidden="true" tabindex="-1"></a>        workers<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">min</span>(args.workers, <span class="dv">6</span>)),  <span class="co"># Limite m√°ximo de 6 workers</span></span>
<span id="cb3-519"><a href="#cb3-519" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.batch_size),</span>
<span id="cb3-520"><a href="#cb3-520" aria-hidden="true" tabindex="-1"></a>        headless<span class="op">=</span><span class="kw">not</span> args.no_headless,</span>
<span id="cb3-521"><a href="#cb3-521" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span><span class="bu">max</span>(<span class="dv">15</span>, args.timeout),</span>
<span id="cb3-522"><a href="#cb3-522" aria-hidden="true" tabindex="-1"></a>        force_overwrite<span class="op">=</span>args.force,</span>
<span id="cb3-523"><a href="#cb3-523" aria-hidden="true" tabindex="-1"></a>        dry_run<span class="op">=</span>args.dry_run,</span>
<span id="cb3-524"><a href="#cb3-524" aria-hidden="true" tabindex="-1"></a>        single_file<span class="op">=</span>args.single_file,</span>
<span id="cb3-525"><a href="#cb3-525" aria-hidden="true" tabindex="-1"></a>        retry_count<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.retry_count),</span>
<span id="cb3-526"><a href="#cb3-526" aria-hidden="true" tabindex="-1"></a>        benchmark<span class="op">=</span>args.benchmark</span>
<span id="cb3-527"><a href="#cb3-527" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-528"><a href="#cb3-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-529"><a href="#cb3-529" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resultado final</span></span>
<span id="cb3-530"><a href="#cb3-530" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb3-531"><a href="#cb3-531" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ SIMULA√á√ÉO CONCLU√çDA&quot;</span>)</span>
<span id="cb3-532"><a href="#cb3-532" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb3-533"><a href="#cb3-533" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> success:</span>
<span id="cb3-534"><a href="#cb3-534" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üéâ CONVERS√ÉO CONCLU√çDA COM SUCESSO!&quot;</span>)</span>
<span id="cb3-535"><a href="#cb3-535" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb3-536"><a href="#cb3-536" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-537"><a href="#cb3-537" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è CONVERS√ÉO INTERROMPIDA OU COM FALHAS&quot;</span>)</span>
<span id="cb3-538"><a href="#cb3-538" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb3-539"><a href="#cb3-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-540"><a href="#cb3-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-541"><a href="#cb3-541" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb3-542"><a href="#cb3-542" aria-hidden="true" tabindex="-1"></a>    multiprocessing.freeze_support()</span>
<span id="cb3-543"><a href="#cb3-543" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-544"><a href="#cb3-544" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handler global para garantir que Ctrl+C sempre funcione</span></span>
<span id="cb3-545"><a href="#cb3-545" aria-hidden="true" tabindex="-1"></a>    original_sigint <span class="op">=</span> signal.getsignal(signal.SIGINT)</span>
<span id="cb3-546"><a href="#cb3-546" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-547"><a href="#cb3-547" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb3-548"><a href="#cb3-548" aria-hidden="true" tabindex="-1"></a>        sys.exit(main())</span>
<span id="cb3-549"><a href="#cb3-549" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb3-550"><a href="#cb3-550" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO GLOBAL !!!&quot;</span>)</span>
<span id="cb3-551"><a href="#cb3-551" aria-hidden="true" tabindex="-1"></a>        emergency_stop_handler(<span class="va">None</span>, <span class="va">None</span>)</span>
<span id="cb3-552"><a href="#cb3-552" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb3-553"><a href="#cb3-553" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üí• ERRO CR√çTICO: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-554"><a href="#cb3-554" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb3-555"><a href="#cb3-555" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb3-556"><a href="#cb3-556" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Restaurar handler original</span></span>
<span id="cb3-557"><a href="#cb3-557" aria-hidden="true" tabindex="-1"></a>        signal.signal(signal.SIGINT, original_sigint)</span></code></pre></div>
<h2 data-number="1.3" id="principais-otimiza√ß√µes-implementadas"><span class="header-section-number">1.3</span> Principais Otimiza√ß√µes
Implementadas:</h2>
<h3 data-number="1.3.1" id="reutiliza√ß√£o-de-browser-por-processo"><span class="header-section-number">1.3.1</span> 1. <strong>Reutiliza√ß√£o de
Browser por Processo</strong></h3>
<ul>
<li>Uma inst√¢ncia do Chromium √© criada por processo e reutilizada para
todo o batch</li>
<li>Fechamento adequado ao final de cada batch</li>
</ul>
<h3 data-number="1.3.2" id="configura√ß√£o-otimizada-do-browser"><span class="header-section-number">1.3.2</span> 2. <strong>Configura√ß√£o
Otimizada do Browser</strong></h3>
<ul>
<li>Args de linha de comando para melhor performance</li>
<li>Viewport consistente para renderiza√ß√£o</li>
<li>Timeouts configur√°veis</li>
</ul>
<h3 data-number="1.3.3" id="paralelismo-seguro"><span class="header-section-number">1.3.3</span> 3. <strong>Paralelismo
Seguro</strong></h3>
<ul>
<li><code>multiprocessing.Pool</code> com n√∫mero otimizado de workers (3
padr√£o)</li>
<li>Batch size balanceado (4 arquivos por batch)</li>
<li>Limite m√°ximo de 6 workers para evitar sobrecarga</li>
</ul>
<h3 data-number="1.3.4" id="sistema-de-retry-robusto"><span class="header-section-number">1.3.4</span> 4. <strong>Sistema de Retry
Robusto</strong></h3>
<ul>
<li>2 tentativas padr√£o por arquivo</li>
<li>Mensagens de retry no listener</li>
<li>Pausa entre tentativas</li>
</ul>
<h3 data-number="1.3.5" id="cancelamento-melhorado"><span class="header-section-number">1.3.5</span> 5. <strong>Cancelamento
Melhorado</strong></h3>
<ul>
<li>Verifica√ß√£o constante de interrup√ß√£o</li>
<li>Limpeza agressiva de processos √≥rf√£os</li>
<li>Termina√ß√£o segura do pool</li>
</ul>
<h3 data-number="1.3.6" id="monitoramento-em-tempo-real"><span class="header-section-number">1.3.6</span> 6. <strong>Monitoramento em
Tempo Real</strong></h3>
<ul>
<li>Listener com estat√≠sticas de progresso</li>
<li>Taxas de convers√£o em tempo real</li>
<li>Relat√≥rio detalhado final</li>
</ul>
<h3 data-number="1.3.7" id="valores-padr√£o-otimizados"><span class="header-section-number">1.3.7</span> 7. <strong>Valores Padr√£o
Otimizados</strong></h3>
<ul>
<li>Workers: 3 (ideal para 4 n√∫cleos)</li>
<li>Batch size: 4</li>
<li>Timeout: 45s</li>
<li>Retry count: 2</li>
</ul>
<h3 data-number="1.3.8" id="performance"><span class="header-section-number">1.3.8</span> 8.
<strong>Performance</strong></h3>
<ul>
<li>Redu√ß√£o de overhead por reutiliza√ß√£o de browser</li>
<li>Balanceamento entre paralelismo e uso de mem√≥ria</li>
<li>Limpeza agressiva de recursos</li>
</ul>
<p>Esta vers√£o oferece o melhor equil√≠brio entre performance,
estabilidade e capacidade de resposta a interrup√ß√µes.</p>
<hr />
<h3 data-number="1.3.9" id="utilizador-2025-11-07-051724-deepseek-reasoner"><span class="header-section-number">1.3.9</span> üë§ Utilizador <em>(2025-11-07
05:17:24)</em> <em>[deepseek-reasoner]</em></h3>
<p>Est√° optimo. Pretendo uma pequena adi√ß√£o que a ser iniciado o
processo de convers√£o de html para pdf que seja mostrado o metodo usado
para a convers√£o. E o file
comb_pdf_direct6_html_based_optimized_live_benchmark.py completo</p>
<hr />
<h3 data-number="1.3.10" id="deepseek-2025-11-07-051724-deepseek-reasoner"><span class="header-section-number">1.3.10</span> ü§ñ DeepSeek <em>(2025-11-07
05:17:24)</em> <em>[deepseek-reasoner]</em></h3>
<p>Vamos adicionar uma mensagem no in√≠cio da convers√£o que mostra o
m√©todo utilizado (ou seja, a estrat√©gia de paralelismo e reutiliza√ß√£o do
browser). A ideia √© informar que estamos usando uma inst√¢ncia do
Chromium por processo (worker) e que os arquivos s√£o processados em
batches.</p>
<p>Vamos modificar a fun√ß√£o <code>generate_pdfs_optimized</code> para
incluir essa informa√ß√£o.</p>
<p>Al√©m disso, vamos ajustar a mensagem de in√≠cio para destacar as
otimiza√ß√µes.</p>
<p>J√° temos a mensagem de in√≠cio que mostra o n√∫mero de workers e o
batch size, mas podemos ser mais expl√≠citos sobre a reutiliza√ß√£o do
browser.</p>
<p>Vamos adicionar uma linha explicativa:</p>
<p>‚ÄúM√©todo: Paralelismo com reutiliza√ß√£o de inst√¢ncia do Chromium por
processo (worker)‚Äù</p>
<p>Vamos colocar isso logo ap√≥s a exibi√ß√£o dos par√¢metros (workers,
batch size, etc.) e antes do aviso do Ctrl+C.</p>
<p>Vou tamb√©m ajustar a mensagem de in√≠cio para incluir a vers√£o
‚ÄúALTAMENTE OTIMIZADA‚Äù.</p>
<p>Vamos l√°. Aqui est√° o arquivo completo com a adi√ß√£o solicitada,
mostrando o m√©todo de convers√£o utilizado:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">comb_pdf_direct6_html_based_optimized_live_benchmark.py</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">Vers√£o ALTAMENTE OTIMIZADA com:</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">- Reutiliza√ß√£o de inst√¢ncia do Chromium por processo</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">- Paralelismo seguro via multiprocessing.Pool</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">- Retry por arquivo (2 tentativas padr√£o)</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">- Cancelamento limpo via Ctrl+C</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">- Workers otimizados (3-4 para 4 n√∫cleos/8GB RAM)</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">- Browser management aprimorado</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> signal</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psutil</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Optional</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright, <span class="pp">TimeoutError</span> <span class="im">as</span> PlaywrightTimeoutError</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Vari√°veis globais para controle de interrup√ß√£o</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>_active_processes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>_should_stop <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Fun√ß√µes utilit√°rias OTIMIZADAS</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kill_orphaned_chromium():</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Encerra processos Chromium √≥rf√£os de forma agressiva.&quot;&quot;&quot;</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Limpando processos Chromium √≥rf√£os...&quot;</span>)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>            subprocess.run(</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chrome.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;msedge.exe&quot;</span>],</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>                stdout<span class="op">=</span>subprocess.DEVNULL, </span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>                stderr<span class="op">=</span>subprocess.DEVNULL,</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>                timeout<span class="op">=</span><span class="dv">10</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chrome&quot;</span>], </span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;playwright&quot;</span>], </span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è Aviso na limpeza: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunkify(seq: List[<span class="bu">str</span>], size: <span class="bu">int</span>) <span class="op">-&gt;</span> List[List[<span class="bu">str</span>]]:</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [seq[i:i <span class="op">+</span> size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(seq), size)]</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_playwright_available(headless_test: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o Playwright + Chromium est√£o instalados.&quot;&quot;&quot;</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless_test,</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> emergency_stop_handler(signum, frame):</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handler de emerg√™ncia para Ctrl+C - para TUDO imediatamente&quot;&quot;&quot;</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">!!! EMERGENCY STOP !!!&quot;</span>)</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üö® INTERRUP√á√ÉO DE EMERG√äNCIA - Terminando </span><span class="sc">{</span><span class="bu">len</span>(_active_processes)<span class="sc">}</span><span class="ss"> processos...&quot;</span>)</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Terminar processos de forma agressiva</span></span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pid <span class="kw">in</span> <span class="bu">list</span>(_active_processes):</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>            parent <span class="op">=</span> psutil.Process(pid)</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> child <span class="kw">in</span> parent.children(recursive<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>                    child.kill()</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span>:</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">pass</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>            parent.kill()</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üíÄ TODOS OS PROCESSOS FORAM TERMINADOS&quot;</span>)</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>    os._exit(<span class="dv">1</span>)  <span class="co"># Sa√≠da de emerg√™ncia</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a><span class="co"># Worker de processamento OTIMIZADO - REUTILIZA BROWSER POR PROCESSO</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_process_batch_optimized(batch_files, pdf_dir, timeout, headless, force_overwrite, retry_count, stop_event, msg_queue):</span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Worker OTIMIZADO que reutiliza uma inst√¢ncia do Chromium por processo&quot;&quot;&quot;</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>    my_pid <span class="op">=</span> os.getpid()</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>    _active_processes.add(my_pid)</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>        out_dir <span class="op">=</span> Path(pdf_dir)</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>        out_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verificar parada ANTES de iniciar o browser</span></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Configura√ß√£o OTIMIZADA do browser - UMA INST√ÇNCIA POR PROCESSO</span></span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless,</span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span>,</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-first-run&#39;</span>,</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-default-browser-check&#39;</span>,</span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-default-apps&#39;</span>,</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-translate&#39;</span>,</span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-extensions&#39;</span></span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb4-148"><a href="#cb4-148" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-149"><a href="#cb4-149" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_path_str <span class="kw">in</span> batch_files:</span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Verificar parada ANTES de cada arquivo</span></span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>                html_path <span class="op">=</span> Path(html_path_str)</span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>                pdf_path <span class="op">=</span> out_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> pdf_path.exists() <span class="kw">and</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;J√° existe&quot;</span>))</span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;skip&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>                success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>                last_error <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>                context <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(retry_count):</span>
<span id="cb4-167"><a href="#cb4-167" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Verificar parada ANTES de cada tentativa</span></span>
<span id="cb4-168"><a href="#cb4-168" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># NOVO CONTEXT por arquivo (mas mesmo browser)</span></span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a>                        context <span class="op">=</span> browser.new_context(</span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a>                            viewport<span class="op">=</span>{<span class="st">&#39;width&#39;</span>: <span class="dv">1920</span>, <span class="st">&#39;height&#39;</span>: <span class="dv">1080</span>},</span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a>                            ignore_https_errors<span class="op">=</span><span class="va">True</span></span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a>                        page <span class="op">=</span> context.new_page()</span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Timeouts otimizados</span></span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>                        page.set_default_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>                        page.set_default_navigation_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a>                        full_path <span class="op">=</span> <span class="ss">f&quot;file:///</span><span class="sc">{</span>html_path<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a>                        page.goto(full_path, wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>, timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Wait for complete load - MAIS CONFI√ÅVEL</span></span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_function(</span>
<span id="cb4-188"><a href="#cb4-188" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;document.readyState === &quot;complete&quot;&#39;</span>,</span>
<span id="cb4-189"><a href="#cb4-189" aria-hidden="true" tabindex="-1"></a>                            timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Pequena espera para conte√∫do din√¢mico</span></span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_timeout(<span class="dv">500</span>)</span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Gera√ß√£o de PDF com configura√ß√µes OTIMIZADAS</span></span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a>                        page.pdf(</span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a>                            path<span class="op">=</span><span class="bu">str</span>(pdf_path),</span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>,</span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a>                            print_background<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a>                            margin<span class="op">=</span>{<span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span>},</span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a>                            prefer_css_page_size<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a>                            display_header_footer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a>                            scale<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a>                        success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;ok&quot;</span>, pdf_path.name))</span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb4-209"><a href="#cb4-209" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb4-210"><a href="#cb4-210" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a>                        last_error <span class="op">=</span> <span class="bu">str</span>(e)</span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;retry&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a>                            time.sleep(<span class="dv">1</span>)  <span class="co"># Pequena pausa entre tentativas</span></span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">finally</span>:</span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> context:</span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">try</span>:</span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a>                                context.close()</span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">except</span>:</span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">pass</span></span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> success:</span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;fail&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>last_error<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">False</span>, last_error))</span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;Sucesso&quot;</span>))</span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fechar browser ao final do batch</span></span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a>                browser.close()</span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a>        msg_queue.put((<span class="st">&quot;error&quot;</span>, <span class="ss">f&quot;Erro no worker: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a>        _active_processes.discard(my_pid)</span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_wrapper_optimized(args):</span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Wrapper para o worker otimizado&quot;&quot;&quot;</span></span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> worker_process_batch_optimized(<span class="op">*</span>args)</span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-247"><a href="#cb4-247" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb4-248"><a href="#cb4-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a><span class="co"># Listener de mensagens APRIMORADO</span></span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> queue_listener_optimized(msg_queue, listener_stop_flag, total_files):</span>
<span id="cb4-254"><a href="#cb4-254" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Listener com barra de progresso e estat√≠sticas&quot;&quot;&quot;</span></span>
<span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a>    processed <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a>    successes <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a>    skips <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a>    failures <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> listener_stop_flag.is_set():</span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a>            obj <span class="op">=</span> msg_queue.get(timeout<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a>            typ, text <span class="op">=</span> obj</span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a>            processed <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> typ <span class="op">==</span> <span class="st">&quot;ok&quot;</span>:</span>
<span id="cb4-270"><a href="#cb4-270" aria-hidden="true" tabindex="-1"></a>                successes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-271"><a href="#cb4-271" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-272"><a href="#cb4-272" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;skip&quot;</span>:</span>
<span id="cb4-273"><a href="#cb4-273" aria-hidden="true" tabindex="-1"></a>                skips <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-274"><a href="#cb4-274" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚è≠Ô∏è </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-275"><a href="#cb4-275" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;fail&quot;</span>:</span>
<span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚ùå </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;error&quot;</span>:</span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üö´ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;retry&quot;</span>:</span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üîÑ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Mostrar progresso a cada 10 arquivos ou no final</span></span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> processed <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> processed <span class="op">==</span> total_files:</span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a>                elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> successes <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a>                    rate <span class="op">=</span> successes <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f&quot;üìä Progresso: </span><span class="sc">{</span>successes<span class="op">+</span>skips<span class="op">+</span>failures<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_files<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;‚úÖ</span><span class="sc">{</span>successes<span class="sc">}</span><span class="ss"> ‚è≠Ô∏è</span><span class="sc">{</span>skips<span class="sc">}</span><span class="ss"> ‚ùå</span><span class="sc">{</span>failures<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;</span><span class="sc">{</span>rate<span class="sc">:.1f}</span><span class="ss"> PDFs/min&quot;</span>)</span>
<span id="cb4-292"><a href="#cb4-292" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb4-293"><a href="#cb4-293" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb4-294"><a href="#cb4-294" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb4-295"><a href="#cb4-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-296"><a href="#cb4-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-297"><a href="#cb4-297" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-298"><a href="#cb4-298" aria-hidden="true" tabindex="-1"></a><span class="co"># Convers√£o principal - VERS√ÉO ALTAMENTE OTIMIZADA</span></span>
<span id="cb4-299"><a href="#cb4-299" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-300"><a href="#cb4-300" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_pdfs_optimized(source_dir, output_dir, workers, batch_size, headless, timeout,</span>
<span id="cb4-301"><a href="#cb4-301" aria-hidden="true" tabindex="-1"></a>                           force_overwrite, dry_run, single_file<span class="op">=</span><span class="va">None</span>, retry_count<span class="op">=</span><span class="dv">2</span>, benchmark<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb4-302"><a href="#cb4-302" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Fun√ß√£o principal OTIMIZADA com interrup√ß√£o robusta e performance m√°xima&quot;&quot;&quot;</span></span>
<span id="cb4-303"><a href="#cb4-303" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop</span>
<span id="cb4-304"><a href="#cb4-304" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-305"><a href="#cb4-305" aria-hidden="true" tabindex="-1"></a>    src <span class="op">=</span> Path(source_dir)</span>
<span id="cb4-306"><a href="#cb4-306" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> Path(output_dir)</span>
<span id="cb4-307"><a href="#cb4-307" aria-hidden="true" tabindex="-1"></a>    out.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb4-308"><a href="#cb4-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-309"><a href="#cb4-309" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> single_file:</span>
<span id="cb4-310"><a href="#cb4-310" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [<span class="bu">str</span>(src <span class="op">/</span> single_file)]</span>
<span id="cb4-311"><a href="#cb4-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> Path(html_files[<span class="dv">0</span>]).exists():</span>
<span id="cb4-312"><a href="#cb4-312" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Arquivo n√£o encontrado: </span><span class="sc">{</span>single_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-313"><a href="#cb4-313" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb4-314"><a href="#cb4-314" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-315"><a href="#cb4-315" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> <span class="bu">sorted</span>([<span class="bu">str</span>(p) <span class="cf">for</span> p <span class="kw">in</span> src.glob(<span class="st">&quot;*.html&quot;</span>)])</span>
<span id="cb4-316"><a href="#cb4-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-317"><a href="#cb4-317" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb4-318"><a href="#cb4-318" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Nenhum arquivo HTML encontrado.&quot;</span>)</span>
<span id="cb4-319"><a href="#cb4-319" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb4-320"><a href="#cb4-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-321"><a href="#cb4-321" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üéØ Encontrados </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos HTML&quot;</span>)</span>
<span id="cb4-322"><a href="#cb4-322" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>workers<span class="sc">}</span><span class="ss"> | Batch: </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb4-323"><a href="#cb4-323" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss"> tentativas por arquivo&quot;</span>)</span>
<span id="cb4-324"><a href="#cb4-324" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;‚èπÔ∏è  Pressione Ctrl+C para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb4-325"><a href="#cb4-325" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-326"><a href="#cb4-326" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MOSTRAR M√âTODO DE CONVERS√ÉO UTILIZADO</span></span>
<span id="cb4-327"><a href="#cb4-327" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîÑ M√âTODO DE CONVERS√ÉO:&quot;</span>)</span>
<span id="cb4-328"><a href="#cb4-328" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Playwright + Chromium headless&quot;</span>)</span>
<span id="cb4-329"><a href="#cb4-329" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ 1 inst√¢ncia do browser por processo worker&quot;</span>)</span>
<span id="cb4-330"><a href="#cb4-330" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Contexto separado por arquivo HTML&quot;</span>)</span>
<span id="cb4-331"><a href="#cb4-331" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Paralelismo seguro com multiprocessing.Pool&quot;</span>)</span>
<span id="cb4-332"><a href="#cb4-332" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Sistema de retry com m√∫ltiplas tentativas&quot;</span>)</span>
<span id="cb4-333"><a href="#cb4-333" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Timeouts configur√°veis por p√°gina&quot;</span>)</span>
<span id="cb4-334"><a href="#cb4-334" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Interrup√ß√£o imediata via Ctrl+C</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb4-335"><a href="#cb4-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-336"><a href="#cb4-336" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dry_run:</span>
<span id="cb4-337"><a href="#cb4-337" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ MODO SIMULA√á√ÉO - Nenhum arquivo ser√° criado&quot;</span>)</span>
<span id="cb4-338"><a href="#cb4-338" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> html_files[:<span class="dv">5</span>]:</span>
<span id="cb4-339"><a href="#cb4-339" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   üìÑ </span><span class="sc">{</span>Path(f)<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-340"><a href="#cb4-340" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(html_files) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb4-341"><a href="#cb4-341" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(html_files) <span class="op">-</span> <span class="dv">5</span><span class="sc">}</span><span class="ss"> arquivos&quot;</span>)</span>
<span id="cb4-342"><a href="#cb4-342" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb4-343"><a href="#cb4-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-344"><a href="#cb4-344" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb4-345"><a href="#cb4-345" aria-hidden="true" tabindex="-1"></a>        original_count <span class="op">=</span> <span class="bu">len</span>(html_files)</span>
<span id="cb4-346"><a href="#cb4-346" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> html_files <span class="cf">if</span> <span class="kw">not</span> (out <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>Path(f)<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span>).exists()]</span>
<span id="cb4-347"><a href="#cb4-347" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üÜï </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos novos para processar (de </span><span class="sc">{</span>original_count<span class="sc">}</span><span class="ss"> total)&quot;</span>)</span>
<span id="cb4-348"><a href="#cb4-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-349"><a href="#cb4-349" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb4-350"><a href="#cb4-350" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Nenhum arquivo novo para processar&quot;</span>)</span>
<span id="cb4-351"><a href="#cb4-351" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb4-352"><a href="#cb4-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-353"><a href="#cb4-353" aria-hidden="true" tabindex="-1"></a>    batches <span class="op">=</span> chunkify(html_files, batch_size)</span>
<span id="cb4-354"><a href="#cb4-354" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üì¶ </span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> batches preparados&quot;</span>)</span>
<span id="cb4-355"><a href="#cb4-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-356"><a href="#cb4-356" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sistema de comunica√ß√£o OTIMIZADO</span></span>
<span id="cb4-357"><a href="#cb4-357" aria-hidden="true" tabindex="-1"></a>    manager <span class="op">=</span> multiprocessing.Manager()</span>
<span id="cb4-358"><a href="#cb4-358" aria-hidden="true" tabindex="-1"></a>    stop_event <span class="op">=</span> manager.Event()</span>
<span id="cb4-359"><a href="#cb4-359" aria-hidden="true" tabindex="-1"></a>    msg_queue <span class="op">=</span> manager.Queue()</span>
<span id="cb4-360"><a href="#cb4-360" aria-hidden="true" tabindex="-1"></a>    listener_stop_flag <span class="op">=</span> threading.Event()</span>
<span id="cb4-361"><a href="#cb4-361" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-362"><a href="#cb4-362" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Listener COM ESTAT√çSTICAS</span></span>
<span id="cb4-363"><a href="#cb4-363" aria-hidden="true" tabindex="-1"></a>    listener_thread <span class="op">=</span> threading.Thread(</span>
<span id="cb4-364"><a href="#cb4-364" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>queue_listener_optimized, </span>
<span id="cb4-365"><a href="#cb4-365" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(msg_queue, listener_stop_flag, <span class="bu">len</span>(html_files)), </span>
<span id="cb4-366"><a href="#cb4-366" aria-hidden="true" tabindex="-1"></a>        daemon<span class="op">=</span><span class="va">True</span></span>
<span id="cb4-367"><a href="#cb4-367" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-368"><a href="#cb4-368" aria-hidden="true" tabindex="-1"></a>    listener_thread.start()</span>
<span id="cb4-369"><a href="#cb4-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-370"><a href="#cb4-370" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparar argumentos</span></span>
<span id="cb4-371"><a href="#cb4-371" aria-hidden="true" tabindex="-1"></a>    args_list <span class="op">=</span> [</span>
<span id="cb4-372"><a href="#cb4-372" aria-hidden="true" tabindex="-1"></a>        (batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, stop_event, msg_queue) </span>
<span id="cb4-373"><a href="#cb4-373" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> batches</span>
<span id="cb4-374"><a href="#cb4-374" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb4-375"><a href="#cb4-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-376"><a href="#cb4-376" aria-hidden="true" tabindex="-1"></a>    success_count, failed <span class="op">=</span> <span class="dv">0</span>, []</span>
<span id="cb4-377"><a href="#cb4-377" aria-hidden="true" tabindex="-1"></a>    pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-378"><a href="#cb4-378" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb4-379"><a href="#cb4-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-380"><a href="#cb4-380" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-381"><a href="#cb4-381" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Criar pool com n√∫mero OTIMIZADO de workers</span></span>
<span id="cb4-382"><a href="#cb4-382" aria-hidden="true" tabindex="-1"></a>        pool <span class="op">=</span> multiprocessing.Pool(processes<span class="op">=</span>workers)</span>
<span id="cb4-383"><a href="#cb4-383" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-384"><a href="#cb4-384" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üîÑ Iniciando convers√£o OTIMIZADA...&quot;</span>)</span>
<span id="cb4-385"><a href="#cb4-385" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-386"><a href="#cb4-386" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Processar batches - com verifica√ß√£o CONSTANTE de parada</span></span>
<span id="cb4-387"><a href="#cb4-387" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, result <span class="kw">in</span> <span class="bu">enumerate</span>(pool.imap_unordered(worker_wrapper_optimized, args_list)):</span>
<span id="cb4-388"><a href="#cb4-388" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> stop_event.is_set():</span>
<span id="cb4-389"><a href="#cb4-389" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üõë Parada de emerg√™ncia ativada!&quot;</span>)</span>
<span id="cb4-390"><a href="#cb4-390" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb4-391"><a href="#cb4-391" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb4-392"><a href="#cb4-392" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Relat√≥rio de progresso por batch</span></span>
<span id="cb4-393"><a href="#cb4-393" aria-hidden="true" tabindex="-1"></a>            batch_progress <span class="op">=</span> <span class="ss">f&quot;üì¶ Batch </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> processado&quot;</span></span>
<span id="cb4-394"><a href="#cb4-394" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(result) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb4-395"><a href="#cb4-395" aria-hidden="true" tabindex="-1"></a>                batch_success <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> _, success, _ <span class="kw">in</span> result <span class="cf">if</span> success)</span>
<span id="cb4-396"><a href="#cb4-396" aria-hidden="true" tabindex="-1"></a>                batch_progress <span class="op">+=</span> <span class="ss">f&quot; - ‚úÖ </span><span class="sc">{</span>batch_success<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(result)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb4-397"><a href="#cb4-397" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(batch_progress)</span>
<span id="cb4-398"><a href="#cb4-398" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb4-399"><a href="#cb4-399" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_file, success, msg <span class="kw">in</span> result:</span>
<span id="cb4-400"><a href="#cb4-400" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> success:</span>
<span id="cb4-401"><a href="#cb4-401" aria-hidden="true" tabindex="-1"></a>                    success_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb4-402"><a href="#cb4-402" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb4-403"><a href="#cb4-403" aria-hidden="true" tabindex="-1"></a>                    failed.append((Path(html_file).name, msg))</span>
<span id="cb4-404"><a href="#cb4-404" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb4-405"><a href="#cb4-405" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verificar parada entre batches</span></span>
<span id="cb4-406"><a href="#cb4-406" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> stop_event.is_set():</span>
<span id="cb4-407"><a href="#cb4-407" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb4-408"><a href="#cb4-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-409"><a href="#cb4-409" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb4-410"><a href="#cb4-410" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO RECEBIDA !!!&quot;</span>)</span>
<span id="cb4-411"><a href="#cb4-411" aria-hidden="true" tabindex="-1"></a>        _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-412"><a href="#cb4-412" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb4-413"><a href="#cb4-413" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-414"><a href="#cb4-414" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Erro no pool principal: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-415"><a href="#cb4-415" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb4-416"><a href="#cb4-416" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb4-417"><a href="#cb4-417" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ LIMPEZA FINAL...&quot;</span>)</span>
<span id="cb4-418"><a href="#cb4-418" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-419"><a href="#cb4-419" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parar listener</span></span>
<span id="cb4-420"><a href="#cb4-420" aria-hidden="true" tabindex="-1"></a>        listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb4-421"><a href="#cb4-421" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb4-422"><a href="#cb4-422" aria-hidden="true" tabindex="-1"></a>            msg_queue.put(<span class="va">None</span>)</span>
<span id="cb4-423"><a href="#cb4-423" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb4-424"><a href="#cb4-424" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb4-425"><a href="#cb4-425" aria-hidden="true" tabindex="-1"></a>        listener_thread.join(timeout<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb4-426"><a href="#cb4-426" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-427"><a href="#cb4-427" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Terminar pool AGressivamente</span></span>
<span id="cb4-428"><a href="#cb4-428" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pool:</span>
<span id="cb4-429"><a href="#cb4-429" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb4-430"><a href="#cb4-430" aria-hidden="true" tabindex="-1"></a>                pool.terminate()</span>
<span id="cb4-431"><a href="#cb4-431" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb4-432"><a href="#cb4-432" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb4-433"><a href="#cb4-433" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb4-434"><a href="#cb4-434" aria-hidden="true" tabindex="-1"></a>                pool.join(timeout<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-435"><a href="#cb4-435" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb4-436"><a href="#cb4-436" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb4-437"><a href="#cb4-437" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-438"><a href="#cb4-438" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final agressiva</span></span>
<span id="cb4-439"><a href="#cb4-439" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb4-440"><a href="#cb4-440" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-441"><a href="#cb4-441" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pequena pausa para garantir que tudo foi limpo</span></span>
<span id="cb4-442"><a href="#cb4-442" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb4-443"><a href="#cb4-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-444"><a href="#cb4-444" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Relat√≥rio DETALHADO</span></span>
<span id="cb4-445"><a href="#cb4-445" aria-hidden="true" tabindex="-1"></a>    elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb4-446"><a href="#cb4-446" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;=&quot;</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb4-447"><a href="#cb4-447" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üìä RELAT√ìRIO FINAL OTIMIZADO:&quot;</span>)</span>
<span id="cb4-448"><a href="#cb4-448" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot; ‚úÖ Sucessos: </span><span class="sc">{</span>success_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-449"><a href="#cb4-449" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot; ‚ùå Falhas: </span><span class="sc">{</span><span class="bu">len</span>(failed)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-450"><a href="#cb4-450" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-451"><a href="#cb4-451" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> failed:</span>
<span id="cb4-452"><a href="#cb4-452" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üìã Arquivos com falha (primeiros 10):&quot;</span>)</span>
<span id="cb4-453"><a href="#cb4-453" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> fname, error <span class="kw">in</span> failed[:<span class="dv">10</span>]:</span>
<span id="cb4-454"><a href="#cb4-454" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   ‚Ä£ </span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-455"><a href="#cb4-455" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(failed) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb4-456"><a href="#cb4-456" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(failed) <span class="op">-</span> <span class="dv">10</span><span class="sc">}</span><span class="ss"> falhas&quot;</span>)</span>
<span id="cb4-457"><a href="#cb4-457" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-458"><a href="#cb4-458" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> benchmark <span class="kw">and</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb4-459"><a href="#cb4-459" aria-hidden="true" tabindex="-1"></a>        rate_total <span class="op">=</span> <span class="bu">len</span>(html_files) <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-460"><a href="#cb4-460" aria-hidden="true" tabindex="-1"></a>        rate_success <span class="op">=</span> success_count <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-461"><a href="#cb4-461" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚è±Ô∏è  Tempo total: </span><span class="sc">{</span>elapsed<span class="sc">:.1f}</span><span class="ss">s&quot;</span>)</span>
<span id="cb4-462"><a href="#cb4-462" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_total<span class="sc">:.1f}</span><span class="ss"> PDFs/min (total)&quot;</span>)</span>
<span id="cb4-463"><a href="#cb4-463" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_success<span class="sc">:.1f}</span><span class="ss"> PDFs/min (sucessos)&quot;</span>)</span>
<span id="cb4-464"><a href="#cb4-464" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-465"><a href="#cb4-465" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> success_count <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb4-466"><a href="#cb4-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-467"><a href="#cb4-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-468"><a href="#cb4-468" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-469"><a href="#cb4-469" aria-hidden="true" tabindex="-1"></a><span class="co"># CLI OTIMIZADA</span></span>
<span id="cb4-470"><a href="#cb4-470" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-471"><a href="#cb4-471" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args():</span>
<span id="cb4-472"><a href="#cb4-472" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(</span>
<span id="cb4-473"><a href="#cb4-473" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">&quot;Convers√£o HTML ‚Üí PDF ALTAMENTE OTIMIZADA com INTERRUP√á√ÉO IMEDIATA&quot;</span></span>
<span id="cb4-474"><a href="#cb4-474" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-475"><a href="#cb4-475" aria-hidden="true" tabindex="-1"></a>    group <span class="op">=</span> parser.add_mutually_exclusive_group()</span>
<span id="cb4-476"><a href="#cb4-476" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--force&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Sobrescreve PDFs j√° existentes&quot;</span>)</span>
<span id="cb4-477"><a href="#cb4-477" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--only-new&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, default<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Apenas novos (padr√£o)&quot;</span>)</span>
<span id="cb4-478"><a href="#cb4-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-479"><a href="#cb4-479" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--dry-run&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Simula sem criar arquivos&quot;</span>)</span>
<span id="cb4-480"><a href="#cb4-480" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--source&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_html&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta com arquivos .html&quot;</span>)</span>
<span id="cb4-481"><a href="#cb4-481" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--output&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_pdfs&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta de sa√≠da para PDFs&quot;</span>)</span>
<span id="cb4-482"><a href="#cb4-482" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">3</span>, </span>
<span id="cb4-483"><a href="#cb4-483" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos (padr√£o: 3 otimizado para 4 n√∫cleos)&quot;</span>)</span>
<span id="cb4-484"><a href="#cb4-484" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--batch-size&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">4</span>, </span>
<span id="cb4-485"><a href="#cb4-485" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Arquivos por batch (padr√£o: 4 para balanceamento)&quot;</span>)</span>
<span id="cb4-486"><a href="#cb4-486" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--no-headless&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra navegador (debug)&quot;</span>)</span>
<span id="cb4-487"><a href="#cb4-487" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--single-file&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Converte apenas um arquivo HTML espec√≠fico&quot;</span>)</span>
<span id="cb4-488"><a href="#cb4-488" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--timeout&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">45</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Timeout por p√°gina (segundos)&quot;</span>)</span>
<span id="cb4-489"><a href="#cb4-489" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--retry-count&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Tentativas por arquivo (padr√£o: 2)&quot;</span>)</span>
<span id="cb4-490"><a href="#cb4-490" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--benchmark&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra tempo total e PDFs/minuto&quot;</span>)</span>
<span id="cb4-491"><a href="#cb4-491" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parser.parse_args()</span>
<span id="cb4-492"><a href="#cb4-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-493"><a href="#cb4-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-494"><a href="#cb4-494" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-495"><a href="#cb4-495" aria-hidden="true" tabindex="-1"></a><span class="co"># Main OTIMIZADA</span></span>
<span id="cb4-496"><a href="#cb4-496" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb4-497"><a href="#cb4-497" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb4-498"><a href="#cb4-498" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configurar handler de EMERG√äNCIA para Ctrl+C</span></span>
<span id="cb4-499"><a href="#cb4-499" aria-hidden="true" tabindex="-1"></a>    signal.signal(signal.SIGINT, emergency_stop_handler)</span>
<span id="cb4-500"><a href="#cb4-500" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-501"><a href="#cb4-501" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args()</span>
<span id="cb4-502"><a href="#cb4-502" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-503"><a href="#cb4-503" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üöÄ PDF GENERATOR - VERS√ÉO ALTAMENTE OTIMIZADA&quot;</span>)</span>
<span id="cb4-504"><a href="#cb4-504" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;!!! EMERGENCY STOP ENABLED - Ctrl+C para PARAR TUDO !!!&quot;</span>)</span>
<span id="cb4-505"><a href="#cb4-505" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;=&quot;</span> <span class="op">*</span> <span class="dv">65</span>)</span>
<span id="cb4-506"><a href="#cb4-506" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>args<span class="sc">.</span>workers<span class="sc">}</span><span class="ss"> (OTIMIZADO) | Batch: </span><span class="sc">{</span>args<span class="sc">.</span>batch_size<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-507"><a href="#cb4-507" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>args<span class="sc">.</span>retry_count<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>args<span class="sc">.</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb4-508"><a href="#cb4-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-509"><a href="#cb4-509" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza inicial agressiva</span></span>
<span id="cb4-510"><a href="#cb4-510" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb4-511"><a href="#cb4-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-512"><a href="#cb4-512" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verifica√ß√µes</span></span>
<span id="cb4-513"><a href="#cb4-513" aria-hidden="true" tabindex="-1"></a>    source_dir <span class="op">=</span> Path(args.source)</span>
<span id="cb4-514"><a href="#cb4-514" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> source_dir.exists():</span>
<span id="cb4-515"><a href="#cb4-515" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Pasta n√£o encontrada: </span><span class="sc">{</span>source_dir<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-516"><a href="#cb4-516" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb4-517"><a href="#cb4-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-518"><a href="#cb4-518" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_playwright_available(headless_test<span class="op">=</span><span class="kw">not</span> args.no_headless):</span>
<span id="cb4-519"><a href="#cb4-519" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Playwright n√£o dispon√≠vel.&quot;</span>)</span>
<span id="cb4-520"><a href="#cb4-520" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   pip install playwright psutil&quot;</span>)</span>
<span id="cb4-521"><a href="#cb4-521" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   playwright install chromium&quot;</span>)</span>
<span id="cb4-522"><a href="#cb4-522" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb4-523"><a href="#cb4-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-524"><a href="#cb4-524" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Executar vers√£o OTIMIZADA</span></span>
<span id="cb4-525"><a href="#cb4-525" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> generate_pdfs_optimized(</span>
<span id="cb4-526"><a href="#cb4-526" aria-hidden="true" tabindex="-1"></a>        source_dir<span class="op">=</span><span class="bu">str</span>(args.source),</span>
<span id="cb4-527"><a href="#cb4-527" aria-hidden="true" tabindex="-1"></a>        output_dir<span class="op">=</span><span class="bu">str</span>(args.output),</span>
<span id="cb4-528"><a href="#cb4-528" aria-hidden="true" tabindex="-1"></a>        workers<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">min</span>(args.workers, <span class="dv">6</span>)),  <span class="co"># Limite m√°ximo de 6 workers</span></span>
<span id="cb4-529"><a href="#cb4-529" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.batch_size),</span>
<span id="cb4-530"><a href="#cb4-530" aria-hidden="true" tabindex="-1"></a>        headless<span class="op">=</span><span class="kw">not</span> args.no_headless,</span>
<span id="cb4-531"><a href="#cb4-531" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span><span class="bu">max</span>(<span class="dv">15</span>, args.timeout),</span>
<span id="cb4-532"><a href="#cb4-532" aria-hidden="true" tabindex="-1"></a>        force_overwrite<span class="op">=</span>args.force,</span>
<span id="cb4-533"><a href="#cb4-533" aria-hidden="true" tabindex="-1"></a>        dry_run<span class="op">=</span>args.dry_run,</span>
<span id="cb4-534"><a href="#cb4-534" aria-hidden="true" tabindex="-1"></a>        single_file<span class="op">=</span>args.single_file,</span>
<span id="cb4-535"><a href="#cb4-535" aria-hidden="true" tabindex="-1"></a>        retry_count<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.retry_count),</span>
<span id="cb4-536"><a href="#cb4-536" aria-hidden="true" tabindex="-1"></a>        benchmark<span class="op">=</span>args.benchmark</span>
<span id="cb4-537"><a href="#cb4-537" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-538"><a href="#cb4-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-539"><a href="#cb4-539" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resultado final</span></span>
<span id="cb4-540"><a href="#cb4-540" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb4-541"><a href="#cb4-541" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ SIMULA√á√ÉO CONCLU√çDA&quot;</span>)</span>
<span id="cb4-542"><a href="#cb4-542" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb4-543"><a href="#cb4-543" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> success:</span>
<span id="cb4-544"><a href="#cb4-544" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üéâ CONVERS√ÉO CONCLU√çDA COM SUCESSO!&quot;</span>)</span>
<span id="cb4-545"><a href="#cb4-545" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb4-546"><a href="#cb4-546" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-547"><a href="#cb4-547" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è CONVERS√ÉO INTERROMPIDA OU COM FALHAS&quot;</span>)</span>
<span id="cb4-548"><a href="#cb4-548" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb4-549"><a href="#cb4-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-550"><a href="#cb4-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-551"><a href="#cb4-551" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb4-552"><a href="#cb4-552" aria-hidden="true" tabindex="-1"></a>    multiprocessing.freeze_support()</span>
<span id="cb4-553"><a href="#cb4-553" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-554"><a href="#cb4-554" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handler global para garantir que Ctrl+C sempre funcione</span></span>
<span id="cb4-555"><a href="#cb4-555" aria-hidden="true" tabindex="-1"></a>    original_sigint <span class="op">=</span> signal.getsignal(signal.SIGINT)</span>
<span id="cb4-556"><a href="#cb4-556" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-557"><a href="#cb4-557" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-558"><a href="#cb4-558" aria-hidden="true" tabindex="-1"></a>        sys.exit(main())</span>
<span id="cb4-559"><a href="#cb4-559" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb4-560"><a href="#cb4-560" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO GLOBAL !!!&quot;</span>)</span>
<span id="cb4-561"><a href="#cb4-561" aria-hidden="true" tabindex="-1"></a>        emergency_stop_handler(<span class="va">None</span>, <span class="va">None</span>)</span>
<span id="cb4-562"><a href="#cb4-562" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb4-563"><a href="#cb4-563" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üí• ERRO CR√çTICO: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb4-564"><a href="#cb4-564" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb4-565"><a href="#cb4-565" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb4-566"><a href="#cb4-566" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Restaurar handler original</span></span>
<span id="cb4-567"><a href="#cb4-567" aria-hidden="true" tabindex="-1"></a>        signal.signal(signal.SIGINT, original_sigint)</span></code></pre></div>
<h2 data-number="1.4" id="adi√ß√£o-principal-realizada"><span class="header-section-number">1.4</span> Adi√ß√£o Principal
Realizada:</h2>
<p>Adicionei uma se√ß√£o <strong>‚ÄúM√âTODO DE CONVERS√ÉO‚Äù</strong> que √©
exibida quando o processo de convers√£o √© iniciado:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MOSTRAR M√âTODO DE CONVERS√ÉO UTILIZADO</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîÑ M√âTODO DE CONVERS√ÉO:&quot;</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Playwright + Chromium headless&quot;</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ 1 inst√¢ncia do browser por processo worker&quot;</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Contexto separado por arquivo HTML&quot;</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Paralelismo seguro com multiprocessing.Pool&quot;</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Sistema de retry com m√∫ltiplas tentativas&quot;</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Timeouts configur√°veis por p√°gina&quot;</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Interrup√ß√£o imediata via Ctrl+C</span><span class="ch">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<p>Esta adi√ß√£o fornece transpar√™ncia total sobre a tecnologia e
estrat√©gia utilizada para a convers√£o, permitindo que o usu√°rio entenda
exatamente como o processo funciona.</p>
<h2 data-number="1.5" id="caracter√≠sticas-do-m√©todo-explicado"><span class="header-section-number">1.5</span> Caracter√≠sticas do M√©todo
Explicado:</h2>
<ol type="1">
<li><strong>Playwright + Chromium headless</strong> - Tecnologia
base</li>
<li><strong>1 inst√¢ncia do browser por processo worker</strong> -
Otimiza√ß√£o de recursos</li>
<li><strong>Contexto separado por arquivo HTML</strong> - Isolamento e
seguran√ßa</li>
<li><strong>Paralelismo seguro com multiprocessing.Pool</strong> -
Escalabilidade</li>
<li><strong>Sistema de retry com m√∫ltiplas tentativas</strong> -
Robustez</li>
<li><strong>Timeouts configur√°veis por p√°gina</strong> - Controle de
performance</li>
<li><strong>Interrup√ß√£o imediata via Ctrl+C</strong> -
Responsividade</li>
</ol>
<p>O arquivo est√° completo e pronto para uso!</p>
<hr />
<h3 data-number="1.5.1" id="utilizador-2025-11-07-053258-deepseek-reasoner"><span class="header-section-number">1.5.1</span> üë§ Utilizador <em>(2025-11-07
05:32:58)</em> <em>[deepseek-reasoner]</em></h3>
<p>Tudo certo. Mas por vezes ainda existe problema com Ctrl+C e estou a
usar ‚Äìbatch-size 3 e ‚Äìworkers 2, por isso gostaria que fosse esse o
default. E se possivel melhorar o a Interrup√ß√£o imediata via Ctrl+C</p>
<hr />
<h3 data-number="1.5.2" id="deepseek-2025-11-07-053259-deepseek-reasoner"><span class="header-section-number">1.5.2</span> ü§ñ DeepSeek <em>(2025-11-07
05:32:59)</em> <em>[deepseek-reasoner]</em></h3>
<p>Vamos ajustar os valores padr√£o para <code>--batch-size 3</code> e
<code>--workers 2</code> e melhorar a interrup√ß√£o via Ctrl+C.</p>
<p>Al√©m disso, vamos revisar o tratamento de sinal para garantir que a
interrup√ß√£o seja a mais r√°pida e confi√°vel poss√≠vel.</p>
<p>Modifica√ß√µes: 1. Alterar o default de <code>--workers</code> para 2 e
<code>--batch-size</code> para 3. 2. Revisar o mecanismo de interrup√ß√£o
para garantir que o sinal seja capturado e propagado mais
rapidamente.</p>
<p>Vamos tamb√©m adicionar uma verifica√ß√£o mais frequente da flag de
parada dentro dos loops dos workers.</p>
<p>Obs: O c√≥digo atual j√° usa <code>stop_event</code> e
<code>_should_stop</code> para controlar a parada. Vamos garantir que a
verifica√ß√£o dessas flags seja feita em pontos estrat√©gicos.</p>
<p>Vamos modificar a fun√ß√£o <code>worker_process_batch_optimized</code>
para verificar a parada tamb√©m durante o processamento de um batch, n√£o
apenas entre arquivos.</p>
<p>Al√©m disso, no loop principal de processamento de batches, vamos
verificar a flag de parada com mais frequ√™ncia.</p>
<p>Vamos tamb√©m ajustar o handler de sinal para definir
<code>_should_stop</code> e <code>stop_event</code> imediatamente.</p>
<p>Vamos ao c√≥digo: Aqui est√° o arquivo completo com os defaults
ajustados para <code>--batch-size 3</code> e <code>--workers 2</code>, e
com uma melhoria significativa no sistema de interrup√ß√£o via Ctrl+C:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">comb_pdf_direct6_html_based_optimized_live_benchmark.py</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">Vers√£o ALTAMENTE OTIMIZADA com:</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">- Reutiliza√ß√£o de inst√¢ncia do Chromium por processo</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">- Paralelismo seguro via multiprocessing.Pool</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">- Retry por arquivo (2 tentativas padr√£o)</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">- Cancelamento IMEDIATO E CONFI√ÅVEL via Ctrl+C</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">- Workers otimizados (2 padr√£o) e batch-size 3</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">- Browser management aprimorado</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> signal</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psutil</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Optional</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright, <span class="pp">TimeoutError</span> <span class="im">as</span> PlaywrightTimeoutError</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Vari√°veis globais para controle de interrup√ß√£o MELHORADO</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>_active_processes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>_should_stop <span class="op">=</span> <span class="va">False</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>_stop_event <span class="op">=</span> <span class="va">None</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>_pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Fun√ß√µes utilit√°rias OTIMIZADAS</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kill_orphaned_chromium():</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Encerra processos Chromium √≥rf√£os de forma agressiva.&quot;&quot;&quot;</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Limpando processos Chromium √≥rf√£os...&quot;</span>)</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>            subprocess.run(</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chrome.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;msedge.exe&quot;</span>],</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>                stdout<span class="op">=</span>subprocess.DEVNULL, </span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>                stderr<span class="op">=</span>subprocess.DEVNULL,</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>                timeout<span class="op">=</span><span class="dv">10</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chrome&quot;</span>], </span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;playwright&quot;</span>], </span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza adicional para garantir</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="fl">0.5</span>)</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>], </span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è Aviso na limpeza: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunkify(seq: List[<span class="bu">str</span>], size: <span class="bu">int</span>) <span class="op">-&gt;</span> List[List[<span class="bu">str</span>]]:</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [seq[i:i <span class="op">+</span> size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(seq), size)]</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_playwright_available(headless_test: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o Playwright + Chromium est√£o instalados.&quot;&quot;&quot;</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless_test,</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> emergency_stop_handler(signum, frame):</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handler de emerg√™ncia para Ctrl+C - PARA TUDO IMEDIATAMENTE&quot;&quot;&quot;</span></span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop, _stop_event, _pool</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">!!! EMERGENCY STOP SOLICITADO !!!&quot;</span>)</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üö® INTERRUP√á√ÉO DE EMERG√äNCIA - Terminando processos...&quot;</span>)</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>    _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sinalizar parada para todos os processos</span></span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _stop_event:</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parar pool AGressivamente</span></span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _pool:</span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;üõë Terminando pool de workers...&quot;</span>)</span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>            _pool.terminate()</span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>            _pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Terminar processos filhos de forma agressiva</span></span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>    current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>        parent <span class="op">=</span> psutil.Process(current_pid)</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>        children <span class="op">=</span> parent.children(recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üî™ Terminando </span><span class="sc">{</span><span class="bu">len</span>(children)<span class="sc">}</span><span class="ss"> processos filhos...&quot;</span>)</span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> child <span class="kw">in</span> children:</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>                child_pid <span class="op">=</span> child.pid</span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> child_pid <span class="op">!=</span> current_pid <span class="kw">and</span> child_pid <span class="kw">in</span> _active_processes:</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>                    child.kill()</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>                    _active_processes.discard(child_pid)</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza final de processos √≥rf√£os</span></span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üíÄ TODOS OS PROCESSOS FORAM TERMINADOS&quot;</span>)</span>
<span id="cb6-143"><a href="#cb6-143" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è PROGRAMA INTERROMPIDO PELO UTILIZADOR&quot;</span>)</span>
<span id="cb6-144"><a href="#cb6-144" aria-hidden="true" tabindex="-1"></a>    os._exit(<span class="dv">1</span>)  <span class="co"># Sa√≠da de emerg√™ncia</span></span>
<span id="cb6-145"><a href="#cb6-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-146"><a href="#cb6-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-147"><a href="#cb6-147" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-148"><a href="#cb6-148" aria-hidden="true" tabindex="-1"></a><span class="co"># Worker de processamento OTIMIZADO - REUTILIZA BROWSER POR PROCESSO</span></span>
<span id="cb6-149"><a href="#cb6-149" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-150"><a href="#cb6-150" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_process_batch_optimized(batch_files, pdf_dir, timeout, headless, force_overwrite, retry_count, stop_event, msg_queue):</span>
<span id="cb6-151"><a href="#cb6-151" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Worker OTIMIZADO que reutiliza uma inst√¢ncia do Chromium por processo&quot;&quot;&quot;</span></span>
<span id="cb6-152"><a href="#cb6-152" aria-hidden="true" tabindex="-1"></a>    my_pid <span class="op">=</span> os.getpid()</span>
<span id="cb6-153"><a href="#cb6-153" aria-hidden="true" tabindex="-1"></a>    _active_processes.add(my_pid)</span>
<span id="cb6-154"><a href="#cb6-154" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-155"><a href="#cb6-155" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb6-156"><a href="#cb6-156" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb6-157"><a href="#cb6-157" aria-hidden="true" tabindex="-1"></a>        out_dir <span class="op">=</span> Path(pdf_dir)</span>
<span id="cb6-158"><a href="#cb6-158" aria-hidden="true" tabindex="-1"></a>        out_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-159"><a href="#cb6-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-160"><a href="#cb6-160" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verificar parada ANTES de iniciar o browser</span></span>
<span id="cb6-161"><a href="#cb6-161" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb6-162"><a href="#cb6-162" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb6-163"><a href="#cb6-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-164"><a href="#cb6-164" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb6-165"><a href="#cb6-165" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Configura√ß√£o OTIMIZADA do browser - UMA INST√ÇNCIA POR PROCESSO</span></span>
<span id="cb6-166"><a href="#cb6-166" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb6-167"><a href="#cb6-167" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless,</span>
<span id="cb6-168"><a href="#cb6-168" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb6-169"><a href="#cb6-169" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb6-170"><a href="#cb6-170" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb6-171"><a href="#cb6-171" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb6-172"><a href="#cb6-172" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb6-173"><a href="#cb6-173" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span>,</span>
<span id="cb6-174"><a href="#cb6-174" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-first-run&#39;</span>,</span>
<span id="cb6-175"><a href="#cb6-175" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-default-browser-check&#39;</span>,</span>
<span id="cb6-176"><a href="#cb6-176" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-default-apps&#39;</span>,</span>
<span id="cb6-177"><a href="#cb6-177" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-translate&#39;</span>,</span>
<span id="cb6-178"><a href="#cb6-178" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-extensions&#39;</span></span>
<span id="cb6-179"><a href="#cb6-179" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb6-180"><a href="#cb6-180" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-181"><a href="#cb6-181" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-182"><a href="#cb6-182" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_path_str <span class="kw">in</span> batch_files:</span>
<span id="cb6-183"><a href="#cb6-183" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb6-184"><a href="#cb6-184" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb6-185"><a href="#cb6-185" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb6-186"><a href="#cb6-186" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb6-187"><a href="#cb6-187" aria-hidden="true" tabindex="-1"></a>                html_path <span class="op">=</span> Path(html_path_str)</span>
<span id="cb6-188"><a href="#cb6-188" aria-hidden="true" tabindex="-1"></a>                pdf_path <span class="op">=</span> out_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb6-189"><a href="#cb6-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-190"><a href="#cb6-190" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> pdf_path.exists() <span class="kw">and</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb6-191"><a href="#cb6-191" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;J√° existe&quot;</span>))</span>
<span id="cb6-192"><a href="#cb6-192" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;skip&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb6-193"><a href="#cb6-193" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb6-194"><a href="#cb6-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-195"><a href="#cb6-195" aria-hidden="true" tabindex="-1"></a>                success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb6-196"><a href="#cb6-196" aria-hidden="true" tabindex="-1"></a>                last_error <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb6-197"><a href="#cb6-197" aria-hidden="true" tabindex="-1"></a>                context <span class="op">=</span> <span class="va">None</span></span>
<span id="cb6-198"><a href="#cb6-198" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-199"><a href="#cb6-199" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(retry_count):</span>
<span id="cb6-200"><a href="#cb6-200" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb6-201"><a href="#cb6-201" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb6-202"><a href="#cb6-202" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb6-203"><a href="#cb6-203" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb6-204"><a href="#cb6-204" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb6-205"><a href="#cb6-205" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># NOVO CONTEXT por arquivo (mas mesmo browser)</span></span>
<span id="cb6-206"><a href="#cb6-206" aria-hidden="true" tabindex="-1"></a>                        context <span class="op">=</span> browser.new_context(</span>
<span id="cb6-207"><a href="#cb6-207" aria-hidden="true" tabindex="-1"></a>                            viewport<span class="op">=</span>{<span class="st">&#39;width&#39;</span>: <span class="dv">1920</span>, <span class="st">&#39;height&#39;</span>: <span class="dv">1080</span>},</span>
<span id="cb6-208"><a href="#cb6-208" aria-hidden="true" tabindex="-1"></a>                            ignore_https_errors<span class="op">=</span><span class="va">True</span></span>
<span id="cb6-209"><a href="#cb6-209" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb6-210"><a href="#cb6-210" aria-hidden="true" tabindex="-1"></a>                        page <span class="op">=</span> context.new_page()</span>
<span id="cb6-211"><a href="#cb6-211" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb6-212"><a href="#cb6-212" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Timeouts otimizados</span></span>
<span id="cb6-213"><a href="#cb6-213" aria-hidden="true" tabindex="-1"></a>                        page.set_default_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb6-214"><a href="#cb6-214" aria-hidden="true" tabindex="-1"></a>                        page.set_default_navigation_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb6-215"><a href="#cb6-215" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb6-216"><a href="#cb6-216" aria-hidden="true" tabindex="-1"></a>                        full_path <span class="op">=</span> <span class="ss">f&quot;file:///</span><span class="sc">{</span>html_path<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb6-217"><a href="#cb6-217" aria-hidden="true" tabindex="-1"></a>                        page.goto(full_path, wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>, timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb6-218"><a href="#cb6-218" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb6-219"><a href="#cb6-219" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada DURANTE o carregamento</span></span>
<span id="cb6-220"><a href="#cb6-220" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb6-221"><a href="#cb6-221" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb6-222"><a href="#cb6-222" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb6-223"><a href="#cb6-223" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Wait for complete load - MAIS CONFI√ÅVEL</span></span>
<span id="cb6-224"><a href="#cb6-224" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_function(</span>
<span id="cb6-225"><a href="#cb6-225" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;document.readyState === &quot;complete&quot;&#39;</span>,</span>
<span id="cb6-226"><a href="#cb6-226" aria-hidden="true" tabindex="-1"></a>                            timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb6-227"><a href="#cb6-227" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb6-228"><a href="#cb6-228" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb6-229"><a href="#cb6-229" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada DURANTE a espera</span></span>
<span id="cb6-230"><a href="#cb6-230" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb6-231"><a href="#cb6-231" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb6-232"><a href="#cb6-232" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb6-233"><a href="#cb6-233" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Pequena espera para conte√∫do din√¢mico</span></span>
<span id="cb6-234"><a href="#cb6-234" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_timeout(<span class="dv">500</span>)</span>
<span id="cb6-235"><a href="#cb6-235" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb6-236"><a href="#cb6-236" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada ANTES do PDF</span></span>
<span id="cb6-237"><a href="#cb6-237" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb6-238"><a href="#cb6-238" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb6-239"><a href="#cb6-239" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb6-240"><a href="#cb6-240" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Gera√ß√£o de PDF com configura√ß√µes OTIMIZADAS</span></span>
<span id="cb6-241"><a href="#cb6-241" aria-hidden="true" tabindex="-1"></a>                        page.pdf(</span>
<span id="cb6-242"><a href="#cb6-242" aria-hidden="true" tabindex="-1"></a>                            path<span class="op">=</span><span class="bu">str</span>(pdf_path),</span>
<span id="cb6-243"><a href="#cb6-243" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>,</span>
<span id="cb6-244"><a href="#cb6-244" aria-hidden="true" tabindex="-1"></a>                            print_background<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb6-245"><a href="#cb6-245" aria-hidden="true" tabindex="-1"></a>                            margin<span class="op">=</span>{<span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span>},</span>
<span id="cb6-246"><a href="#cb6-246" aria-hidden="true" tabindex="-1"></a>                            prefer_css_page_size<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb6-247"><a href="#cb6-247" aria-hidden="true" tabindex="-1"></a>                            display_header_footer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb6-248"><a href="#cb6-248" aria-hidden="true" tabindex="-1"></a>                            scale<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb6-249"><a href="#cb6-249" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb6-250"><a href="#cb6-250" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb6-251"><a href="#cb6-251" aria-hidden="true" tabindex="-1"></a>                        success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb6-252"><a href="#cb6-252" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;ok&quot;</span>, pdf_path.name))</span>
<span id="cb6-253"><a href="#cb6-253" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb6-254"><a href="#cb6-254" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb6-255"><a href="#cb6-255" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-256"><a href="#cb6-256" aria-hidden="true" tabindex="-1"></a>                        last_error <span class="op">=</span> <span class="bu">str</span>(e)</span>
<span id="cb6-257"><a href="#cb6-257" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># N√£o reportar retry se foi por interrup√ß√£o</span></span>
<span id="cb6-258"><a href="#cb6-258" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb6-259"><a href="#cb6-259" aria-hidden="true" tabindex="-1"></a>                            msg_queue.put((<span class="st">&quot;retry&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb6-260"><a href="#cb6-260" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="op">-</span> <span class="dv">1</span> <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb6-261"><a href="#cb6-261" aria-hidden="true" tabindex="-1"></a>                            time.sleep(<span class="dv">1</span>)  <span class="co"># Pequena pausa entre tentativas</span></span>
<span id="cb6-262"><a href="#cb6-262" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">finally</span>:</span>
<span id="cb6-263"><a href="#cb6-263" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> context:</span>
<span id="cb6-264"><a href="#cb6-264" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">try</span>:</span>
<span id="cb6-265"><a href="#cb6-265" aria-hidden="true" tabindex="-1"></a>                                context.close()</span>
<span id="cb6-266"><a href="#cb6-266" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">except</span>:</span>
<span id="cb6-267"><a href="#cb6-267" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">pass</span></span>
<span id="cb6-268"><a href="#cb6-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-269"><a href="#cb6-269" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Se foi interrompido, sair imediatamente</span></span>
<span id="cb6-270"><a href="#cb6-270" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb6-271"><a href="#cb6-271" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb6-272"><a href="#cb6-272" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb6-273"><a href="#cb6-273" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> success <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb6-274"><a href="#cb6-274" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;fail&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>last_error<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb6-275"><a href="#cb6-275" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">False</span>, last_error))</span>
<span id="cb6-276"><a href="#cb6-276" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> success:</span>
<span id="cb6-277"><a href="#cb6-277" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;Sucesso&quot;</span>))</span>
<span id="cb6-278"><a href="#cb6-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-279"><a href="#cb6-279" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fechar browser ao final do batch</span></span>
<span id="cb6-280"><a href="#cb6-280" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb6-281"><a href="#cb6-281" aria-hidden="true" tabindex="-1"></a>                browser.close()</span>
<span id="cb6-282"><a href="#cb6-282" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb6-283"><a href="#cb6-283" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb6-284"><a href="#cb6-284" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-285"><a href="#cb6-285" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-286"><a href="#cb6-286" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb6-287"><a href="#cb6-287" aria-hidden="true" tabindex="-1"></a>            msg_queue.put((<span class="st">&quot;error&quot;</span>, <span class="ss">f&quot;Erro no worker: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb6-288"><a href="#cb6-288" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb6-289"><a href="#cb6-289" aria-hidden="true" tabindex="-1"></a>        _active_processes.discard(my_pid)</span>
<span id="cb6-290"><a href="#cb6-290" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-291"><a href="#cb6-291" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb6-292"><a href="#cb6-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-293"><a href="#cb6-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-294"><a href="#cb6-294" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_wrapper_optimized(args):</span>
<span id="cb6-295"><a href="#cb6-295" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Wrapper para o worker otimizado&quot;&quot;&quot;</span></span>
<span id="cb6-296"><a href="#cb6-296" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb6-297"><a href="#cb6-297" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> worker_process_batch_optimized(<span class="op">*</span>args)</span>
<span id="cb6-298"><a href="#cb6-298" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-299"><a href="#cb6-299" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb6-300"><a href="#cb6-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-301"><a href="#cb6-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-302"><a href="#cb6-302" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-303"><a href="#cb6-303" aria-hidden="true" tabindex="-1"></a><span class="co"># Listener de mensagens APRIMORADO</span></span>
<span id="cb6-304"><a href="#cb6-304" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-305"><a href="#cb6-305" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> queue_listener_optimized(msg_queue, listener_stop_flag, total_files):</span>
<span id="cb6-306"><a href="#cb6-306" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Listener com barra de progresso e estat√≠sticas&quot;&quot;&quot;</span></span>
<span id="cb6-307"><a href="#cb6-307" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb6-308"><a href="#cb6-308" aria-hidden="true" tabindex="-1"></a>    processed <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-309"><a href="#cb6-309" aria-hidden="true" tabindex="-1"></a>    successes <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-310"><a href="#cb6-310" aria-hidden="true" tabindex="-1"></a>    skips <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-311"><a href="#cb6-311" aria-hidden="true" tabindex="-1"></a>    failures <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-312"><a href="#cb6-312" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-313"><a href="#cb6-313" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> listener_stop_flag.is_set():</span>
<span id="cb6-314"><a href="#cb6-314" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb6-315"><a href="#cb6-315" aria-hidden="true" tabindex="-1"></a>            obj <span class="op">=</span> msg_queue.get(timeout<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb6-316"><a href="#cb6-316" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb6-317"><a href="#cb6-317" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb6-318"><a href="#cb6-318" aria-hidden="true" tabindex="-1"></a>            typ, text <span class="op">=</span> obj</span>
<span id="cb6-319"><a href="#cb6-319" aria-hidden="true" tabindex="-1"></a>            processed <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-320"><a href="#cb6-320" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-321"><a href="#cb6-321" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> typ <span class="op">==</span> <span class="st">&quot;ok&quot;</span>:</span>
<span id="cb6-322"><a href="#cb6-322" aria-hidden="true" tabindex="-1"></a>                successes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-323"><a href="#cb6-323" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-324"><a href="#cb6-324" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;skip&quot;</span>:</span>
<span id="cb6-325"><a href="#cb6-325" aria-hidden="true" tabindex="-1"></a>                skips <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-326"><a href="#cb6-326" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚è≠Ô∏è </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-327"><a href="#cb6-327" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;fail&quot;</span>:</span>
<span id="cb6-328"><a href="#cb6-328" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-329"><a href="#cb6-329" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚ùå </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-330"><a href="#cb6-330" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;error&quot;</span>:</span>
<span id="cb6-331"><a href="#cb6-331" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-332"><a href="#cb6-332" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üö´ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-333"><a href="#cb6-333" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;retry&quot;</span>:</span>
<span id="cb6-334"><a href="#cb6-334" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üîÑ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-335"><a href="#cb6-335" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-336"><a href="#cb6-336" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Mostrar progresso a cada 5 arquivos para feedback mais frequente</span></span>
<span id="cb6-337"><a href="#cb6-337" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> processed <span class="op">%</span> <span class="dv">5</span> <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> processed <span class="op">==</span> total_files:</span>
<span id="cb6-338"><a href="#cb6-338" aria-hidden="true" tabindex="-1"></a>                elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb6-339"><a href="#cb6-339" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> successes <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb6-340"><a href="#cb6-340" aria-hidden="true" tabindex="-1"></a>                    rate <span class="op">=</span> successes <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb6-341"><a href="#cb6-341" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f&quot;üìä Progresso: </span><span class="sc">{</span>successes<span class="op">+</span>skips<span class="op">+</span>failures<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_files<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb6-342"><a href="#cb6-342" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;‚úÖ</span><span class="sc">{</span>successes<span class="sc">}</span><span class="ss"> ‚è≠Ô∏è</span><span class="sc">{</span>skips<span class="sc">}</span><span class="ss"> ‚ùå</span><span class="sc">{</span>failures<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb6-343"><a href="#cb6-343" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;</span><span class="sc">{</span>rate<span class="sc">:.1f}</span><span class="ss"> PDFs/min&quot;</span>)</span>
<span id="cb6-344"><a href="#cb6-344" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb6-345"><a href="#cb6-345" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb6-346"><a href="#cb6-346" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb6-347"><a href="#cb6-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-348"><a href="#cb6-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-349"><a href="#cb6-349" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-350"><a href="#cb6-350" aria-hidden="true" tabindex="-1"></a><span class="co"># Convers√£o principal - VERS√ÉO ALTAMENTE OTIMIZADA</span></span>
<span id="cb6-351"><a href="#cb6-351" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-352"><a href="#cb6-352" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_pdfs_optimized(source_dir, output_dir, workers, batch_size, headless, timeout,</span>
<span id="cb6-353"><a href="#cb6-353" aria-hidden="true" tabindex="-1"></a>                           force_overwrite, dry_run, single_file<span class="op">=</span><span class="va">None</span>, retry_count<span class="op">=</span><span class="dv">2</span>, benchmark<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb6-354"><a href="#cb6-354" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Fun√ß√£o principal OTIMIZADA com interrup√ß√£o robusta e performance m√°xima&quot;&quot;&quot;</span></span>
<span id="cb6-355"><a href="#cb6-355" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop, _stop_event, _pool</span>
<span id="cb6-356"><a href="#cb6-356" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-357"><a href="#cb6-357" aria-hidden="true" tabindex="-1"></a>    src <span class="op">=</span> Path(source_dir)</span>
<span id="cb6-358"><a href="#cb6-358" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> Path(output_dir)</span>
<span id="cb6-359"><a href="#cb6-359" aria-hidden="true" tabindex="-1"></a>    out.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-360"><a href="#cb6-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-361"><a href="#cb6-361" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> single_file:</span>
<span id="cb6-362"><a href="#cb6-362" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [<span class="bu">str</span>(src <span class="op">/</span> single_file)]</span>
<span id="cb6-363"><a href="#cb6-363" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> Path(html_files[<span class="dv">0</span>]).exists():</span>
<span id="cb6-364"><a href="#cb6-364" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Arquivo n√£o encontrado: </span><span class="sc">{</span>single_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-365"><a href="#cb6-365" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-366"><a href="#cb6-366" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-367"><a href="#cb6-367" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> <span class="bu">sorted</span>([<span class="bu">str</span>(p) <span class="cf">for</span> p <span class="kw">in</span> src.glob(<span class="st">&quot;*.html&quot;</span>)])</span>
<span id="cb6-368"><a href="#cb6-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-369"><a href="#cb6-369" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb6-370"><a href="#cb6-370" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Nenhum arquivo HTML encontrado.&quot;</span>)</span>
<span id="cb6-371"><a href="#cb6-371" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-372"><a href="#cb6-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-373"><a href="#cb6-373" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üéØ Encontrados </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos HTML&quot;</span>)</span>
<span id="cb6-374"><a href="#cb6-374" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>workers<span class="sc">}</span><span class="ss"> | Batch: </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb6-375"><a href="#cb6-375" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss"> tentativas por arquivo&quot;</span>)</span>
<span id="cb6-376"><a href="#cb6-376" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;‚èπÔ∏è  Pressione Ctrl+C para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb6-377"><a href="#cb6-377" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-378"><a href="#cb6-378" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MOSTRAR M√âTODO DE CONVERS√ÉO UTILIZADO</span></span>
<span id="cb6-379"><a href="#cb6-379" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîÑ M√âTODO DE CONVERS√ÉO:&quot;</span>)</span>
<span id="cb6-380"><a href="#cb6-380" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Playwright + Chromium headless&quot;</span>)</span>
<span id="cb6-381"><a href="#cb6-381" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ 1 inst√¢ncia do browser por processo worker&quot;</span>)</span>
<span id="cb6-382"><a href="#cb6-382" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Contexto separado por arquivo HTML&quot;</span>)</span>
<span id="cb6-383"><a href="#cb6-383" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Paralelismo seguro com multiprocessing.Pool&quot;</span>)</span>
<span id="cb6-384"><a href="#cb6-384" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Sistema de retry com m√∫ltiplas tentativas&quot;</span>)</span>
<span id="cb6-385"><a href="#cb6-385" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Timeouts configur√°veis por p√°gina&quot;</span>)</span>
<span id="cb6-386"><a href="#cb6-386" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ INTERRUP√á√ÉO IMEDIATA via Ctrl+C (SIGINT)</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb6-387"><a href="#cb6-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-388"><a href="#cb6-388" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dry_run:</span>
<span id="cb6-389"><a href="#cb6-389" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ MODO SIMULA√á√ÉO - Nenhum arquivo ser√° criado&quot;</span>)</span>
<span id="cb6-390"><a href="#cb6-390" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> html_files[:<span class="dv">5</span>]:</span>
<span id="cb6-391"><a href="#cb6-391" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   üìÑ </span><span class="sc">{</span>Path(f)<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-392"><a href="#cb6-392" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(html_files) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb6-393"><a href="#cb6-393" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(html_files) <span class="op">-</span> <span class="dv">5</span><span class="sc">}</span><span class="ss"> arquivos&quot;</span>)</span>
<span id="cb6-394"><a href="#cb6-394" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-395"><a href="#cb6-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-396"><a href="#cb6-396" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb6-397"><a href="#cb6-397" aria-hidden="true" tabindex="-1"></a>        original_count <span class="op">=</span> <span class="bu">len</span>(html_files)</span>
<span id="cb6-398"><a href="#cb6-398" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> html_files <span class="cf">if</span> <span class="kw">not</span> (out <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>Path(f)<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span>).exists()]</span>
<span id="cb6-399"><a href="#cb6-399" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üÜï </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos novos para processar (de </span><span class="sc">{</span>original_count<span class="sc">}</span><span class="ss"> total)&quot;</span>)</span>
<span id="cb6-400"><a href="#cb6-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-401"><a href="#cb6-401" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb6-402"><a href="#cb6-402" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Nenhum arquivo novo para processar&quot;</span>)</span>
<span id="cb6-403"><a href="#cb6-403" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-404"><a href="#cb6-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-405"><a href="#cb6-405" aria-hidden="true" tabindex="-1"></a>    batches <span class="op">=</span> chunkify(html_files, batch_size)</span>
<span id="cb6-406"><a href="#cb6-406" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üì¶ </span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> batches preparados&quot;</span>)</span>
<span id="cb6-407"><a href="#cb6-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-408"><a href="#cb6-408" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sistema de comunica√ß√£o OTIMIZADO</span></span>
<span id="cb6-409"><a href="#cb6-409" aria-hidden="true" tabindex="-1"></a>    manager <span class="op">=</span> multiprocessing.Manager()</span>
<span id="cb6-410"><a href="#cb6-410" aria-hidden="true" tabindex="-1"></a>    _stop_event <span class="op">=</span> manager.Event()</span>
<span id="cb6-411"><a href="#cb6-411" aria-hidden="true" tabindex="-1"></a>    msg_queue <span class="op">=</span> manager.Queue()</span>
<span id="cb6-412"><a href="#cb6-412" aria-hidden="true" tabindex="-1"></a>    listener_stop_flag <span class="op">=</span> threading.Event()</span>
<span id="cb6-413"><a href="#cb6-413" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-414"><a href="#cb6-414" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Listener COM ESTAT√çSTICAS</span></span>
<span id="cb6-415"><a href="#cb6-415" aria-hidden="true" tabindex="-1"></a>    listener_thread <span class="op">=</span> threading.Thread(</span>
<span id="cb6-416"><a href="#cb6-416" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>queue_listener_optimized, </span>
<span id="cb6-417"><a href="#cb6-417" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(msg_queue, listener_stop_flag, <span class="bu">len</span>(html_files)), </span>
<span id="cb6-418"><a href="#cb6-418" aria-hidden="true" tabindex="-1"></a>        daemon<span class="op">=</span><span class="va">True</span></span>
<span id="cb6-419"><a href="#cb6-419" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-420"><a href="#cb6-420" aria-hidden="true" tabindex="-1"></a>    listener_thread.start()</span>
<span id="cb6-421"><a href="#cb6-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-422"><a href="#cb6-422" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparar argumentos</span></span>
<span id="cb6-423"><a href="#cb6-423" aria-hidden="true" tabindex="-1"></a>    args_list <span class="op">=</span> [</span>
<span id="cb6-424"><a href="#cb6-424" aria-hidden="true" tabindex="-1"></a>        (batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, _stop_event, msg_queue) </span>
<span id="cb6-425"><a href="#cb6-425" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> batches</span>
<span id="cb6-426"><a href="#cb6-426" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-427"><a href="#cb6-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-428"><a href="#cb6-428" aria-hidden="true" tabindex="-1"></a>    success_count, failed <span class="op">=</span> <span class="dv">0</span>, []</span>
<span id="cb6-429"><a href="#cb6-429" aria-hidden="true" tabindex="-1"></a>    _pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb6-430"><a href="#cb6-430" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb6-431"><a href="#cb6-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-432"><a href="#cb6-432" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb6-433"><a href="#cb6-433" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Criar pool com n√∫mero OTIMIZADO de workers</span></span>
<span id="cb6-434"><a href="#cb6-434" aria-hidden="true" tabindex="-1"></a>        _pool <span class="op">=</span> multiprocessing.Pool(processes<span class="op">=</span>workers)</span>
<span id="cb6-435"><a href="#cb6-435" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-436"><a href="#cb6-436" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üîÑ Iniciando convers√£o OTIMIZADA...&quot;</span>)</span>
<span id="cb6-437"><a href="#cb6-437" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üí° Dica: Pressione Ctrl+C a qualquer momento para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb6-438"><a href="#cb6-438" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-439"><a href="#cb6-439" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Processar batches - com verifica√ß√£o CONSTANTE de parada</span></span>
<span id="cb6-440"><a href="#cb6-440" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, result <span class="kw">in</span> <span class="bu">enumerate</span>(_pool.imap_unordered(worker_wrapper_optimized, args_list)):</span>
<span id="cb6-441"><a href="#cb6-441" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb6-442"><a href="#cb6-442" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> _stop_event.is_set():</span>
<span id="cb6-443"><a href="#cb6-443" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üõë Parada de emerg√™ncia ativada durante o processamento!&quot;</span>)</span>
<span id="cb6-444"><a href="#cb6-444" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb6-445"><a href="#cb6-445" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb6-446"><a href="#cb6-446" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Relat√≥rio de progresso por batch</span></span>
<span id="cb6-447"><a href="#cb6-447" aria-hidden="true" tabindex="-1"></a>            batch_progress <span class="op">=</span> <span class="ss">f&quot;üì¶ Batch </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> processado&quot;</span></span>
<span id="cb6-448"><a href="#cb6-448" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(result) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb6-449"><a href="#cb6-449" aria-hidden="true" tabindex="-1"></a>                batch_success <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> _, success, _ <span class="kw">in</span> result <span class="cf">if</span> success)</span>
<span id="cb6-450"><a href="#cb6-450" aria-hidden="true" tabindex="-1"></a>                batch_progress <span class="op">+=</span> <span class="ss">f&quot; - ‚úÖ </span><span class="sc">{</span>batch_success<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(result)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb6-451"><a href="#cb6-451" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(batch_progress)</span>
<span id="cb6-452"><a href="#cb6-452" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-453"><a href="#cb6-453" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_file, success, msg <span class="kw">in</span> result:</span>
<span id="cb6-454"><a href="#cb6-454" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> success:</span>
<span id="cb6-455"><a href="#cb6-455" aria-hidden="true" tabindex="-1"></a>                    success_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-456"><a href="#cb6-456" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb6-457"><a href="#cb6-457" aria-hidden="true" tabindex="-1"></a>                    failed.append((Path(html_file).name, msg))</span>
<span id="cb6-458"><a href="#cb6-458" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb6-459"><a href="#cb6-459" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verifica√ß√£o de parada entre batches</span></span>
<span id="cb6-460"><a href="#cb6-460" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> _stop_event.is_set():</span>
<span id="cb6-461"><a href="#cb6-461" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb6-462"><a href="#cb6-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-463"><a href="#cb6-463" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb6-464"><a href="#cb6-464" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO POR TECLADO DETECTADA !!!&quot;</span>)</span>
<span id="cb6-465"><a href="#cb6-465" aria-hidden="true" tabindex="-1"></a>        _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb6-466"><a href="#cb6-466" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb6-467"><a href="#cb6-467" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-468"><a href="#cb6-468" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Erro no pool principal: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-469"><a href="#cb6-469" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb6-470"><a href="#cb6-470" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb6-471"><a href="#cb6-471" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üßπ LIMPEZA FINAL EM ANDAMENTO...&quot;</span>)</span>
<span id="cb6-472"><a href="#cb6-472" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-473"><a href="#cb6-473" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sinalizar parada para todos</span></span>
<span id="cb6-474"><a href="#cb6-474" aria-hidden="true" tabindex="-1"></a>        _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb6-475"><a href="#cb6-475" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb6-476"><a href="#cb6-476" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-477"><a href="#cb6-477" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parar listener</span></span>
<span id="cb6-478"><a href="#cb6-478" aria-hidden="true" tabindex="-1"></a>        listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb6-479"><a href="#cb6-479" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb6-480"><a href="#cb6-480" aria-hidden="true" tabindex="-1"></a>            msg_queue.put(<span class="va">None</span>)</span>
<span id="cb6-481"><a href="#cb6-481" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb6-482"><a href="#cb6-482" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb6-483"><a href="#cb6-483" aria-hidden="true" tabindex="-1"></a>        listener_thread.join(timeout<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb6-484"><a href="#cb6-484" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-485"><a href="#cb6-485" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Terminar pool AGressivamente</span></span>
<span id="cb6-486"><a href="#cb6-486" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> _pool:</span>
<span id="cb6-487"><a href="#cb6-487" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb6-488"><a href="#cb6-488" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üî™ Terminando pool de workers...&quot;</span>)</span>
<span id="cb6-489"><a href="#cb6-489" aria-hidden="true" tabindex="-1"></a>                _pool.terminate()</span>
<span id="cb6-490"><a href="#cb6-490" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb6-491"><a href="#cb6-491" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb6-492"><a href="#cb6-492" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb6-493"><a href="#cb6-493" aria-hidden="true" tabindex="-1"></a>                _pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb6-494"><a href="#cb6-494" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb6-495"><a href="#cb6-495" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb6-496"><a href="#cb6-496" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-497"><a href="#cb6-497" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final agressiva</span></span>
<span id="cb6-498"><a href="#cb6-498" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üóëÔ∏è  Limpando processos √≥rf√£os...&quot;</span>)</span>
<span id="cb6-499"><a href="#cb6-499" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb6-500"><a href="#cb6-500" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-501"><a href="#cb6-501" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pequena pausa para garantir que tudo foi limpo</span></span>
<span id="cb6-502"><a href="#cb6-502" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb6-503"><a href="#cb6-503" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Limpeza conclu√≠da&quot;</span>)</span>
<span id="cb6-504"><a href="#cb6-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-505"><a href="#cb6-505" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Relat√≥rio DETALHADO (apenas se n√£o foi interrompido abruptamente)</span></span>
<span id="cb6-506"><a href="#cb6-506" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> _should_stop <span class="kw">or</span> success_count <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb6-507"><a href="#cb6-507" aria-hidden="true" tabindex="-1"></a>        elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb6-508"><a href="#cb6-508" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;=&quot;</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb6-509"><a href="#cb6-509" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üìä RELAT√ìRIO FINAL OTIMIZADO:&quot;</span>)</span>
<span id="cb6-510"><a href="#cb6-510" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot; ‚úÖ Sucessos: </span><span class="sc">{</span>success_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-511"><a href="#cb6-511" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot; ‚ùå Falhas: </span><span class="sc">{</span><span class="bu">len</span>(failed)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-512"><a href="#cb6-512" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-513"><a href="#cb6-513" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> failed <span class="kw">and</span> <span class="kw">not</span> _should_stop:</span>
<span id="cb6-514"><a href="#cb6-514" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üìã Arquivos com falha (primeiros 10):&quot;</span>)</span>
<span id="cb6-515"><a href="#cb6-515" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> fname, error <span class="kw">in</span> failed[:<span class="dv">10</span>]:</span>
<span id="cb6-516"><a href="#cb6-516" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;   ‚Ä£ </span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-517"><a href="#cb6-517" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(failed) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb6-518"><a href="#cb6-518" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(failed) <span class="op">-</span> <span class="dv">10</span><span class="sc">}</span><span class="ss"> falhas&quot;</span>)</span>
<span id="cb6-519"><a href="#cb6-519" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-520"><a href="#cb6-520" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> benchmark <span class="kw">and</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb6-521"><a href="#cb6-521" aria-hidden="true" tabindex="-1"></a>            rate_total <span class="op">=</span> <span class="bu">len</span>(html_files) <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb6-522"><a href="#cb6-522" aria-hidden="true" tabindex="-1"></a>            rate_success <span class="op">=</span> success_count <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb6-523"><a href="#cb6-523" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚è±Ô∏è  Tempo total: </span><span class="sc">{</span>elapsed<span class="sc">:.1f}</span><span class="ss">s&quot;</span>)</span>
<span id="cb6-524"><a href="#cb6-524" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_total<span class="sc">:.1f}</span><span class="ss"> PDFs/min (total)&quot;</span>)</span>
<span id="cb6-525"><a href="#cb6-525" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_success<span class="sc">:.1f}</span><span class="ss"> PDFs/min (sucessos)&quot;</span>)</span>
<span id="cb6-526"><a href="#cb6-526" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-527"><a href="#cb6-527" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="kw">not</span> _should_stop</span>
<span id="cb6-528"><a href="#cb6-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-529"><a href="#cb6-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-530"><a href="#cb6-530" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-531"><a href="#cb6-531" aria-hidden="true" tabindex="-1"></a><span class="co"># CLI OTIMIZADA</span></span>
<span id="cb6-532"><a href="#cb6-532" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-533"><a href="#cb6-533" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args():</span>
<span id="cb6-534"><a href="#cb6-534" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(</span>
<span id="cb6-535"><a href="#cb6-535" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">&quot;Convers√£o HTML ‚Üí PDF ALTAMENTE OTIMIZADA com INTERRUP√á√ÉO IMEDIATA&quot;</span></span>
<span id="cb6-536"><a href="#cb6-536" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-537"><a href="#cb6-537" aria-hidden="true" tabindex="-1"></a>    group <span class="op">=</span> parser.add_mutually_exclusive_group()</span>
<span id="cb6-538"><a href="#cb6-538" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--force&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Sobrescreve PDFs j√° existentes&quot;</span>)</span>
<span id="cb6-539"><a href="#cb6-539" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--only-new&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, default<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Apenas novos (padr√£o)&quot;</span>)</span>
<span id="cb6-540"><a href="#cb6-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-541"><a href="#cb6-541" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--dry-run&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Simula sem criar arquivos&quot;</span>)</span>
<span id="cb6-542"><a href="#cb6-542" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--source&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_html&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta com arquivos .html&quot;</span>)</span>
<span id="cb6-543"><a href="#cb6-543" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--output&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_pdfs&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta de sa√≠da para PDFs&quot;</span>)</span>
<span id="cb6-544"><a href="#cb6-544" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb6-545"><a href="#cb6-545" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos (padr√£o: 2 otimizado para estabilidade)&quot;</span>)</span>
<span id="cb6-546"><a href="#cb6-546" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--batch-size&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">3</span>, </span>
<span id="cb6-547"><a href="#cb6-547" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Arquivos por batch (padr√£o: 3 para resposta r√°pida)&quot;</span>)</span>
<span id="cb6-548"><a href="#cb6-548" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--no-headless&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra navegador (debug)&quot;</span>)</span>
<span id="cb6-549"><a href="#cb6-549" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--single-file&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Converte apenas um arquivo HTML espec√≠fico&quot;</span>)</span>
<span id="cb6-550"><a href="#cb6-550" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--timeout&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">45</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Timeout por p√°gina (segundos)&quot;</span>)</span>
<span id="cb6-551"><a href="#cb6-551" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--retry-count&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Tentativas por arquivo (padr√£o: 2)&quot;</span>)</span>
<span id="cb6-552"><a href="#cb6-552" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--benchmark&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra tempo total e PDFs/minuto&quot;</span>)</span>
<span id="cb6-553"><a href="#cb6-553" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parser.parse_args()</span>
<span id="cb6-554"><a href="#cb6-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-555"><a href="#cb6-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-556"><a href="#cb6-556" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-557"><a href="#cb6-557" aria-hidden="true" tabindex="-1"></a><span class="co"># Main OTIMIZADA</span></span>
<span id="cb6-558"><a href="#cb6-558" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb6-559"><a href="#cb6-559" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb6-560"><a href="#cb6-560" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configurar handler de EMERG√äNCIA para Ctrl+C</span></span>
<span id="cb6-561"><a href="#cb6-561" aria-hidden="true" tabindex="-1"></a>    signal.signal(signal.SIGINT, emergency_stop_handler)</span>
<span id="cb6-562"><a href="#cb6-562" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-563"><a href="#cb6-563" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args()</span>
<span id="cb6-564"><a href="#cb6-564" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-565"><a href="#cb6-565" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üöÄ PDF GENERATOR - VERS√ÉO ALTAMENTE OTIMIZADA&quot;</span>)</span>
<span id="cb6-566"><a href="#cb6-566" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;!!! EMERGENCY STOP ENABLED - Ctrl+C para PARAR TUDO IMEDIATAMENTE !!!&quot;</span>)</span>
<span id="cb6-567"><a href="#cb6-567" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;=&quot;</span> <span class="op">*</span> <span class="dv">65</span>)</span>
<span id="cb6-568"><a href="#cb6-568" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>args<span class="sc">.</span>workers<span class="sc">}</span><span class="ss"> (OTIMIZADO) | Batch: </span><span class="sc">{</span>args<span class="sc">.</span>batch_size<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-569"><a href="#cb6-569" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>args<span class="sc">.</span>retry_count<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>args<span class="sc">.</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb6-570"><a href="#cb6-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-571"><a href="#cb6-571" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza inicial agressiva</span></span>
<span id="cb6-572"><a href="#cb6-572" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb6-573"><a href="#cb6-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-574"><a href="#cb6-574" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verifica√ß√µes</span></span>
<span id="cb6-575"><a href="#cb6-575" aria-hidden="true" tabindex="-1"></a>    source_dir <span class="op">=</span> Path(args.source)</span>
<span id="cb6-576"><a href="#cb6-576" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> source_dir.exists():</span>
<span id="cb6-577"><a href="#cb6-577" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Pasta n√£o encontrada: </span><span class="sc">{</span>source_dir<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-578"><a href="#cb6-578" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb6-579"><a href="#cb6-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-580"><a href="#cb6-580" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_playwright_available(headless_test<span class="op">=</span><span class="kw">not</span> args.no_headless):</span>
<span id="cb6-581"><a href="#cb6-581" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Playwright n√£o dispon√≠vel.&quot;</span>)</span>
<span id="cb6-582"><a href="#cb6-582" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   pip install playwright psutil&quot;</span>)</span>
<span id="cb6-583"><a href="#cb6-583" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   playwright install chromium&quot;</span>)</span>
<span id="cb6-584"><a href="#cb6-584" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb6-585"><a href="#cb6-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-586"><a href="#cb6-586" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Executar vers√£o OTIMIZADA</span></span>
<span id="cb6-587"><a href="#cb6-587" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> generate_pdfs_optimized(</span>
<span id="cb6-588"><a href="#cb6-588" aria-hidden="true" tabindex="-1"></a>        source_dir<span class="op">=</span><span class="bu">str</span>(args.source),</span>
<span id="cb6-589"><a href="#cb6-589" aria-hidden="true" tabindex="-1"></a>        output_dir<span class="op">=</span><span class="bu">str</span>(args.output),</span>
<span id="cb6-590"><a href="#cb6-590" aria-hidden="true" tabindex="-1"></a>        workers<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">min</span>(args.workers, <span class="dv">4</span>)),  <span class="co"># Limite m√°ximo de 4 workers para estabilidade</span></span>
<span id="cb6-591"><a href="#cb6-591" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.batch_size),</span>
<span id="cb6-592"><a href="#cb6-592" aria-hidden="true" tabindex="-1"></a>        headless<span class="op">=</span><span class="kw">not</span> args.no_headless,</span>
<span id="cb6-593"><a href="#cb6-593" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span><span class="bu">max</span>(<span class="dv">15</span>, args.timeout),</span>
<span id="cb6-594"><a href="#cb6-594" aria-hidden="true" tabindex="-1"></a>        force_overwrite<span class="op">=</span>args.force,</span>
<span id="cb6-595"><a href="#cb6-595" aria-hidden="true" tabindex="-1"></a>        dry_run<span class="op">=</span>args.dry_run,</span>
<span id="cb6-596"><a href="#cb6-596" aria-hidden="true" tabindex="-1"></a>        single_file<span class="op">=</span>args.single_file,</span>
<span id="cb6-597"><a href="#cb6-597" aria-hidden="true" tabindex="-1"></a>        retry_count<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.retry_count),</span>
<span id="cb6-598"><a href="#cb6-598" aria-hidden="true" tabindex="-1"></a>        benchmark<span class="op">=</span>args.benchmark</span>
<span id="cb6-599"><a href="#cb6-599" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-600"><a href="#cb6-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-601"><a href="#cb6-601" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resultado final</span></span>
<span id="cb6-602"><a href="#cb6-602" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb6-603"><a href="#cb6-603" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ SIMULA√á√ÉO CONCLU√çDA&quot;</span>)</span>
<span id="cb6-604"><a href="#cb6-604" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb6-605"><a href="#cb6-605" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> success:</span>
<span id="cb6-606"><a href="#cb6-606" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üéâ CONVERS√ÉO CONCLU√çDA COM SUCESSO!&quot;</span>)</span>
<span id="cb6-607"><a href="#cb6-607" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb6-608"><a href="#cb6-608" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-609"><a href="#cb6-609" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è CONVERS√ÉO INTERROMPIDA OU COM FALHAS&quot;</span>)</span>
<span id="cb6-610"><a href="#cb6-610" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb6-611"><a href="#cb6-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-612"><a href="#cb6-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-613"><a href="#cb6-613" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb6-614"><a href="#cb6-614" aria-hidden="true" tabindex="-1"></a>    multiprocessing.freeze_support()</span>
<span id="cb6-615"><a href="#cb6-615" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-616"><a href="#cb6-616" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handler global para garantir que Ctrl+C sempre funcione</span></span>
<span id="cb6-617"><a href="#cb6-617" aria-hidden="true" tabindex="-1"></a>    original_sigint <span class="op">=</span> signal.getsignal(signal.SIGINT)</span>
<span id="cb6-618"><a href="#cb6-618" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-619"><a href="#cb6-619" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb6-620"><a href="#cb6-620" aria-hidden="true" tabindex="-1"></a>        sys.exit(main())</span>
<span id="cb6-621"><a href="#cb6-621" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb6-622"><a href="#cb6-622" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO GLOBAL DETECTADA !!!&quot;</span>)</span>
<span id="cb6-623"><a href="#cb6-623" aria-hidden="true" tabindex="-1"></a>        emergency_stop_handler(<span class="va">None</span>, <span class="va">None</span>)</span>
<span id="cb6-624"><a href="#cb6-624" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb6-625"><a href="#cb6-625" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üí• ERRO CR√çTICO: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb6-626"><a href="#cb6-626" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb6-627"><a href="#cb6-627" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb6-628"><a href="#cb6-628" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Restaurar handler original</span></span>
<span id="cb6-629"><a href="#cb6-629" aria-hidden="true" tabindex="-1"></a>        signal.signal(signal.SIGINT, original_sigint)</span></code></pre></div>
<h2 data-number="1.6" id="principais-melhorias-na-interrup√ß√£o-ctrlc"><span class="header-section-number">1.6</span> Principais Melhorias na
Interrup√ß√£o Ctrl+C:</h2>
<h3 data-number="1.6.1" id="defaults-otimizados"><span class="header-section-number">1.6.1</span> 1. <strong>Defaults
Otimizados</strong></h3>
<ul>
<li><code>--workers 2</code> (em vez de 3)</li>
<li><code>--batch-size 3</code> (em vez de 4)</li>
</ul>
<h3 data-number="1.6.2" id="sistema-de-interrup√ß√£o-melhorado"><span class="header-section-number">1.6.2</span> 2. <strong>Sistema de
Interrup√ß√£o Melhorado</strong></h3>
<ul>
<li><strong>Verifica√ß√µes mais frequentes</strong> de parada em todos os
pontos cr√≠ticos</li>
<li><strong>Vari√°veis globais</strong> para <code>_stop_event</code> e
<code>_pool</code> para acesso direto no handler</li>
<li><strong>Limpeza mais agressiva</strong> de processos filhos</li>
<li><strong>Termina√ß√£o imediata</strong> do pool com
<code>terminate() + join()</code></li>
</ul>
<h3 data-number="1.6.3" id="melhorias-no-handler-de-emerg√™ncia"><span class="header-section-number">1.6.3</span> 3. <strong>Melhorias no
Handler de Emerg√™ncia</strong></h3>
<ul>
<li>Acesso direto ao pool global para termina√ß√£o imediata</li>
<li>Kill seletivo de processos filhos</li>
<li>Limpeza dupla de processos Chromium</li>
<li>Mensagens mais claras sobre o estado da interrup√ß√£o</li>
</ul>
<h3 data-number="1.6.4" id="verifica√ß√µes-de-parada-adicionais"><span class="header-section-number">1.6.4</span> 4. <strong>Verifica√ß√µes de
Parada Adicionais</strong></h3>
<ul>
<li>Durante o carregamento de p√°ginas</li>
<li>Antes da gera√ß√£o de PDF</li>
<li>Entre tentativas de retry</li>
<li>A cada 5 arquivos processados (feedback mais frequente)</li>
</ul>
<h3 data-number="1.6.5" id="limpeza-mais-robusta"><span class="header-section-number">1.6.5</span> 5. <strong>Limpeza Mais
Robusta</strong></h3>
<ul>
<li>M√∫ltiplas tentativas de kill de processos</li>
<li>Timeouts mais curtos para finaliza√ß√£o</li>
<li>Verifica√ß√£o de processos √≥rf√£os adicional</li>
</ul>
<h3 data-number="1.6.6" id="feedback-melhorado"><span class="header-section-number">1.6.6</span> 6. <strong>Feedback
Melhorado</strong></h3>
<ul>
<li>Mensagens mais expl√≠citas sobre interrup√ß√£o</li>
<li>Indicadores visuais de limpeza em andamento</li>
<li>Confirma√ß√£o de limpeza conclu√≠da</li>
</ul>
<p>Agora o Ctrl+C deve ser <strong>quase instant√¢neo</strong> e
<strong>extremamente confi√°vel</strong>, mesmo com os par√¢metros
<code>--workers 2 --batch-size 3</code> que voc√™ est√° usando. O sistema
verifica a interrup√ß√£o em praticamente todos os pontos do c√≥digo onde
poderia haver bloqueio.</p>
<hr />
<h3 data-number="1.6.7" id="utilizador-2025-11-07-054611-deepseek-reasoner"><span class="header-section-number">1.6.7</span> üë§ Utilizador <em>(2025-11-07
05:46:11)</em> <em>[deepseek-reasoner]</em></h3>
<p>Pretendo a seguinte altera√ß√£o no
comb_pdf_direct6_html_based_optimized_live_benchmark.py Detec√ß√£o de
conda activate Pesquisas. Isto √©, que foi activado o ambiente Pesquisas;
e se n√£o mostrar a mensagem Use: conda activate Pesquisas antes de
executar este script. E parar o script.</p>
<hr />
<h3 data-number="1.6.8" id="deepseek-2025-11-07-054611-deepseek-reasoner"><span class="header-section-number">1.6.8</span> ü§ñ DeepSeek <em>(2025-11-07
05:46:11)</em> <em>[deepseek-reasoner]</em></h3>
<p>Vamos adicionar uma verifica√ß√£o para detectar se o ambiente Conda
‚ÄúPesquisas‚Äù est√° ativo. Se n√£o estiver, exibiremos uma mensagem e
pararemos o script.</p>
<p>Podemos fazer isso verificando a vari√°vel de ambiente
CONDA_DEFAULT_ENV ou CONDA_PREFIX. No Windows e Linux, a vari√°vel
CONDA_DEFAULT_ENV deve conter o nome do ambiente atual.</p>
<p>No entanto, note que o script pode ser executado em qualquer ambiente
Conda, ou at√© mesmo sem Conda. Vamos verificar se o Conda est√° ativo e
se o ambiente √© ‚ÄúPesquisas‚Äù.</p>
<p>Se n√£o estiver no ambiente ‚ÄúPesquisas‚Äù, exiba a mensagem e saia.</p>
<p>Vamos tamb√©m adicionar uma op√ß√£o para pular essa verifica√ß√£o, caso o
usu√°rio queira.</p>
<p>Mas note: o script original n√£o tem essa verifica√ß√£o. Vamos adicionar
no in√≠cio do main().</p>
<p>Passos: 1. Verificar se a vari√°vel de ambiente CONDA_DEFAULT_ENV
existe e √© igual a ‚ÄúPesquisas‚Äù. 2. Se n√£o for, verificar se o usu√°rio
passou uma op√ß√£o para ignorar (vamos adicionar um argumento opcional
‚Äìignore-conda-env). 3. Se n√£o ignorar, exibir mensagem e sair.</p>
<p>No entanto, o usu√°rio pode n√£o estar usando Conda. Vamos apenas
avisar se estiver em um Conda environment que n√£o √© o ‚ÄúPesquisas‚Äù.</p>
<p>Mas note: se o usu√°rio n√£o estiver em um ambiente Conda,
CONDA_DEFAULT_ENV n√£o estar√° definida. Nesse caso, n√£o vamos fazer nada?
A inten√ß√£o √© garantir que o ambiente correto seja ativado. Se o usu√°rio
n√£o estiver no Conda, talvez n√£o tenha as depend√™ncias?</p>
<p>Vamos pensar: o script precisa do Playwright e do Chromium. Se o
usu√°rio tiver instalado globalmente, pode funcionar.</p>
<p>Mas como o objetivo √© for√ßar o uso do ambiente ‚ÄúPesquisas‚Äù, vamos
verificar apenas se o Conda est√° ativo (ou seja, se a vari√°vel
CONDA_DEFAULT_ENV existe) e se n√£o √© o ambiente ‚ÄúPesquisas‚Äù.</p>
<p>Se a vari√°vel CONDA_DEFAULT_ENV existir e n√£o for ‚ÄúPesquisas‚Äù, ent√£o
avisamos.</p>
<p>Se n√£o existir, assumimos que o usu√°rio n√£o est√° usando Conda e,
portanto, n√£o podemos garantir o ambiente. Mas talvez queiramos for√ßar o
Conda?</p>
<p>Vamos ajustar: a mensagem diz ‚ÄúUse: cond</p>
<hr />
<h3 data-number="1.6.9" id="utilizador-2025-11-07-054708-deepseek-reasoner"><span class="header-section-number">1.6.9</span> üë§ Utilizador <em>(2025-11-07
05:47:08)</em> <em>[deepseek-reasoner]</em></h3>
<p>Pretendo a seguinte altera√ß√£o no
comb_pdf_direct6_html_based_optimized_live_benchmark.py Detec√ß√£o de
conda activate Pesquisas. Isto √©, que foi activado o ambiente Pesquisas;
e se n√£o mostrar a mensagem Use: conda activate Pesquisas antes de
executar este script. E parar o script. (No windows)</p>
<hr />
<h3 data-number="1.6.10" id="deepseek-2025-11-07-054708-deepseek-reasoner"><span class="header-section-number">1.6.10</span> ü§ñ DeepSeek <em>(2025-11-07
05:47:08)</em> <em>[deepseek-reasoner]</em></h3>
<p>Vamos adicionar uma verifica√ß√£o no in√≠cio do script para verificar se
o ambiente conda ‚ÄúPesquisas‚Äù est√° ativo. No Windows, podemos verificar a
vari√°vel de ambiente CONDA_DEFAULT_ENV ou CONDA_PREFIX. Se n√£o estiver
no ambiente ‚ÄúPesquisas‚Äù, exibimos a mensagem e sa√≠mos.</p>
<p>No Windows, o conda altera a vari√°vel de ambiente CONDA_DEFAULT_ENV
para o nome do ambiente atual. Vamos verificar se CONDA_DEFAULT_ENV √©
‚ÄúPesquisas‚Äù. Se n√£o for, exibimos a mensagem e sa√≠mos.</p>
<p>No entanto, note que o usu√°rio pode ter ativado o ambiente via
<code>conda activate</code> apenas no terminal atual. Mas no script,
podemos verificar a vari√°vel de ambiente.</p>
<p>Vamos fazer: - Se a vari√°vel de ambiente CONDA_DEFAULT_ENV existir e
for ‚ÄúPesquisas‚Äù, continuamos. - Caso contr√°rio, exibimos a mensagem e
sa√≠mos.</p>
<p>Mas note: √© poss√≠vel que o usu√°rio n√£o esteja usando conda? Sim, mas
o requisito √© que use o ambiente ‚ÄúPesquisas‚Äù. Se n√£o estiver usando
conda, a vari√°vel CONDA_DEFAULT_ENV n√£o existir√°.</p>
<p>Outra abordagem: verificar CONDA_PREFIX, que aponta para o diret√≥rio
do ambiente. Mas n√£o temos o caminho fixo.</p>
<p>Vamos optar por verificar CONDA_DEFAULT_ENV.</p>
<p>No Windows, a vari√°vel de ambiente √© acess√≠vel via os.environ.</p>
<p>Vamos adicionar esta verifica√ß√£o no in√≠cio do main(). Aqui est√° o
arquivo completo com a detec√ß√£o do ambiente Conda ‚ÄúPesquisas‚Äù para
Windows:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">comb_pdf_direct6_html_based_optimized_live_benchmark.py</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">Vers√£o ALTAMENTE OTIMIZADA com:</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">- Reutiliza√ß√£o de inst√¢ncia do Chromium por processo</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">- Paralelismo seguro via multiprocessing.Pool</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">- Retry por arquivo (2 tentativas padr√£o)</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">- Cancelamento IMEDIATO E CONFI√ÅVEL via Ctrl+C</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">- Workers otimizados (2 padr√£o) e batch-size 3</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">- Browser management aprimorado</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">- Detec√ß√£o de ambiente Conda &quot;Pesquisas&quot;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> signal</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psutil</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Optional</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright, <span class="pp">TimeoutError</span> <span class="im">as</span> PlaywrightTimeoutError</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Vari√°veis globais para controle de interrup√ß√£o MELHORADO</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>_active_processes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>_should_stop <span class="op">=</span> <span class="va">False</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>_stop_event <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>_pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Fun√ß√µes utilit√°rias OTIMIZADAS</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_conda_environment():</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o ambiente Conda &#39;Pesquisas&#39; est√° ativo no Windows&quot;&quot;&quot;</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> platform.system() <span class="op">!=</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span>  <span class="co"># Skip check on non-Windows systems</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># M√©todo 1: Verificar vari√°vel de ambiente CONDA_DEFAULT_ENV</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>        conda_env <span class="op">=</span> os.environ.get(<span class="st">&#39;CONDA_DEFAULT_ENV&#39;</span>, <span class="st">&#39;&#39;</span>)</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">&#39;Pesquisas&#39;</span> <span class="kw">in</span> conda_env:</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ Ambiente Conda detectado: </span><span class="sc">{</span>conda_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># M√©todo 2: Verificar via comando conda info</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> subprocess.run(</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>            [<span class="st">&#39;conda&#39;</span>, <span class="st">&#39;info&#39;</span>, <span class="st">&#39;--json&#39;</span>], </span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>            capture_output<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>            timeout<span class="op">=</span><span class="dv">10</span></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result.returncode <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>            <span class="im">import</span> json</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>            conda_info <span class="op">=</span> json.loads(result.stdout)</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>            active_env <span class="op">=</span> conda_info.get(<span class="st">&#39;active_prefix_name&#39;</span>, <span class="st">&#39;&#39;</span>)</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">&#39;Pesquisas&#39;</span> <span class="kw">in</span> active_env:</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ Ambiente Conda detectado: </span><span class="sc">{</span>active_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># M√©todo 3: Verificar no prompt via conda env list</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> subprocess.run(</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>            [<span class="st">&#39;conda&#39;</span>, <span class="st">&#39;env&#39;</span>, <span class="st">&#39;list&#39;</span>], </span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>            capture_output<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>            timeout<span class="op">=</span><span class="dv">10</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result.returncode <span class="op">==</span> <span class="dv">0</span> <span class="kw">and</span> <span class="st">&#39;Pesquisas&#39;</span> <span class="kw">in</span> result.stdout:</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è  Ambiente &#39;Pesquisas&#39; existe mas n√£o est√° ativo!&quot;</span>)</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Se nenhum m√©todo encontrou o ambiente Pesquisas</span></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå AMBIENTE CONDA &#39;PESQUISAS&#39; N√ÉO DETECTADO!&quot;</span>)</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîß USE O SEGUINTE COMANDO ANTES DE EXECUTAR:&quot;</span>)</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda activate Pesquisas&quot;</span>)</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üí° Se o ambiente n√£o existir, crie com:&quot;</span>)</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda create -n Pesquisas python=3.8&quot;</span>)</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda activate Pesquisas&quot;</span>)</span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   pip install playwright psutil&quot;</span>)</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   playwright install chromium&quot;</span>)</span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (subprocess.TimeoutExpired, subprocess.CalledProcessError, <span class="pp">FileNotFoundError</span>):</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Conda n√£o encontrado ou comando falhou!&quot;</span>)</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîß VERIFIQUE SE O CONDA EST√Å INSTALADO E CONFIGURADO&quot;</span>)</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   E USE: conda activate Pesquisas&quot;</span>)</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Erro na verifica√ß√£o do Conda: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîß USE: conda activate Pesquisas antes de executar este script&quot;</span>)</span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kill_orphaned_chromium():</span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Encerra processos Chromium √≥rf√£os de forma agressiva.&quot;&quot;&quot;</span></span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Limpando processos Chromium √≥rf√£os...&quot;</span>)</span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>        current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>            subprocess.run(</span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chrome.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;msedge.exe&quot;</span>],</span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>                stdout<span class="op">=</span>subprocess.DEVNULL, </span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>                stderr<span class="op">=</span>subprocess.DEVNULL,</span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>                timeout<span class="op">=</span><span class="dv">10</span></span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chrome&quot;</span>], </span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;playwright&quot;</span>], </span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza adicional para garantir</span></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="fl">0.5</span>)</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>], </span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è Aviso na limpeza: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunkify(seq: List[<span class="bu">str</span>], size: <span class="bu">int</span>) <span class="op">-&gt;</span> List[List[<span class="bu">str</span>]]:</span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [seq[i:i <span class="op">+</span> size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(seq), size)]</span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_playwright_available(headless_test: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o Playwright + Chromium est√£o instalados.&quot;&quot;&quot;</span></span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless_test,</span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span></span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> emergency_stop_handler(signum, frame):</span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handler de emerg√™ncia para Ctrl+C - PARA TUDO IMEDIATAMENTE&quot;&quot;&quot;</span></span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop, _stop_event, _pool</span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">!!! EMERGENCY STOP SOLICITADO !!!&quot;</span>)</span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üö® INTERRUP√á√ÉO DE EMERG√äNCIA - Terminando processos...&quot;</span>)</span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>    _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sinalizar parada para todos os processos</span></span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _stop_event:</span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parar pool AGressivamente</span></span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _pool:</span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;üõë Terminando pool de workers...&quot;</span>)</span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a>            _pool.terminate()</span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a>            _pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Terminar processos filhos de forma agressiva</span></span>
<span id="cb7-183"><a href="#cb7-183" aria-hidden="true" tabindex="-1"></a>    current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb7-184"><a href="#cb7-184" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-185"><a href="#cb7-185" aria-hidden="true" tabindex="-1"></a>        parent <span class="op">=</span> psutil.Process(current_pid)</span>
<span id="cb7-186"><a href="#cb7-186" aria-hidden="true" tabindex="-1"></a>        children <span class="op">=</span> parent.children(recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-187"><a href="#cb7-187" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üî™ Terminando </span><span class="sc">{</span><span class="bu">len</span>(children)<span class="sc">}</span><span class="ss"> processos filhos...&quot;</span>)</span>
<span id="cb7-188"><a href="#cb7-188" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-189"><a href="#cb7-189" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> child <span class="kw">in</span> children:</span>
<span id="cb7-190"><a href="#cb7-190" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb7-191"><a href="#cb7-191" aria-hidden="true" tabindex="-1"></a>                child_pid <span class="op">=</span> child.pid</span>
<span id="cb7-192"><a href="#cb7-192" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> child_pid <span class="op">!=</span> current_pid <span class="kw">and</span> child_pid <span class="kw">in</span> _active_processes:</span>
<span id="cb7-193"><a href="#cb7-193" aria-hidden="true" tabindex="-1"></a>                    child.kill()</span>
<span id="cb7-194"><a href="#cb7-194" aria-hidden="true" tabindex="-1"></a>                    _active_processes.discard(child_pid)</span>
<span id="cb7-195"><a href="#cb7-195" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb7-196"><a href="#cb7-196" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb7-197"><a href="#cb7-197" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb7-198"><a href="#cb7-198" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb7-199"><a href="#cb7-199" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-200"><a href="#cb7-200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza final de processos √≥rf√£os</span></span>
<span id="cb7-201"><a href="#cb7-201" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb7-202"><a href="#cb7-202" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-203"><a href="#cb7-203" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üíÄ TODOS OS PROCESSOS FORAM TERMINADOS&quot;</span>)</span>
<span id="cb7-204"><a href="#cb7-204" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è PROGRAMA INTERROMPIDO PELO UTILIZADOR&quot;</span>)</span>
<span id="cb7-205"><a href="#cb7-205" aria-hidden="true" tabindex="-1"></a>    os._exit(<span class="dv">1</span>)  <span class="co"># Sa√≠da de emerg√™ncia</span></span>
<span id="cb7-206"><a href="#cb7-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-207"><a href="#cb7-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-208"><a href="#cb7-208" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-209"><a href="#cb7-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Worker de processamento OTIMIZADO - REUTILIZA BROWSER POR PROCESSO</span></span>
<span id="cb7-210"><a href="#cb7-210" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-211"><a href="#cb7-211" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_process_batch_optimized(batch_files, pdf_dir, timeout, headless, force_overwrite, retry_count, stop_event, msg_queue):</span>
<span id="cb7-212"><a href="#cb7-212" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Worker OTIMIZADO que reutiliza uma inst√¢ncia do Chromium por processo&quot;&quot;&quot;</span></span>
<span id="cb7-213"><a href="#cb7-213" aria-hidden="true" tabindex="-1"></a>    my_pid <span class="op">=</span> os.getpid()</span>
<span id="cb7-214"><a href="#cb7-214" aria-hidden="true" tabindex="-1"></a>    _active_processes.add(my_pid)</span>
<span id="cb7-215"><a href="#cb7-215" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-216"><a href="#cb7-216" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-217"><a href="#cb7-217" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb7-218"><a href="#cb7-218" aria-hidden="true" tabindex="-1"></a>        out_dir <span class="op">=</span> Path(pdf_dir)</span>
<span id="cb7-219"><a href="#cb7-219" aria-hidden="true" tabindex="-1"></a>        out_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-220"><a href="#cb7-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-221"><a href="#cb7-221" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verificar parada ANTES de iniciar o browser</span></span>
<span id="cb7-222"><a href="#cb7-222" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb7-223"><a href="#cb7-223" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb7-224"><a href="#cb7-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-225"><a href="#cb7-225" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb7-226"><a href="#cb7-226" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Configura√ß√£o OTIMIZADA do browser - UMA INST√ÇNCIA POR PROCESSO</span></span>
<span id="cb7-227"><a href="#cb7-227" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb7-228"><a href="#cb7-228" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless,</span>
<span id="cb7-229"><a href="#cb7-229" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb7-230"><a href="#cb7-230" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb7-231"><a href="#cb7-231" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb7-232"><a href="#cb7-232" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb7-233"><a href="#cb7-233" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb7-234"><a href="#cb7-234" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span>,</span>
<span id="cb7-235"><a href="#cb7-235" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-first-run&#39;</span>,</span>
<span id="cb7-236"><a href="#cb7-236" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-default-browser-check&#39;</span>,</span>
<span id="cb7-237"><a href="#cb7-237" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-default-apps&#39;</span>,</span>
<span id="cb7-238"><a href="#cb7-238" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-translate&#39;</span>,</span>
<span id="cb7-239"><a href="#cb7-239" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-extensions&#39;</span></span>
<span id="cb7-240"><a href="#cb7-240" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb7-241"><a href="#cb7-241" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb7-242"><a href="#cb7-242" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-243"><a href="#cb7-243" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_path_str <span class="kw">in</span> batch_files:</span>
<span id="cb7-244"><a href="#cb7-244" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb7-245"><a href="#cb7-245" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb7-246"><a href="#cb7-246" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb7-247"><a href="#cb7-247" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb7-248"><a href="#cb7-248" aria-hidden="true" tabindex="-1"></a>                html_path <span class="op">=</span> Path(html_path_str)</span>
<span id="cb7-249"><a href="#cb7-249" aria-hidden="true" tabindex="-1"></a>                pdf_path <span class="op">=</span> out_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb7-250"><a href="#cb7-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-251"><a href="#cb7-251" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> pdf_path.exists() <span class="kw">and</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb7-252"><a href="#cb7-252" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;J√° existe&quot;</span>))</span>
<span id="cb7-253"><a href="#cb7-253" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;skip&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb7-254"><a href="#cb7-254" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb7-255"><a href="#cb7-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-256"><a href="#cb7-256" aria-hidden="true" tabindex="-1"></a>                success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb7-257"><a href="#cb7-257" aria-hidden="true" tabindex="-1"></a>                last_error <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb7-258"><a href="#cb7-258" aria-hidden="true" tabindex="-1"></a>                context <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-259"><a href="#cb7-259" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-260"><a href="#cb7-260" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(retry_count):</span>
<span id="cb7-261"><a href="#cb7-261" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb7-262"><a href="#cb7-262" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb7-263"><a href="#cb7-263" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb7-264"><a href="#cb7-264" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb7-265"><a href="#cb7-265" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb7-266"><a href="#cb7-266" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># NOVO CONTEXT por arquivo (mas mesmo browser)</span></span>
<span id="cb7-267"><a href="#cb7-267" aria-hidden="true" tabindex="-1"></a>                        context <span class="op">=</span> browser.new_context(</span>
<span id="cb7-268"><a href="#cb7-268" aria-hidden="true" tabindex="-1"></a>                            viewport<span class="op">=</span>{<span class="st">&#39;width&#39;</span>: <span class="dv">1920</span>, <span class="st">&#39;height&#39;</span>: <span class="dv">1080</span>},</span>
<span id="cb7-269"><a href="#cb7-269" aria-hidden="true" tabindex="-1"></a>                            ignore_https_errors<span class="op">=</span><span class="va">True</span></span>
<span id="cb7-270"><a href="#cb7-270" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb7-271"><a href="#cb7-271" aria-hidden="true" tabindex="-1"></a>                        page <span class="op">=</span> context.new_page()</span>
<span id="cb7-272"><a href="#cb7-272" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb7-273"><a href="#cb7-273" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Timeouts otimizados</span></span>
<span id="cb7-274"><a href="#cb7-274" aria-hidden="true" tabindex="-1"></a>                        page.set_default_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb7-275"><a href="#cb7-275" aria-hidden="true" tabindex="-1"></a>                        page.set_default_navigation_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb7-276"><a href="#cb7-276" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb7-277"><a href="#cb7-277" aria-hidden="true" tabindex="-1"></a>                        full_path <span class="op">=</span> <span class="ss">f&quot;file:///</span><span class="sc">{</span>html_path<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb7-278"><a href="#cb7-278" aria-hidden="true" tabindex="-1"></a>                        page.goto(full_path, wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>, timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb7-279"><a href="#cb7-279" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb7-280"><a href="#cb7-280" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada DURANTE o carregamento</span></span>
<span id="cb7-281"><a href="#cb7-281" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb7-282"><a href="#cb7-282" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb7-283"><a href="#cb7-283" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb7-284"><a href="#cb7-284" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Wait for complete load - MAIS CONFI√ÅVEL</span></span>
<span id="cb7-285"><a href="#cb7-285" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_function(</span>
<span id="cb7-286"><a href="#cb7-286" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;document.readyState === &quot;complete&quot;&#39;</span>,</span>
<span id="cb7-287"><a href="#cb7-287" aria-hidden="true" tabindex="-1"></a>                            timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb7-288"><a href="#cb7-288" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb7-289"><a href="#cb7-289" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb7-290"><a href="#cb7-290" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada DURANTE a espera</span></span>
<span id="cb7-291"><a href="#cb7-291" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb7-292"><a href="#cb7-292" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb7-293"><a href="#cb7-293" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb7-294"><a href="#cb7-294" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Pequena espera para conte√∫do din√¢mico</span></span>
<span id="cb7-295"><a href="#cb7-295" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_timeout(<span class="dv">500</span>)</span>
<span id="cb7-296"><a href="#cb7-296" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb7-297"><a href="#cb7-297" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada ANTES do PDF</span></span>
<span id="cb7-298"><a href="#cb7-298" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb7-299"><a href="#cb7-299" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb7-300"><a href="#cb7-300" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb7-301"><a href="#cb7-301" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Gera√ß√£o de PDF com configura√ß√µes OTIMIZADAS</span></span>
<span id="cb7-302"><a href="#cb7-302" aria-hidden="true" tabindex="-1"></a>                        page.pdf(</span>
<span id="cb7-303"><a href="#cb7-303" aria-hidden="true" tabindex="-1"></a>                            path<span class="op">=</span><span class="bu">str</span>(pdf_path),</span>
<span id="cb7-304"><a href="#cb7-304" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>,</span>
<span id="cb7-305"><a href="#cb7-305" aria-hidden="true" tabindex="-1"></a>                            print_background<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-306"><a href="#cb7-306" aria-hidden="true" tabindex="-1"></a>                            margin<span class="op">=</span>{<span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span>},</span>
<span id="cb7-307"><a href="#cb7-307" aria-hidden="true" tabindex="-1"></a>                            prefer_css_page_size<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-308"><a href="#cb7-308" aria-hidden="true" tabindex="-1"></a>                            display_header_footer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb7-309"><a href="#cb7-309" aria-hidden="true" tabindex="-1"></a>                            scale<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb7-310"><a href="#cb7-310" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb7-311"><a href="#cb7-311" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb7-312"><a href="#cb7-312" aria-hidden="true" tabindex="-1"></a>                        success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb7-313"><a href="#cb7-313" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;ok&quot;</span>, pdf_path.name))</span>
<span id="cb7-314"><a href="#cb7-314" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb7-315"><a href="#cb7-315" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb7-316"><a href="#cb7-316" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb7-317"><a href="#cb7-317" aria-hidden="true" tabindex="-1"></a>                        last_error <span class="op">=</span> <span class="bu">str</span>(e)</span>
<span id="cb7-318"><a href="#cb7-318" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># N√£o reportar retry se foi por interrup√ß√£o</span></span>
<span id="cb7-319"><a href="#cb7-319" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb7-320"><a href="#cb7-320" aria-hidden="true" tabindex="-1"></a>                            msg_queue.put((<span class="st">&quot;retry&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb7-321"><a href="#cb7-321" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="op">-</span> <span class="dv">1</span> <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb7-322"><a href="#cb7-322" aria-hidden="true" tabindex="-1"></a>                            time.sleep(<span class="dv">1</span>)  <span class="co"># Pequena pausa entre tentativas</span></span>
<span id="cb7-323"><a href="#cb7-323" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">finally</span>:</span>
<span id="cb7-324"><a href="#cb7-324" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> context:</span>
<span id="cb7-325"><a href="#cb7-325" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">try</span>:</span>
<span id="cb7-326"><a href="#cb7-326" aria-hidden="true" tabindex="-1"></a>                                context.close()</span>
<span id="cb7-327"><a href="#cb7-327" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">except</span>:</span>
<span id="cb7-328"><a href="#cb7-328" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">pass</span></span>
<span id="cb7-329"><a href="#cb7-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-330"><a href="#cb7-330" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Se foi interrompido, sair imediatamente</span></span>
<span id="cb7-331"><a href="#cb7-331" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb7-332"><a href="#cb7-332" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb7-333"><a href="#cb7-333" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb7-334"><a href="#cb7-334" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> success <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb7-335"><a href="#cb7-335" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;fail&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>last_error<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb7-336"><a href="#cb7-336" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">False</span>, last_error))</span>
<span id="cb7-337"><a href="#cb7-337" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> success:</span>
<span id="cb7-338"><a href="#cb7-338" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;Sucesso&quot;</span>))</span>
<span id="cb7-339"><a href="#cb7-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-340"><a href="#cb7-340" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fechar browser ao final do batch</span></span>
<span id="cb7-341"><a href="#cb7-341" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb7-342"><a href="#cb7-342" aria-hidden="true" tabindex="-1"></a>                browser.close()</span>
<span id="cb7-343"><a href="#cb7-343" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb7-344"><a href="#cb7-344" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb7-345"><a href="#cb7-345" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-346"><a href="#cb7-346" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb7-347"><a href="#cb7-347" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb7-348"><a href="#cb7-348" aria-hidden="true" tabindex="-1"></a>            msg_queue.put((<span class="st">&quot;error&quot;</span>, <span class="ss">f&quot;Erro no worker: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb7-349"><a href="#cb7-349" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb7-350"><a href="#cb7-350" aria-hidden="true" tabindex="-1"></a>        _active_processes.discard(my_pid)</span>
<span id="cb7-351"><a href="#cb7-351" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-352"><a href="#cb7-352" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb7-353"><a href="#cb7-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-354"><a href="#cb7-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-355"><a href="#cb7-355" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_wrapper_optimized(args):</span>
<span id="cb7-356"><a href="#cb7-356" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Wrapper para o worker otimizado&quot;&quot;&quot;</span></span>
<span id="cb7-357"><a href="#cb7-357" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-358"><a href="#cb7-358" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> worker_process_batch_optimized(<span class="op">*</span>args)</span>
<span id="cb7-359"><a href="#cb7-359" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb7-360"><a href="#cb7-360" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb7-361"><a href="#cb7-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-362"><a href="#cb7-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-363"><a href="#cb7-363" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-364"><a href="#cb7-364" aria-hidden="true" tabindex="-1"></a><span class="co"># Listener de mensagens APRIMORADO</span></span>
<span id="cb7-365"><a href="#cb7-365" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-366"><a href="#cb7-366" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> queue_listener_optimized(msg_queue, listener_stop_flag, total_files):</span>
<span id="cb7-367"><a href="#cb7-367" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Listener com barra de progresso e estat√≠sticas&quot;&quot;&quot;</span></span>
<span id="cb7-368"><a href="#cb7-368" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb7-369"><a href="#cb7-369" aria-hidden="true" tabindex="-1"></a>    processed <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-370"><a href="#cb7-370" aria-hidden="true" tabindex="-1"></a>    successes <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-371"><a href="#cb7-371" aria-hidden="true" tabindex="-1"></a>    skips <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-372"><a href="#cb7-372" aria-hidden="true" tabindex="-1"></a>    failures <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-373"><a href="#cb7-373" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-374"><a href="#cb7-374" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> listener_stop_flag.is_set():</span>
<span id="cb7-375"><a href="#cb7-375" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb7-376"><a href="#cb7-376" aria-hidden="true" tabindex="-1"></a>            obj <span class="op">=</span> msg_queue.get(timeout<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb7-377"><a href="#cb7-377" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb7-378"><a href="#cb7-378" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb7-379"><a href="#cb7-379" aria-hidden="true" tabindex="-1"></a>            typ, text <span class="op">=</span> obj</span>
<span id="cb7-380"><a href="#cb7-380" aria-hidden="true" tabindex="-1"></a>            processed <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-381"><a href="#cb7-381" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-382"><a href="#cb7-382" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> typ <span class="op">==</span> <span class="st">&quot;ok&quot;</span>:</span>
<span id="cb7-383"><a href="#cb7-383" aria-hidden="true" tabindex="-1"></a>                successes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-384"><a href="#cb7-384" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-385"><a href="#cb7-385" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;skip&quot;</span>:</span>
<span id="cb7-386"><a href="#cb7-386" aria-hidden="true" tabindex="-1"></a>                skips <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-387"><a href="#cb7-387" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚è≠Ô∏è </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-388"><a href="#cb7-388" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;fail&quot;</span>:</span>
<span id="cb7-389"><a href="#cb7-389" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-390"><a href="#cb7-390" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚ùå </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-391"><a href="#cb7-391" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;error&quot;</span>:</span>
<span id="cb7-392"><a href="#cb7-392" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-393"><a href="#cb7-393" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üö´ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-394"><a href="#cb7-394" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;retry&quot;</span>:</span>
<span id="cb7-395"><a href="#cb7-395" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üîÑ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-396"><a href="#cb7-396" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-397"><a href="#cb7-397" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Mostrar progresso a cada 5 arquivos para feedback mais frequente</span></span>
<span id="cb7-398"><a href="#cb7-398" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> processed <span class="op">%</span> <span class="dv">5</span> <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> processed <span class="op">==</span> total_files:</span>
<span id="cb7-399"><a href="#cb7-399" aria-hidden="true" tabindex="-1"></a>                elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb7-400"><a href="#cb7-400" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> successes <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb7-401"><a href="#cb7-401" aria-hidden="true" tabindex="-1"></a>                    rate <span class="op">=</span> successes <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb7-402"><a href="#cb7-402" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f&quot;üìä Progresso: </span><span class="sc">{</span>successes<span class="op">+</span>skips<span class="op">+</span>failures<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_files<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb7-403"><a href="#cb7-403" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;‚úÖ</span><span class="sc">{</span>successes<span class="sc">}</span><span class="ss"> ‚è≠Ô∏è</span><span class="sc">{</span>skips<span class="sc">}</span><span class="ss"> ‚ùå</span><span class="sc">{</span>failures<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb7-404"><a href="#cb7-404" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;</span><span class="sc">{</span>rate<span class="sc">:.1f}</span><span class="ss"> PDFs/min&quot;</span>)</span>
<span id="cb7-405"><a href="#cb7-405" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb7-406"><a href="#cb7-406" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb7-407"><a href="#cb7-407" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb7-408"><a href="#cb7-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-409"><a href="#cb7-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-410"><a href="#cb7-410" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-411"><a href="#cb7-411" aria-hidden="true" tabindex="-1"></a><span class="co"># Convers√£o principal - VERS√ÉO ALTAMENTE OTIMIZADA</span></span>
<span id="cb7-412"><a href="#cb7-412" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-413"><a href="#cb7-413" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_pdfs_optimized(source_dir, output_dir, workers, batch_size, headless, timeout,</span>
<span id="cb7-414"><a href="#cb7-414" aria-hidden="true" tabindex="-1"></a>                           force_overwrite, dry_run, single_file<span class="op">=</span><span class="va">None</span>, retry_count<span class="op">=</span><span class="dv">2</span>, benchmark<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb7-415"><a href="#cb7-415" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Fun√ß√£o principal OTIMIZADA com interrup√ß√£o robusta e performance m√°xima&quot;&quot;&quot;</span></span>
<span id="cb7-416"><a href="#cb7-416" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop, _stop_event, _pool</span>
<span id="cb7-417"><a href="#cb7-417" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-418"><a href="#cb7-418" aria-hidden="true" tabindex="-1"></a>    src <span class="op">=</span> Path(source_dir)</span>
<span id="cb7-419"><a href="#cb7-419" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> Path(output_dir)</span>
<span id="cb7-420"><a href="#cb7-420" aria-hidden="true" tabindex="-1"></a>    out.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-421"><a href="#cb7-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-422"><a href="#cb7-422" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> single_file:</span>
<span id="cb7-423"><a href="#cb7-423" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [<span class="bu">str</span>(src <span class="op">/</span> single_file)]</span>
<span id="cb7-424"><a href="#cb7-424" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> Path(html_files[<span class="dv">0</span>]).exists():</span>
<span id="cb7-425"><a href="#cb7-425" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Arquivo n√£o encontrado: </span><span class="sc">{</span>single_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-426"><a href="#cb7-426" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb7-427"><a href="#cb7-427" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-428"><a href="#cb7-428" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> <span class="bu">sorted</span>([<span class="bu">str</span>(p) <span class="cf">for</span> p <span class="kw">in</span> src.glob(<span class="st">&quot;*.html&quot;</span>)])</span>
<span id="cb7-429"><a href="#cb7-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-430"><a href="#cb7-430" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb7-431"><a href="#cb7-431" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Nenhum arquivo HTML encontrado.&quot;</span>)</span>
<span id="cb7-432"><a href="#cb7-432" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb7-433"><a href="#cb7-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-434"><a href="#cb7-434" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üéØ Encontrados </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos HTML&quot;</span>)</span>
<span id="cb7-435"><a href="#cb7-435" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>workers<span class="sc">}</span><span class="ss"> | Batch: </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb7-436"><a href="#cb7-436" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss"> tentativas por arquivo&quot;</span>)</span>
<span id="cb7-437"><a href="#cb7-437" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;‚èπÔ∏è  Pressione Ctrl+C para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb7-438"><a href="#cb7-438" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-439"><a href="#cb7-439" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MOSTRAR M√âTODO DE CONVERS√ÉO UTILIZADO</span></span>
<span id="cb7-440"><a href="#cb7-440" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîÑ M√âTODO DE CONVERS√ÉO:&quot;</span>)</span>
<span id="cb7-441"><a href="#cb7-441" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Playwright + Chromium headless&quot;</span>)</span>
<span id="cb7-442"><a href="#cb7-442" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ 1 inst√¢ncia do browser por processo worker&quot;</span>)</span>
<span id="cb7-443"><a href="#cb7-443" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Contexto separado por arquivo HTML&quot;</span>)</span>
<span id="cb7-444"><a href="#cb7-444" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Paralelismo seguro com multiprocessing.Pool&quot;</span>)</span>
<span id="cb7-445"><a href="#cb7-445" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Sistema de retry com m√∫ltiplas tentativas&quot;</span>)</span>
<span id="cb7-446"><a href="#cb7-446" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Timeouts configur√°veis por p√°gina&quot;</span>)</span>
<span id="cb7-447"><a href="#cb7-447" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ INTERRUP√á√ÉO IMEDIATA via Ctrl+C (SIGINT)</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb7-448"><a href="#cb7-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-449"><a href="#cb7-449" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dry_run:</span>
<span id="cb7-450"><a href="#cb7-450" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ MODO SIMULA√á√ÉO - Nenhum arquivo ser√° criado&quot;</span>)</span>
<span id="cb7-451"><a href="#cb7-451" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> html_files[:<span class="dv">5</span>]:</span>
<span id="cb7-452"><a href="#cb7-452" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   üìÑ </span><span class="sc">{</span>Path(f)<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-453"><a href="#cb7-453" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(html_files) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb7-454"><a href="#cb7-454" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(html_files) <span class="op">-</span> <span class="dv">5</span><span class="sc">}</span><span class="ss"> arquivos&quot;</span>)</span>
<span id="cb7-455"><a href="#cb7-455" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb7-456"><a href="#cb7-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-457"><a href="#cb7-457" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb7-458"><a href="#cb7-458" aria-hidden="true" tabindex="-1"></a>        original_count <span class="op">=</span> <span class="bu">len</span>(html_files)</span>
<span id="cb7-459"><a href="#cb7-459" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> html_files <span class="cf">if</span> <span class="kw">not</span> (out <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>Path(f)<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span>).exists()]</span>
<span id="cb7-460"><a href="#cb7-460" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üÜï </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos novos para processar (de </span><span class="sc">{</span>original_count<span class="sc">}</span><span class="ss"> total)&quot;</span>)</span>
<span id="cb7-461"><a href="#cb7-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-462"><a href="#cb7-462" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb7-463"><a href="#cb7-463" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Nenhum arquivo novo para processar&quot;</span>)</span>
<span id="cb7-464"><a href="#cb7-464" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb7-465"><a href="#cb7-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-466"><a href="#cb7-466" aria-hidden="true" tabindex="-1"></a>    batches <span class="op">=</span> chunkify(html_files, batch_size)</span>
<span id="cb7-467"><a href="#cb7-467" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üì¶ </span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> batches preparados&quot;</span>)</span>
<span id="cb7-468"><a href="#cb7-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-469"><a href="#cb7-469" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sistema de comunica√ß√£o OTIMIZADO</span></span>
<span id="cb7-470"><a href="#cb7-470" aria-hidden="true" tabindex="-1"></a>    manager <span class="op">=</span> multiprocessing.Manager()</span>
<span id="cb7-471"><a href="#cb7-471" aria-hidden="true" tabindex="-1"></a>    _stop_event <span class="op">=</span> manager.Event()</span>
<span id="cb7-472"><a href="#cb7-472" aria-hidden="true" tabindex="-1"></a>    msg_queue <span class="op">=</span> manager.Queue()</span>
<span id="cb7-473"><a href="#cb7-473" aria-hidden="true" tabindex="-1"></a>    listener_stop_flag <span class="op">=</span> threading.Event()</span>
<span id="cb7-474"><a href="#cb7-474" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-475"><a href="#cb7-475" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Listener COM ESTAT√çSTICAS</span></span>
<span id="cb7-476"><a href="#cb7-476" aria-hidden="true" tabindex="-1"></a>    listener_thread <span class="op">=</span> threading.Thread(</span>
<span id="cb7-477"><a href="#cb7-477" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>queue_listener_optimized, </span>
<span id="cb7-478"><a href="#cb7-478" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(msg_queue, listener_stop_flag, <span class="bu">len</span>(html_files)), </span>
<span id="cb7-479"><a href="#cb7-479" aria-hidden="true" tabindex="-1"></a>        daemon<span class="op">=</span><span class="va">True</span></span>
<span id="cb7-480"><a href="#cb7-480" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-481"><a href="#cb7-481" aria-hidden="true" tabindex="-1"></a>    listener_thread.start()</span>
<span id="cb7-482"><a href="#cb7-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-483"><a href="#cb7-483" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparar argumentos</span></span>
<span id="cb7-484"><a href="#cb7-484" aria-hidden="true" tabindex="-1"></a>    args_list <span class="op">=</span> [</span>
<span id="cb7-485"><a href="#cb7-485" aria-hidden="true" tabindex="-1"></a>        (batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, _stop_event, msg_queue) </span>
<span id="cb7-486"><a href="#cb7-486" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> batches</span>
<span id="cb7-487"><a href="#cb7-487" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb7-488"><a href="#cb7-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-489"><a href="#cb7-489" aria-hidden="true" tabindex="-1"></a>    success_count, failed <span class="op">=</span> <span class="dv">0</span>, []</span>
<span id="cb7-490"><a href="#cb7-490" aria-hidden="true" tabindex="-1"></a>    _pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb7-491"><a href="#cb7-491" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb7-492"><a href="#cb7-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-493"><a href="#cb7-493" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-494"><a href="#cb7-494" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Criar pool com n√∫mero OTIMIZADO de workers</span></span>
<span id="cb7-495"><a href="#cb7-495" aria-hidden="true" tabindex="-1"></a>        _pool <span class="op">=</span> multiprocessing.Pool(processes<span class="op">=</span>workers)</span>
<span id="cb7-496"><a href="#cb7-496" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-497"><a href="#cb7-497" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üîÑ Iniciando convers√£o OTIMIZADA...&quot;</span>)</span>
<span id="cb7-498"><a href="#cb7-498" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üí° Dica: Pressione Ctrl+C a qualquer momento para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb7-499"><a href="#cb7-499" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-500"><a href="#cb7-500" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Processar batches - com verifica√ß√£o CONSTANTE de parada</span></span>
<span id="cb7-501"><a href="#cb7-501" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, result <span class="kw">in</span> <span class="bu">enumerate</span>(_pool.imap_unordered(worker_wrapper_optimized, args_list)):</span>
<span id="cb7-502"><a href="#cb7-502" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb7-503"><a href="#cb7-503" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> _stop_event.is_set():</span>
<span id="cb7-504"><a href="#cb7-504" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üõë Parada de emerg√™ncia ativada durante o processamento!&quot;</span>)</span>
<span id="cb7-505"><a href="#cb7-505" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb7-506"><a href="#cb7-506" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-507"><a href="#cb7-507" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Relat√≥rio de progresso por batch</span></span>
<span id="cb7-508"><a href="#cb7-508" aria-hidden="true" tabindex="-1"></a>            batch_progress <span class="op">=</span> <span class="ss">f&quot;üì¶ Batch </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> processado&quot;</span></span>
<span id="cb7-509"><a href="#cb7-509" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(result) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb7-510"><a href="#cb7-510" aria-hidden="true" tabindex="-1"></a>                batch_success <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> _, success, _ <span class="kw">in</span> result <span class="cf">if</span> success)</span>
<span id="cb7-511"><a href="#cb7-511" aria-hidden="true" tabindex="-1"></a>                batch_progress <span class="op">+=</span> <span class="ss">f&quot; - ‚úÖ </span><span class="sc">{</span>batch_success<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(result)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb7-512"><a href="#cb7-512" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(batch_progress)</span>
<span id="cb7-513"><a href="#cb7-513" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb7-514"><a href="#cb7-514" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_file, success, msg <span class="kw">in</span> result:</span>
<span id="cb7-515"><a href="#cb7-515" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> success:</span>
<span id="cb7-516"><a href="#cb7-516" aria-hidden="true" tabindex="-1"></a>                    success_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-517"><a href="#cb7-517" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb7-518"><a href="#cb7-518" aria-hidden="true" tabindex="-1"></a>                    failed.append((Path(html_file).name, msg))</span>
<span id="cb7-519"><a href="#cb7-519" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb7-520"><a href="#cb7-520" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verifica√ß√£o de parada entre batches</span></span>
<span id="cb7-521"><a href="#cb7-521" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> _stop_event.is_set():</span>
<span id="cb7-522"><a href="#cb7-522" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb7-523"><a href="#cb7-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-524"><a href="#cb7-524" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb7-525"><a href="#cb7-525" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO POR TECLADO DETECTADA !!!&quot;</span>)</span>
<span id="cb7-526"><a href="#cb7-526" aria-hidden="true" tabindex="-1"></a>        _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb7-527"><a href="#cb7-527" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb7-528"><a href="#cb7-528" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb7-529"><a href="#cb7-529" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Erro no pool principal: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-530"><a href="#cb7-530" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb7-531"><a href="#cb7-531" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb7-532"><a href="#cb7-532" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üßπ LIMPEZA FINAL EM ANDAMENTO...&quot;</span>)</span>
<span id="cb7-533"><a href="#cb7-533" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-534"><a href="#cb7-534" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sinalizar parada para todos</span></span>
<span id="cb7-535"><a href="#cb7-535" aria-hidden="true" tabindex="-1"></a>        _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb7-536"><a href="#cb7-536" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb7-537"><a href="#cb7-537" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-538"><a href="#cb7-538" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parar listener</span></span>
<span id="cb7-539"><a href="#cb7-539" aria-hidden="true" tabindex="-1"></a>        listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb7-540"><a href="#cb7-540" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb7-541"><a href="#cb7-541" aria-hidden="true" tabindex="-1"></a>            msg_queue.put(<span class="va">None</span>)</span>
<span id="cb7-542"><a href="#cb7-542" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb7-543"><a href="#cb7-543" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb7-544"><a href="#cb7-544" aria-hidden="true" tabindex="-1"></a>        listener_thread.join(timeout<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb7-545"><a href="#cb7-545" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-546"><a href="#cb7-546" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Terminar pool AGressivamente</span></span>
<span id="cb7-547"><a href="#cb7-547" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> _pool:</span>
<span id="cb7-548"><a href="#cb7-548" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb7-549"><a href="#cb7-549" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üî™ Terminando pool de workers...&quot;</span>)</span>
<span id="cb7-550"><a href="#cb7-550" aria-hidden="true" tabindex="-1"></a>                _pool.terminate()</span>
<span id="cb7-551"><a href="#cb7-551" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb7-552"><a href="#cb7-552" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb7-553"><a href="#cb7-553" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb7-554"><a href="#cb7-554" aria-hidden="true" tabindex="-1"></a>                _pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb7-555"><a href="#cb7-555" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb7-556"><a href="#cb7-556" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb7-557"><a href="#cb7-557" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-558"><a href="#cb7-558" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final agressiva</span></span>
<span id="cb7-559"><a href="#cb7-559" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üóëÔ∏è  Limpando processos √≥rf√£os...&quot;</span>)</span>
<span id="cb7-560"><a href="#cb7-560" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb7-561"><a href="#cb7-561" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-562"><a href="#cb7-562" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pequena pausa para garantir que tudo foi limpo</span></span>
<span id="cb7-563"><a href="#cb7-563" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb7-564"><a href="#cb7-564" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Limpeza conclu√≠da&quot;</span>)</span>
<span id="cb7-565"><a href="#cb7-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-566"><a href="#cb7-566" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Relat√≥rio DETALHADO (apenas se n√£o foi interrompido abruptamente)</span></span>
<span id="cb7-567"><a href="#cb7-567" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> _should_stop <span class="kw">or</span> success_count <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb7-568"><a href="#cb7-568" aria-hidden="true" tabindex="-1"></a>        elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb7-569"><a href="#cb7-569" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;=&quot;</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb7-570"><a href="#cb7-570" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üìä RELAT√ìRIO FINAL OTIMIZADO:&quot;</span>)</span>
<span id="cb7-571"><a href="#cb7-571" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot; ‚úÖ Sucessos: </span><span class="sc">{</span>success_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-572"><a href="#cb7-572" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot; ‚ùå Falhas: </span><span class="sc">{</span><span class="bu">len</span>(failed)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-573"><a href="#cb7-573" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-574"><a href="#cb7-574" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> failed <span class="kw">and</span> <span class="kw">not</span> _should_stop:</span>
<span id="cb7-575"><a href="#cb7-575" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üìã Arquivos com falha (primeiros 10):&quot;</span>)</span>
<span id="cb7-576"><a href="#cb7-576" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> fname, error <span class="kw">in</span> failed[:<span class="dv">10</span>]:</span>
<span id="cb7-577"><a href="#cb7-577" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;   ‚Ä£ </span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-578"><a href="#cb7-578" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(failed) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb7-579"><a href="#cb7-579" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(failed) <span class="op">-</span> <span class="dv">10</span><span class="sc">}</span><span class="ss"> falhas&quot;</span>)</span>
<span id="cb7-580"><a href="#cb7-580" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb7-581"><a href="#cb7-581" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> benchmark <span class="kw">and</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb7-582"><a href="#cb7-582" aria-hidden="true" tabindex="-1"></a>            rate_total <span class="op">=</span> <span class="bu">len</span>(html_files) <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb7-583"><a href="#cb7-583" aria-hidden="true" tabindex="-1"></a>            rate_success <span class="op">=</span> success_count <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb7-584"><a href="#cb7-584" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚è±Ô∏è  Tempo total: </span><span class="sc">{</span>elapsed<span class="sc">:.1f}</span><span class="ss">s&quot;</span>)</span>
<span id="cb7-585"><a href="#cb7-585" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_total<span class="sc">:.1f}</span><span class="ss"> PDFs/min (total)&quot;</span>)</span>
<span id="cb7-586"><a href="#cb7-586" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_success<span class="sc">:.1f}</span><span class="ss"> PDFs/min (sucessos)&quot;</span>)</span>
<span id="cb7-587"><a href="#cb7-587" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-588"><a href="#cb7-588" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="kw">not</span> _should_stop</span>
<span id="cb7-589"><a href="#cb7-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-590"><a href="#cb7-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-591"><a href="#cb7-591" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-592"><a href="#cb7-592" aria-hidden="true" tabindex="-1"></a><span class="co"># CLI OTIMIZADA</span></span>
<span id="cb7-593"><a href="#cb7-593" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-594"><a href="#cb7-594" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args():</span>
<span id="cb7-595"><a href="#cb7-595" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(</span>
<span id="cb7-596"><a href="#cb7-596" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">&quot;Convers√£o HTML ‚Üí PDF ALTAMENTE OTIMIZADA com INTERRUP√á√ÉO IMEDIATA&quot;</span></span>
<span id="cb7-597"><a href="#cb7-597" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-598"><a href="#cb7-598" aria-hidden="true" tabindex="-1"></a>    group <span class="op">=</span> parser.add_mutually_exclusive_group()</span>
<span id="cb7-599"><a href="#cb7-599" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--force&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Sobrescreve PDFs j√° existentes&quot;</span>)</span>
<span id="cb7-600"><a href="#cb7-600" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--only-new&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, default<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Apenas novos (padr√£o)&quot;</span>)</span>
<span id="cb7-601"><a href="#cb7-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-602"><a href="#cb7-602" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--dry-run&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Simula sem criar arquivos&quot;</span>)</span>
<span id="cb7-603"><a href="#cb7-603" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--source&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_html&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta com arquivos .html&quot;</span>)</span>
<span id="cb7-604"><a href="#cb7-604" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--output&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_pdfs&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta de sa√≠da para PDFs&quot;</span>)</span>
<span id="cb7-605"><a href="#cb7-605" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb7-606"><a href="#cb7-606" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos (padr√£o: 2 otimizado para estabilidade)&quot;</span>)</span>
<span id="cb7-607"><a href="#cb7-607" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--batch-size&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">3</span>, </span>
<span id="cb7-608"><a href="#cb7-608" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Arquivos por batch (padr√£o: 3 para resposta r√°pida)&quot;</span>)</span>
<span id="cb7-609"><a href="#cb7-609" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--no-headless&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra navegador (debug)&quot;</span>)</span>
<span id="cb7-610"><a href="#cb7-610" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--single-file&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Converte apenas um arquivo HTML espec√≠fico&quot;</span>)</span>
<span id="cb7-611"><a href="#cb7-611" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--timeout&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">45</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Timeout por p√°gina (segundos)&quot;</span>)</span>
<span id="cb7-612"><a href="#cb7-612" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--retry-count&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Tentativas por arquivo (padr√£o: 2)&quot;</span>)</span>
<span id="cb7-613"><a href="#cb7-613" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--benchmark&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra tempo total e PDFs/minuto&quot;</span>)</span>
<span id="cb7-614"><a href="#cb7-614" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parser.parse_args()</span>
<span id="cb7-615"><a href="#cb7-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-616"><a href="#cb7-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-617"><a href="#cb7-617" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-618"><a href="#cb7-618" aria-hidden="true" tabindex="-1"></a><span class="co"># Main OTIMIZADA</span></span>
<span id="cb7-619"><a href="#cb7-619" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb7-620"><a href="#cb7-620" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb7-621"><a href="#cb7-621" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VERIFICA√á√ÉO DO AMBIENTE CONDA - APENAS NO WINDOWS</span></span>
<span id="cb7-622"><a href="#cb7-622" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb7-623"><a href="#cb7-623" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üîç Verificando ambiente Conda &#39;Pesquisas&#39;...&quot;</span>)</span>
<span id="cb7-624"><a href="#cb7-624" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> check_conda_environment():</span>
<span id="cb7-625"><a href="#cb7-625" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">‚ùå EXECU√á√ÉO INTERROMPIDA: Ambiente Conda &#39;Pesquisas&#39; n√£o est√° ativo!&quot;</span>)</span>
<span id="cb7-626"><a href="#cb7-626" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;üí° Use o comando abaixo antes de executar este script:&quot;</span>)</span>
<span id="cb7-627"><a href="#cb7-627" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;   conda activate Pesquisas&quot;</span>)</span>
<span id="cb7-628"><a href="#cb7-628" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb7-629"><a href="#cb7-629" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-630"><a href="#cb7-630" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üîç Sistema n√£o-Windows detectado, pulando verifica√ß√£o do Conda...&quot;</span>)</span>
<span id="cb7-631"><a href="#cb7-631" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-632"><a href="#cb7-632" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configurar handler de EMERG√äNCIA para Ctrl+C</span></span>
<span id="cb7-633"><a href="#cb7-633" aria-hidden="true" tabindex="-1"></a>    signal.signal(signal.SIGINT, emergency_stop_handler)</span>
<span id="cb7-634"><a href="#cb7-634" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-635"><a href="#cb7-635" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args()</span>
<span id="cb7-636"><a href="#cb7-636" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-637"><a href="#cb7-637" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üöÄ PDF GENERATOR - VERS√ÉO ALTAMENTE OTIMIZADA&quot;</span>)</span>
<span id="cb7-638"><a href="#cb7-638" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;!!! EMERGENCY STOP ENABLED - Ctrl+C para PARAR TUDO IMEDIATAMENTE !!!&quot;</span>)</span>
<span id="cb7-639"><a href="#cb7-639" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;=&quot;</span> <span class="op">*</span> <span class="dv">65</span>)</span>
<span id="cb7-640"><a href="#cb7-640" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>args<span class="sc">.</span>workers<span class="sc">}</span><span class="ss"> (OTIMIZADO) | Batch: </span><span class="sc">{</span>args<span class="sc">.</span>batch_size<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-641"><a href="#cb7-641" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>args<span class="sc">.</span>retry_count<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>args<span class="sc">.</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb7-642"><a href="#cb7-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-643"><a href="#cb7-643" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza inicial agressiva</span></span>
<span id="cb7-644"><a href="#cb7-644" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb7-645"><a href="#cb7-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-646"><a href="#cb7-646" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verifica√ß√µes</span></span>
<span id="cb7-647"><a href="#cb7-647" aria-hidden="true" tabindex="-1"></a>    source_dir <span class="op">=</span> Path(args.source)</span>
<span id="cb7-648"><a href="#cb7-648" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> source_dir.exists():</span>
<span id="cb7-649"><a href="#cb7-649" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Pasta n√£o encontrada: </span><span class="sc">{</span>source_dir<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-650"><a href="#cb7-650" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb7-651"><a href="#cb7-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-652"><a href="#cb7-652" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_playwright_available(headless_test<span class="op">=</span><span class="kw">not</span> args.no_headless):</span>
<span id="cb7-653"><a href="#cb7-653" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Playwright n√£o dispon√≠vel.&quot;</span>)</span>
<span id="cb7-654"><a href="#cb7-654" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   pip install playwright psutil&quot;</span>)</span>
<span id="cb7-655"><a href="#cb7-655" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   playwright install chromium&quot;</span>)</span>
<span id="cb7-656"><a href="#cb7-656" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb7-657"><a href="#cb7-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-658"><a href="#cb7-658" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Executar vers√£o OTIMIZADA</span></span>
<span id="cb7-659"><a href="#cb7-659" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> generate_pdfs_optimized(</span>
<span id="cb7-660"><a href="#cb7-660" aria-hidden="true" tabindex="-1"></a>        source_dir<span class="op">=</span><span class="bu">str</span>(args.source),</span>
<span id="cb7-661"><a href="#cb7-661" aria-hidden="true" tabindex="-1"></a>        output_dir<span class="op">=</span><span class="bu">str</span>(args.output),</span>
<span id="cb7-662"><a href="#cb7-662" aria-hidden="true" tabindex="-1"></a>        workers<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">min</span>(args.workers, <span class="dv">4</span>)),  <span class="co"># Limite m√°ximo de 4 workers para estabilidade</span></span>
<span id="cb7-663"><a href="#cb7-663" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.batch_size),</span>
<span id="cb7-664"><a href="#cb7-664" aria-hidden="true" tabindex="-1"></a>        headless<span class="op">=</span><span class="kw">not</span> args.no_headless,</span>
<span id="cb7-665"><a href="#cb7-665" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span><span class="bu">max</span>(<span class="dv">15</span>, args.timeout),</span>
<span id="cb7-666"><a href="#cb7-666" aria-hidden="true" tabindex="-1"></a>        force_overwrite<span class="op">=</span>args.force,</span>
<span id="cb7-667"><a href="#cb7-667" aria-hidden="true" tabindex="-1"></a>        dry_run<span class="op">=</span>args.dry_run,</span>
<span id="cb7-668"><a href="#cb7-668" aria-hidden="true" tabindex="-1"></a>        single_file<span class="op">=</span>args.single_file,</span>
<span id="cb7-669"><a href="#cb7-669" aria-hidden="true" tabindex="-1"></a>        retry_count<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.retry_count),</span>
<span id="cb7-670"><a href="#cb7-670" aria-hidden="true" tabindex="-1"></a>        benchmark<span class="op">=</span>args.benchmark</span>
<span id="cb7-671"><a href="#cb7-671" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-672"><a href="#cb7-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-673"><a href="#cb7-673" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resultado final</span></span>
<span id="cb7-674"><a href="#cb7-674" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb7-675"><a href="#cb7-675" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ SIMULA√á√ÉO CONCLU√çDA&quot;</span>)</span>
<span id="cb7-676"><a href="#cb7-676" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb7-677"><a href="#cb7-677" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> success:</span>
<span id="cb7-678"><a href="#cb7-678" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üéâ CONVERS√ÉO CONCLU√çDA COM SUCESSO!&quot;</span>)</span>
<span id="cb7-679"><a href="#cb7-679" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb7-680"><a href="#cb7-680" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-681"><a href="#cb7-681" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è CONVERS√ÉO INTERROMPIDA OU COM FALHAS&quot;</span>)</span>
<span id="cb7-682"><a href="#cb7-682" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb7-683"><a href="#cb7-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-684"><a href="#cb7-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-685"><a href="#cb7-685" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb7-686"><a href="#cb7-686" aria-hidden="true" tabindex="-1"></a>    multiprocessing.freeze_support()</span>
<span id="cb7-687"><a href="#cb7-687" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-688"><a href="#cb7-688" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handler global para garantir que Ctrl+C sempre funcione</span></span>
<span id="cb7-689"><a href="#cb7-689" aria-hidden="true" tabindex="-1"></a>    original_sigint <span class="op">=</span> signal.getsignal(signal.SIGINT)</span>
<span id="cb7-690"><a href="#cb7-690" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-691"><a href="#cb7-691" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-692"><a href="#cb7-692" aria-hidden="true" tabindex="-1"></a>        sys.exit(main())</span>
<span id="cb7-693"><a href="#cb7-693" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb7-694"><a href="#cb7-694" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO GLOBAL DETECTADA !!!&quot;</span>)</span>
<span id="cb7-695"><a href="#cb7-695" aria-hidden="true" tabindex="-1"></a>        emergency_stop_handler(<span class="va">None</span>, <span class="va">None</span>)</span>
<span id="cb7-696"><a href="#cb7-696" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb7-697"><a href="#cb7-697" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üí• ERRO CR√çTICO: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-698"><a href="#cb7-698" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb7-699"><a href="#cb7-699" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb7-700"><a href="#cb7-700" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Restaurar handler original</span></span>
<span id="cb7-701"><a href="#cb7-701" aria-hidden="true" tabindex="-1"></a>        signal.signal(signal.SIGINT, original_sigint)</span></code></pre></div>
<h2 data-number="1.7" id="principais-adi√ß√µes"><span class="header-section-number">1.7</span> Principais Adi√ß√µes:</h2>
<h3 data-number="1.7.1" id="fun√ß√£o-check_conda_environment"><span class="header-section-number">1.7.1</span> 1. <strong>Fun√ß√£o
<code>check_conda_environment()</code></strong></h3>
<ul>
<li>Verifica se o ambiente Conda ‚ÄúPesquisas‚Äù est√° ativo no Windows</li>
<li>Usa m√∫ltiplos m√©todos para detec√ß√£o:
<ul>
<li>Vari√°vel de ambiente <code>CONDA_DEFAULT_ENV</code></li>
<li>Comando <code>conda info --json</code></li>
<li>Comando <code>conda env list</code></li>
</ul></li>
</ul>
<h3 data-number="1.7.2" id="integra√ß√£o-na-fun√ß√£o-main"><span class="header-section-number">1.7.2</span> 2. <strong>Integra√ß√£o na
Fun√ß√£o <code>main()</code></strong></h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># VERIFICA√á√ÉO DO AMBIENTE CONDA - APENAS NO WINDOWS</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üîç Verificando ambiente Conda &#39;Pesquisas&#39;...&quot;</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_conda_environment():</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">‚ùå EXECU√á√ÉO INTERROMPIDA: Ambiente Conda &#39;Pesquisas&#39; n√£o est√° ativo!&quot;</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üí° Use o comando abaixo antes de executar este script:&quot;</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda activate Pesquisas&quot;</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span></code></pre></div>
<h3 data-number="1.7.3" id="mensagens-de-erro-detalhadas"><span class="header-section-number">1.7.3</span> 3. <strong>Mensagens de Erro
Detalhadas</strong></h3>
<ul>
<li>Detecta se o ambiente existe mas n√£o est√° ativo</li>
<li>Fornece instru√ß√µes claras para ativa√ß√£o</li>
<li>Inclui comandos para criar o ambiente se n√£o existir</li>
</ul>
<h3 data-number="1.7.4" id="comportamento-por-sistema"><span class="header-section-number">1.7.4</span> 4. <strong>Comportamento por
Sistema</strong></h3>
<ul>
<li>Apenas verifica no Windows</li>
<li>Ignora a verifica√ß√£o em outros sistemas operacionais</li>
</ul>
<h2 data-number="1.8" id="funcionamento"><span class="header-section-number">1.8</span> Funcionamento:</h2>
<ol type="1">
<li><strong>No Windows</strong>: Verifica se o ambiente ‚ÄúPesquisas‚Äù est√°
ativo</li>
<li><strong>Se n√£o estiver ativo</strong>: Mostra mensagem clara e para
a execu√ß√£o</li>
<li><strong>Se estiver ativo</strong>: Continua normalmente com a
convers√£o</li>
<li><strong>Em outros SOs</strong>: Pula a verifica√ß√£o e continua
normalmente</li>
</ol>
<p>Agora o script garantir√° que o ambiente Conda correto esteja ativo
antes de prosseguir com a convers√£o!</p>
<hr />
<h3 data-number="1.8.1" id="utilizador-2025-11-07-055442-deepseek-reasoner"><span class="header-section-number">1.8.1</span> üë§ Utilizador <em>(2025-11-07
05:54:42)</em> <em>[deepseek-reasoner]</em></h3>
<p>N√£o √© detectado por isso (base)
D:_DOCS__DOCS___D_C_G_Qwen_Op&gt;python
comb_pdf_direct6_html_based_optimized_live_benchmark.py ‚Äìbenchmark
Traceback (most recent call last): File
‚ÄúD:_DOCS__DOCS___D_C_G_Qwen_Op_pdf_direct6_html_based_optimized_live_benchmark.py‚Äù,
line 28, in <module> from playwright.sync_api import sync_playwright,
TimeoutError as PlaywrightTimeoutError ModuleNotFoundError: No module
named ‚Äòplaywright‚Äô</p>
<p>Tambem pretendo que ‚Äìtimeout 50 seja o default</p>
<hr />
<h3 data-number="1.8.2" id="deepseek-2025-11-07-055442-deepseek-reasoner"><span class="header-section-number">1.8.2</span> ü§ñ DeepSeek <em>(2025-11-07
05:54:42)</em> <em>[deepseek-reasoner]</em></h3>
<p>Vamos ajustar o script para que o timeout padr√£o seja 50 e tamb√©m
melhorar a detec√ß√£o do ambiente Conda. O problema √© que o ambiente Conda
n√£o est√° sendo detectado corretamente. Vamos tentar uma abordagem mais
direta.</p>
<p>Al√©m disso, o erro ‚ÄúModuleNotFoundError: No module named
‚Äòplaywright‚Äô‚Äù indica que o playwright n√£o est√° instalado no ambiente
ativo. A verifica√ß√£o do Conda deve ser feita antes de importar o
playwright, mas n√£o podemos evitar a importa√ß√£o porque a verifica√ß√£o do
Conda est√° no main.</p>
<p>Vamos reestruturar:</p>
<ol type="1">
<li><p>Mover a verifica√ß√£o do Conda para o in√≠cio do main, antes de
importar o playwright? N√£o, porque a importa√ß√£o do playwright j√° est√° no
topo. Vamos tentar uma abordagem diferente.</p></li>
<li><p>Em vez de verificar o Conda no main, vamos verificar no in√≠cio do
script, mas isso n√£o √© poss√≠vel porque a importa√ß√£o do playwright j√°
falha.</p></li>
<li><p>Solu√ß√£o: Adiar a importa√ß√£o do playwright at√© depois da
verifica√ß√£o do Conda.</p></li>
</ol>
<p>Por√©m, a verifica√ß√£o do Conda est√° no main, e as fun√ß√µes que usam
playwright est√£o definidas antes do main.</p>
<p>Vamos reorganizar:</p>
<ul>
<li>Mover a importa√ß√£o do playwright para dentro das fun√ß√µes que o usam?
Isso √© poss√≠vel, mas tornaria o c√≥digo mais lento e menos leg√≠vel.</li>
</ul>
<ol start="4" type="1">
<li><p>Outra ideia: Verificar o ambiente Conda e, se estiver no Windows
e o ambiente n√£o for o Pesquisas, exibir a mensagem e sair, mas sem
dependender da importa√ß√£o do playwright.</p></li>
<li><p>Vamos tentar uma verifica√ß√£o simples: se estiver no Windows,
verificar a vari√°vel de ambiente CONDA_DEFAULT_ENV.</p></li>
<li><p>Se a vari√°vel existir e for ‚ÄúPesquisas‚Äù, ent√£o continuamos. Caso
contr√°rio, exibimos a mensagem e sa√≠mos.</p></li>
<li><p>Mas note: o usu√°rio pode n√£o estar usando Conda, ent√£o se a
vari√°vel n√£o existir, n√£o podemos assumir que est√° no ambiente
correto.</p></li>
<li><p>Vamos ajustar a fun√ß√£o check_conda_environment para ser mais
simples e confi√°vel.</p></li>
<li><p>E tamb√©m mudar o default do timeout para 50.</p></li>
</ol>
<p>Vamos fazer:</p>
<ul>
<li>A fun√ß√£o check_conda_environment vai verificar a vari√°vel de
ambiente CONDA_DEFAULT_ENV.</li>
<li>Se a vari√°vel existir e for ‚ÄúPesquisas‚Äù, retorna True.</li>
<li>Se n√£o, tenta usar o comando <code>conda info --envs</code> para
verificar o ambiente ativo? Mas isso √© mais lento.</li>
</ul>
<ol start="10" type="1">
<li><p>Vamos manter simples: apenas a vari√°vel de ambiente.</p></li>
<li><p>E adicionar uma op√ß√£o para pular a verifica√ß√£o? N√£o, porque o
objetivo √© garantir que est√° no ambiente correto.</p></li>
<li><p>Se a vari√°vel n√£o existir, ent√£o assumimos que n√£o est√° no Conda
e exibimos a mensagem.</p></li>
<li><p>Mas e se o usu√°rio estiver em outro ambiente Conda? A vari√°vel
existir√° e ter√° o nome do ambiente.</p></li>
<li><p>Vamos modificar a fun√ß√£o para:</p>
<ul>
<li>No Windows, se a vari√°vel CONDA_DEFAULT_ENV existir e for
‚ÄúPesquisas‚Äù, retorna True.</li>
<li>Se existir e n√£o for ‚ÄúPesquisas‚Äù, imprime a mensagem e retorna
False.</li>
<li>Se n√£o existir, imprime a mensagem e retorna False.</li>
</ul></li>
<li><p>E se n√£o for Windows, n√£o faz a verifica√ß√£o? Sim, porque o
problema √© espec√≠fico do Windows.</p></li>
<li><p>Vamos tamb√©m alterar o default do timeout para 50.</p></li>
<li><p>E corrigir: a verifica√ß√£o do Conda deve ser a primeira coisa no
main, mas a importa√ß√£o do playwright j√° falhou.</p></li>
<li><p>Para resolver o problema da importa√ß√£o, temos que adiar a
importa√ß√£o do playwright at√© depois da verifica√ß√£o.</p></li>
<li><p>Vamos mover a importa√ß√£o do playwright para dentro da fun√ß√£o
check_playwright_available? Sim, porque essa fun√ß√£o √© chamada depois da
verifica√ß√£o do Conda.</p></li>
<li><p>E tamb√©m mover a importa√ß√£o para dentro das fun√ß√µes que usam
playwright? Isso √© poss√≠vel, mas vai espalhar as importa√ß√µes.</p></li>
<li><p>Vamos tentar mover a importa√ß√£o do playwright para dentro da
fun√ß√£o check_playwright_available e da worker function.</p></li>
<li><p>Na fun√ß√£o check_playwright_available, vamos importar
sync_playwright dentro da fun√ß√£o.</p></li>
<li><p>Na worker function, vamos importar sync_playwright e
PlaywrightTimeoutError dentro da fun√ß√£o.</p></li>
<li><p>E na fun√ß√£o generate_pdfs_optimized, a importa√ß√£o do playwright
n√£o √© usada diretamente, ent√£o n√£o precisamos mover.</p></li>
<li><p>Vamos fazer:</p>
<ul>
<li>Remover a importa√ß√£o do playwright no topo.</li>
<li>Em check_playwright_available, importar sync_playwright dentro do
try.</li>
<li>Na worker_process_batch_optimized, importar sync_playwright e
PlaywrightTimeoutError dentro da fun√ß√£o.</li>
</ul></li>
<li><p>Mas note: a worker function √© executada em outro processo, ent√£o
a importa√ß√£o l√° dentro n√£o afeta o processo principal.</p></li>
<li><p>No processo principal, a fun√ß√£o check_playwright_available √©
chamada depois da verifica√ß√£o do Conda, ent√£o se o ambiente estiver
correto, a importa√ß√£o deve funcionar.</p></li>
<li><p>Vamos tentar.</p></li>
<li><p>Al√©m disso, alterar o default do timeout para 50.</p></li>
<li><p>E tamb√©m ajustar a verifica√ß√£o do Conda para ser mais tolerante?
N√£o, queremos que seja rigorosa.</p></li>
</ol>
<p>Vamos reescrever o c√≥digo:</p>
<ul>
<li>Remover a importa√ß√£o do playwright no topo.</li>
<li>Mover a importa√ß√£o para dentro das fun√ß√µes que usam.</li>
</ul>
<p>No entanto, isso pode causar overhead, mas √© aceit√°vel porque as
fun√ß√µes s√£o chamadas apenas uma vez.</p>
<p>Vamos fazer:</p>
<ul>
<li>check_playwright_available: importar sync_playwright dentro do
try.</li>
<li>worker_process_batch_optimized: importar sync_playwright e
PlaywrightTimeoutError dentro da fun√ß√£o.</li>
</ul>
<ol start="31" type="1">
<li><p>E na fun√ß√£o emergency_stop_handler, n√£o usamos playwright, ent√£o
n√£o precisa.</p></li>
<li><p>Vamos testar.</p></li>
<li><p>Al√©m disso, na fun√ß√£o check_conda_environment, vamos
simplificar:</p>
<ul>
<li>No Windows, verificar a vari√°vel CONDA_DEFAULT_ENV.</li>
<li>Se for ‚ÄúPesquisas‚Äù, retorna True.</li>
<li>Caso contr√°rio, retorna False.</li>
</ul></li>
<li><p>E no main, se for Windows e a verifica√ß√£o retornar False, sair
com mensagem.</p></li>
<li><p>Se n√£o for Windows, n√£o verificar.</p></li>
<li><p>Vamos tamb√©m alterar o default do timeout para 50.</p></li>
<li><p>E ajustar a ajuda do argumento timeout.</p></li>
</ol>
<p>Vamos implementar. Aqui est√° o arquivo corrigido com a detec√ß√£o
melhorada do ambiente Conda e o timeout padr√£o de 50:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">comb_pdf_direct6_html_based_optimized_live_benchmark.py</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">Vers√£o ALTAMENTE OTIMIZADA com:</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">- Reutiliza√ß√£o de inst√¢ncia do Chromium por processo</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">- Paralelismo seguro via multiprocessing.Pool</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">- Retry por arquivo (2 tentativas padr√£o)</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">- Cancelamento IMEDIATO E CONFI√ÅVEL via Ctrl+C</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">- Workers otimizados (2 padr√£o) e batch-size 3</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">- Browser management aprimorado</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">- Detec√ß√£o de ambiente Conda &quot;Pesquisas&quot;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">- Timeout padr√£o de 50 segundos</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> signal</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psutil</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Optional</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Importa√ß√£o do Playwright adiada para depois da verifica√ß√£o do Conda</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co"># from playwright.sync_api import sync_playwright, TimeoutError as PlaywrightTimeoutError</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Vari√°veis globais para controle de interrup√ß√£o MELHORADO</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>_active_processes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>_should_stop <span class="op">=</span> <span class="va">False</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>_stop_event <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>_pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Fun√ß√µes utilit√°rias OTIMIZADAS</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_conda_environment():</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o ambiente Conda &#39;Pesquisas&#39; est√° ativo no Windows&quot;&quot;&quot;</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> platform.system() <span class="op">!=</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span>  <span class="co"># Skip check on non-Windows systems</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># M√©todo 1: Verificar vari√°vel de ambiente CONDA_DEFAULT_ENV (mais confi√°vel)</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>        conda_env <span class="op">=</span> os.environ.get(<span class="st">&#39;CONDA_DEFAULT_ENV&#39;</span>, <span class="st">&#39;&#39;</span>)</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üîç Ambiente Conda detectado: </span><span class="sc">{</span>conda_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">&#39;Pesquisas&#39;</span> <span class="kw">in</span> conda_env:</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ Ambiente Conda correto: </span><span class="sc">{</span>conda_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># M√©todo 2: Verificar se estamos em qualquer ambiente conda (n√£o base)</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> conda_env <span class="kw">and</span> conda_env <span class="op">!=</span> <span class="st">&#39;base&#39;</span>:</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è  Ambiente Conda detectado: </span><span class="sc">{</span>conda_env<span class="sc">}</span><span class="ss"> (mas n√£o √© &#39;Pesquisas&#39;)&quot;</span>)</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># M√©todo 3: Tentar detectar via conda info</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> subprocess.run(</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&#39;conda&#39;</span>, <span class="st">&#39;info&#39;</span>, <span class="st">&#39;--json&#39;</span>], </span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>                capture_output<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>                text<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>                timeout<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>                shell<span class="op">=</span><span class="va">True</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> result.returncode <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>                <span class="im">import</span> json</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>                conda_info <span class="op">=</span> json.loads(result.stdout)</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>                active_env <span class="op">=</span> conda_info.get(<span class="st">&#39;active_prefix_name&#39;</span>, <span class="st">&#39;&#39;</span>)</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> active_env:</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f&quot;üîç Ambiente ativo via conda info: </span><span class="sc">{</span>active_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="st">&#39;Pesquisas&#39;</span> <span class="kw">in</span> active_env:</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ Ambiente Conda correto: </span><span class="sc">{</span>active_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Se chegou aqui, n√£o detectou o ambiente Pesquisas</span></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå AMBIENTE CONDA &#39;PESQUISAS&#39; N√ÉO DETECTADO!&quot;</span>)</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîß USE O SEGUINTE COMANDO ANTES DE EXECUTAR:&quot;</span>)</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda activate Pesquisas&quot;</span>)</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üí° Se o ambiente n√£o existir, crie com:&quot;</span>)</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda create -n Pesquisas python=3.8&quot;</span>)</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda activate Pesquisas&quot;</span>)</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   pip install playwright psutil&quot;</span>)</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   playwright install chromium&quot;</span>)</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Erro na verifica√ß√£o do Conda: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîß USE: conda activate Pesquisas antes de executar este script&quot;</span>)</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kill_orphaned_chromium():</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Encerra processos Chromium √≥rf√£os de forma agressiva.&quot;&quot;&quot;</span></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Limpando processos Chromium √≥rf√£os...&quot;</span>)</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>        current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>            subprocess.run(</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chrome.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;msedge.exe&quot;</span>],</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>                stdout<span class="op">=</span>subprocess.DEVNULL, </span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>                stderr<span class="op">=</span>subprocess.DEVNULL,</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>                timeout<span class="op">=</span><span class="dv">10</span></span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chrome&quot;</span>], </span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;playwright&quot;</span>], </span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza adicional para garantir</span></span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="fl">0.5</span>)</span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>], </span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è Aviso na limpeza: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunkify(seq: List[<span class="bu">str</span>], size: <span class="bu">int</span>) <span class="op">-&gt;</span> List[List[<span class="bu">str</span>]]:</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [seq[i:i <span class="op">+</span> size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(seq), size)]</span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_playwright_available(headless_test: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o Playwright + Chromium est√£o instalados.&quot;&quot;&quot;</span></span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless_test,</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span></span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Erro ao verificar Playwright: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> emergency_stop_handler(signum, frame):</span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handler de emerg√™ncia para Ctrl+C - PARA TUDO IMEDIATAMENTE&quot;&quot;&quot;</span></span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop, _stop_event, _pool</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">!!! EMERGENCY STOP SOLICITADO !!!&quot;</span>)</span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üö® INTERRUP√á√ÉO DE EMERG√äNCIA - Terminando processos...&quot;</span>)</span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>    _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sinalizar parada para todos os processos</span></span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _stop_event:</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parar pool AGressivamente</span></span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _pool:</span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;üõë Terminando pool de workers...&quot;</span>)</span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>            _pool.terminate()</span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>            _pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Terminar processos filhos de forma agressiva</span></span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>    current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>        parent <span class="op">=</span> psutil.Process(current_pid)</span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>        children <span class="op">=</span> parent.children(recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üî™ Terminando </span><span class="sc">{</span><span class="bu">len</span>(children)<span class="sc">}</span><span class="ss"> processos filhos...&quot;</span>)</span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> child <span class="kw">in</span> children:</span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>                child_pid <span class="op">=</span> child.pid</span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> child_pid <span class="op">!=</span> current_pid <span class="kw">and</span> child_pid <span class="kw">in</span> _active_processes:</span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>                    child.kill()</span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a>                    _active_processes.discard(child_pid)</span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza final de processos √≥rf√£os</span></span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üíÄ TODOS OS PROCESSOS FORAM TERMINADOS&quot;</span>)</span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è PROGRAMA INTERROMPIDO PELO UTILIZADOR&quot;</span>)</span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a>    os._exit(<span class="dv">1</span>)  <span class="co"># Sa√≠da de emerg√™ncia</span></span>
<span id="cb9-208"><a href="#cb9-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-209"><a href="#cb9-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-210"><a href="#cb9-210" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb9-211"><a href="#cb9-211" aria-hidden="true" tabindex="-1"></a><span class="co"># Worker de processamento OTIMIZADO - REUTILIZA BROWSER POR PROCESSO</span></span>
<span id="cb9-212"><a href="#cb9-212" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb9-213"><a href="#cb9-213" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_process_batch_optimized(batch_files, pdf_dir, timeout, headless, force_overwrite, retry_count, stop_event, msg_queue):</span>
<span id="cb9-214"><a href="#cb9-214" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Worker OTIMIZADO que reutiliza uma inst√¢ncia do Chromium por processo&quot;&quot;&quot;</span></span>
<span id="cb9-215"><a href="#cb9-215" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> playwright.sync_api <span class="im">import</span> sync</span>
<span id="cb9-216"><a href="#cb9-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-217"><a href="#cb9-217" aria-hidden="true" tabindex="-1"></a><span class="op">---</span></span>
<span id="cb9-218"><a href="#cb9-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-219"><a href="#cb9-219" aria-hidden="true" tabindex="-1"></a><span class="co">### üë§ Utilizador *(2025-11-07 06:02:00)* *[deepseek-reasoner]*</span></span>
<span id="cb9-220"><a href="#cb9-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-221"><a href="#cb9-221" aria-hidden="true" tabindex="-1"></a>N√£o me parece boa ideia     Remover a importa√ß√£o do playwright no topo.</span>
<span id="cb9-222"><a href="#cb9-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-223"><a href="#cb9-223" aria-hidden="true" tabindex="-1"></a>    Mover a importa√ß√£o para dentro das fun√ß√µes que usam. Por cusa do </span>
<span id="cb9-224"><a href="#cb9-224" aria-hidden="true" tabindex="-1"></a>  overhead. Poque n√£o fazer com que a primeira fun√ß√£o usada seja a dete√ß√£o de ambinte. E depois fazer o <span class="im">import</span> de playwright  ou outras. Proceguir com o resto do script.</span>
<span id="cb9-225"><a href="#cb9-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-226"><a href="#cb9-226" aria-hidden="true" tabindex="-1"></a><span class="op">---</span></span>
<span id="cb9-227"><a href="#cb9-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-228"><a href="#cb9-228" aria-hidden="true" tabindex="-1"></a><span class="co">### ü§ñ DeepSeek *(2025-11-07 06:02:00)* *[deepseek-reasoner]*</span></span>
<span id="cb9-229"><a href="#cb9-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-230"><a href="#cb9-230" aria-hidden="true" tabindex="-1"></a>Vamos ajustar a estrat√©gia:</span>
<span id="cb9-231"><a href="#cb9-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-232"><a href="#cb9-232" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span> Manter a importa√ß√£o do playwright no topo, mas proteg√™<span class="op">-</span>la com uma verifica√ß√£o condicional.</span>
<span id="cb9-233"><a href="#cb9-233" aria-hidden="true" tabindex="-1"></a><span class="fl">2.</span> Primeiro, verificar o ambiente Conda (apenas no Windows) e s√≥ ent√£o importar o playwright.</span>
<span id="cb9-234"><a href="#cb9-234" aria-hidden="true" tabindex="-1"></a><span class="fl">3.</span> Se a verifica√ß√£o do Conda falhar, o script termina antes de tentar importar o playwright.</span>
<span id="cb9-235"><a href="#cb9-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-236"><a href="#cb9-236" aria-hidden="true" tabindex="-1"></a>No entanto, o erro que voc√™ est√° tendo √© porque o playwright n√£o est√° instalado no ambiente base. A verifica√ß√£o do Conda est√° falhando em detectar que voc√™ n√£o est√° no ambiente <span class="st">&#39;Pesquisas&#39;</span>. Vamos melhorar a verifica√ß√£o do Conda.</span>
<span id="cb9-237"><a href="#cb9-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-238"><a href="#cb9-238" aria-hidden="true" tabindex="-1"></a>Al√©m disso, vamos mudar o timeout padr√£o para <span class="fl">50.</span></span>
<span id="cb9-239"><a href="#cb9-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-240"><a href="#cb9-240" aria-hidden="true" tabindex="-1"></a>Vamos reorganizar o c√≥digo:</span>
<span id="cb9-241"><a href="#cb9-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-242"><a href="#cb9-242" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> Primeiro, verificar o ambiente Conda (apenas Windows) e sair se n√£o <span class="cf">for</span> o ambiente correto.</span>
<span id="cb9-243"><a href="#cb9-243" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> S√≥ ent√£o importar o playwright (e outras depend√™ncias) para evitar <span class="pp">ModuleNotFoundError</span>.</span>
<span id="cb9-244"><a href="#cb9-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-245"><a href="#cb9-245" aria-hidden="true" tabindex="-1"></a>Mas note: se o playwright n√£o estiver instalado no ambiente <span class="st">&#39;Pesquisas&#39;</span>, o mesmo erro ocorrer√°. A verifica√ß√£o do Conda deve garantir que estamos no ambiente correto, e a verifica√ß√£o do playwright (que vem depois) deve garantir que <span class="im">as</span> depend√™ncias est√£o instaladas.</span>
<span id="cb9-246"><a href="#cb9-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-247"><a href="#cb9-247" aria-hidden="true" tabindex="-1"></a>Vamos ajustar a fun√ß√£o `check_conda_environment` para ser mais rigorosa.</span>
<span id="cb9-248"><a href="#cb9-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-249"><a href="#cb9-249" aria-hidden="true" tabindex="-1"></a>Outra ideia: em vez de verificar se o ambiente √© <span class="st">&quot;Pesquisas&quot;</span>, podemos verificar se o playwright est√° instalado. Se n√£o estiver, avisamos para ativar o ambiente correto. Mas isso pode ser enganoso se o playwright n√£o estiver instalado no ambiente <span class="st">&#39;Pesquisas&#39;</span>.</span>
<span id="cb9-250"><a href="#cb9-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-251"><a href="#cb9-251" aria-hidden="true" tabindex="-1"></a>Vamos tentar:</span>
<span id="cb9-252"><a href="#cb9-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-253"><a href="#cb9-253" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span> Verificar se estamos no Windows.</span>
<span id="cb9-254"><a href="#cb9-254" aria-hidden="true" tabindex="-1"></a><span class="fl">2.</span> Se sim, verificar a vari√°vel de ambiente CONDA_DEFAULT_ENV. Se n√£o <span class="cf">for</span> <span class="st">&quot;Pesquisas&quot;</span>, avisar e sair.</span>
<span id="cb9-255"><a href="#cb9-255" aria-hidden="true" tabindex="-1"></a><span class="fl">3.</span> Se n√£o <span class="cf">for</span> Windows, n√£o fazemos a verifica√ß√£o.</span>
<span id="cb9-256"><a href="#cb9-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-257"><a href="#cb9-257" aria-hidden="true" tabindex="-1"></a>Mas note: o erro que voc√™ teve foi porque o playwright n√£o estava instalado no ambiente base. Portanto, a verifica√ß√£o do Conda deve ser feita antes de importar o playwright.</span>
<span id="cb9-258"><a href="#cb9-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-259"><a href="#cb9-259" aria-hidden="true" tabindex="-1"></a>Vamos mover a importa√ß√£o do playwright para depois da verifica√ß√£o do Conda. Vamos tamb√©m adicionar uma verifica√ß√£o da instala√ß√£o do playwright usando a fun√ß√£o `check_playwright_available` que j√° temos.</span>
<span id="cb9-260"><a href="#cb9-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-261"><a href="#cb9-261" aria-hidden="true" tabindex="-1"></a>Vamos reestruturar o main:</span>
<span id="cb9-262"><a href="#cb9-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-263"><a href="#cb9-263" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> Verificar Conda (Windows apenas)</span>
<span id="cb9-264"><a href="#cb9-264" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> Importar playwright (e outras depend√™ncias) ap√≥s a verifica√ß√£o do Conda</span>
<span id="cb9-265"><a href="#cb9-265" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> Verificar se o playwright est√° dispon√≠vel (usando a fun√ß√£o existente)</span>
<span id="cb9-266"><a href="#cb9-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-267"><a href="#cb9-267" aria-hidden="true" tabindex="-1"></a>No entanto, n√£o podemos mover todas <span class="im">as</span> importa√ß√µes de playwright para depois da verifica√ß√£o do Conda porque o c√≥digo depende dele em v√°rias fun√ß√µes. Vamos ent√£o:</span>
<span id="cb9-268"><a href="#cb9-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-269"><a href="#cb9-269" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> Deixar a importa√ß√£o do playwright no topo, mas dentro de um bloco condicional que s√≥ √© executado se a verifica√ß√£o do Conda passar? N√£o, porque o <span class="im">import</span> √© no topo e √© executado antes do main.</span>
<span id="cb9-270"><a href="#cb9-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-271"><a href="#cb9-271" aria-hidden="true" tabindex="-1"></a>Uma solu√ß√£o alternativa √©:</span>
<span id="cb9-272"><a href="#cb9-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-273"><a href="#cb9-273" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> N√£o importar o playwright no topo, mas sim dentro das fun√ß√µes que o usam. Isso pode ser feito, mas pode causar overhead? Na verdade, o <span class="im">import</span> √© custoso, mas como essas fun√ß√µes s√£o chamadas apenas uma vez por processo, e s√£o poucas, pode ser aceit√°vel.</span>
<span id="cb9-274"><a href="#cb9-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-275"><a href="#cb9-275" aria-hidden="true" tabindex="-1"></a>Outra solu√ß√£o:</span>
<span id="cb9-276"><a href="#cb9-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-277"><a href="#cb9-277" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> Fazer a verifica√ß√£o do Conda no in√≠cio do main, e se passar, ent√£o importar o playwright e outros m√≥dulos. Mas isso exigiria que todo o c√≥digo que usa playwright estivesse dentro de fun√ß√µes que s√≥ s√£o chamadas ap√≥s o <span class="im">import</span>.</span>
<span id="cb9-278"><a href="#cb9-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-279"><a href="#cb9-279" aria-hidden="true" tabindex="-1"></a>Vamos adotar a seguinte estrat√©gia:</span>
<span id="cb9-280"><a href="#cb9-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-281"><a href="#cb9-281" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span> Remover <span class="im">as</span> importa√ß√µes de playwright do topo.</span>
<span id="cb9-282"><a href="#cb9-282" aria-hidden="true" tabindex="-1"></a><span class="fl">2.</span> Fazer a verifica√ß√£o do Conda no in√≠cio do main.</span>
<span id="cb9-283"><a href="#cb9-283" aria-hidden="true" tabindex="-1"></a><span class="fl">3.</span> Se a verifica√ß√£o do Conda <span class="cf">for</span> bem<span class="op">-</span>sucedida (ou se n√£o <span class="cf">for</span> Windows), ent√£o importar o playwright.</span>
<span id="cb9-284"><a href="#cb9-284" aria-hidden="true" tabindex="-1"></a><span class="fl">4.</span> Colocar <span class="im">as</span> importa√ß√µes do playwright dentro das fun√ß√µes que o utilizam.</span>
<span id="cb9-285"><a href="#cb9-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-286"><a href="#cb9-286" aria-hidden="true" tabindex="-1"></a>Isso evita o erro de importa√ß√£o se o ambiente Conda n√£o estiver ativo.</span>
<span id="cb9-287"><a href="#cb9-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-288"><a href="#cb9-288" aria-hidden="true" tabindex="-1"></a>Vamos fazer isso, e tamb√©m ajustar o timeout padr√£o para <span class="fl">50.</span></span>
<span id="cb9-289"><a href="#cb9-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-290"><a href="#cb9-290" aria-hidden="true" tabindex="-1"></a>Vou reescrever o c√≥digo para:</span>
<span id="cb9-291"><a href="#cb9-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-292"><a href="#cb9-292" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> Remover a importa√ß√£o do playwright no topo.</span>
<span id="cb9-293"><a href="#cb9-293" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> Mover a importa√ß√£o para dentro das fun√ß√µes `check_playwright_available`, `worker_process_batch_optimized` e `generate_pdfs_optimized` (que √© chamada por main).</span>
<span id="cb9-294"><a href="#cb9-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-295"><a href="#cb9-295" aria-hidden="true" tabindex="-1"></a>Al√©m disso, a fun√ß√£o `check_playwright_available` j√° faz um teste de importa√ß√£o, ent√£o podemos usar essa fun√ß√£o para verificar a instala√ß√£o do playwright.</span>
<span id="cb9-296"><a href="#cb9-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-297"><a href="#cb9-297" aria-hidden="true" tabindex="-1"></a>Vamos ajustar:</span>
<span id="cb9-298"><a href="#cb9-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-299"><a href="#cb9-299" aria-hidden="true" tabindex="-1"></a><span class="op">-</span> A fun√ß√£o `check_playwright_available` deve tentar importar o playwright e, se falhar, retornar <span class="va">False</span>.</span>
<span id="cb9-300"><a href="#cb9-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-301"><a href="#cb9-301" aria-hidden="true" tabindex="-1"></a>Vamos modificar a fun√ß√£o `check_playwright_available` para:</span>
<span id="cb9-302"><a href="#cb9-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-303"><a href="#cb9-303" aria-hidden="true" tabindex="-1"></a>```python</span>
<span id="cb9-304"><a href="#cb9-304" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_playwright_available(headless_test: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb9-305"><a href="#cb9-305" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o Playwright + Chromium est√£o instalados.&quot;&quot;&quot;</span></span>
<span id="cb9-306"><a href="#cb9-306" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb9-307"><a href="#cb9-307" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright</span>
<span id="cb9-308"><a href="#cb9-308" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb9-309"><a href="#cb9-309" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(headless<span class="op">=</span>headless_test)</span>
<span id="cb9-310"><a href="#cb9-310" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb9-311"><a href="#cb9-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb9-312"><a href="#cb9-312" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb9-313"><a href="#cb9-313" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span></code></pre></div>
<p>E ent√£o, no main, ap√≥s a verifica√ß√£o do Conda, chamamos
<code>check_playwright_available</code> e, se falhar, avisamos para
instalar.</p>
<p>Vamos reescrever o c√≥digo conforme abaixo.</p>
<p>Nota: Vamos tamb√©m alterar o timeout padr√£o para 50 no argument
parser.</p>
<p>Vamos l√°. Aqui est√° o arquivo corrigido com a detec√ß√£o do ambiente
Conda no in√≠cio e importa√ß√£o do Playwright apenas ap√≥s a verifica√ß√£o,
mantendo a performance:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">comb_pdf_direct6_html_based_optimized_live_benchmark.py</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">Vers√£o ALTAMENTE OTIMIZADA com:</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">- Reutiliza√ß√£o de inst√¢ncia do Chromium por processo</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">- Paralelismo seguro via multiprocessing.Pool</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">- Retry por arquivo (2 tentativas padr√£o)</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">- Cancelamento IMEDIATO E CONFI√ÅVEL via Ctrl+C</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">- Workers otimizados (2 padr√£o) e batch-size 3</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">- Browser management aprimorado</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">- Detec√ß√£o de ambiente Conda &quot;Pesquisas&quot;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">- Timeout padr√£o de 50 segundos</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> signal</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psutil</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Optional</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Vari√°veis globais para controle de interrup√ß√£o MELHORADO</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>_active_processes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>_should_stop <span class="op">=</span> <span class="va">False</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>_stop_event <span class="op">=</span> <span class="va">None</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>_pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="co"># DETEC√á√ÉO DO AMBIENTE CONDA - DEVE SER A PRIMEIRA COISA A EXECUTAR</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_conda_environment():</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o ambiente Conda &#39;Pesquisas&#39; est√° ativo no Windows&quot;&quot;&quot;</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> platform.system() <span class="op">!=</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span>  <span class="co"># Skip check on non-Windows systems</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># M√©todo 1: Verificar vari√°vel de ambiente CONDA_DEFAULT_ENV (mais confi√°vel)</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        conda_env <span class="op">=</span> os.environ.get(<span class="st">&#39;CONDA_DEFAULT_ENV&#39;</span>, <span class="st">&#39;&#39;</span>)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üîç Ambiente Conda detectado: </span><span class="sc">{</span>conda_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">&#39;Pesquisas&#39;</span> <span class="kw">in</span> conda_env:</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ Ambiente Conda correto: </span><span class="sc">{</span>conda_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># M√©todo 2: Verificar se estamos em qualquer ambiente conda (n√£o base)</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> conda_env <span class="kw">and</span> conda_env <span class="op">!=</span> <span class="st">&#39;base&#39;</span>:</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è  Ambiente Conda detectado: </span><span class="sc">{</span>conda_env<span class="sc">}</span><span class="ss"> (mas n√£o √© &#39;Pesquisas&#39;)&quot;</span>)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># M√©todo 3: Tentar detectar via conda info</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> subprocess.run(</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&#39;conda&#39;</span>, <span class="st">&#39;info&#39;</span>, <span class="st">&#39;--json&#39;</span>], </span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>                capture_output<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>                text<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>                timeout<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>                shell<span class="op">=</span><span class="va">True</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> result.returncode <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>                <span class="im">import</span> json</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>                conda_info <span class="op">=</span> json.loads(result.stdout)</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>                active_env <span class="op">=</span> conda_info.get(<span class="st">&#39;active_prefix_name&#39;</span>, <span class="st">&#39;&#39;</span>)</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> active_env:</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f&quot;üîç Ambiente ativo via conda info: </span><span class="sc">{</span>active_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="st">&#39;Pesquisas&#39;</span> <span class="kw">in</span> active_env:</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ Ambiente Conda correto: </span><span class="sc">{</span>active_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Se chegou aqui, n√£o detectou o ambiente Pesquisas</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå AMBIENTE CONDA &#39;PESQUISAS&#39; N√ÉO DETECTADO!&quot;</span>)</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîß USE O SEGUINTE COMANDO ANTES DE EXECUTAR:&quot;</span>)</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda activate Pesquisas&quot;</span>)</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üí° Se o ambiente n√£o existir, crie com:&quot;</span>)</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda create -n Pesquisas python=3.8&quot;</span>)</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda activate Pesquisas&quot;</span>)</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   pip install playwright psutil&quot;</span>)</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   playwright install chromium&quot;</span>)</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Erro na verifica√ß√£o do Conda: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîß USE: conda activate Pesquisas antes de executar este script&quot;</span>)</span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a><span class="co"># VERIFICA√á√ÉO INICIAL DO AMBIENTE</span></span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üîç Verificando ambiente Conda &#39;Pesquisas&#39;...&quot;</span>)</span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_conda_environment():</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">‚ùå EXECU√á√ÉO INTERROMPIDA: Ambiente Conda &#39;Pesquisas&#39; n√£o est√° ativo!&quot;</span>)</span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üí° Use o comando abaixo antes de executar este script:&quot;</span>)</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda activate Pesquisas&quot;</span>)</span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üîç Sistema n√£o-Windows detectado, pulando verifica√ß√£o do Conda...&quot;</span>)</span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a><span class="co"># AGORA IMPORTAMOS AS DEPEND√äNCIAS (AP√ìS VERIFICA√á√ÉO DO CONDA)</span></span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright, <span class="pp">TimeoutError</span> <span class="im">as</span> PlaywrightTimeoutError</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Fun√ß√µes utilit√°rias OTIMIZADAS</span></span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kill_orphaned_chromium():</span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Encerra processos Chromium √≥rf√£os de forma agressiva.&quot;&quot;&quot;</span></span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Limpando processos Chromium √≥rf√£os...&quot;</span>)</span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>        current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a>            subprocess.run(</span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chrome.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;msedge.exe&quot;</span>],</span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a>                stdout<span class="op">=</span>subprocess.DEVNULL, </span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a>                stderr<span class="op">=</span>subprocess.DEVNULL,</span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a>                timeout<span class="op">=</span><span class="dv">10</span></span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chrome&quot;</span>], </span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;playwright&quot;</span>], </span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza adicional para garantir</span></span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="fl">0.5</span>)</span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>], </span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è Aviso na limpeza: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunkify(seq: List[<span class="bu">str</span>], size: <span class="bu">int</span>) <span class="op">-&gt;</span> List[List[<span class="bu">str</span>]]:</span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [seq[i:i <span class="op">+</span> size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(seq), size)]</span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_playwright_available(headless_test: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o Playwright + Chromium est√£o instalados.&quot;&quot;&quot;</span></span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless_test,</span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb10-162"><a href="#cb10-162" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb10-163"><a href="#cb10-163" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb10-164"><a href="#cb10-164" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb10-165"><a href="#cb10-165" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb10-166"><a href="#cb10-166" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span></span>
<span id="cb10-167"><a href="#cb10-167" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb10-168"><a href="#cb10-168" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb10-169"><a href="#cb10-169" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb10-170"><a href="#cb10-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb10-171"><a href="#cb10-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb10-172"><a href="#cb10-172" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Erro ao verificar Playwright: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-173"><a href="#cb10-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb10-174"><a href="#cb10-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-175"><a href="#cb10-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-176"><a href="#cb10-176" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> emergency_stop_handler(signum, frame):</span>
<span id="cb10-177"><a href="#cb10-177" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handler de emerg√™ncia para Ctrl+C - PARA TUDO IMEDIATAMENTE&quot;&quot;&quot;</span></span>
<span id="cb10-178"><a href="#cb10-178" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop, _stop_event, _pool</span>
<span id="cb10-179"><a href="#cb10-179" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-180"><a href="#cb10-180" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">!!! EMERGENCY STOP SOLICITADO !!!&quot;</span>)</span>
<span id="cb10-181"><a href="#cb10-181" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üö® INTERRUP√á√ÉO DE EMERG√äNCIA - Terminando processos...&quot;</span>)</span>
<span id="cb10-182"><a href="#cb10-182" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-183"><a href="#cb10-183" aria-hidden="true" tabindex="-1"></a>    _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb10-184"><a href="#cb10-184" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-185"><a href="#cb10-185" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sinalizar parada para todos os processos</span></span>
<span id="cb10-186"><a href="#cb10-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _stop_event:</span>
<span id="cb10-187"><a href="#cb10-187" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb10-188"><a href="#cb10-188" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-189"><a href="#cb10-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parar pool AGressivamente</span></span>
<span id="cb10-190"><a href="#cb10-190" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _pool:</span>
<span id="cb10-191"><a href="#cb10-191" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb10-192"><a href="#cb10-192" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;üõë Terminando pool de workers...&quot;</span>)</span>
<span id="cb10-193"><a href="#cb10-193" aria-hidden="true" tabindex="-1"></a>            _pool.terminate()</span>
<span id="cb10-194"><a href="#cb10-194" aria-hidden="true" tabindex="-1"></a>            _pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb10-195"><a href="#cb10-195" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb10-196"><a href="#cb10-196" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb10-197"><a href="#cb10-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-198"><a href="#cb10-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Terminar processos filhos de forma agressiva</span></span>
<span id="cb10-199"><a href="#cb10-199" aria-hidden="true" tabindex="-1"></a>    current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb10-200"><a href="#cb10-200" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-201"><a href="#cb10-201" aria-hidden="true" tabindex="-1"></a>        parent <span class="op">=</span> psutil.Process(current_pid)</span>
<span id="cb10-202"><a href="#cb10-202" aria-hidden="true" tabindex="-1"></a>        children <span class="op">=</span> parent.children(recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-203"><a href="#cb10-203" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üî™ Terminando </span><span class="sc">{</span><span class="bu">len</span>(children)<span class="sc">}</span><span class="ss"> processos filhos...&quot;</span>)</span>
<span id="cb10-204"><a href="#cb10-204" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-205"><a href="#cb10-205" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> child <span class="kw">in</span> children:</span>
<span id="cb10-206"><a href="#cb10-206" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb10-207"><a href="#cb10-207" aria-hidden="true" tabindex="-1"></a>                child_pid <span class="op">=</span> child.pid</span>
<span id="cb10-208"><a href="#cb10-208" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> child_pid <span class="op">!=</span> current_pid <span class="kw">and</span> child_pid <span class="kw">in</span> _active_processes:</span>
<span id="cb10-209"><a href="#cb10-209" aria-hidden="true" tabindex="-1"></a>                    child.kill()</span>
<span id="cb10-210"><a href="#cb10-210" aria-hidden="true" tabindex="-1"></a>                    _active_processes.discard(child_pid)</span>
<span id="cb10-211"><a href="#cb10-211" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb10-212"><a href="#cb10-212" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb10-213"><a href="#cb10-213" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb10-214"><a href="#cb10-214" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb10-215"><a href="#cb10-215" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-216"><a href="#cb10-216" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza final de processos √≥rf√£os</span></span>
<span id="cb10-217"><a href="#cb10-217" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb10-218"><a href="#cb10-218" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-219"><a href="#cb10-219" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üíÄ TODOS OS PROCESSOS FORAM TERMINADOS&quot;</span>)</span>
<span id="cb10-220"><a href="#cb10-220" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è PROGRAMA INTERROMPIDO PELO UTILIZADOR&quot;</span>)</span>
<span id="cb10-221"><a href="#cb10-221" aria-hidden="true" tabindex="-1"></a>    os._exit(<span class="dv">1</span>)  <span class="co"># Sa√≠da de emerg√™ncia</span></span>
<span id="cb10-222"><a href="#cb10-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-223"><a href="#cb10-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-224"><a href="#cb10-224" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-225"><a href="#cb10-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Worker de processamento OTIMIZADO - REUTILIZA BROWSER POR PROCESSO</span></span>
<span id="cb10-226"><a href="#cb10-226" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-227"><a href="#cb10-227" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_process_batch_optimized(batch_files, pdf_dir, timeout, headless, force_overwrite, retry_count, stop_event, msg_queue):</span>
<span id="cb10-228"><a href="#cb10-228" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Worker OTIMIZADO que reutiliza uma inst√¢ncia do Chromium por processo&quot;&quot;&quot;</span></span>
<span id="cb10-229"><a href="#cb10-229" aria-hidden="true" tabindex="-1"></a>    my_pid <span class="op">=</span> os.getpid()</span>
<span id="cb10-230"><a href="#cb10-230" aria-hidden="true" tabindex="-1"></a>    _active_processes.add(my_pid)</span>
<span id="cb10-231"><a href="#cb10-231" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-232"><a href="#cb10-232" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-233"><a href="#cb10-233" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb10-234"><a href="#cb10-234" aria-hidden="true" tabindex="-1"></a>        out_dir <span class="op">=</span> Path(pdf_dir)</span>
<span id="cb10-235"><a href="#cb10-235" aria-hidden="true" tabindex="-1"></a>        out_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-236"><a href="#cb10-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-237"><a href="#cb10-237" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verificar parada ANTES de iniciar o browser</span></span>
<span id="cb10-238"><a href="#cb10-238" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb10-239"><a href="#cb10-239" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb10-240"><a href="#cb10-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-241"><a href="#cb10-241" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb10-242"><a href="#cb10-242" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Configura√ß√£o OTIMIZADA do browser - UMA INST√ÇNCIA POR PROCESSO</span></span>
<span id="cb10-243"><a href="#cb10-243" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb10-244"><a href="#cb10-244" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless,</span>
<span id="cb10-245"><a href="#cb10-245" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb10-246"><a href="#cb10-246" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb10-247"><a href="#cb10-247" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb10-248"><a href="#cb10-248" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb10-249"><a href="#cb10-249" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb10-250"><a href="#cb10-250" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span>,</span>
<span id="cb10-251"><a href="#cb10-251" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-first-run&#39;</span>,</span>
<span id="cb10-252"><a href="#cb10-252" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-default-browser-check&#39;</span>,</span>
<span id="cb10-253"><a href="#cb10-253" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-default-apps&#39;</span>,</span>
<span id="cb10-254"><a href="#cb10-254" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-translate&#39;</span>,</span>
<span id="cb10-255"><a href="#cb10-255" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-extensions&#39;</span></span>
<span id="cb10-256"><a href="#cb10-256" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb10-257"><a href="#cb10-257" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb10-258"><a href="#cb10-258" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-259"><a href="#cb10-259" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_path_str <span class="kw">in</span> batch_files:</span>
<span id="cb10-260"><a href="#cb10-260" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb10-261"><a href="#cb10-261" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb10-262"><a href="#cb10-262" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb10-263"><a href="#cb10-263" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb10-264"><a href="#cb10-264" aria-hidden="true" tabindex="-1"></a>                html_path <span class="op">=</span> Path(html_path_str)</span>
<span id="cb10-265"><a href="#cb10-265" aria-hidden="true" tabindex="-1"></a>                pdf_path <span class="op">=</span> out_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb10-266"><a href="#cb10-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-267"><a href="#cb10-267" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> pdf_path.exists() <span class="kw">and</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb10-268"><a href="#cb10-268" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;J√° existe&quot;</span>))</span>
<span id="cb10-269"><a href="#cb10-269" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;skip&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb10-270"><a href="#cb10-270" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb10-271"><a href="#cb10-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-272"><a href="#cb10-272" aria-hidden="true" tabindex="-1"></a>                success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb10-273"><a href="#cb10-273" aria-hidden="true" tabindex="-1"></a>                last_error <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb10-274"><a href="#cb10-274" aria-hidden="true" tabindex="-1"></a>                context <span class="op">=</span> <span class="va">None</span></span>
<span id="cb10-275"><a href="#cb10-275" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-276"><a href="#cb10-276" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(retry_count):</span>
<span id="cb10-277"><a href="#cb10-277" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb10-278"><a href="#cb10-278" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb10-279"><a href="#cb10-279" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb10-280"><a href="#cb10-280" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb10-281"><a href="#cb10-281" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb10-282"><a href="#cb10-282" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># NOVO CONTEXT por arquivo (mas mesmo browser)</span></span>
<span id="cb10-283"><a href="#cb10-283" aria-hidden="true" tabindex="-1"></a>                        context <span class="op">=</span> browser.new_context(</span>
<span id="cb10-284"><a href="#cb10-284" aria-hidden="true" tabindex="-1"></a>                            viewport<span class="op">=</span>{<span class="st">&#39;width&#39;</span>: <span class="dv">1920</span>, <span class="st">&#39;height&#39;</span>: <span class="dv">1080</span>},</span>
<span id="cb10-285"><a href="#cb10-285" aria-hidden="true" tabindex="-1"></a>                            ignore_https_errors<span class="op">=</span><span class="va">True</span></span>
<span id="cb10-286"><a href="#cb10-286" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb10-287"><a href="#cb10-287" aria-hidden="true" tabindex="-1"></a>                        page <span class="op">=</span> context.new_page()</span>
<span id="cb10-288"><a href="#cb10-288" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb10-289"><a href="#cb10-289" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Timeouts otimizados</span></span>
<span id="cb10-290"><a href="#cb10-290" aria-hidden="true" tabindex="-1"></a>                        page.set_default_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb10-291"><a href="#cb10-291" aria-hidden="true" tabindex="-1"></a>                        page.set_default_navigation_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb10-292"><a href="#cb10-292" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb10-293"><a href="#cb10-293" aria-hidden="true" tabindex="-1"></a>                        full_path <span class="op">=</span> <span class="ss">f&quot;file:///</span><span class="sc">{</span>html_path<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb10-294"><a href="#cb10-294" aria-hidden="true" tabindex="-1"></a>                        page.goto(full_path, wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>, timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb10-295"><a href="#cb10-295" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb10-296"><a href="#cb10-296" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada DURANTE o carregamento</span></span>
<span id="cb10-297"><a href="#cb10-297" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb10-298"><a href="#cb10-298" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb10-299"><a href="#cb10-299" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb10-300"><a href="#cb10-300" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Wait for complete load - MAIS CONFI√ÅVEL</span></span>
<span id="cb10-301"><a href="#cb10-301" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_function(</span>
<span id="cb10-302"><a href="#cb10-302" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;document.readyState === &quot;complete&quot;&#39;</span>,</span>
<span id="cb10-303"><a href="#cb10-303" aria-hidden="true" tabindex="-1"></a>                            timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb10-304"><a href="#cb10-304" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb10-305"><a href="#cb10-305" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb10-306"><a href="#cb10-306" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada DURANTE a espera</span></span>
<span id="cb10-307"><a href="#cb10-307" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb10-308"><a href="#cb10-308" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb10-309"><a href="#cb10-309" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb10-310"><a href="#cb10-310" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Pequena espera para conte√∫do din√¢mico</span></span>
<span id="cb10-311"><a href="#cb10-311" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_timeout(<span class="dv">500</span>)</span>
<span id="cb10-312"><a href="#cb10-312" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb10-313"><a href="#cb10-313" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada ANTES do PDF</span></span>
<span id="cb10-314"><a href="#cb10-314" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb10-315"><a href="#cb10-315" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb10-316"><a href="#cb10-316" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb10-317"><a href="#cb10-317" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Gera√ß√£o de PDF com configura√ß√µes OTIMIZADAS</span></span>
<span id="cb10-318"><a href="#cb10-318" aria-hidden="true" tabindex="-1"></a>                        page.pdf(</span>
<span id="cb10-319"><a href="#cb10-319" aria-hidden="true" tabindex="-1"></a>                            path<span class="op">=</span><span class="bu">str</span>(pdf_path),</span>
<span id="cb10-320"><a href="#cb10-320" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>,</span>
<span id="cb10-321"><a href="#cb10-321" aria-hidden="true" tabindex="-1"></a>                            print_background<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb10-322"><a href="#cb10-322" aria-hidden="true" tabindex="-1"></a>                            margin<span class="op">=</span>{<span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span>},</span>
<span id="cb10-323"><a href="#cb10-323" aria-hidden="true" tabindex="-1"></a>                            prefer_css_page_size<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb10-324"><a href="#cb10-324" aria-hidden="true" tabindex="-1"></a>                            display_header_footer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb10-325"><a href="#cb10-325" aria-hidden="true" tabindex="-1"></a>                            scale<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb10-326"><a href="#cb10-326" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb10-327"><a href="#cb10-327" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb10-328"><a href="#cb10-328" aria-hidden="true" tabindex="-1"></a>                        success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb10-329"><a href="#cb10-329" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;ok&quot;</span>, pdf_path.name))</span>
<span id="cb10-330"><a href="#cb10-330" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb10-331"><a href="#cb10-331" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb10-332"><a href="#cb10-332" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb10-333"><a href="#cb10-333" aria-hidden="true" tabindex="-1"></a>                        last_error <span class="op">=</span> <span class="bu">str</span>(e)</span>
<span id="cb10-334"><a href="#cb10-334" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># N√£o reportar retry se foi por interrup√ß√£o</span></span>
<span id="cb10-335"><a href="#cb10-335" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb10-336"><a href="#cb10-336" aria-hidden="true" tabindex="-1"></a>                            msg_queue.put((<span class="st">&quot;retry&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb10-337"><a href="#cb10-337" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="op">-</span> <span class="dv">1</span> <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb10-338"><a href="#cb10-338" aria-hidden="true" tabindex="-1"></a>                            time.sleep(<span class="dv">1</span>)  <span class="co"># Pequena pausa entre tentativas</span></span>
<span id="cb10-339"><a href="#cb10-339" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">finally</span>:</span>
<span id="cb10-340"><a href="#cb10-340" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> context:</span>
<span id="cb10-341"><a href="#cb10-341" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">try</span>:</span>
<span id="cb10-342"><a href="#cb10-342" aria-hidden="true" tabindex="-1"></a>                                context.close()</span>
<span id="cb10-343"><a href="#cb10-343" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">except</span>:</span>
<span id="cb10-344"><a href="#cb10-344" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">pass</span></span>
<span id="cb10-345"><a href="#cb10-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-346"><a href="#cb10-346" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Se foi interrompido, sair imediatamente</span></span>
<span id="cb10-347"><a href="#cb10-347" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb10-348"><a href="#cb10-348" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb10-349"><a href="#cb10-349" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb10-350"><a href="#cb10-350" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> success <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb10-351"><a href="#cb10-351" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;fail&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>last_error<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb10-352"><a href="#cb10-352" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">False</span>, last_error))</span>
<span id="cb10-353"><a href="#cb10-353" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> success:</span>
<span id="cb10-354"><a href="#cb10-354" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;Sucesso&quot;</span>))</span>
<span id="cb10-355"><a href="#cb10-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-356"><a href="#cb10-356" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fechar browser ao final do batch</span></span>
<span id="cb10-357"><a href="#cb10-357" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb10-358"><a href="#cb10-358" aria-hidden="true" tabindex="-1"></a>                browser.close()</span>
<span id="cb10-359"><a href="#cb10-359" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb10-360"><a href="#cb10-360" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb10-361"><a href="#cb10-361" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-362"><a href="#cb10-362" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb10-363"><a href="#cb10-363" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb10-364"><a href="#cb10-364" aria-hidden="true" tabindex="-1"></a>            msg_queue.put((<span class="st">&quot;error&quot;</span>, <span class="ss">f&quot;Erro no worker: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb10-365"><a href="#cb10-365" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb10-366"><a href="#cb10-366" aria-hidden="true" tabindex="-1"></a>        _active_processes.discard(my_pid)</span>
<span id="cb10-367"><a href="#cb10-367" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-368"><a href="#cb10-368" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb10-369"><a href="#cb10-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-370"><a href="#cb10-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-371"><a href="#cb10-371" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_wrapper_optimized(args):</span>
<span id="cb10-372"><a href="#cb10-372" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Wrapper para o worker otimizado&quot;&quot;&quot;</span></span>
<span id="cb10-373"><a href="#cb10-373" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-374"><a href="#cb10-374" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> worker_process_batch_optimized(<span class="op">*</span>args)</span>
<span id="cb10-375"><a href="#cb10-375" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb10-376"><a href="#cb10-376" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb10-377"><a href="#cb10-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-378"><a href="#cb10-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-379"><a href="#cb10-379" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-380"><a href="#cb10-380" aria-hidden="true" tabindex="-1"></a><span class="co"># Listener de mensagens APRIMORADO</span></span>
<span id="cb10-381"><a href="#cb10-381" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-382"><a href="#cb10-382" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> queue_listener_optimized(msg_queue, listener_stop_flag, total_files):</span>
<span id="cb10-383"><a href="#cb10-383" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Listener com barra de progresso e estat√≠sticas&quot;&quot;&quot;</span></span>
<span id="cb10-384"><a href="#cb10-384" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb10-385"><a href="#cb10-385" aria-hidden="true" tabindex="-1"></a>    processed <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-386"><a href="#cb10-386" aria-hidden="true" tabindex="-1"></a>    successes <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-387"><a href="#cb10-387" aria-hidden="true" tabindex="-1"></a>    skips <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-388"><a href="#cb10-388" aria-hidden="true" tabindex="-1"></a>    failures <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb10-389"><a href="#cb10-389" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-390"><a href="#cb10-390" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> listener_stop_flag.is_set():</span>
<span id="cb10-391"><a href="#cb10-391" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb10-392"><a href="#cb10-392" aria-hidden="true" tabindex="-1"></a>            obj <span class="op">=</span> msg_queue.get(timeout<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb10-393"><a href="#cb10-393" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb10-394"><a href="#cb10-394" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb10-395"><a href="#cb10-395" aria-hidden="true" tabindex="-1"></a>            typ, text <span class="op">=</span> obj</span>
<span id="cb10-396"><a href="#cb10-396" aria-hidden="true" tabindex="-1"></a>            processed <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-397"><a href="#cb10-397" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-398"><a href="#cb10-398" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> typ <span class="op">==</span> <span class="st">&quot;ok&quot;</span>:</span>
<span id="cb10-399"><a href="#cb10-399" aria-hidden="true" tabindex="-1"></a>                successes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-400"><a href="#cb10-400" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-401"><a href="#cb10-401" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;skip&quot;</span>:</span>
<span id="cb10-402"><a href="#cb10-402" aria-hidden="true" tabindex="-1"></a>                skips <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-403"><a href="#cb10-403" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚è≠Ô∏è </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-404"><a href="#cb10-404" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;fail&quot;</span>:</span>
<span id="cb10-405"><a href="#cb10-405" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-406"><a href="#cb10-406" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚ùå </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-407"><a href="#cb10-407" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;error&quot;</span>:</span>
<span id="cb10-408"><a href="#cb10-408" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-409"><a href="#cb10-409" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üö´ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-410"><a href="#cb10-410" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;retry&quot;</span>:</span>
<span id="cb10-411"><a href="#cb10-411" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üîÑ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-412"><a href="#cb10-412" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-413"><a href="#cb10-413" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Mostrar progresso a cada 5 arquivos para feedback mais frequente</span></span>
<span id="cb10-414"><a href="#cb10-414" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> processed <span class="op">%</span> <span class="dv">5</span> <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> processed <span class="op">==</span> total_files:</span>
<span id="cb10-415"><a href="#cb10-415" aria-hidden="true" tabindex="-1"></a>                elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb10-416"><a href="#cb10-416" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> successes <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb10-417"><a href="#cb10-417" aria-hidden="true" tabindex="-1"></a>                    rate <span class="op">=</span> successes <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb10-418"><a href="#cb10-418" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f&quot;üìä Progresso: </span><span class="sc">{</span>successes<span class="op">+</span>skips<span class="op">+</span>failures<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_files<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb10-419"><a href="#cb10-419" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;‚úÖ</span><span class="sc">{</span>successes<span class="sc">}</span><span class="ss"> ‚è≠Ô∏è</span><span class="sc">{</span>skips<span class="sc">}</span><span class="ss"> ‚ùå</span><span class="sc">{</span>failures<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb10-420"><a href="#cb10-420" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;</span><span class="sc">{</span>rate<span class="sc">:.1f}</span><span class="ss"> PDFs/min&quot;</span>)</span>
<span id="cb10-421"><a href="#cb10-421" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb10-422"><a href="#cb10-422" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb10-423"><a href="#cb10-423" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb10-424"><a href="#cb10-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-425"><a href="#cb10-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-426"><a href="#cb10-426" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-427"><a href="#cb10-427" aria-hidden="true" tabindex="-1"></a><span class="co"># Convers√£o principal - VERS√ÉO ALTAMENTE OTIMIZADA</span></span>
<span id="cb10-428"><a href="#cb10-428" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-429"><a href="#cb10-429" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_pdfs_optimized(source_dir, output_dir, workers, batch_size, headless, timeout,</span>
<span id="cb10-430"><a href="#cb10-430" aria-hidden="true" tabindex="-1"></a>                           force_overwrite, dry_run, single_file<span class="op">=</span><span class="va">None</span>, retry_count<span class="op">=</span><span class="dv">2</span>, benchmark<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb10-431"><a href="#cb10-431" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Fun√ß√£o principal OTIMIZADA com interrup√ß√£o robusta e performance m√°xima&quot;&quot;&quot;</span></span>
<span id="cb10-432"><a href="#cb10-432" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop, _stop_event, _pool</span>
<span id="cb10-433"><a href="#cb10-433" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-434"><a href="#cb10-434" aria-hidden="true" tabindex="-1"></a>    src <span class="op">=</span> Path(source_dir)</span>
<span id="cb10-435"><a href="#cb10-435" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> Path(output_dir)</span>
<span id="cb10-436"><a href="#cb10-436" aria-hidden="true" tabindex="-1"></a>    out.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-437"><a href="#cb10-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-438"><a href="#cb10-438" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> single_file:</span>
<span id="cb10-439"><a href="#cb10-439" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [<span class="bu">str</span>(src <span class="op">/</span> single_file)]</span>
<span id="cb10-440"><a href="#cb10-440" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> Path(html_files[<span class="dv">0</span>]).exists():</span>
<span id="cb10-441"><a href="#cb10-441" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Arquivo n√£o encontrado: </span><span class="sc">{</span>single_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-442"><a href="#cb10-442" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb10-443"><a href="#cb10-443" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-444"><a href="#cb10-444" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> <span class="bu">sorted</span>([<span class="bu">str</span>(p) <span class="cf">for</span> p <span class="kw">in</span> src.glob(<span class="st">&quot;*.html&quot;</span>)])</span>
<span id="cb10-445"><a href="#cb10-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-446"><a href="#cb10-446" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb10-447"><a href="#cb10-447" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Nenhum arquivo HTML encontrado.&quot;</span>)</span>
<span id="cb10-448"><a href="#cb10-448" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb10-449"><a href="#cb10-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-450"><a href="#cb10-450" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üéØ Encontrados </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos HTML&quot;</span>)</span>
<span id="cb10-451"><a href="#cb10-451" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>workers<span class="sc">}</span><span class="ss"> | Batch: </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb10-452"><a href="#cb10-452" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss"> tentativas por arquivo&quot;</span>)</span>
<span id="cb10-453"><a href="#cb10-453" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;‚èπÔ∏è  Pressione Ctrl+C para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb10-454"><a href="#cb10-454" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-455"><a href="#cb10-455" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MOSTRAR M√âTODO DE CONVERS√ÉO UTILIZADO</span></span>
<span id="cb10-456"><a href="#cb10-456" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîÑ M√âTODO DE CONVERS√ÉO:&quot;</span>)</span>
<span id="cb10-457"><a href="#cb10-457" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Playwright + Chromium headless&quot;</span>)</span>
<span id="cb10-458"><a href="#cb10-458" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ 1 inst√¢ncia do browser por processo worker&quot;</span>)</span>
<span id="cb10-459"><a href="#cb10-459" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Contexto separado por arquivo HTML&quot;</span>)</span>
<span id="cb10-460"><a href="#cb10-460" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Paralelismo seguro com multiprocessing.Pool&quot;</span>)</span>
<span id="cb10-461"><a href="#cb10-461" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Sistema de retry com m√∫ltiplas tentativas&quot;</span>)</span>
<span id="cb10-462"><a href="#cb10-462" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Timeouts configur√°veis por p√°gina&quot;</span>)</span>
<span id="cb10-463"><a href="#cb10-463" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ INTERRUP√á√ÉO IMEDIATA via Ctrl+C (SIGINT)</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb10-464"><a href="#cb10-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-465"><a href="#cb10-465" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dry_run:</span>
<span id="cb10-466"><a href="#cb10-466" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ MODO SIMULA√á√ÉO - Nenhum arquivo ser√° criado&quot;</span>)</span>
<span id="cb10-467"><a href="#cb10-467" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> html_files[:<span class="dv">5</span>]:</span>
<span id="cb10-468"><a href="#cb10-468" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   üìÑ </span><span class="sc">{</span>Path(f)<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-469"><a href="#cb10-469" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(html_files) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb10-470"><a href="#cb10-470" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(html_files) <span class="op">-</span> <span class="dv">5</span><span class="sc">}</span><span class="ss"> arquivos&quot;</span>)</span>
<span id="cb10-471"><a href="#cb10-471" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb10-472"><a href="#cb10-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-473"><a href="#cb10-473" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb10-474"><a href="#cb10-474" aria-hidden="true" tabindex="-1"></a>        original_count <span class="op">=</span> <span class="bu">len</span>(html_files)</span>
<span id="cb10-475"><a href="#cb10-475" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> html_files <span class="cf">if</span> <span class="kw">not</span> (out <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>Path(f)<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span>).exists()]</span>
<span id="cb10-476"><a href="#cb10-476" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üÜï </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos novos para processar (de </span><span class="sc">{</span>original_count<span class="sc">}</span><span class="ss"> total)&quot;</span>)</span>
<span id="cb10-477"><a href="#cb10-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-478"><a href="#cb10-478" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb10-479"><a href="#cb10-479" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Nenhum arquivo novo para processar&quot;</span>)</span>
<span id="cb10-480"><a href="#cb10-480" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb10-481"><a href="#cb10-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-482"><a href="#cb10-482" aria-hidden="true" tabindex="-1"></a>    batches <span class="op">=</span> chunkify(html_files, batch_size)</span>
<span id="cb10-483"><a href="#cb10-483" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üì¶ </span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> batches preparados&quot;</span>)</span>
<span id="cb10-484"><a href="#cb10-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-485"><a href="#cb10-485" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sistema de comunica√ß√£o OTIMIZADO</span></span>
<span id="cb10-486"><a href="#cb10-486" aria-hidden="true" tabindex="-1"></a>    manager <span class="op">=</span> multiprocessing.Manager()</span>
<span id="cb10-487"><a href="#cb10-487" aria-hidden="true" tabindex="-1"></a>    _stop_event <span class="op">=</span> manager.Event()</span>
<span id="cb10-488"><a href="#cb10-488" aria-hidden="true" tabindex="-1"></a>    msg_queue <span class="op">=</span> manager.Queue()</span>
<span id="cb10-489"><a href="#cb10-489" aria-hidden="true" tabindex="-1"></a>    listener_stop_flag <span class="op">=</span> threading.Event()</span>
<span id="cb10-490"><a href="#cb10-490" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-491"><a href="#cb10-491" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Listener COM ESTAT√çSTICAS</span></span>
<span id="cb10-492"><a href="#cb10-492" aria-hidden="true" tabindex="-1"></a>    listener_thread <span class="op">=</span> threading.Thread(</span>
<span id="cb10-493"><a href="#cb10-493" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>queue_listener_optimized, </span>
<span id="cb10-494"><a href="#cb10-494" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(msg_queue, listener_stop_flag, <span class="bu">len</span>(html_files)), </span>
<span id="cb10-495"><a href="#cb10-495" aria-hidden="true" tabindex="-1"></a>        daemon<span class="op">=</span><span class="va">True</span></span>
<span id="cb10-496"><a href="#cb10-496" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-497"><a href="#cb10-497" aria-hidden="true" tabindex="-1"></a>    listener_thread.start()</span>
<span id="cb10-498"><a href="#cb10-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-499"><a href="#cb10-499" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparar argumentos</span></span>
<span id="cb10-500"><a href="#cb10-500" aria-hidden="true" tabindex="-1"></a>    args_list <span class="op">=</span> [</span>
<span id="cb10-501"><a href="#cb10-501" aria-hidden="true" tabindex="-1"></a>        (batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, _stop_event, msg_queue) </span>
<span id="cb10-502"><a href="#cb10-502" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> batches</span>
<span id="cb10-503"><a href="#cb10-503" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb10-504"><a href="#cb10-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-505"><a href="#cb10-505" aria-hidden="true" tabindex="-1"></a>    success_count, failed <span class="op">=</span> <span class="dv">0</span>, []</span>
<span id="cb10-506"><a href="#cb10-506" aria-hidden="true" tabindex="-1"></a>    _pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb10-507"><a href="#cb10-507" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb10-508"><a href="#cb10-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-509"><a href="#cb10-509" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-510"><a href="#cb10-510" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Criar pool com n√∫mero OTIMIZADO de workers</span></span>
<span id="cb10-511"><a href="#cb10-511" aria-hidden="true" tabindex="-1"></a>        _pool <span class="op">=</span> multiprocessing.Pool(processes<span class="op">=</span>workers)</span>
<span id="cb10-512"><a href="#cb10-512" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-513"><a href="#cb10-513" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üîÑ Iniciando convers√£o OTIMIZADA...&quot;</span>)</span>
<span id="cb10-514"><a href="#cb10-514" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üí° Dica: Pressione Ctrl+C a qualquer momento para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb10-515"><a href="#cb10-515" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-516"><a href="#cb10-516" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Processar batches - com verifica√ß√£o CONSTANTE de parada</span></span>
<span id="cb10-517"><a href="#cb10-517" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, result <span class="kw">in</span> <span class="bu">enumerate</span>(_pool.imap_unordered(worker_wrapper_optimized, args_list)):</span>
<span id="cb10-518"><a href="#cb10-518" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb10-519"><a href="#cb10-519" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> _stop_event.is_set():</span>
<span id="cb10-520"><a href="#cb10-520" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üõë Parada de emerg√™ncia ativada durante o processamento!&quot;</span>)</span>
<span id="cb10-521"><a href="#cb10-521" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb10-522"><a href="#cb10-522" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb10-523"><a href="#cb10-523" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Relat√≥rio de progresso por batch</span></span>
<span id="cb10-524"><a href="#cb10-524" aria-hidden="true" tabindex="-1"></a>            batch_progress <span class="op">=</span> <span class="ss">f&quot;üì¶ Batch </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> processado&quot;</span></span>
<span id="cb10-525"><a href="#cb10-525" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(result) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb10-526"><a href="#cb10-526" aria-hidden="true" tabindex="-1"></a>                batch_success <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> _, success, _ <span class="kw">in</span> result <span class="cf">if</span> success)</span>
<span id="cb10-527"><a href="#cb10-527" aria-hidden="true" tabindex="-1"></a>                batch_progress <span class="op">+=</span> <span class="ss">f&quot; - ‚úÖ </span><span class="sc">{</span>batch_success<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(result)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb10-528"><a href="#cb10-528" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(batch_progress)</span>
<span id="cb10-529"><a href="#cb10-529" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-530"><a href="#cb10-530" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_file, success, msg <span class="kw">in</span> result:</span>
<span id="cb10-531"><a href="#cb10-531" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> success:</span>
<span id="cb10-532"><a href="#cb10-532" aria-hidden="true" tabindex="-1"></a>                    success_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb10-533"><a href="#cb10-533" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb10-534"><a href="#cb10-534" aria-hidden="true" tabindex="-1"></a>                    failed.append((Path(html_file).name, msg))</span>
<span id="cb10-535"><a href="#cb10-535" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb10-536"><a href="#cb10-536" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verifica√ß√£o de parada entre batches</span></span>
<span id="cb10-537"><a href="#cb10-537" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> _stop_event.is_set():</span>
<span id="cb10-538"><a href="#cb10-538" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb10-539"><a href="#cb10-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-540"><a href="#cb10-540" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb10-541"><a href="#cb10-541" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO POR TECLADO DETECTADA !!!&quot;</span>)</span>
<span id="cb10-542"><a href="#cb10-542" aria-hidden="true" tabindex="-1"></a>        _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb10-543"><a href="#cb10-543" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb10-544"><a href="#cb10-544" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb10-545"><a href="#cb10-545" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Erro no pool principal: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-546"><a href="#cb10-546" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb10-547"><a href="#cb10-547" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb10-548"><a href="#cb10-548" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üßπ LIMPEZA FINAL EM ANDAMENTO...&quot;</span>)</span>
<span id="cb10-549"><a href="#cb10-549" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-550"><a href="#cb10-550" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sinalizar parada para todos</span></span>
<span id="cb10-551"><a href="#cb10-551" aria-hidden="true" tabindex="-1"></a>        _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb10-552"><a href="#cb10-552" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb10-553"><a href="#cb10-553" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-554"><a href="#cb10-554" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parar listener</span></span>
<span id="cb10-555"><a href="#cb10-555" aria-hidden="true" tabindex="-1"></a>        listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb10-556"><a href="#cb10-556" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb10-557"><a href="#cb10-557" aria-hidden="true" tabindex="-1"></a>            msg_queue.put(<span class="va">None</span>)</span>
<span id="cb10-558"><a href="#cb10-558" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb10-559"><a href="#cb10-559" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb10-560"><a href="#cb10-560" aria-hidden="true" tabindex="-1"></a>        listener_thread.join(timeout<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb10-561"><a href="#cb10-561" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-562"><a href="#cb10-562" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Terminar pool AGressivamente</span></span>
<span id="cb10-563"><a href="#cb10-563" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> _pool:</span>
<span id="cb10-564"><a href="#cb10-564" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb10-565"><a href="#cb10-565" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üî™ Terminando pool de workers...&quot;</span>)</span>
<span id="cb10-566"><a href="#cb10-566" aria-hidden="true" tabindex="-1"></a>                _pool.terminate()</span>
<span id="cb10-567"><a href="#cb10-567" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb10-568"><a href="#cb10-568" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb10-569"><a href="#cb10-569" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb10-570"><a href="#cb10-570" aria-hidden="true" tabindex="-1"></a>                _pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb10-571"><a href="#cb10-571" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb10-572"><a href="#cb10-572" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb10-573"><a href="#cb10-573" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-574"><a href="#cb10-574" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final agressiva</span></span>
<span id="cb10-575"><a href="#cb10-575" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üóëÔ∏è  Limpando processos √≥rf√£os...&quot;</span>)</span>
<span id="cb10-576"><a href="#cb10-576" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb10-577"><a href="#cb10-577" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-578"><a href="#cb10-578" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pequena pausa para garantir que tudo foi limpo</span></span>
<span id="cb10-579"><a href="#cb10-579" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb10-580"><a href="#cb10-580" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Limpeza conclu√≠da&quot;</span>)</span>
<span id="cb10-581"><a href="#cb10-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-582"><a href="#cb10-582" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Relat√≥rio DETALHADO (apenas se n√£o foi interrompido abruptamente)</span></span>
<span id="cb10-583"><a href="#cb10-583" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> _should_stop <span class="kw">or</span> success_count <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb10-584"><a href="#cb10-584" aria-hidden="true" tabindex="-1"></a>        elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb10-585"><a href="#cb10-585" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;=&quot;</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb10-586"><a href="#cb10-586" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üìä RELAT√ìRIO FINAL OTIMIZADO:&quot;</span>)</span>
<span id="cb10-587"><a href="#cb10-587" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot; ‚úÖ Sucessos: </span><span class="sc">{</span>success_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-588"><a href="#cb10-588" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot; ‚ùå Falhas: </span><span class="sc">{</span><span class="bu">len</span>(failed)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-589"><a href="#cb10-589" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-590"><a href="#cb10-590" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> failed <span class="kw">and</span> <span class="kw">not</span> _should_stop:</span>
<span id="cb10-591"><a href="#cb10-591" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üìã Arquivos com falha (primeiros 10):&quot;</span>)</span>
<span id="cb10-592"><a href="#cb10-592" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> fname, error <span class="kw">in</span> failed[:<span class="dv">10</span>]:</span>
<span id="cb10-593"><a href="#cb10-593" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;   ‚Ä£ </span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-594"><a href="#cb10-594" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(failed) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb10-595"><a href="#cb10-595" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(failed) <span class="op">-</span> <span class="dv">10</span><span class="sc">}</span><span class="ss"> falhas&quot;</span>)</span>
<span id="cb10-596"><a href="#cb10-596" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-597"><a href="#cb10-597" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> benchmark <span class="kw">and</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb10-598"><a href="#cb10-598" aria-hidden="true" tabindex="-1"></a>            rate_total <span class="op">=</span> <span class="bu">len</span>(html_files) <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb10-599"><a href="#cb10-599" aria-hidden="true" tabindex="-1"></a>            rate_success <span class="op">=</span> success_count <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb10-600"><a href="#cb10-600" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚è±Ô∏è  Tempo total: </span><span class="sc">{</span>elapsed<span class="sc">:.1f}</span><span class="ss">s&quot;</span>)</span>
<span id="cb10-601"><a href="#cb10-601" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_total<span class="sc">:.1f}</span><span class="ss"> PDFs/min (total)&quot;</span>)</span>
<span id="cb10-602"><a href="#cb10-602" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_success<span class="sc">:.1f}</span><span class="ss"> PDFs/min (sucessos)&quot;</span>)</span>
<span id="cb10-603"><a href="#cb10-603" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-604"><a href="#cb10-604" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="kw">not</span> _should_stop</span>
<span id="cb10-605"><a href="#cb10-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-606"><a href="#cb10-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-607"><a href="#cb10-607" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-608"><a href="#cb10-608" aria-hidden="true" tabindex="-1"></a><span class="co"># CLI OTIMIZADA</span></span>
<span id="cb10-609"><a href="#cb10-609" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-610"><a href="#cb10-610" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args():</span>
<span id="cb10-611"><a href="#cb10-611" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(</span>
<span id="cb10-612"><a href="#cb10-612" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">&quot;Convers√£o HTML ‚Üí PDF ALTAMENTE OTIMIZADA com INTERRUP√á√ÉO IMEDIATA&quot;</span></span>
<span id="cb10-613"><a href="#cb10-613" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-614"><a href="#cb10-614" aria-hidden="true" tabindex="-1"></a>    group <span class="op">=</span> parser.add_mutually_exclusive_group()</span>
<span id="cb10-615"><a href="#cb10-615" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--force&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Sobrescreve PDFs j√° existentes&quot;</span>)</span>
<span id="cb10-616"><a href="#cb10-616" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--only-new&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, default<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Apenas novos (padr√£o)&quot;</span>)</span>
<span id="cb10-617"><a href="#cb10-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-618"><a href="#cb10-618" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--dry-run&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Simula sem criar arquivos&quot;</span>)</span>
<span id="cb10-619"><a href="#cb10-619" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--source&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_html&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta com arquivos .html&quot;</span>)</span>
<span id="cb10-620"><a href="#cb10-620" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--output&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_pdfs&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta de sa√≠da para PDFs&quot;</span>)</span>
<span id="cb10-621"><a href="#cb10-621" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb10-622"><a href="#cb10-622" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos (padr√£o: 2 otimizado para estabilidade)&quot;</span>)</span>
<span id="cb10-623"><a href="#cb10-623" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--batch-size&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">3</span>, </span>
<span id="cb10-624"><a href="#cb10-624" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Arquivos por batch (padr√£o: 3 para resposta r√°pida)&quot;</span>)</span>
<span id="cb10-625"><a href="#cb10-625" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--no-headless&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra navegador (debug)&quot;</span>)</span>
<span id="cb10-626"><a href="#cb10-626" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--single-file&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Converte apenas um arquivo HTML espec√≠fico&quot;</span>)</span>
<span id="cb10-627"><a href="#cb10-627" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--timeout&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">50</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Timeout por p√°gina (padr√£o: 50 segundos)&quot;</span>)</span>
<span id="cb10-628"><a href="#cb10-628" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--retry-count&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Tentativas por arquivo (padr√£o: 2)&quot;</span>)</span>
<span id="cb10-629"><a href="#cb10-629" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--benchmark&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra tempo total e PDFs/minuto&quot;</span>)</span>
<span id="cb10-630"><a href="#cb10-630" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parser.parse_args()</span>
<span id="cb10-631"><a href="#cb10-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-632"><a href="#cb10-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-633"><a href="#cb10-633" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-634"><a href="#cb10-634" aria-hidden="true" tabindex="-1"></a><span class="co"># Main OTIMIZADA</span></span>
<span id="cb10-635"><a href="#cb10-635" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb10-636"><a href="#cb10-636" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb10-637"><a href="#cb10-637" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configurar handler de EMERG√äNCIA para Ctrl+C</span></span>
<span id="cb10-638"><a href="#cb10-638" aria-hidden="true" tabindex="-1"></a>    signal.signal(signal.SIGINT, emergency_stop_handler)</span>
<span id="cb10-639"><a href="#cb10-639" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-640"><a href="#cb10-640" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args()</span>
<span id="cb10-641"><a href="#cb10-641" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-642"><a href="#cb10-642" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üöÄ PDF GENERATOR - VERS√ÉO ALTAMENTE OTIMIZADA&quot;</span>)</span>
<span id="cb10-643"><a href="#cb10-643" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;!!! EMERGENCY STOP ENABLED - Ctrl+C para PARAR TUDO IMEDIATAMENTE !!!&quot;</span>)</span>
<span id="cb10-644"><a href="#cb10-644" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;=&quot;</span> <span class="op">*</span> <span class="dv">65</span>)</span>
<span id="cb10-645"><a href="#cb10-645" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>args<span class="sc">.</span>workers<span class="sc">}</span><span class="ss"> (OTIMIZADO) | Batch: </span><span class="sc">{</span>args<span class="sc">.</span>batch_size<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-646"><a href="#cb10-646" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>args<span class="sc">.</span>retry_count<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>args<span class="sc">.</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb10-647"><a href="#cb10-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-648"><a href="#cb10-648" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza inicial agressiva</span></span>
<span id="cb10-649"><a href="#cb10-649" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb10-650"><a href="#cb10-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-651"><a href="#cb10-651" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verifica√ß√µes</span></span>
<span id="cb10-652"><a href="#cb10-652" aria-hidden="true" tabindex="-1"></a>    source_dir <span class="op">=</span> Path(args.source)</span>
<span id="cb10-653"><a href="#cb10-653" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> source_dir.exists():</span>
<span id="cb10-654"><a href="#cb10-654" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Pasta n√£o encontrada: </span><span class="sc">{</span>source_dir<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-655"><a href="#cb10-655" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb10-656"><a href="#cb10-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-657"><a href="#cb10-657" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_playwright_available(headless_test<span class="op">=</span><span class="kw">not</span> args.no_headless):</span>
<span id="cb10-658"><a href="#cb10-658" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Playwright n√£o dispon√≠vel.&quot;</span>)</span>
<span id="cb10-659"><a href="#cb10-659" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   pip install playwright psutil&quot;</span>)</span>
<span id="cb10-660"><a href="#cb10-660" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   playwright install chromium&quot;</span>)</span>
<span id="cb10-661"><a href="#cb10-661" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb10-662"><a href="#cb10-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-663"><a href="#cb10-663" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Executar vers√£o OTIMIZADA</span></span>
<span id="cb10-664"><a href="#cb10-664" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> generate_pdfs_optimized(</span>
<span id="cb10-665"><a href="#cb10-665" aria-hidden="true" tabindex="-1"></a>        source_dir<span class="op">=</span><span class="bu">str</span>(args.source),</span>
<span id="cb10-666"><a href="#cb10-666" aria-hidden="true" tabindex="-1"></a>        output_dir<span class="op">=</span><span class="bu">str</span>(args.output),</span>
<span id="cb10-667"><a href="#cb10-667" aria-hidden="true" tabindex="-1"></a>        workers<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">min</span>(args.workers, <span class="dv">4</span>)),  <span class="co"># Limite m√°ximo de 4 workers para estabilidade</span></span>
<span id="cb10-668"><a href="#cb10-668" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.batch_size),</span>
<span id="cb10-669"><a href="#cb10-669" aria-hidden="true" tabindex="-1"></a>        headless<span class="op">=</span><span class="kw">not</span> args.no_headless,</span>
<span id="cb10-670"><a href="#cb10-670" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span><span class="bu">max</span>(<span class="dv">15</span>, args.timeout),</span>
<span id="cb10-671"><a href="#cb10-671" aria-hidden="true" tabindex="-1"></a>        force_overwrite<span class="op">=</span>args.force,</span>
<span id="cb10-672"><a href="#cb10-672" aria-hidden="true" tabindex="-1"></a>        dry_run<span class="op">=</span>args.dry_run,</span>
<span id="cb10-673"><a href="#cb10-673" aria-hidden="true" tabindex="-1"></a>        single_file<span class="op">=</span>args.single_file,</span>
<span id="cb10-674"><a href="#cb10-674" aria-hidden="true" tabindex="-1"></a>        retry_count<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.retry_count),</span>
<span id="cb10-675"><a href="#cb10-675" aria-hidden="true" tabindex="-1"></a>        benchmark<span class="op">=</span>args.benchmark</span>
<span id="cb10-676"><a href="#cb10-676" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-677"><a href="#cb10-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-678"><a href="#cb10-678" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resultado final</span></span>
<span id="cb10-679"><a href="#cb10-679" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb10-680"><a href="#cb10-680" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ SIMULA√á√ÉO CONCLU√çDA&quot;</span>)</span>
<span id="cb10-681"><a href="#cb10-681" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb10-682"><a href="#cb10-682" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> success:</span>
<span id="cb10-683"><a href="#cb10-683" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üéâ CONVERS√ÉO CONCLU√çDA COM SUCESSO!&quot;</span>)</span>
<span id="cb10-684"><a href="#cb10-684" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb10-685"><a href="#cb10-685" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb10-686"><a href="#cb10-686" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è CONVERS√ÉO INTERROMPIDA OU COM FALHAS&quot;</span>)</span>
<span id="cb10-687"><a href="#cb10-687" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb10-688"><a href="#cb10-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-689"><a href="#cb10-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-690"><a href="#cb10-690" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb10-691"><a href="#cb10-691" aria-hidden="true" tabindex="-1"></a>    multiprocessing.freeze_support()</span>
<span id="cb10-692"><a href="#cb10-692" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-693"><a href="#cb10-693" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handler global para garantir que Ctrl+C sempre funcione</span></span>
<span id="cb10-694"><a href="#cb10-694" aria-hidden="true" tabindex="-1"></a>    original_sigint <span class="op">=</span> signal.getsignal(signal.SIGINT)</span>
<span id="cb10-695"><a href="#cb10-695" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-696"><a href="#cb10-696" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-697"><a href="#cb10-697" aria-hidden="true" tabindex="-1"></a>        sys.exit(main())</span>
<span id="cb10-698"><a href="#cb10-698" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb10-699"><a href="#cb10-699" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO GLOBAL DETECTADA !!!&quot;</span>)</span>
<span id="cb10-700"><a href="#cb10-700" aria-hidden="true" tabindex="-1"></a>        emergency_stop_handler(<span class="va">None</span>, <span class="va">None</span>)</span>
<span id="cb10-701"><a href="#cb10-701" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb10-702"><a href="#cb10-702" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üí• ERRO CR√çTICO: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-703"><a href="#cb10-703" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb10-704"><a href="#cb10-704" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb10-705"><a href="#cb10-705" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Restaurar handler original</span></span>
<span id="cb10-706"><a href="#cb10-706" aria-hidden="true" tabindex="-1"></a>        signal.signal(signal.SIGINT, original_sigint)</span></code></pre></div>
<h2 data-number="1.9" id="principais-melhorias"><span class="header-section-number">1.9</span> Principais Melhorias:</h2>
<h3 data-number="1.9.1" id="detec√ß√£o-do-conda-no-in√≠cio"><span class="header-section-number">1.9.1</span> 1. <strong>Detec√ß√£o do Conda
no In√≠cio</strong></h3>
<ul>
<li>A verifica√ß√£o do ambiente Conda √© a <strong>primeira coisa</strong>
que o script executa</li>
<li>Se falhar no Windows, o script para <strong>imediatamente</strong>
antes de importar qualquer depend√™ncia</li>
<li>Mensagens claras de erro e instru√ß√µes</li>
</ul>
<h3 data-number="1.9.2" id="importa√ß√£o-do-playwright-ap√≥s-verifica√ß√£o"><span class="header-section-number">1.9.2</span> 2. <strong>Importa√ß√£o do
Playwright ap√≥s Verifica√ß√£o</strong></h3>
<ul>
<li>O Playwright s√≥ √© importado <strong>depois</strong> da verifica√ß√£o
bem-sucedida do ambiente Conda</li>
<li>Evita o erro <code>ModuleNotFoundError</code> quando o ambiente est√°
incorreto</li>
</ul>
<h3 data-number="1.9.3" id="timeout-padr√£o-de-50-segundos"><span class="header-section-number">1.9.3</span> 3. <strong>Timeout Padr√£o de
50 Segundos</strong></h3>
<ul>
<li>Alterado de 45 para 50 segundos como solicitado:</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">&#39;--timeout&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">50</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Timeout por p√°gina (padr√£o: 50 segundos)&quot;</span>)</span></code></pre></div>
<h3 data-number="1.9.4" id="estrutura-otimizada"><span class="header-section-number">1.9.4</span> 4. <strong>Estrutura
Otimizada</strong></h3>
<ul>
<li><strong>C√≥digo de verifica√ß√£o</strong> ‚Üí
<strong>Importa√ß√µes</strong> ‚Üí <strong>Fun√ß√µes principais</strong></li>
<li>Mant√©m a performance sem overhead desnecess√°rio</li>
<li>Preserva todas as otimiza√ß√µes anteriores</li>
</ul>
<h3 data-number="1.9.5" id="fluxo-corrigido"><span class="header-section-number">1.9.5</span> 5. <strong>Fluxo
Corrigido</strong></h3>
<ol type="1">
<li>Verifica Conda (apenas Windows)</li>
<li>Se falhar ‚Üí Mensagem de erro ‚Üí Sai do script</li>
<li>Se suceder ‚Üí Importa Playwright ‚Üí Continua execu√ß√£o normal</li>
</ol>
<p>Agora o script ir√°: - <strong>Detectar corretamente</strong> se voc√™
est√° no ambiente Conda ‚ÄúPesquisas‚Äù - <strong>Parar
imediatamente</strong> com mensagem clara se n√£o estiver -
<strong>Continuar normalmente</strong> se estiver no ambiente correto -
Usar <strong>timeout de 50s</strong> como padr√£o</p>
<hr />
<h3 data-number="1.9.6" id="utilizador-2025-11-07-061114-deepseek-reasoner"><span class="header-section-number">1.9.6</span> üë§ Utilizador <em>(2025-11-07
06:11:14)</em> <em>[deepseek-reasoner]</em></h3>
<p>(base) D:_DOCS__DOCS___D_C_G_Qwen_Op&gt;python
comb_pdf_direct6_html_based_optimized_live_benchmark.py ‚Äìbenchmark üîç
Verificando ambiente Conda ‚ÄòPesquisas‚Äô‚Ä¶ üîç Ambiente Conda detectado:
base üîç Ambiente ativo via conda info: base ‚ùå AMBIENTE CONDA
‚ÄòPESQUISAS‚Äô N√ÉO DETECTADO!</p>
<p>üîß USE O SEGUINTE COMANDO ANTES DE EXECUTAR: conda activate
Pesquisas</p>
<p>üí° Se o ambiente n√£o existir, crie com: conda create -n Pesquisas
python=3.8 conda activate Pesquisas pip install playwright psutil
playwright install chromium</p>
<p>‚ùå EXECU√á√ÉO INTERROMPIDA: Ambiente Conda ‚ÄòPesquisas‚Äô n√£o est√° ativo!
üí° Use o comando abaixo antes de executar este script: conda activate
Pesquisas</p>
<p>(base) D:_DOCS__DOCS___D_C_G_Qwen_Op&gt;conda activate Pesquisas</p>
<p>(Pesquisas) D:_DOCS__DOCS___D_C_G_Qwen_Op&gt;python
comb_pdf_direct6_html_based_optimized_live_benchmark.py ‚Äìbenchmark üîç
Verificando ambiente Conda ‚ÄòPesquisas‚Äô‚Ä¶ üîç Ambiente Conda detectado:
Pesquisas ‚úÖ Ambiente Conda correto: Pesquisas üöÄ PDF GENERATOR - VERS√ÉO
ALTAMENTE OTIMIZADA !!! EMERGENCY STOP ENABLED - Ctrl+C para PARAR TUDO
IMEDIATAMENTE !!!
================================================================= üîß
Workers: 2 (OTIMIZADO) | Batch: 3 üîÑ Retry: 2 | Timeout: 50s üßπ Limpando
processos Chromium √≥rf√£os‚Ä¶ üéØ Encontrados 206 arquivos HTML üîß Workers:
2 | Batch: 3 | Timeout: 50s üîÑ Retry: 2 tentativas por arquivo ‚èπÔ∏è
Pressione Ctrl+C para PARAR IMEDIATAMENTE</p>
<p>üîÑ M√âTODO DE CONVERS√ÉO: ‚Ä¢ Playwright + Chromium headless ‚Ä¢ 1
inst√¢ncia do browser por processo worker ‚Ä¢ Contexto separado por arquivo
HTML ‚Ä¢ Paralelismo seguro com multiprocessing.Pool ‚Ä¢ Sistema de retry
com m√∫ltiplas tentativas ‚Ä¢ Timeouts configur√°veis por p√°gina ‚Ä¢
INTERRUP√á√ÉO IMEDIATA via Ctrl+C (SIGINT)</p>
<p>üÜï 85 arquivos novos para processar (de 206 total) üì¶ 29 batches
preparados üîç Verificando ambiente Conda ‚ÄòPesquisas‚Äô‚Ä¶ üîç Ambiente Conda
detectado: Pesquisas ‚úÖ Ambiente Conda correto: Pesquisas üîÑ Iniciando
convers√£o OTIMIZADA‚Ä¶ üí° Dica: Pressione Ctrl+C a qualquer momento para
PARAR IMEDIATAMENTE üîç Verificando ambiente Conda ‚ÄòPesquisas‚Äô‚Ä¶ üîç
Ambiente Conda detectado: Pesquisas ‚úÖ Ambiente Conda correto: Pesquisas
üîç Verificando ambiente Conda ‚ÄòPesquisas‚Äô‚Ä¶ üîç Ambiente Conda detectado:
Pesquisas ‚úÖ Ambiente Conda correto: Pesquisas ‚úÖ
116_Grok_Update_menuinst_for_Jupyter_Notebook.pdf ‚úÖ
117_Grok_Abrir_Arquivos_Markdown_no_Windows.pdf ‚úÖ
118_Grok_Windows_10_Support_Ends_2025.pdf ; Porque Verificando ambiente
Conda ‚ÄòPesquisas‚Äô.. aparece varias vezes?</p>
<hr />
<h3 data-number="1.9.7" id="deepseek-2025-11-07-061114-deepseek-reasoner"><span class="header-section-number">1.9.7</span> ü§ñ DeepSeek <em>(2025-11-07
06:11:14)</em> <em>[deepseek-reasoner]</em></h3>
<p>O problema √© que a verifica√ß√£o do ambiente Conda est√° sendo executada
v√°rias vezes porque o script √© executado em m√∫ltiplos processos (devido
ao uso de multiprocessing). Cada processo filho importa o script e
executa o c√≥digo no topo, incluindo a verifica√ß√£o do Conda.</p>
<p>Para corrigir isso, precisamos garantir que a verifica√ß√£o do Conda
seja executada apenas no processo principal. Vamos reorganizar o c√≥digo
para que a verifica√ß√£o seja feita apenas quando o script √© executado
como principal e n√£o quando √© importado por um processo filho.</p>
<p>Al√©m disso, note que a verifica√ß√£o do Conda est√° sendo feita no topo
do script, mas tamb√©m dentro da fun√ß√£o <code>main</code> (que √© chamada
apenas no processo principal). A verifica√ß√£o no topo do script ser√°
executada em todos os processos, o que n√£o √© desejado.</p>
<p>Vamos remover a verifica√ß√£o do topo do script e deixar apenas na
fun√ß√£o <code>main</code>. Dessa forma, apenas o processo principal far√°
a verifica√ß√£o.</p>
<p>Outro ponto: a verifica√ß√£o do Conda deve ser feita apenas no Windows,
ent√£o vamos manter a l√≥gica dentro da fun√ß√£o <code>main</code> e n√£o no
topo do script.</p>
<p>Vamos ajustar:</p>
<ol type="1">
<li>Remover a verifica√ß√£o do topo do script (o bloco que chama
<code>check_conda_environment</code> e sai se falhar).</li>
<li>Manter a verifica√ß√£o dentro da fun√ß√£o <code>main</code> (ap√≥s a
an√°lise de argumentos) e antes de qualquer outra coisa.</li>
</ol>
<p>Al√©m disso, note que a fun√ß√£o <code>check_conda_environment</code>
est√° sendo chamada v√°rias vezes porque cada processo filho (criado pelo
multiprocessing) importa o m√≥dulo e, no Windows, o multiprocessing usa
<code>spawn</code> que recria o ambiente do zero, ent√£o cada processo
filho tentar√° verificar o Conda novamente.</p>
<p>Para evitar isso, podemos usar a prote√ß√£o
<code>if __name__ == &quot;__main__&quot;:</code> para a verifica√ß√£o do Conda, mas
note que a verifica√ß√£o deve ser feita apenas no processo principal, e
n√£o nos filhos.</p>
<p>Vamos mover a verifica√ß√£o para dentro de <code>main</code> e garantir
que n√£o seja executada nos processos filhos.</p>
<p>No entanto, os processos filhos n√£o passam pela fun√ß√£o
<code>main</code>, ent√£o isso deve resolver.</p>
<p>Vamos reestruturar:</p>
<ul>
<li>Remover o c√≥digo de verifica√ß√£o do topo do script (linhas
73-80).</li>
<li>Manter a verifica√ß√£o dentro da fun√ß√£o <code>main</code> (ap√≥s
<code>parse_args</code> e antes de qualquer outra coisa).</li>
</ul>
<p>Al√©m disso, note que a fun√ß√£o <code>check_conda_environment</code>
est√° sendo chamada em <code>main</code> apenas no Windows. Vamos manter
isso.</p>
<p>Vamos fazer essas altera√ß√µes e testar.</p>
<p>Outro ponto: o c√≥digo de verifica√ß√£o do Conda no topo do script
estava sendo executado mesmo quando o script era importado por um
processo filho. Agora, ao mover para <code>main</code>, que √© chamada
apenas no processo principal, evitamos a verifica√ß√£o nos filhos.</p>
<p>Vamos tamb√©m ajustar a mensagem de verifica√ß√£o para que n√£o apare√ßa
m√∫ltiplas vezes.</p>
<p>Al√©m disso, note que o multiprocessing no Windows usa a cria√ß√£o de
processos via <code>spawn</code>, o que significa que cada processo
filho vai importar o m√≥dulo novamente. Se houver c√≥digo no topo do
m√≥dulo que n√£o esteja protegido por
<code>if __name__ == &quot;__main__&quot;:</code>, ele ser√° executado novamente.
Portanto, √© importante proteger a execu√ß√£o do c√≥digo no topo do m√≥dulo
que n√£o deve ser executado nos processos filhos.</p>
<p>No entanto, a verifica√ß√£o do Conda n√£o √© necess√°ria nos processos
filhos, apenas no principal.</p>
<p>Vamos remover a verifica√ß√£o do topo do script e colocar em
<code>main</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remover este bloco (linhas 73-80):</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#if platform.system() == &quot;Windows&quot;:</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#    print(&quot;üîç Verificando ambiente Conda &#39;Pesquisas&#39;...&quot;)</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#    if not check_conda_environment():</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#        print(&quot;\n‚ùå EXECU√á√ÉO INTERROMPIDA: Ambiente Conda &#39;Pesquisas&#39; n√£o est√° ativo!&quot;)</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">#        print(&quot;üí° Use o comando abaixo antes de executar este script:&quot;)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#        print(&quot;   conda activate Pesquisas&quot;)</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#        sys.exit(1)</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#else:</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#    print(&quot;üîç Sistema n√£o-Windows detectado, pulando verifica√ß√£o do Conda...&quot;)</span></span></code></pre></div>
<p>E na fun√ß√£o <code>main</code>, ap√≥s a an√°lise de argumentos,
adicionar a verifica√ß√£o:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VERIFICA√á√ÉO DO AMBIENTE CONDA - APENAS NO WINDOWS</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üîç Verificando ambiente Conda &#39;Pesquisas&#39;...&quot;</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> check_conda_environment():</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">‚ùå EXECU√á√ÉO INTERROMPIDA: Ambiente Conda &#39;Pesquisas&#39; n√£o est√° ativo!&quot;</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;üí° Use o comando abaixo antes de executar este script:&quot;</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;   conda activate Pesquisas&quot;</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... restante do c√≥digo da main ...</span></span></code></pre></div>
<p>Dessa forma, a verifica√ß√£o s√≥ ocorre no processo principal e apenas
uma vez.</p>
<p>Vamos tamb√©m ajustar o timeout padr√£o para 50 segundos, como
solicitado.</p>
<p>Agora, vamos gerar o c√≥digo completo com essas altera√ß√µes. O problema
√© que a verifica√ß√£o do Conda est√° sendo executada m√∫ltiplas vezes porque
o script est√° sendo importado/re-executado nos processos filhos do
multiprocessing. Vou corrigir isso garantindo que a verifica√ß√£o s√≥
aconte√ßa no processo principal:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">comb_pdf_direct6_html_based_optimized_live_benchmark.py</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">Vers√£o ALTAMENTE OTIMIZADA com:</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">- Reutiliza√ß√£o de inst√¢ncia do Chromium por processo</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">- Paralelismo seguro via multiprocessing.Pool</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">- Retry por arquivo (2 tentativas padr√£o)</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">- Cancelamento IMEDIATO E CONFI√ÅVEL via Ctrl+C</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">- Workers otimizados (2 padr√£o) e batch-size 3</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">- Browser management aprimorado</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">- Detec√ß√£o de ambiente Conda &quot;Pesquisas&quot; (apenas no processo principal)</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">- Timeout padr√£o de 50 segundos</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> signal</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psutil</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Optional</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Vari√°veis globais para controle de interrup√ß√£o MELHORADO</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>_active_processes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>_should_stop <span class="op">=</span> <span class="va">False</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>_stop_event <span class="op">=</span> <span class="va">None</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>_pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="co"># DETEC√á√ÉO DO AMBIENTE CONDA - APENAS NO PROCESSO PRINCIPAL</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_conda_environment():</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o ambiente Conda &#39;Pesquisas&#39; est√° ativo no Windows - APENAS NO PROCESSO PRINCIPAL&quot;&quot;&quot;</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> platform.system() <span class="op">!=</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span>  <span class="co"># Skip check on non-Windows systems</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># M√©todo 1: Verificar vari√°vel de ambiente CONDA_DEFAULT_ENV (mais confi√°vel)</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>        conda_env <span class="op">=</span> os.environ.get(<span class="st">&#39;CONDA_DEFAULT_ENV&#39;</span>, <span class="st">&#39;&#39;</span>)</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üîç Ambiente Conda detectado: </span><span class="sc">{</span>conda_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">&#39;Pesquisas&#39;</span> <span class="kw">in</span> conda_env:</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ Ambiente Conda correto: </span><span class="sc">{</span>conda_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># M√©todo 2: Verificar se estamos em qualquer ambiente conda (n√£o base)</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> conda_env <span class="kw">and</span> conda_env <span class="op">!=</span> <span class="st">&#39;base&#39;</span>:</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è  Ambiente Conda detectado: </span><span class="sc">{</span>conda_env<span class="sc">}</span><span class="ss"> (mas n√£o √© &#39;Pesquisas&#39;)&quot;</span>)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># M√©todo 3: Tentar detectar via conda info</span></span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> subprocess.run(</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&#39;conda&#39;</span>, <span class="st">&#39;info&#39;</span>, <span class="st">&#39;--json&#39;</span>], </span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>                capture_output<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>                text<span class="op">=</span><span class="va">True</span>, </span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>                timeout<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>                shell<span class="op">=</span><span class="va">True</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> result.returncode <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>                <span class="im">import</span> json</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>                conda_info <span class="op">=</span> json.loads(result.stdout)</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>                active_env <span class="op">=</span> conda_info.get(<span class="st">&#39;active_prefix_name&#39;</span>, <span class="st">&#39;&#39;</span>)</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> active_env:</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f&quot;üîç Ambiente ativo via conda info: </span><span class="sc">{</span>active_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="st">&#39;Pesquisas&#39;</span> <span class="kw">in</span> active_env:</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ Ambiente Conda correto: </span><span class="sc">{</span>active_env<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Se chegou aqui, n√£o detectou o ambiente Pesquisas</span></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå AMBIENTE CONDA &#39;PESQUISAS&#39; N√ÉO DETECTADO!&quot;</span>)</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîß USE O SEGUINTE COMANDO ANTES DE EXECUTAR:&quot;</span>)</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda activate Pesquisas&quot;</span>)</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üí° Se o ambiente n√£o existir, crie com:&quot;</span>)</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda create -n Pesquisas python=3.8&quot;</span>)</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda activate Pesquisas&quot;</span>)</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   pip install playwright psutil&quot;</span>)</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   playwright install chromium&quot;</span>)</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Erro na verifica√ß√£o do Conda: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîß USE: conda activate Pesquisas antes de executar este script&quot;</span>)</span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a><span class="co"># VERIFICA√á√ÉO INICIAL DO AMBIENTE - APENAS NO PROCESSO PRINCIPAL</span></span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span> <span class="kw">and</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üîç Verificando ambiente Conda &#39;Pesquisas&#39;...&quot;</span>)</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_conda_environment():</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">‚ùå EXECU√á√ÉO INTERROMPIDA: Ambiente Conda &#39;Pesquisas&#39; n√£o est√° ativo!&quot;</span>)</span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üí° Use o comando abaixo antes de executar este script:&quot;</span>)</span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   conda activate Pesquisas&quot;</span>)</span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üîç Sistema n√£o-Windows detectado, pulando verifica√ß√£o do Conda...&quot;</span>)</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-111"><a href="#cb14-111" aria-hidden="true" tabindex="-1"></a><span class="co"># AGORA IMPORTAMOS AS DEPEND√äNCIAS (AP√ìS VERIFICA√á√ÉO DO CONDA)</span></span>
<span id="cb14-112"><a href="#cb14-112" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-113"><a href="#cb14-113" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright, <span class="pp">TimeoutError</span> <span class="im">as</span> PlaywrightTimeoutError</span>
<span id="cb14-114"><a href="#cb14-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-115"><a href="#cb14-115" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-116"><a href="#cb14-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Fun√ß√µes utilit√°rias OTIMIZADAS</span></span>
<span id="cb14-117"><a href="#cb14-117" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-118"><a href="#cb14-118" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kill_orphaned_chromium():</span>
<span id="cb14-119"><a href="#cb14-119" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Encerra processos Chromium √≥rf√£os de forma agressiva.&quot;&quot;&quot;</span></span>
<span id="cb14-120"><a href="#cb14-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-121"><a href="#cb14-121" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Limpando processos Chromium √≥rf√£os...&quot;</span>)</span>
<span id="cb14-122"><a href="#cb14-122" aria-hidden="true" tabindex="-1"></a>        current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb14-123"><a href="#cb14-123" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-124"><a href="#cb14-124" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb14-125"><a href="#cb14-125" aria-hidden="true" tabindex="-1"></a>            subprocess.run(</span>
<span id="cb14-126"><a href="#cb14-126" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chrome.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;msedge.exe&quot;</span>],</span>
<span id="cb14-127"><a href="#cb14-127" aria-hidden="true" tabindex="-1"></a>                stdout<span class="op">=</span>subprocess.DEVNULL, </span>
<span id="cb14-128"><a href="#cb14-128" aria-hidden="true" tabindex="-1"></a>                stderr<span class="op">=</span>subprocess.DEVNULL,</span>
<span id="cb14-129"><a href="#cb14-129" aria-hidden="true" tabindex="-1"></a>                timeout<span class="op">=</span><span class="dv">10</span></span>
<span id="cb14-130"><a href="#cb14-130" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-131"><a href="#cb14-131" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-132"><a href="#cb14-132" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb14-133"><a href="#cb14-133" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb14-134"><a href="#cb14-134" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chrome&quot;</span>], </span>
<span id="cb14-135"><a href="#cb14-135" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb14-136"><a href="#cb14-136" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;playwright&quot;</span>], </span>
<span id="cb14-137"><a href="#cb14-137" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb14-138"><a href="#cb14-138" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-139"><a href="#cb14-139" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza adicional para garantir</span></span>
<span id="cb14-140"><a href="#cb14-140" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="fl">0.5</span>)</span>
<span id="cb14-141"><a href="#cb14-141" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb14-142"><a href="#cb14-142" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>], </span>
<span id="cb14-143"><a href="#cb14-143" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb14-144"><a href="#cb14-144" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb14-145"><a href="#cb14-145" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb14-146"><a href="#cb14-146" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb14-147"><a href="#cb14-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb14-148"><a href="#cb14-148" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è Aviso na limpeza: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-149"><a href="#cb14-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-150"><a href="#cb14-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-151"><a href="#cb14-151" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunkify(seq: List[<span class="bu">str</span>], size: <span class="bu">int</span>) <span class="op">-&gt;</span> List[List[<span class="bu">str</span>]]:</span>
<span id="cb14-152"><a href="#cb14-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [seq[i:i <span class="op">+</span> size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(seq), size)]</span>
<span id="cb14-153"><a href="#cb14-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-154"><a href="#cb14-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-155"><a href="#cb14-155" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_playwright_available(headless_test: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb14-156"><a href="#cb14-156" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o Playwright + Chromium est√£o instalados.&quot;&quot;&quot;</span></span>
<span id="cb14-157"><a href="#cb14-157" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-158"><a href="#cb14-158" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb14-159"><a href="#cb14-159" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb14-160"><a href="#cb14-160" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless_test,</span>
<span id="cb14-161"><a href="#cb14-161" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb14-162"><a href="#cb14-162" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb14-163"><a href="#cb14-163" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb14-164"><a href="#cb14-164" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb14-165"><a href="#cb14-165" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb14-166"><a href="#cb14-166" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span></span>
<span id="cb14-167"><a href="#cb14-167" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb14-168"><a href="#cb14-168" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-169"><a href="#cb14-169" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb14-170"><a href="#cb14-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb14-171"><a href="#cb14-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb14-172"><a href="#cb14-172" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Erro ao verificar Playwright: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-173"><a href="#cb14-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb14-174"><a href="#cb14-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-175"><a href="#cb14-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-176"><a href="#cb14-176" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> emergency_stop_handler(signum, frame):</span>
<span id="cb14-177"><a href="#cb14-177" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handler de emerg√™ncia para Ctrl+C - PARA TUDO IMEDIATAMENTE&quot;&quot;&quot;</span></span>
<span id="cb14-178"><a href="#cb14-178" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop, _stop_event, _pool</span>
<span id="cb14-179"><a href="#cb14-179" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-180"><a href="#cb14-180" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">!!! EMERGENCY STOP SOLICITADO !!!&quot;</span>)</span>
<span id="cb14-181"><a href="#cb14-181" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üö® INTERRUP√á√ÉO DE EMERG√äNCIA - Terminando processos...&quot;</span>)</span>
<span id="cb14-182"><a href="#cb14-182" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-183"><a href="#cb14-183" aria-hidden="true" tabindex="-1"></a>    _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb14-184"><a href="#cb14-184" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-185"><a href="#cb14-185" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sinalizar parada para todos os processos</span></span>
<span id="cb14-186"><a href="#cb14-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _stop_event:</span>
<span id="cb14-187"><a href="#cb14-187" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb14-188"><a href="#cb14-188" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-189"><a href="#cb14-189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parar pool AGressivamente</span></span>
<span id="cb14-190"><a href="#cb14-190" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _pool:</span>
<span id="cb14-191"><a href="#cb14-191" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb14-192"><a href="#cb14-192" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;üõë Terminando pool de workers...&quot;</span>)</span>
<span id="cb14-193"><a href="#cb14-193" aria-hidden="true" tabindex="-1"></a>            _pool.terminate()</span>
<span id="cb14-194"><a href="#cb14-194" aria-hidden="true" tabindex="-1"></a>            _pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb14-195"><a href="#cb14-195" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb14-196"><a href="#cb14-196" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb14-197"><a href="#cb14-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-198"><a href="#cb14-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Terminar processos filhos de forma agressiva</span></span>
<span id="cb14-199"><a href="#cb14-199" aria-hidden="true" tabindex="-1"></a>    current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb14-200"><a href="#cb14-200" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-201"><a href="#cb14-201" aria-hidden="true" tabindex="-1"></a>        parent <span class="op">=</span> psutil.Process(current_pid)</span>
<span id="cb14-202"><a href="#cb14-202" aria-hidden="true" tabindex="-1"></a>        children <span class="op">=</span> parent.children(recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-203"><a href="#cb14-203" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üî™ Terminando </span><span class="sc">{</span><span class="bu">len</span>(children)<span class="sc">}</span><span class="ss"> processos filhos...&quot;</span>)</span>
<span id="cb14-204"><a href="#cb14-204" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-205"><a href="#cb14-205" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> child <span class="kw">in</span> children:</span>
<span id="cb14-206"><a href="#cb14-206" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb14-207"><a href="#cb14-207" aria-hidden="true" tabindex="-1"></a>                child_pid <span class="op">=</span> child.pid</span>
<span id="cb14-208"><a href="#cb14-208" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> child_pid <span class="op">!=</span> current_pid <span class="kw">and</span> child_pid <span class="kw">in</span> _active_processes:</span>
<span id="cb14-209"><a href="#cb14-209" aria-hidden="true" tabindex="-1"></a>                    child.kill()</span>
<span id="cb14-210"><a href="#cb14-210" aria-hidden="true" tabindex="-1"></a>                    _active_processes.discard(child_pid)</span>
<span id="cb14-211"><a href="#cb14-211" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb14-212"><a href="#cb14-212" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb14-213"><a href="#cb14-213" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb14-214"><a href="#cb14-214" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb14-215"><a href="#cb14-215" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-216"><a href="#cb14-216" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza final de processos √≥rf√£os</span></span>
<span id="cb14-217"><a href="#cb14-217" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb14-218"><a href="#cb14-218" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-219"><a href="#cb14-219" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üíÄ TODOS OS PROCESSOS FORAM TERMINADOS&quot;</span>)</span>
<span id="cb14-220"><a href="#cb14-220" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è PROGRAMA INTERROMPIDO PELO UTILIZADOR&quot;</span>)</span>
<span id="cb14-221"><a href="#cb14-221" aria-hidden="true" tabindex="-1"></a>    os._exit(<span class="dv">1</span>)  <span class="co"># Sa√≠da de emerg√™ncia</span></span>
<span id="cb14-222"><a href="#cb14-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-223"><a href="#cb14-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-224"><a href="#cb14-224" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-225"><a href="#cb14-225" aria-hidden="true" tabindex="-1"></a><span class="co"># Worker de processamento OTIMIZADO - REUTILIZA BROWSER POR PROCESSO</span></span>
<span id="cb14-226"><a href="#cb14-226" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-227"><a href="#cb14-227" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_process_batch_optimized(batch_files, pdf_dir, timeout, headless, force_overwrite, retry_count, stop_event, msg_queue):</span>
<span id="cb14-228"><a href="#cb14-228" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Worker OTIMIZADO que reutiliza uma inst√¢ncia do Chromium por processo&quot;&quot;&quot;</span></span>
<span id="cb14-229"><a href="#cb14-229" aria-hidden="true" tabindex="-1"></a>    my_pid <span class="op">=</span> os.getpid()</span>
<span id="cb14-230"><a href="#cb14-230" aria-hidden="true" tabindex="-1"></a>    _active_processes.add(my_pid)</span>
<span id="cb14-231"><a href="#cb14-231" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-232"><a href="#cb14-232" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-233"><a href="#cb14-233" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb14-234"><a href="#cb14-234" aria-hidden="true" tabindex="-1"></a>        out_dir <span class="op">=</span> Path(pdf_dir)</span>
<span id="cb14-235"><a href="#cb14-235" aria-hidden="true" tabindex="-1"></a>        out_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-236"><a href="#cb14-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-237"><a href="#cb14-237" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verificar parada ANTES de iniciar o browser</span></span>
<span id="cb14-238"><a href="#cb14-238" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb14-239"><a href="#cb14-239" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb14-240"><a href="#cb14-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-241"><a href="#cb14-241" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb14-242"><a href="#cb14-242" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Configura√ß√£o OTIMIZADA do browser - UMA INST√ÇNCIA POR PROCESSO</span></span>
<span id="cb14-243"><a href="#cb14-243" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb14-244"><a href="#cb14-244" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless,</span>
<span id="cb14-245"><a href="#cb14-245" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb14-246"><a href="#cb14-246" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb14-247"><a href="#cb14-247" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb14-248"><a href="#cb14-248" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb14-249"><a href="#cb14-249" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb14-250"><a href="#cb14-250" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span>,</span>
<span id="cb14-251"><a href="#cb14-251" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-first-run&#39;</span>,</span>
<span id="cb14-252"><a href="#cb14-252" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-default-browser-check&#39;</span>,</span>
<span id="cb14-253"><a href="#cb14-253" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-default-apps&#39;</span>,</span>
<span id="cb14-254"><a href="#cb14-254" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-translate&#39;</span>,</span>
<span id="cb14-255"><a href="#cb14-255" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-extensions&#39;</span></span>
<span id="cb14-256"><a href="#cb14-256" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb14-257"><a href="#cb14-257" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-258"><a href="#cb14-258" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-259"><a href="#cb14-259" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_path_str <span class="kw">in</span> batch_files:</span>
<span id="cb14-260"><a href="#cb14-260" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb14-261"><a href="#cb14-261" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb14-262"><a href="#cb14-262" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb14-263"><a href="#cb14-263" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb14-264"><a href="#cb14-264" aria-hidden="true" tabindex="-1"></a>                html_path <span class="op">=</span> Path(html_path_str)</span>
<span id="cb14-265"><a href="#cb14-265" aria-hidden="true" tabindex="-1"></a>                pdf_path <span class="op">=</span> out_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb14-266"><a href="#cb14-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-267"><a href="#cb14-267" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> pdf_path.exists() <span class="kw">and</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb14-268"><a href="#cb14-268" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;J√° existe&quot;</span>))</span>
<span id="cb14-269"><a href="#cb14-269" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;skip&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb14-270"><a href="#cb14-270" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb14-271"><a href="#cb14-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-272"><a href="#cb14-272" aria-hidden="true" tabindex="-1"></a>                success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb14-273"><a href="#cb14-273" aria-hidden="true" tabindex="-1"></a>                last_error <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb14-274"><a href="#cb14-274" aria-hidden="true" tabindex="-1"></a>                context <span class="op">=</span> <span class="va">None</span></span>
<span id="cb14-275"><a href="#cb14-275" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb14-276"><a href="#cb14-276" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(retry_count):</span>
<span id="cb14-277"><a href="#cb14-277" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb14-278"><a href="#cb14-278" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb14-279"><a href="#cb14-279" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb14-280"><a href="#cb14-280" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb14-281"><a href="#cb14-281" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb14-282"><a href="#cb14-282" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># NOVO CONTEXT por arquivo (mas mesmo browser)</span></span>
<span id="cb14-283"><a href="#cb14-283" aria-hidden="true" tabindex="-1"></a>                        context <span class="op">=</span> browser.new_context(</span>
<span id="cb14-284"><a href="#cb14-284" aria-hidden="true" tabindex="-1"></a>                            viewport<span class="op">=</span>{<span class="st">&#39;width&#39;</span>: <span class="dv">1920</span>, <span class="st">&#39;height&#39;</span>: <span class="dv">1080</span>},</span>
<span id="cb14-285"><a href="#cb14-285" aria-hidden="true" tabindex="-1"></a>                            ignore_https_errors<span class="op">=</span><span class="va">True</span></span>
<span id="cb14-286"><a href="#cb14-286" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb14-287"><a href="#cb14-287" aria-hidden="true" tabindex="-1"></a>                        page <span class="op">=</span> context.new_page()</span>
<span id="cb14-288"><a href="#cb14-288" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb14-289"><a href="#cb14-289" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Timeouts otimizados</span></span>
<span id="cb14-290"><a href="#cb14-290" aria-hidden="true" tabindex="-1"></a>                        page.set_default_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb14-291"><a href="#cb14-291" aria-hidden="true" tabindex="-1"></a>                        page.set_default_navigation_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb14-292"><a href="#cb14-292" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb14-293"><a href="#cb14-293" aria-hidden="true" tabindex="-1"></a>                        full_path <span class="op">=</span> <span class="ss">f&quot;file:///</span><span class="sc">{</span>html_path<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb14-294"><a href="#cb14-294" aria-hidden="true" tabindex="-1"></a>                        page.goto(full_path, wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>, timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb14-295"><a href="#cb14-295" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb14-296"><a href="#cb14-296" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada DURANTE o carregamento</span></span>
<span id="cb14-297"><a href="#cb14-297" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb14-298"><a href="#cb14-298" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb14-299"><a href="#cb14-299" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb14-300"><a href="#cb14-300" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Wait for complete load - MAIS CONFI√ÅVEL</span></span>
<span id="cb14-301"><a href="#cb14-301" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_function(</span>
<span id="cb14-302"><a href="#cb14-302" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;document.readyState === &quot;complete&quot;&#39;</span>,</span>
<span id="cb14-303"><a href="#cb14-303" aria-hidden="true" tabindex="-1"></a>                            timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb14-304"><a href="#cb14-304" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb14-305"><a href="#cb14-305" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb14-306"><a href="#cb14-306" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada DURANTE a espera</span></span>
<span id="cb14-307"><a href="#cb14-307" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb14-308"><a href="#cb14-308" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb14-309"><a href="#cb14-309" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb14-310"><a href="#cb14-310" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Pequena espera para conte√∫do din√¢mico</span></span>
<span id="cb14-311"><a href="#cb14-311" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_timeout(<span class="dv">500</span>)</span>
<span id="cb14-312"><a href="#cb14-312" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb14-313"><a href="#cb14-313" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada ANTES do PDF</span></span>
<span id="cb14-314"><a href="#cb14-314" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb14-315"><a href="#cb14-315" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb14-316"><a href="#cb14-316" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb14-317"><a href="#cb14-317" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Gera√ß√£o de PDF com configura√ß√µes OTIMIZADAS</span></span>
<span id="cb14-318"><a href="#cb14-318" aria-hidden="true" tabindex="-1"></a>                        page.pdf(</span>
<span id="cb14-319"><a href="#cb14-319" aria-hidden="true" tabindex="-1"></a>                            path<span class="op">=</span><span class="bu">str</span>(pdf_path),</span>
<span id="cb14-320"><a href="#cb14-320" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>,</span>
<span id="cb14-321"><a href="#cb14-321" aria-hidden="true" tabindex="-1"></a>                            print_background<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb14-322"><a href="#cb14-322" aria-hidden="true" tabindex="-1"></a>                            margin<span class="op">=</span>{<span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span>},</span>
<span id="cb14-323"><a href="#cb14-323" aria-hidden="true" tabindex="-1"></a>                            prefer_css_page_size<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb14-324"><a href="#cb14-324" aria-hidden="true" tabindex="-1"></a>                            display_header_footer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb14-325"><a href="#cb14-325" aria-hidden="true" tabindex="-1"></a>                            scale<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb14-326"><a href="#cb14-326" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb14-327"><a href="#cb14-327" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb14-328"><a href="#cb14-328" aria-hidden="true" tabindex="-1"></a>                        success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb14-329"><a href="#cb14-329" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;ok&quot;</span>, pdf_path.name))</span>
<span id="cb14-330"><a href="#cb14-330" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb14-331"><a href="#cb14-331" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb14-332"><a href="#cb14-332" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb14-333"><a href="#cb14-333" aria-hidden="true" tabindex="-1"></a>                        last_error <span class="op">=</span> <span class="bu">str</span>(e)</span>
<span id="cb14-334"><a href="#cb14-334" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># N√£o reportar retry se foi por interrup√ß√£o</span></span>
<span id="cb14-335"><a href="#cb14-335" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb14-336"><a href="#cb14-336" aria-hidden="true" tabindex="-1"></a>                            msg_queue.put((<span class="st">&quot;retry&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb14-337"><a href="#cb14-337" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="op">-</span> <span class="dv">1</span> <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb14-338"><a href="#cb14-338" aria-hidden="true" tabindex="-1"></a>                            time.sleep(<span class="dv">1</span>)  <span class="co"># Pequena pausa entre tentativas</span></span>
<span id="cb14-339"><a href="#cb14-339" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">finally</span>:</span>
<span id="cb14-340"><a href="#cb14-340" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> context:</span>
<span id="cb14-341"><a href="#cb14-341" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">try</span>:</span>
<span id="cb14-342"><a href="#cb14-342" aria-hidden="true" tabindex="-1"></a>                                context.close()</span>
<span id="cb14-343"><a href="#cb14-343" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">except</span>:</span>
<span id="cb14-344"><a href="#cb14-344" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">pass</span></span>
<span id="cb14-345"><a href="#cb14-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-346"><a href="#cb14-346" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Se foi interrompido, sair imediatamente</span></span>
<span id="cb14-347"><a href="#cb14-347" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb14-348"><a href="#cb14-348" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb14-349"><a href="#cb14-349" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb14-350"><a href="#cb14-350" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> success <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb14-351"><a href="#cb14-351" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;fail&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>last_error<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb14-352"><a href="#cb14-352" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">False</span>, last_error))</span>
<span id="cb14-353"><a href="#cb14-353" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> success:</span>
<span id="cb14-354"><a href="#cb14-354" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;Sucesso&quot;</span>))</span>
<span id="cb14-355"><a href="#cb14-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-356"><a href="#cb14-356" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fechar browser ao final do batch</span></span>
<span id="cb14-357"><a href="#cb14-357" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb14-358"><a href="#cb14-358" aria-hidden="true" tabindex="-1"></a>                browser.close()</span>
<span id="cb14-359"><a href="#cb14-359" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb14-360"><a href="#cb14-360" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb14-361"><a href="#cb14-361" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb14-362"><a href="#cb14-362" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb14-363"><a href="#cb14-363" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb14-364"><a href="#cb14-364" aria-hidden="true" tabindex="-1"></a>            msg_queue.put((<span class="st">&quot;error&quot;</span>, <span class="ss">f&quot;Erro no worker: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb14-365"><a href="#cb14-365" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb14-366"><a href="#cb14-366" aria-hidden="true" tabindex="-1"></a>        _active_processes.discard(my_pid)</span>
<span id="cb14-367"><a href="#cb14-367" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-368"><a href="#cb14-368" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb14-369"><a href="#cb14-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-370"><a href="#cb14-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-371"><a href="#cb14-371" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_wrapper_optimized(args):</span>
<span id="cb14-372"><a href="#cb14-372" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Wrapper para o worker otimizado&quot;&quot;&quot;</span></span>
<span id="cb14-373"><a href="#cb14-373" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-374"><a href="#cb14-374" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> worker_process_batch_optimized(<span class="op">*</span>args)</span>
<span id="cb14-375"><a href="#cb14-375" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb14-376"><a href="#cb14-376" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb14-377"><a href="#cb14-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-378"><a href="#cb14-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-379"><a href="#cb14-379" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-380"><a href="#cb14-380" aria-hidden="true" tabindex="-1"></a><span class="co"># Listener de mensagens APRIMORADO</span></span>
<span id="cb14-381"><a href="#cb14-381" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-382"><a href="#cb14-382" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> queue_listener_optimized(msg_queue, listener_stop_flag, total_files):</span>
<span id="cb14-383"><a href="#cb14-383" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Listener com barra de progresso e estat√≠sticas&quot;&quot;&quot;</span></span>
<span id="cb14-384"><a href="#cb14-384" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb14-385"><a href="#cb14-385" aria-hidden="true" tabindex="-1"></a>    processed <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-386"><a href="#cb14-386" aria-hidden="true" tabindex="-1"></a>    successes <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-387"><a href="#cb14-387" aria-hidden="true" tabindex="-1"></a>    skips <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-388"><a href="#cb14-388" aria-hidden="true" tabindex="-1"></a>    failures <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-389"><a href="#cb14-389" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-390"><a href="#cb14-390" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> listener_stop_flag.is_set():</span>
<span id="cb14-391"><a href="#cb14-391" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb14-392"><a href="#cb14-392" aria-hidden="true" tabindex="-1"></a>            obj <span class="op">=</span> msg_queue.get(timeout<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb14-393"><a href="#cb14-393" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb14-394"><a href="#cb14-394" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb14-395"><a href="#cb14-395" aria-hidden="true" tabindex="-1"></a>            typ, text <span class="op">=</span> obj</span>
<span id="cb14-396"><a href="#cb14-396" aria-hidden="true" tabindex="-1"></a>            processed <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-397"><a href="#cb14-397" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-398"><a href="#cb14-398" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> typ <span class="op">==</span> <span class="st">&quot;ok&quot;</span>:</span>
<span id="cb14-399"><a href="#cb14-399" aria-hidden="true" tabindex="-1"></a>                successes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-400"><a href="#cb14-400" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-401"><a href="#cb14-401" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;skip&quot;</span>:</span>
<span id="cb14-402"><a href="#cb14-402" aria-hidden="true" tabindex="-1"></a>                skips <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-403"><a href="#cb14-403" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚è≠Ô∏è </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-404"><a href="#cb14-404" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;fail&quot;</span>:</span>
<span id="cb14-405"><a href="#cb14-405" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-406"><a href="#cb14-406" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚ùå </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-407"><a href="#cb14-407" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;error&quot;</span>:</span>
<span id="cb14-408"><a href="#cb14-408" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-409"><a href="#cb14-409" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üö´ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-410"><a href="#cb14-410" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;retry&quot;</span>:</span>
<span id="cb14-411"><a href="#cb14-411" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üîÑ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-412"><a href="#cb14-412" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-413"><a href="#cb14-413" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Mostrar progresso a cada 5 arquivos para feedback mais frequente</span></span>
<span id="cb14-414"><a href="#cb14-414" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> processed <span class="op">%</span> <span class="dv">5</span> <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> processed <span class="op">==</span> total_files:</span>
<span id="cb14-415"><a href="#cb14-415" aria-hidden="true" tabindex="-1"></a>                elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb14-416"><a href="#cb14-416" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> successes <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb14-417"><a href="#cb14-417" aria-hidden="true" tabindex="-1"></a>                    rate <span class="op">=</span> successes <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb14-418"><a href="#cb14-418" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f&quot;üìä Progresso: </span><span class="sc">{</span>successes<span class="op">+</span>skips<span class="op">+</span>failures<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_files<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb14-419"><a href="#cb14-419" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;‚úÖ</span><span class="sc">{</span>successes<span class="sc">}</span><span class="ss"> ‚è≠Ô∏è</span><span class="sc">{</span>skips<span class="sc">}</span><span class="ss"> ‚ùå</span><span class="sc">{</span>failures<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb14-420"><a href="#cb14-420" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;</span><span class="sc">{</span>rate<span class="sc">:.1f}</span><span class="ss"> PDFs/min&quot;</span>)</span>
<span id="cb14-421"><a href="#cb14-421" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb14-422"><a href="#cb14-422" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb14-423"><a href="#cb14-423" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb14-424"><a href="#cb14-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-425"><a href="#cb14-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-426"><a href="#cb14-426" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-427"><a href="#cb14-427" aria-hidden="true" tabindex="-1"></a><span class="co"># Convers√£o principal - VERS√ÉO ALTAMENTE OTIMIZADA</span></span>
<span id="cb14-428"><a href="#cb14-428" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-429"><a href="#cb14-429" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_pdfs_optimized(source_dir, output_dir, workers, batch_size, headless, timeout,</span>
<span id="cb14-430"><a href="#cb14-430" aria-hidden="true" tabindex="-1"></a>                           force_overwrite, dry_run, single_file<span class="op">=</span><span class="va">None</span>, retry_count<span class="op">=</span><span class="dv">2</span>, benchmark<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb14-431"><a href="#cb14-431" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Fun√ß√£o principal OTIMIZADA com interrup√ß√£o robusta e performance m√°xima&quot;&quot;&quot;</span></span>
<span id="cb14-432"><a href="#cb14-432" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop, _stop_event, _pool</span>
<span id="cb14-433"><a href="#cb14-433" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-434"><a href="#cb14-434" aria-hidden="true" tabindex="-1"></a>    src <span class="op">=</span> Path(source_dir)</span>
<span id="cb14-435"><a href="#cb14-435" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> Path(output_dir)</span>
<span id="cb14-436"><a href="#cb14-436" aria-hidden="true" tabindex="-1"></a>    out.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-437"><a href="#cb14-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-438"><a href="#cb14-438" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> single_file:</span>
<span id="cb14-439"><a href="#cb14-439" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [<span class="bu">str</span>(src <span class="op">/</span> single_file)]</span>
<span id="cb14-440"><a href="#cb14-440" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> Path(html_files[<span class="dv">0</span>]).exists():</span>
<span id="cb14-441"><a href="#cb14-441" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Arquivo n√£o encontrado: </span><span class="sc">{</span>single_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-442"><a href="#cb14-442" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb14-443"><a href="#cb14-443" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb14-444"><a href="#cb14-444" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> <span class="bu">sorted</span>([<span class="bu">str</span>(p) <span class="cf">for</span> p <span class="kw">in</span> src.glob(<span class="st">&quot;*.html&quot;</span>)])</span>
<span id="cb14-445"><a href="#cb14-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-446"><a href="#cb14-446" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb14-447"><a href="#cb14-447" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Nenhum arquivo HTML encontrado.&quot;</span>)</span>
<span id="cb14-448"><a href="#cb14-448" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb14-449"><a href="#cb14-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-450"><a href="#cb14-450" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üéØ Encontrados </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos HTML&quot;</span>)</span>
<span id="cb14-451"><a href="#cb14-451" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>workers<span class="sc">}</span><span class="ss"> | Batch: </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb14-452"><a href="#cb14-452" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss"> tentativas por arquivo&quot;</span>)</span>
<span id="cb14-453"><a href="#cb14-453" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;‚èπÔ∏è  Pressione Ctrl+C para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb14-454"><a href="#cb14-454" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-455"><a href="#cb14-455" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MOSTRAR M√âTODO DE CONVERS√ÉO UTILIZADO</span></span>
<span id="cb14-456"><a href="#cb14-456" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîÑ M√âTODO DE CONVERS√ÉO:&quot;</span>)</span>
<span id="cb14-457"><a href="#cb14-457" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Playwright + Chromium headless&quot;</span>)</span>
<span id="cb14-458"><a href="#cb14-458" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ 1 inst√¢ncia do browser por processo worker&quot;</span>)</span>
<span id="cb14-459"><a href="#cb14-459" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Contexto separado por arquivo HTML&quot;</span>)</span>
<span id="cb14-460"><a href="#cb14-460" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Paralelismo seguro com multiprocessing.Pool&quot;</span>)</span>
<span id="cb14-461"><a href="#cb14-461" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Sistema de retry com m√∫ltiplas tentativas&quot;</span>)</span>
<span id="cb14-462"><a href="#cb14-462" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Timeouts configur√°veis por p√°gina&quot;</span>)</span>
<span id="cb14-463"><a href="#cb14-463" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ INTERRUP√á√ÉO IMEDIATA via Ctrl+C (SIGINT)</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb14-464"><a href="#cb14-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-465"><a href="#cb14-465" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dry_run:</span>
<span id="cb14-466"><a href="#cb14-466" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ MODO SIMULA√á√ÉO - Nenhum arquivo ser√° criado&quot;</span>)</span>
<span id="cb14-467"><a href="#cb14-467" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> html_files[:<span class="dv">5</span>]:</span>
<span id="cb14-468"><a href="#cb14-468" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   üìÑ </span><span class="sc">{</span>Path(f)<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-469"><a href="#cb14-469" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(html_files) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb14-470"><a href="#cb14-470" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(html_files) <span class="op">-</span> <span class="dv">5</span><span class="sc">}</span><span class="ss"> arquivos&quot;</span>)</span>
<span id="cb14-471"><a href="#cb14-471" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb14-472"><a href="#cb14-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-473"><a href="#cb14-473" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb14-474"><a href="#cb14-474" aria-hidden="true" tabindex="-1"></a>        original_count <span class="op">=</span> <span class="bu">len</span>(html_files)</span>
<span id="cb14-475"><a href="#cb14-475" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> html_files <span class="cf">if</span> <span class="kw">not</span> (out <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>Path(f)<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span>).exists()]</span>
<span id="cb14-476"><a href="#cb14-476" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üÜï </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos novos para processar (de </span><span class="sc">{</span>original_count<span class="sc">}</span><span class="ss"> total)&quot;</span>)</span>
<span id="cb14-477"><a href="#cb14-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-478"><a href="#cb14-478" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb14-479"><a href="#cb14-479" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Nenhum arquivo novo para processar&quot;</span>)</span>
<span id="cb14-480"><a href="#cb14-480" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb14-481"><a href="#cb14-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-482"><a href="#cb14-482" aria-hidden="true" tabindex="-1"></a>    batches <span class="op">=</span> chunkify(html_files, batch_size)</span>
<span id="cb14-483"><a href="#cb14-483" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üì¶ </span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> batches preparados&quot;</span>)</span>
<span id="cb14-484"><a href="#cb14-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-485"><a href="#cb14-485" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sistema de comunica√ß√£o OTIMIZADO</span></span>
<span id="cb14-486"><a href="#cb14-486" aria-hidden="true" tabindex="-1"></a>    manager <span class="op">=</span> multiprocessing.Manager()</span>
<span id="cb14-487"><a href="#cb14-487" aria-hidden="true" tabindex="-1"></a>    _stop_event <span class="op">=</span> manager.Event()</span>
<span id="cb14-488"><a href="#cb14-488" aria-hidden="true" tabindex="-1"></a>    msg_queue <span class="op">=</span> manager.Queue()</span>
<span id="cb14-489"><a href="#cb14-489" aria-hidden="true" tabindex="-1"></a>    listener_stop_flag <span class="op">=</span> threading.Event()</span>
<span id="cb14-490"><a href="#cb14-490" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-491"><a href="#cb14-491" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Listener COM ESTAT√çSTICAS</span></span>
<span id="cb14-492"><a href="#cb14-492" aria-hidden="true" tabindex="-1"></a>    listener_thread <span class="op">=</span> threading.Thread(</span>
<span id="cb14-493"><a href="#cb14-493" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>queue_listener_optimized, </span>
<span id="cb14-494"><a href="#cb14-494" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(msg_queue, listener_stop_flag, <span class="bu">len</span>(html_files)), </span>
<span id="cb14-495"><a href="#cb14-495" aria-hidden="true" tabindex="-1"></a>        daemon<span class="op">=</span><span class="va">True</span></span>
<span id="cb14-496"><a href="#cb14-496" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-497"><a href="#cb14-497" aria-hidden="true" tabindex="-1"></a>    listener_thread.start()</span>
<span id="cb14-498"><a href="#cb14-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-499"><a href="#cb14-499" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparar argumentos</span></span>
<span id="cb14-500"><a href="#cb14-500" aria-hidden="true" tabindex="-1"></a>    args_list <span class="op">=</span> [</span>
<span id="cb14-501"><a href="#cb14-501" aria-hidden="true" tabindex="-1"></a>        (batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, _stop_event, msg_queue) </span>
<span id="cb14-502"><a href="#cb14-502" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> batches</span>
<span id="cb14-503"><a href="#cb14-503" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb14-504"><a href="#cb14-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-505"><a href="#cb14-505" aria-hidden="true" tabindex="-1"></a>    success_count, failed <span class="op">=</span> <span class="dv">0</span>, []</span>
<span id="cb14-506"><a href="#cb14-506" aria-hidden="true" tabindex="-1"></a>    _pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb14-507"><a href="#cb14-507" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb14-508"><a href="#cb14-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-509"><a href="#cb14-509" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-510"><a href="#cb14-510" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Criar pool com n√∫mero OTIMIZADO de workers</span></span>
<span id="cb14-511"><a href="#cb14-511" aria-hidden="true" tabindex="-1"></a>        _pool <span class="op">=</span> multiprocessing.Pool(processes<span class="op">=</span>workers)</span>
<span id="cb14-512"><a href="#cb14-512" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-513"><a href="#cb14-513" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üîÑ Iniciando convers√£o OTIMIZADA...&quot;</span>)</span>
<span id="cb14-514"><a href="#cb14-514" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üí° Dica: Pressione Ctrl+C a qualquer momento para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb14-515"><a href="#cb14-515" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-516"><a href="#cb14-516" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Processar batches - com verifica√ß√£o CONSTANTE de parada</span></span>
<span id="cb14-517"><a href="#cb14-517" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, result <span class="kw">in</span> <span class="bu">enumerate</span>(_pool.imap_unordered(worker_wrapper_optimized, args_list)):</span>
<span id="cb14-518"><a href="#cb14-518" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb14-519"><a href="#cb14-519" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> _stop_event.is_set():</span>
<span id="cb14-520"><a href="#cb14-520" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üõë Parada de emerg√™ncia ativada durante o processamento!&quot;</span>)</span>
<span id="cb14-521"><a href="#cb14-521" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb14-522"><a href="#cb14-522" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb14-523"><a href="#cb14-523" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Relat√≥rio de progresso por batch</span></span>
<span id="cb14-524"><a href="#cb14-524" aria-hidden="true" tabindex="-1"></a>            batch_progress <span class="op">=</span> <span class="ss">f&quot;üì¶ Batch </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> processado&quot;</span></span>
<span id="cb14-525"><a href="#cb14-525" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(result) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb14-526"><a href="#cb14-526" aria-hidden="true" tabindex="-1"></a>                batch_success <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> _, success, _ <span class="kw">in</span> result <span class="cf">if</span> success)</span>
<span id="cb14-527"><a href="#cb14-527" aria-hidden="true" tabindex="-1"></a>                batch_progress <span class="op">+=</span> <span class="ss">f&quot; - ‚úÖ </span><span class="sc">{</span>batch_success<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(result)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb14-528"><a href="#cb14-528" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(batch_progress)</span>
<span id="cb14-529"><a href="#cb14-529" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb14-530"><a href="#cb14-530" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_file, success, msg <span class="kw">in</span> result:</span>
<span id="cb14-531"><a href="#cb14-531" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> success:</span>
<span id="cb14-532"><a href="#cb14-532" aria-hidden="true" tabindex="-1"></a>                    success_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-533"><a href="#cb14-533" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb14-534"><a href="#cb14-534" aria-hidden="true" tabindex="-1"></a>                    failed.append((Path(html_file).name, msg))</span>
<span id="cb14-535"><a href="#cb14-535" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb14-536"><a href="#cb14-536" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verifica√ß√£o de parada entre batches</span></span>
<span id="cb14-537"><a href="#cb14-537" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> _stop_event.is_set():</span>
<span id="cb14-538"><a href="#cb14-538" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb14-539"><a href="#cb14-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-540"><a href="#cb14-540" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb14-541"><a href="#cb14-541" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO POR TECLADO DETECTADA !!!&quot;</span>)</span>
<span id="cb14-542"><a href="#cb14-542" aria-hidden="true" tabindex="-1"></a>        _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb14-543"><a href="#cb14-543" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb14-544"><a href="#cb14-544" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb14-545"><a href="#cb14-545" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Erro no pool principal: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-546"><a href="#cb14-546" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb14-547"><a href="#cb14-547" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb14-548"><a href="#cb14-548" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üßπ LIMPEZA FINAL EM ANDAMENTO...&quot;</span>)</span>
<span id="cb14-549"><a href="#cb14-549" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-550"><a href="#cb14-550" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sinalizar parada para todos</span></span>
<span id="cb14-551"><a href="#cb14-551" aria-hidden="true" tabindex="-1"></a>        _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb14-552"><a href="#cb14-552" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb14-553"><a href="#cb14-553" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-554"><a href="#cb14-554" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parar listener</span></span>
<span id="cb14-555"><a href="#cb14-555" aria-hidden="true" tabindex="-1"></a>        listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb14-556"><a href="#cb14-556" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb14-557"><a href="#cb14-557" aria-hidden="true" tabindex="-1"></a>            msg_queue.put(<span class="va">None</span>)</span>
<span id="cb14-558"><a href="#cb14-558" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb14-559"><a href="#cb14-559" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb14-560"><a href="#cb14-560" aria-hidden="true" tabindex="-1"></a>        listener_thread.join(timeout<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb14-561"><a href="#cb14-561" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-562"><a href="#cb14-562" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Terminar pool AGressivamente</span></span>
<span id="cb14-563"><a href="#cb14-563" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> _pool:</span>
<span id="cb14-564"><a href="#cb14-564" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb14-565"><a href="#cb14-565" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üî™ Terminando pool de workers...&quot;</span>)</span>
<span id="cb14-566"><a href="#cb14-566" aria-hidden="true" tabindex="-1"></a>                _pool.terminate()</span>
<span id="cb14-567"><a href="#cb14-567" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb14-568"><a href="#cb14-568" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb14-569"><a href="#cb14-569" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb14-570"><a href="#cb14-570" aria-hidden="true" tabindex="-1"></a>                _pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb14-571"><a href="#cb14-571" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb14-572"><a href="#cb14-572" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb14-573"><a href="#cb14-573" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-574"><a href="#cb14-574" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final agressiva</span></span>
<span id="cb14-575"><a href="#cb14-575" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üóëÔ∏è  Limpando processos √≥rf√£os...&quot;</span>)</span>
<span id="cb14-576"><a href="#cb14-576" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb14-577"><a href="#cb14-577" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-578"><a href="#cb14-578" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pequena pausa para garantir que tudo foi limpo</span></span>
<span id="cb14-579"><a href="#cb14-579" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb14-580"><a href="#cb14-580" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Limpeza conclu√≠da&quot;</span>)</span>
<span id="cb14-581"><a href="#cb14-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-582"><a href="#cb14-582" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Relat√≥rio DETALHADO (apenas se n√£o foi interrompido abruptamente)</span></span>
<span id="cb14-583"><a href="#cb14-583" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> _should_stop <span class="kw">or</span> success_count <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb14-584"><a href="#cb14-584" aria-hidden="true" tabindex="-1"></a>        elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb14-585"><a href="#cb14-585" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;=&quot;</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb14-586"><a href="#cb14-586" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üìä RELAT√ìRIO FINAL OTIMIZADO:&quot;</span>)</span>
<span id="cb14-587"><a href="#cb14-587" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot; ‚úÖ Sucessos: </span><span class="sc">{</span>success_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-588"><a href="#cb14-588" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot; ‚ùå Falhas: </span><span class="sc">{</span><span class="bu">len</span>(failed)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-589"><a href="#cb14-589" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-590"><a href="#cb14-590" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> failed <span class="kw">and</span> <span class="kw">not</span> _should_stop:</span>
<span id="cb14-591"><a href="#cb14-591" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üìã Arquivos com falha (primeiros 10):&quot;</span>)</span>
<span id="cb14-592"><a href="#cb14-592" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> fname, error <span class="kw">in</span> failed[:<span class="dv">10</span>]:</span>
<span id="cb14-593"><a href="#cb14-593" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;   ‚Ä£ </span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-594"><a href="#cb14-594" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(failed) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb14-595"><a href="#cb14-595" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(failed) <span class="op">-</span> <span class="dv">10</span><span class="sc">}</span><span class="ss"> falhas&quot;</span>)</span>
<span id="cb14-596"><a href="#cb14-596" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb14-597"><a href="#cb14-597" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> benchmark <span class="kw">and</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb14-598"><a href="#cb14-598" aria-hidden="true" tabindex="-1"></a>            rate_total <span class="op">=</span> <span class="bu">len</span>(html_files) <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb14-599"><a href="#cb14-599" aria-hidden="true" tabindex="-1"></a>            rate_success <span class="op">=</span> success_count <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb14-600"><a href="#cb14-600" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚è±Ô∏è  Tempo total: </span><span class="sc">{</span>elapsed<span class="sc">:.1f}</span><span class="ss">s&quot;</span>)</span>
<span id="cb14-601"><a href="#cb14-601" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_total<span class="sc">:.1f}</span><span class="ss"> PDFs/min (total)&quot;</span>)</span>
<span id="cb14-602"><a href="#cb14-602" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_success<span class="sc">:.1f}</span><span class="ss"> PDFs/min (sucessos)&quot;</span>)</span>
<span id="cb14-603"><a href="#cb14-603" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-604"><a href="#cb14-604" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="kw">not</span> _should_stop</span>
<span id="cb14-605"><a href="#cb14-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-606"><a href="#cb14-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-607"><a href="#cb14-607" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-608"><a href="#cb14-608" aria-hidden="true" tabindex="-1"></a><span class="co"># CLI OTIMIZADA</span></span>
<span id="cb14-609"><a href="#cb14-609" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-610"><a href="#cb14-610" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args():</span>
<span id="cb14-611"><a href="#cb14-611" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(</span>
<span id="cb14-612"><a href="#cb14-612" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">&quot;Convers√£o HTML ‚Üí PDF ALTAMENTE OTIMIZADA com INTERRUP√á√ÉO IMEDIATA&quot;</span></span>
<span id="cb14-613"><a href="#cb14-613" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-614"><a href="#cb14-614" aria-hidden="true" tabindex="-1"></a>    group <span class="op">=</span> parser.add_mutually_exclusive_group()</span>
<span id="cb14-615"><a href="#cb14-615" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--force&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Sobrescreve PDFs j√° existentes&quot;</span>)</span>
<span id="cb14-616"><a href="#cb14-616" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--only-new&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, default<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Apenas novos (padr√£o)&quot;</span>)</span>
<span id="cb14-617"><a href="#cb14-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-618"><a href="#cb14-618" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--dry-run&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Simula sem criar arquivos&quot;</span>)</span>
<span id="cb14-619"><a href="#cb14-619" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--source&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_html&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta com arquivos .html&quot;</span>)</span>
<span id="cb14-620"><a href="#cb14-620" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--output&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_pdfs&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta de sa√≠da para PDFs&quot;</span>)</span>
<span id="cb14-621"><a href="#cb14-621" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb14-622"><a href="#cb14-622" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos (padr√£o: 2 otimizado para estabilidade)&quot;</span>)</span>
<span id="cb14-623"><a href="#cb14-623" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--batch-size&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">3</span>, </span>
<span id="cb14-624"><a href="#cb14-624" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Arquivos por batch (padr√£o: 3 para resposta r√°pida)&quot;</span>)</span>
<span id="cb14-625"><a href="#cb14-625" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--no-headless&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra navegador (debug)&quot;</span>)</span>
<span id="cb14-626"><a href="#cb14-626" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--single-file&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Converte apenas um arquivo HTML espec√≠fico&quot;</span>)</span>
<span id="cb14-627"><a href="#cb14-627" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--timeout&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">50</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Timeout por p√°gina (padr√£o: 50 segundos)&quot;</span>)</span>
<span id="cb14-628"><a href="#cb14-628" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--retry-count&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Tentativas por arquivo (padr√£o: 2)&quot;</span>)</span>
<span id="cb14-629"><a href="#cb14-629" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--benchmark&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra tempo total e PDFs/minuto&quot;</span>)</span>
<span id="cb14-630"><a href="#cb14-630" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parser.parse_args()</span>
<span id="cb14-631"><a href="#cb14-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-632"><a href="#cb14-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-633"><a href="#cb14-633" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-634"><a href="#cb14-634" aria-hidden="true" tabindex="-1"></a><span class="co"># Main OTIMIZADA</span></span>
<span id="cb14-635"><a href="#cb14-635" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb14-636"><a href="#cb14-636" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb14-637"><a href="#cb14-637" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configurar handler de EMERG√äNCIA para Ctrl+C</span></span>
<span id="cb14-638"><a href="#cb14-638" aria-hidden="true" tabindex="-1"></a>    signal.signal(signal.SIGINT, emergency_stop_handler)</span>
<span id="cb14-639"><a href="#cb14-639" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-640"><a href="#cb14-640" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args()</span>
<span id="cb14-641"><a href="#cb14-641" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-642"><a href="#cb14-642" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üöÄ PDF GENERATOR - VERS√ÉO ALTAMENTE OTIMIZADA&quot;</span>)</span>
<span id="cb14-643"><a href="#cb14-643" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;!!! EMERGENCY STOP ENABLED - Ctrl+C para PARAR TUDO IMEDIATAMENTE !!!&quot;</span>)</span>
<span id="cb14-644"><a href="#cb14-644" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;=&quot;</span> <span class="op">*</span> <span class="dv">65</span>)</span>
<span id="cb14-645"><a href="#cb14-645" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>args<span class="sc">.</span>workers<span class="sc">}</span><span class="ss"> (OTIMIZADO) | Batch: </span><span class="sc">{</span>args<span class="sc">.</span>batch_size<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-646"><a href="#cb14-646" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>args<span class="sc">.</span>retry_count<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>args<span class="sc">.</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb14-647"><a href="#cb14-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-648"><a href="#cb14-648" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza inicial agressiva</span></span>
<span id="cb14-649"><a href="#cb14-649" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb14-650"><a href="#cb14-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-651"><a href="#cb14-651" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verifica√ß√µes</span></span>
<span id="cb14-652"><a href="#cb14-652" aria-hidden="true" tabindex="-1"></a>    source_dir <span class="op">=</span> Path(args.source)</span>
<span id="cb14-653"><a href="#cb14-653" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> source_dir.exists():</span>
<span id="cb14-654"><a href="#cb14-654" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Pasta n√£o encontrada: </span><span class="sc">{</span>source_dir<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-655"><a href="#cb14-655" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb14-656"><a href="#cb14-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-657"><a href="#cb14-657" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_playwright_available(headless_test<span class="op">=</span><span class="kw">not</span> args.no_headless):</span>
<span id="cb14-658"><a href="#cb14-658" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Playwright n√£o dispon√≠vel.&quot;</span>)</span>
<span id="cb14-659"><a href="#cb14-659" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   pip install playwright psutil&quot;</span>)</span>
<span id="cb14-660"><a href="#cb14-660" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   playwright install chromium&quot;</span>)</span>
<span id="cb14-661"><a href="#cb14-661" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb14-662"><a href="#cb14-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-663"><a href="#cb14-663" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Executar vers√£o OTIMIZADA</span></span>
<span id="cb14-664"><a href="#cb14-664" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> generate_pdfs_optimized(</span>
<span id="cb14-665"><a href="#cb14-665" aria-hidden="true" tabindex="-1"></a>        source_dir<span class="op">=</span><span class="bu">str</span>(args.source),</span>
<span id="cb14-666"><a href="#cb14-666" aria-hidden="true" tabindex="-1"></a>        output_dir<span class="op">=</span><span class="bu">str</span>(args.output),</span>
<span id="cb14-667"><a href="#cb14-667" aria-hidden="true" tabindex="-1"></a>        workers<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">min</span>(args.workers, <span class="dv">4</span>)),  <span class="co"># Limite m√°ximo de 4 workers para estabilidade</span></span>
<span id="cb14-668"><a href="#cb14-668" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.batch_size),</span>
<span id="cb14-669"><a href="#cb14-669" aria-hidden="true" tabindex="-1"></a>        headless<span class="op">=</span><span class="kw">not</span> args.no_headless,</span>
<span id="cb14-670"><a href="#cb14-670" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span><span class="bu">max</span>(<span class="dv">15</span>, args.timeout),</span>
<span id="cb14-671"><a href="#cb14-671" aria-hidden="true" tabindex="-1"></a>        force_overwrite<span class="op">=</span>args.force,</span>
<span id="cb14-672"><a href="#cb14-672" aria-hidden="true" tabindex="-1"></a>        dry_run<span class="op">=</span>args.dry_run,</span>
<span id="cb14-673"><a href="#cb14-673" aria-hidden="true" tabindex="-1"></a>        single_file<span class="op">=</span>args.single_file,</span>
<span id="cb14-674"><a href="#cb14-674" aria-hidden="true" tabindex="-1"></a>        retry_count<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.retry_count),</span>
<span id="cb14-675"><a href="#cb14-675" aria-hidden="true" tabindex="-1"></a>        benchmark<span class="op">=</span>args.benchmark</span>
<span id="cb14-676"><a href="#cb14-676" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-677"><a href="#cb14-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-678"><a href="#cb14-678" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resultado final</span></span>
<span id="cb14-679"><a href="#cb14-679" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb14-680"><a href="#cb14-680" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ SIMULA√á√ÉO CONCLU√çDA&quot;</span>)</span>
<span id="cb14-681"><a href="#cb14-681" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb14-682"><a href="#cb14-682" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> success:</span>
<span id="cb14-683"><a href="#cb14-683" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üéâ CONVERS√ÉO CONCLU√çDA COM SUCESSO!&quot;</span>)</span>
<span id="cb14-684"><a href="#cb14-684" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb14-685"><a href="#cb14-685" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb14-686"><a href="#cb14-686" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è CONVERS√ÉO INTERROMPIDA OU COM FALHAS&quot;</span>)</span>
<span id="cb14-687"><a href="#cb14-687" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb14-688"><a href="#cb14-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-689"><a href="#cb14-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-690"><a href="#cb14-690" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb14-691"><a href="#cb14-691" aria-hidden="true" tabindex="-1"></a>    multiprocessing.freeze_support()</span>
<span id="cb14-692"><a href="#cb14-692" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-693"><a href="#cb14-693" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handler global para garantir que Ctrl+C sempre funcione</span></span>
<span id="cb14-694"><a href="#cb14-694" aria-hidden="true" tabindex="-1"></a>    original_sigint <span class="op">=</span> signal.getsignal(signal.SIGINT)</span>
<span id="cb14-695"><a href="#cb14-695" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-696"><a href="#cb14-696" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-697"><a href="#cb14-697" aria-hidden="true" tabindex="-1"></a>        sys.exit(main())</span>
<span id="cb14-698"><a href="#cb14-698" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb14-699"><a href="#cb14-699" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO GLOBAL DETECTADA !!!&quot;</span>)</span>
<span id="cb14-700"><a href="#cb14-700" aria-hidden="true" tabindex="-1"></a>        emergency_stop_handler(<span class="va">None</span>, <span class="va">None</span>)</span>
<span id="cb14-701"><a href="#cb14-701" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb14-702"><a href="#cb14-702" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üí• ERRO CR√çTICO: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb14-703"><a href="#cb14-703" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb14-704"><a href="#cb14-704" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb14-705"><a href="#cb14-705" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Restaurar handler original</span></span>
<span id="cb14-706"><a href="#cb14-706" aria-hidden="true" tabindex="-1"></a>        signal.signal(signal.SIGINT, original_sigint)</span></code></pre></div>
<h2 data-number="1.10" id="principais-corre√ß√µes"><span class="header-section-number">1.10</span> Principais Corre√ß√µes:</h2>
<h3 data-number="1.10.1" id="verifica√ß√£o-do-conda-apenas-no-processo-principal"><span class="header-section-number">1.10.1</span> 1. <strong>Verifica√ß√£o do
Conda Apenas no Processo Principal</strong></h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span> <span class="kw">and</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üîç Verificando ambiente Conda &#39;Pesquisas&#39;...&quot;</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_conda_environment():</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... c√≥digo de erro</span></span></code></pre></div>
<h3 data-number="1.10.2" id="prote√ß√£o-com-__name__-__main__"><span class="header-section-number">1.10.2</span> 2. <strong>Prote√ß√£o com
<code>__name__ == &quot;__main__&quot;</code></strong></h3>
<ul>
<li>A verifica√ß√£o s√≥ acontece quando o script √© executado
diretamente</li>
<li>N√£o acontece quando o script √© importado por processos filhos do
multiprocessing</li>
</ul>
<h3 data-number="1.10.3" id="mant√©m-todas-as-otimiza√ß√µes-anteriores"><span class="header-section-number">1.10.3</span> 3. <strong>Mant√©m Todas as
Otimiza√ß√µes Anteriores</strong></h3>
<ul>
<li>Timeout padr√£o de 50 segundos</li>
<li>Workers: 2, Batch-size: 3</li>
<li>Sistema de interrup√ß√£o robusto</li>
</ul>
<h3 data-number="1.10.4" id="fluxo-corrigido-1"><span class="header-section-number">1.10.4</span> 4. <strong>Fluxo
Corrigido</strong></h3>
<ol type="1">
<li><strong>Processo Principal</strong>: Verifica Conda ‚Üí Importa
Playwright ‚Üí Executa convers√£o</li>
<li><strong>Processos Filhos</strong>: Pulam verifica√ß√£o do Conda ‚Üí
Importam Playwright ‚Üí Processam batches</li>
</ol>
<p>Agora a verifica√ß√£o do Conda aparecer√° <strong>apenas uma
vez</strong> no in√≠cio, e os processos filhos n√£o repetir√£o a
verifica√ß√£o!</p>
<hr />
<h3 data-number="1.10.5" id="utilizador-2025-11-07-062544-deepseek-reasoner"><span class="header-section-number">1.10.5</span> üë§ Utilizador
<em>(2025-11-07 06:25:44)</em> <em>[deepseek-reasoner]</em></h3>
<p>Funciona. Mas Por uma quest√£o de efici√™ncia solicito a remo√ß√£o da
detec√ß√£o do ambiente conda. E assim voltar √† vers√£o anterior sem
detec√ß√£o. Fica responsabilidade do utilizador fazer isso.</p>
<hr />
<h3 data-number="1.10.6" id="deepseek-2025-11-07-062544-deepseek-reasoner"><span class="header-section-number">1.10.6</span> ü§ñ DeepSeek <em>(2025-11-07
06:25:44)</em> <em>[deepseek-reasoner]</em></h3>
<p>Vamos remover a detec√ß√£o do ambiente Conda e voltar √† vers√£o
anterior, mas mantendo as outras otimiza√ß√µes (timeout 50, workers 2,
batch-size 3, etc.). Al√©m disso, vamos garantir que a importa√ß√£o do
Playwright est√° no topo, pois n√£o h√° mais a verifica√ß√£o do Conda que
exigia a importa√ß√£o tardia. Aqui est√° a vers√£o sem a detec√ß√£o do
ambiente Conda, voltando √† vers√£o anterior mais eficiente:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">comb_pdf_direct6_html_based_optimized_live_benchmark.py</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">Vers√£o ALTAMENTE OTIMIZADA com:</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">- Reutiliza√ß√£o de inst√¢ncia do Chromium por processo</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">- Paralelismo seguro via multiprocessing.Pool</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">- Retry por arquivo (2 tentativas padr√£o)</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">- Cancelamento IMEDIATO E CONFI√ÅVEL via Ctrl+C</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">- Workers otimizados (2 padr√£o) e batch-size 3</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">- Browser management aprimorado</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">- Timeout padr√£o de 50 segundos</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> signal</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psutil</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Optional</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright, <span class="pp">TimeoutError</span> <span class="im">as</span> PlaywrightTimeoutError</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Vari√°veis globais para controle de interrup√ß√£o MELHORADO</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>_active_processes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>_should_stop <span class="op">=</span> <span class="va">False</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>_stop_event <span class="op">=</span> <span class="va">None</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>_pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Fun√ß√µes utilit√°rias OTIMIZADAS</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kill_orphaned_chromium():</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Encerra processos Chromium √≥rf√£os de forma agressiva.&quot;&quot;&quot;</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Limpando processos Chromium √≥rf√£os...&quot;</span>)</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>        current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>            subprocess.run(</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chrome.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;msedge.exe&quot;</span>],</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>                stdout<span class="op">=</span>subprocess.DEVNULL, </span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>                stderr<span class="op">=</span>subprocess.DEVNULL,</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>                timeout<span class="op">=</span><span class="dv">10</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chrome&quot;</span>], </span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;playwright&quot;</span>], </span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza adicional para garantir</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="fl">0.5</span>)</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>], </span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è Aviso na limpeza: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunkify(seq: List[<span class="bu">str</span>], size: <span class="bu">int</span>) <span class="op">-&gt;</span> List[List[<span class="bu">str</span>]]:</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [seq[i:i <span class="op">+</span> size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(seq), size)]</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_playwright_available(headless_test: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o Playwright + Chromium est√£o instalados.&quot;&quot;&quot;</span></span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless_test,</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span></span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Erro ao verificar Playwright: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> emergency_stop_handler(signum, frame):</span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handler de emerg√™ncia para Ctrl+C - PARA TUDO IMEDIATAMENTE&quot;&quot;&quot;</span></span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop, _stop_event, _pool</span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-105"><a href="#cb16-105" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">!!! EMERGENCY STOP SOLICITADO !!!&quot;</span>)</span>
<span id="cb16-106"><a href="#cb16-106" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üö® INTERRUP√á√ÉO DE EMERG√äNCIA - Terminando processos...&quot;</span>)</span>
<span id="cb16-107"><a href="#cb16-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-108"><a href="#cb16-108" aria-hidden="true" tabindex="-1"></a>    _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb16-109"><a href="#cb16-109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-110"><a href="#cb16-110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sinalizar parada para todos os processos</span></span>
<span id="cb16-111"><a href="#cb16-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _stop_event:</span>
<span id="cb16-112"><a href="#cb16-112" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb16-113"><a href="#cb16-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-114"><a href="#cb16-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parar pool AGressivamente</span></span>
<span id="cb16-115"><a href="#cb16-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _pool:</span>
<span id="cb16-116"><a href="#cb16-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb16-117"><a href="#cb16-117" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;üõë Terminando pool de workers...&quot;</span>)</span>
<span id="cb16-118"><a href="#cb16-118" aria-hidden="true" tabindex="-1"></a>            _pool.terminate()</span>
<span id="cb16-119"><a href="#cb16-119" aria-hidden="true" tabindex="-1"></a>            _pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-120"><a href="#cb16-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb16-121"><a href="#cb16-121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb16-122"><a href="#cb16-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-123"><a href="#cb16-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Terminar processos filhos de forma agressiva</span></span>
<span id="cb16-124"><a href="#cb16-124" aria-hidden="true" tabindex="-1"></a>    current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb16-125"><a href="#cb16-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb16-126"><a href="#cb16-126" aria-hidden="true" tabindex="-1"></a>        parent <span class="op">=</span> psutil.Process(current_pid)</span>
<span id="cb16-127"><a href="#cb16-127" aria-hidden="true" tabindex="-1"></a>        children <span class="op">=</span> parent.children(recursive<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-128"><a href="#cb16-128" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üî™ Terminando </span><span class="sc">{</span><span class="bu">len</span>(children)<span class="sc">}</span><span class="ss"> processos filhos...&quot;</span>)</span>
<span id="cb16-129"><a href="#cb16-129" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-130"><a href="#cb16-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> child <span class="kw">in</span> children:</span>
<span id="cb16-131"><a href="#cb16-131" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb16-132"><a href="#cb16-132" aria-hidden="true" tabindex="-1"></a>                child_pid <span class="op">=</span> child.pid</span>
<span id="cb16-133"><a href="#cb16-133" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> child_pid <span class="op">!=</span> current_pid <span class="kw">and</span> child_pid <span class="kw">in</span> _active_processes:</span>
<span id="cb16-134"><a href="#cb16-134" aria-hidden="true" tabindex="-1"></a>                    child.kill()</span>
<span id="cb16-135"><a href="#cb16-135" aria-hidden="true" tabindex="-1"></a>                    _active_processes.discard(child_pid)</span>
<span id="cb16-136"><a href="#cb16-136" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb16-137"><a href="#cb16-137" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb16-138"><a href="#cb16-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb16-139"><a href="#cb16-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb16-140"><a href="#cb16-140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-141"><a href="#cb16-141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza final de processos √≥rf√£os</span></span>
<span id="cb16-142"><a href="#cb16-142" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb16-143"><a href="#cb16-143" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-144"><a href="#cb16-144" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üíÄ TODOS OS PROCESSOS FORAM TERMINADOS&quot;</span>)</span>
<span id="cb16-145"><a href="#cb16-145" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è PROGRAMA INTERROMPIDO PELO UTILIZADOR&quot;</span>)</span>
<span id="cb16-146"><a href="#cb16-146" aria-hidden="true" tabindex="-1"></a>    os._exit(<span class="dv">1</span>)  <span class="co"># Sa√≠da de emerg√™ncia</span></span>
<span id="cb16-147"><a href="#cb16-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-148"><a href="#cb16-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-149"><a href="#cb16-149" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-150"><a href="#cb16-150" aria-hidden="true" tabindex="-1"></a><span class="co"># Worker de processamento OTIMIZADO - REUTILIZA BROWSER POR PROCESSO</span></span>
<span id="cb16-151"><a href="#cb16-151" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-152"><a href="#cb16-152" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_process_batch_optimized(batch_files, pdf_dir, timeout, headless, force_overwrite, retry_count, stop_event, msg_queue):</span>
<span id="cb16-153"><a href="#cb16-153" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Worker OTIMIZADO que reutiliza uma inst√¢ncia do Chromium por processo&quot;&quot;&quot;</span></span>
<span id="cb16-154"><a href="#cb16-154" aria-hidden="true" tabindex="-1"></a>    my_pid <span class="op">=</span> os.getpid()</span>
<span id="cb16-155"><a href="#cb16-155" aria-hidden="true" tabindex="-1"></a>    _active_processes.add(my_pid)</span>
<span id="cb16-156"><a href="#cb16-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-157"><a href="#cb16-157" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb16-158"><a href="#cb16-158" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb16-159"><a href="#cb16-159" aria-hidden="true" tabindex="-1"></a>        out_dir <span class="op">=</span> Path(pdf_dir)</span>
<span id="cb16-160"><a href="#cb16-160" aria-hidden="true" tabindex="-1"></a>        out_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-161"><a href="#cb16-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-162"><a href="#cb16-162" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verificar parada ANTES de iniciar o browser</span></span>
<span id="cb16-163"><a href="#cb16-163" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb16-164"><a href="#cb16-164" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb16-165"><a href="#cb16-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-166"><a href="#cb16-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb16-167"><a href="#cb16-167" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Configura√ß√£o OTIMIZADA do browser - UMA INST√ÇNCIA POR PROCESSO</span></span>
<span id="cb16-168"><a href="#cb16-168" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb16-169"><a href="#cb16-169" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless,</span>
<span id="cb16-170"><a href="#cb16-170" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb16-171"><a href="#cb16-171" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb16-172"><a href="#cb16-172" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb16-173"><a href="#cb16-173" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb16-174"><a href="#cb16-174" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb16-175"><a href="#cb16-175" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span>,</span>
<span id="cb16-176"><a href="#cb16-176" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-first-run&#39;</span>,</span>
<span id="cb16-177"><a href="#cb16-177" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--no-default-browser-check&#39;</span>,</span>
<span id="cb16-178"><a href="#cb16-178" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-default-apps&#39;</span>,</span>
<span id="cb16-179"><a href="#cb16-179" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-translate&#39;</span>,</span>
<span id="cb16-180"><a href="#cb16-180" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-extensions&#39;</span></span>
<span id="cb16-181"><a href="#cb16-181" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb16-182"><a href="#cb16-182" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-183"><a href="#cb16-183" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-184"><a href="#cb16-184" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_path_str <span class="kw">in</span> batch_files:</span>
<span id="cb16-185"><a href="#cb16-185" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb16-186"><a href="#cb16-186" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb16-187"><a href="#cb16-187" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb16-188"><a href="#cb16-188" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb16-189"><a href="#cb16-189" aria-hidden="true" tabindex="-1"></a>                html_path <span class="op">=</span> Path(html_path_str)</span>
<span id="cb16-190"><a href="#cb16-190" aria-hidden="true" tabindex="-1"></a>                pdf_path <span class="op">=</span> out_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb16-191"><a href="#cb16-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-192"><a href="#cb16-192" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> pdf_path.exists() <span class="kw">and</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb16-193"><a href="#cb16-193" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;J√° existe&quot;</span>))</span>
<span id="cb16-194"><a href="#cb16-194" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;skip&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb16-195"><a href="#cb16-195" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb16-196"><a href="#cb16-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-197"><a href="#cb16-197" aria-hidden="true" tabindex="-1"></a>                success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb16-198"><a href="#cb16-198" aria-hidden="true" tabindex="-1"></a>                last_error <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb16-199"><a href="#cb16-199" aria-hidden="true" tabindex="-1"></a>                context <span class="op">=</span> <span class="va">None</span></span>
<span id="cb16-200"><a href="#cb16-200" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb16-201"><a href="#cb16-201" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(retry_count):</span>
<span id="cb16-202"><a href="#cb16-202" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb16-203"><a href="#cb16-203" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb16-204"><a href="#cb16-204" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb16-205"><a href="#cb16-205" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb16-206"><a href="#cb16-206" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb16-207"><a href="#cb16-207" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># NOVO CONTEXT por arquivo (mas mesmo browser)</span></span>
<span id="cb16-208"><a href="#cb16-208" aria-hidden="true" tabindex="-1"></a>                        context <span class="op">=</span> browser.new_context(</span>
<span id="cb16-209"><a href="#cb16-209" aria-hidden="true" tabindex="-1"></a>                            viewport<span class="op">=</span>{<span class="st">&#39;width&#39;</span>: <span class="dv">1920</span>, <span class="st">&#39;height&#39;</span>: <span class="dv">1080</span>},</span>
<span id="cb16-210"><a href="#cb16-210" aria-hidden="true" tabindex="-1"></a>                            ignore_https_errors<span class="op">=</span><span class="va">True</span></span>
<span id="cb16-211"><a href="#cb16-211" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb16-212"><a href="#cb16-212" aria-hidden="true" tabindex="-1"></a>                        page <span class="op">=</span> context.new_page()</span>
<span id="cb16-213"><a href="#cb16-213" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb16-214"><a href="#cb16-214" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Timeouts otimizados</span></span>
<span id="cb16-215"><a href="#cb16-215" aria-hidden="true" tabindex="-1"></a>                        page.set_default_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb16-216"><a href="#cb16-216" aria-hidden="true" tabindex="-1"></a>                        page.set_default_navigation_timeout(timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb16-217"><a href="#cb16-217" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb16-218"><a href="#cb16-218" aria-hidden="true" tabindex="-1"></a>                        full_path <span class="op">=</span> <span class="ss">f&quot;file:///</span><span class="sc">{</span>html_path<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb16-219"><a href="#cb16-219" aria-hidden="true" tabindex="-1"></a>                        page.goto(full_path, wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>, timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb16-220"><a href="#cb16-220" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb16-221"><a href="#cb16-221" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada DURANTE o carregamento</span></span>
<span id="cb16-222"><a href="#cb16-222" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb16-223"><a href="#cb16-223" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb16-224"><a href="#cb16-224" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb16-225"><a href="#cb16-225" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Wait for complete load - MAIS CONFI√ÅVEL</span></span>
<span id="cb16-226"><a href="#cb16-226" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_function(</span>
<span id="cb16-227"><a href="#cb16-227" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;document.readyState === &quot;complete&quot;&#39;</span>,</span>
<span id="cb16-228"><a href="#cb16-228" aria-hidden="true" tabindex="-1"></a>                            timeout<span class="op">=</span>timeout <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb16-229"><a href="#cb16-229" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb16-230"><a href="#cb16-230" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb16-231"><a href="#cb16-231" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada DURANTE a espera</span></span>
<span id="cb16-232"><a href="#cb16-232" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb16-233"><a href="#cb16-233" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb16-234"><a href="#cb16-234" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb16-235"><a href="#cb16-235" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Pequena espera para conte√∫do din√¢mico</span></span>
<span id="cb16-236"><a href="#cb16-236" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_timeout(<span class="dv">500</span>)</span>
<span id="cb16-237"><a href="#cb16-237" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb16-238"><a href="#cb16-238" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Verifica√ß√£o de parada ANTES do PDF</span></span>
<span id="cb16-239"><a href="#cb16-239" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb16-240"><a href="#cb16-240" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">break</span></span>
<span id="cb16-241"><a href="#cb16-241" aria-hidden="true" tabindex="-1"></a>                            </span>
<span id="cb16-242"><a href="#cb16-242" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Gera√ß√£o de PDF com configura√ß√µes OTIMIZADAS</span></span>
<span id="cb16-243"><a href="#cb16-243" aria-hidden="true" tabindex="-1"></a>                        page.pdf(</span>
<span id="cb16-244"><a href="#cb16-244" aria-hidden="true" tabindex="-1"></a>                            path<span class="op">=</span><span class="bu">str</span>(pdf_path),</span>
<span id="cb16-245"><a href="#cb16-245" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>,</span>
<span id="cb16-246"><a href="#cb16-246" aria-hidden="true" tabindex="-1"></a>                            print_background<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb16-247"><a href="#cb16-247" aria-hidden="true" tabindex="-1"></a>                            margin<span class="op">=</span>{<span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span>},</span>
<span id="cb16-248"><a href="#cb16-248" aria-hidden="true" tabindex="-1"></a>                            prefer_css_page_size<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb16-249"><a href="#cb16-249" aria-hidden="true" tabindex="-1"></a>                            display_header_footer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb16-250"><a href="#cb16-250" aria-hidden="true" tabindex="-1"></a>                            scale<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb16-251"><a href="#cb16-251" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb16-252"><a href="#cb16-252" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb16-253"><a href="#cb16-253" aria-hidden="true" tabindex="-1"></a>                        success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb16-254"><a href="#cb16-254" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;ok&quot;</span>, pdf_path.name))</span>
<span id="cb16-255"><a href="#cb16-255" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb16-256"><a href="#cb16-256" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb16-257"><a href="#cb16-257" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb16-258"><a href="#cb16-258" aria-hidden="true" tabindex="-1"></a>                        last_error <span class="op">=</span> <span class="bu">str</span>(e)</span>
<span id="cb16-259"><a href="#cb16-259" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># N√£o reportar retry se foi por interrup√ß√£o</span></span>
<span id="cb16-260"><a href="#cb16-260" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb16-261"><a href="#cb16-261" aria-hidden="true" tabindex="-1"></a>                            msg_queue.put((<span class="st">&quot;retry&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb16-262"><a href="#cb16-262" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="op">-</span> <span class="dv">1</span> <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb16-263"><a href="#cb16-263" aria-hidden="true" tabindex="-1"></a>                            time.sleep(<span class="dv">1</span>)  <span class="co"># Pequena pausa entre tentativas</span></span>
<span id="cb16-264"><a href="#cb16-264" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">finally</span>:</span>
<span id="cb16-265"><a href="#cb16-265" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> context:</span>
<span id="cb16-266"><a href="#cb16-266" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">try</span>:</span>
<span id="cb16-267"><a href="#cb16-267" aria-hidden="true" tabindex="-1"></a>                                context.close()</span>
<span id="cb16-268"><a href="#cb16-268" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">except</span>:</span>
<span id="cb16-269"><a href="#cb16-269" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">pass</span></span>
<span id="cb16-270"><a href="#cb16-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-271"><a href="#cb16-271" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Se foi interrompido, sair imediatamente</span></span>
<span id="cb16-272"><a href="#cb16-272" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb16-273"><a href="#cb16-273" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb16-274"><a href="#cb16-274" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb16-275"><a href="#cb16-275" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> success <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb16-276"><a href="#cb16-276" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;fail&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>last_error<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb16-277"><a href="#cb16-277" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">False</span>, last_error))</span>
<span id="cb16-278"><a href="#cb16-278" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> success:</span>
<span id="cb16-279"><a href="#cb16-279" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;Sucesso&quot;</span>))</span>
<span id="cb16-280"><a href="#cb16-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-281"><a href="#cb16-281" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fechar browser ao final do batch</span></span>
<span id="cb16-282"><a href="#cb16-282" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb16-283"><a href="#cb16-283" aria-hidden="true" tabindex="-1"></a>                browser.close()</span>
<span id="cb16-284"><a href="#cb16-284" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb16-285"><a href="#cb16-285" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb16-286"><a href="#cb16-286" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb16-287"><a href="#cb16-287" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb16-288"><a href="#cb16-288" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb16-289"><a href="#cb16-289" aria-hidden="true" tabindex="-1"></a>            msg_queue.put((<span class="st">&quot;error&quot;</span>, <span class="ss">f&quot;Erro no worker: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb16-290"><a href="#cb16-290" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb16-291"><a href="#cb16-291" aria-hidden="true" tabindex="-1"></a>        _active_processes.discard(my_pid)</span>
<span id="cb16-292"><a href="#cb16-292" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-293"><a href="#cb16-293" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb16-294"><a href="#cb16-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-295"><a href="#cb16-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-296"><a href="#cb16-296" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_wrapper_optimized(args):</span>
<span id="cb16-297"><a href="#cb16-297" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Wrapper para o worker otimizado&quot;&quot;&quot;</span></span>
<span id="cb16-298"><a href="#cb16-298" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb16-299"><a href="#cb16-299" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> worker_process_batch_optimized(<span class="op">*</span>args)</span>
<span id="cb16-300"><a href="#cb16-300" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb16-301"><a href="#cb16-301" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb16-302"><a href="#cb16-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-303"><a href="#cb16-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-304"><a href="#cb16-304" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-305"><a href="#cb16-305" aria-hidden="true" tabindex="-1"></a><span class="co"># Listener de mensagens APRIMORADO</span></span>
<span id="cb16-306"><a href="#cb16-306" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-307"><a href="#cb16-307" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> queue_listener_optimized(msg_queue, listener_stop_flag, total_files):</span>
<span id="cb16-308"><a href="#cb16-308" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Listener com barra de progresso e estat√≠sticas&quot;&quot;&quot;</span></span>
<span id="cb16-309"><a href="#cb16-309" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb16-310"><a href="#cb16-310" aria-hidden="true" tabindex="-1"></a>    processed <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-311"><a href="#cb16-311" aria-hidden="true" tabindex="-1"></a>    successes <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-312"><a href="#cb16-312" aria-hidden="true" tabindex="-1"></a>    skips <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-313"><a href="#cb16-313" aria-hidden="true" tabindex="-1"></a>    failures <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb16-314"><a href="#cb16-314" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-315"><a href="#cb16-315" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> listener_stop_flag.is_set():</span>
<span id="cb16-316"><a href="#cb16-316" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb16-317"><a href="#cb16-317" aria-hidden="true" tabindex="-1"></a>            obj <span class="op">=</span> msg_queue.get(timeout<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb16-318"><a href="#cb16-318" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb16-319"><a href="#cb16-319" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb16-320"><a href="#cb16-320" aria-hidden="true" tabindex="-1"></a>            typ, text <span class="op">=</span> obj</span>
<span id="cb16-321"><a href="#cb16-321" aria-hidden="true" tabindex="-1"></a>            processed <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb16-322"><a href="#cb16-322" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-323"><a href="#cb16-323" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> typ <span class="op">==</span> <span class="st">&quot;ok&quot;</span>:</span>
<span id="cb16-324"><a href="#cb16-324" aria-hidden="true" tabindex="-1"></a>                successes <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb16-325"><a href="#cb16-325" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-326"><a href="#cb16-326" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;skip&quot;</span>:</span>
<span id="cb16-327"><a href="#cb16-327" aria-hidden="true" tabindex="-1"></a>                skips <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb16-328"><a href="#cb16-328" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚è≠Ô∏è </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-329"><a href="#cb16-329" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;fail&quot;</span>:</span>
<span id="cb16-330"><a href="#cb16-330" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb16-331"><a href="#cb16-331" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚ùå </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-332"><a href="#cb16-332" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;error&quot;</span>:</span>
<span id="cb16-333"><a href="#cb16-333" aria-hidden="true" tabindex="-1"></a>                failures <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb16-334"><a href="#cb16-334" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üö´ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-335"><a href="#cb16-335" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;retry&quot;</span>:</span>
<span id="cb16-336"><a href="#cb16-336" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üîÑ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-337"><a href="#cb16-337" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-338"><a href="#cb16-338" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Mostrar progresso a cada 5 arquivos para feedback mais frequente</span></span>
<span id="cb16-339"><a href="#cb16-339" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> processed <span class="op">%</span> <span class="dv">5</span> <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> processed <span class="op">==</span> total_files:</span>
<span id="cb16-340"><a href="#cb16-340" aria-hidden="true" tabindex="-1"></a>                elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb16-341"><a href="#cb16-341" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> successes <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb16-342"><a href="#cb16-342" aria-hidden="true" tabindex="-1"></a>                    rate <span class="op">=</span> successes <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb16-343"><a href="#cb16-343" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f&quot;üìä Progresso: </span><span class="sc">{</span>successes<span class="op">+</span>skips<span class="op">+</span>failures<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_files<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb16-344"><a href="#cb16-344" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;‚úÖ</span><span class="sc">{</span>successes<span class="sc">}</span><span class="ss"> ‚è≠Ô∏è</span><span class="sc">{</span>skips<span class="sc">}</span><span class="ss"> ‚ùå</span><span class="sc">{</span>failures<span class="sc">}</span><span class="ss"> | &quot;</span></span>
<span id="cb16-345"><a href="#cb16-345" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f&quot;</span><span class="sc">{</span>rate<span class="sc">:.1f}</span><span class="ss"> PDFs/min&quot;</span>)</span>
<span id="cb16-346"><a href="#cb16-346" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb16-347"><a href="#cb16-347" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb16-348"><a href="#cb16-348" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb16-349"><a href="#cb16-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-350"><a href="#cb16-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-351"><a href="#cb16-351" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-352"><a href="#cb16-352" aria-hidden="true" tabindex="-1"></a><span class="co"># Convers√£o principal - VERS√ÉO ALTAMENTE OTIMIZADA</span></span>
<span id="cb16-353"><a href="#cb16-353" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-354"><a href="#cb16-354" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_pdfs_optimized(source_dir, output_dir, workers, batch_size, headless, timeout,</span>
<span id="cb16-355"><a href="#cb16-355" aria-hidden="true" tabindex="-1"></a>                           force_overwrite, dry_run, single_file<span class="op">=</span><span class="va">None</span>, retry_count<span class="op">=</span><span class="dv">2</span>, benchmark<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb16-356"><a href="#cb16-356" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Fun√ß√£o principal OTIMIZADA com interrup√ß√£o robusta e performance m√°xima&quot;&quot;&quot;</span></span>
<span id="cb16-357"><a href="#cb16-357" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop, _stop_event, _pool</span>
<span id="cb16-358"><a href="#cb16-358" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-359"><a href="#cb16-359" aria-hidden="true" tabindex="-1"></a>    src <span class="op">=</span> Path(source_dir)</span>
<span id="cb16-360"><a href="#cb16-360" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> Path(output_dir)</span>
<span id="cb16-361"><a href="#cb16-361" aria-hidden="true" tabindex="-1"></a>    out.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-362"><a href="#cb16-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-363"><a href="#cb16-363" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> single_file:</span>
<span id="cb16-364"><a href="#cb16-364" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [<span class="bu">str</span>(src <span class="op">/</span> single_file)]</span>
<span id="cb16-365"><a href="#cb16-365" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> Path(html_files[<span class="dv">0</span>]).exists():</span>
<span id="cb16-366"><a href="#cb16-366" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Arquivo n√£o encontrado: </span><span class="sc">{</span>single_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-367"><a href="#cb16-367" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb16-368"><a href="#cb16-368" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb16-369"><a href="#cb16-369" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> <span class="bu">sorted</span>([<span class="bu">str</span>(p) <span class="cf">for</span> p <span class="kw">in</span> src.glob(<span class="st">&quot;*.html&quot;</span>)])</span>
<span id="cb16-370"><a href="#cb16-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-371"><a href="#cb16-371" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb16-372"><a href="#cb16-372" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Nenhum arquivo HTML encontrado.&quot;</span>)</span>
<span id="cb16-373"><a href="#cb16-373" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb16-374"><a href="#cb16-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-375"><a href="#cb16-375" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üéØ Encontrados </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos HTML&quot;</span>)</span>
<span id="cb16-376"><a href="#cb16-376" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>workers<span class="sc">}</span><span class="ss"> | Batch: </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb16-377"><a href="#cb16-377" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss"> tentativas por arquivo&quot;</span>)</span>
<span id="cb16-378"><a href="#cb16-378" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;‚èπÔ∏è  Pressione Ctrl+C para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb16-379"><a href="#cb16-379" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-380"><a href="#cb16-380" aria-hidden="true" tabindex="-1"></a>    <span class="co"># MOSTRAR M√âTODO DE CONVERS√ÉO UTILIZADO</span></span>
<span id="cb16-381"><a href="#cb16-381" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üîÑ M√âTODO DE CONVERS√ÉO:&quot;</span>)</span>
<span id="cb16-382"><a href="#cb16-382" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Playwright + Chromium headless&quot;</span>)</span>
<span id="cb16-383"><a href="#cb16-383" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ 1 inst√¢ncia do browser por processo worker&quot;</span>)</span>
<span id="cb16-384"><a href="#cb16-384" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Contexto separado por arquivo HTML&quot;</span>)</span>
<span id="cb16-385"><a href="#cb16-385" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Paralelismo seguro com multiprocessing.Pool&quot;</span>)</span>
<span id="cb16-386"><a href="#cb16-386" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Sistema de retry com m√∫ltiplas tentativas&quot;</span>)</span>
<span id="cb16-387"><a href="#cb16-387" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ Timeouts configur√°veis por p√°gina&quot;</span>)</span>
<span id="cb16-388"><a href="#cb16-388" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;   ‚Ä¢ INTERRUP√á√ÉO IMEDIATA via Ctrl+C (SIGINT)</span><span class="ch">\n</span><span class="st">&quot;</span>)</span>
<span id="cb16-389"><a href="#cb16-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-390"><a href="#cb16-390" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dry_run:</span>
<span id="cb16-391"><a href="#cb16-391" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ MODO SIMULA√á√ÉO - Nenhum arquivo ser√° criado&quot;</span>)</span>
<span id="cb16-392"><a href="#cb16-392" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> html_files[:<span class="dv">5</span>]:</span>
<span id="cb16-393"><a href="#cb16-393" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   üìÑ </span><span class="sc">{</span>Path(f)<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-394"><a href="#cb16-394" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(html_files) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb16-395"><a href="#cb16-395" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(html_files) <span class="op">-</span> <span class="dv">5</span><span class="sc">}</span><span class="ss"> arquivos&quot;</span>)</span>
<span id="cb16-396"><a href="#cb16-396" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb16-397"><a href="#cb16-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-398"><a href="#cb16-398" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb16-399"><a href="#cb16-399" aria-hidden="true" tabindex="-1"></a>        original_count <span class="op">=</span> <span class="bu">len</span>(html_files)</span>
<span id="cb16-400"><a href="#cb16-400" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> html_files <span class="cf">if</span> <span class="kw">not</span> (out <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>Path(f)<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span>).exists()]</span>
<span id="cb16-401"><a href="#cb16-401" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üÜï </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos novos para processar (de </span><span class="sc">{</span>original_count<span class="sc">}</span><span class="ss"> total)&quot;</span>)</span>
<span id="cb16-402"><a href="#cb16-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-403"><a href="#cb16-403" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb16-404"><a href="#cb16-404" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Nenhum arquivo novo para processar&quot;</span>)</span>
<span id="cb16-405"><a href="#cb16-405" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb16-406"><a href="#cb16-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-407"><a href="#cb16-407" aria-hidden="true" tabindex="-1"></a>    batches <span class="op">=</span> chunkify(html_files, batch_size)</span>
<span id="cb16-408"><a href="#cb16-408" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üì¶ </span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> batches preparados&quot;</span>)</span>
<span id="cb16-409"><a href="#cb16-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-410"><a href="#cb16-410" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sistema de comunica√ß√£o OTIMIZADO</span></span>
<span id="cb16-411"><a href="#cb16-411" aria-hidden="true" tabindex="-1"></a>    manager <span class="op">=</span> multiprocessing.Manager()</span>
<span id="cb16-412"><a href="#cb16-412" aria-hidden="true" tabindex="-1"></a>    _stop_event <span class="op">=</span> manager.Event()</span>
<span id="cb16-413"><a href="#cb16-413" aria-hidden="true" tabindex="-1"></a>    msg_queue <span class="op">=</span> manager.Queue()</span>
<span id="cb16-414"><a href="#cb16-414" aria-hidden="true" tabindex="-1"></a>    listener_stop_flag <span class="op">=</span> threading.Event()</span>
<span id="cb16-415"><a href="#cb16-415" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-416"><a href="#cb16-416" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Listener COM ESTAT√çSTICAS</span></span>
<span id="cb16-417"><a href="#cb16-417" aria-hidden="true" tabindex="-1"></a>    listener_thread <span class="op">=</span> threading.Thread(</span>
<span id="cb16-418"><a href="#cb16-418" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>queue_listener_optimized, </span>
<span id="cb16-419"><a href="#cb16-419" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(msg_queue, listener_stop_flag, <span class="bu">len</span>(html_files)), </span>
<span id="cb16-420"><a href="#cb16-420" aria-hidden="true" tabindex="-1"></a>        daemon<span class="op">=</span><span class="va">True</span></span>
<span id="cb16-421"><a href="#cb16-421" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-422"><a href="#cb16-422" aria-hidden="true" tabindex="-1"></a>    listener_thread.start()</span>
<span id="cb16-423"><a href="#cb16-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-424"><a href="#cb16-424" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparar argumentos</span></span>
<span id="cb16-425"><a href="#cb16-425" aria-hidden="true" tabindex="-1"></a>    args_list <span class="op">=</span> [</span>
<span id="cb16-426"><a href="#cb16-426" aria-hidden="true" tabindex="-1"></a>        (batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, _stop_event, msg_queue) </span>
<span id="cb16-427"><a href="#cb16-427" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> batches</span>
<span id="cb16-428"><a href="#cb16-428" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb16-429"><a href="#cb16-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-430"><a href="#cb16-430" aria-hidden="true" tabindex="-1"></a>    success_count, failed <span class="op">=</span> <span class="dv">0</span>, []</span>
<span id="cb16-431"><a href="#cb16-431" aria-hidden="true" tabindex="-1"></a>    _pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb16-432"><a href="#cb16-432" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb16-433"><a href="#cb16-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-434"><a href="#cb16-434" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb16-435"><a href="#cb16-435" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Criar pool com n√∫mero OTIMIZADO de workers</span></span>
<span id="cb16-436"><a href="#cb16-436" aria-hidden="true" tabindex="-1"></a>        _pool <span class="op">=</span> multiprocessing.Pool(processes<span class="op">=</span>workers)</span>
<span id="cb16-437"><a href="#cb16-437" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-438"><a href="#cb16-438" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üîÑ Iniciando convers√£o OTIMIZADA...&quot;</span>)</span>
<span id="cb16-439"><a href="#cb16-439" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üí° Dica: Pressione Ctrl+C a qualquer momento para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb16-440"><a href="#cb16-440" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-441"><a href="#cb16-441" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Processar batches - com verifica√ß√£o CONSTANTE de parada</span></span>
<span id="cb16-442"><a href="#cb16-442" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, result <span class="kw">in</span> <span class="bu">enumerate</span>(_pool.imap_unordered(worker_wrapper_optimized, args_list)):</span>
<span id="cb16-443"><a href="#cb16-443" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verifica√ß√£o MAIS FREQUENTE de parada</span></span>
<span id="cb16-444"><a href="#cb16-444" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> _stop_event.is_set():</span>
<span id="cb16-445"><a href="#cb16-445" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üõë Parada de emerg√™ncia ativada durante o processamento!&quot;</span>)</span>
<span id="cb16-446"><a href="#cb16-446" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb16-447"><a href="#cb16-447" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb16-448"><a href="#cb16-448" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Relat√≥rio de progresso por batch</span></span>
<span id="cb16-449"><a href="#cb16-449" aria-hidden="true" tabindex="-1"></a>            batch_progress <span class="op">=</span> <span class="ss">f&quot;üì¶ Batch </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> processado&quot;</span></span>
<span id="cb16-450"><a href="#cb16-450" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(result) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb16-451"><a href="#cb16-451" aria-hidden="true" tabindex="-1"></a>                batch_success <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> _, success, _ <span class="kw">in</span> result <span class="cf">if</span> success)</span>
<span id="cb16-452"><a href="#cb16-452" aria-hidden="true" tabindex="-1"></a>                batch_progress <span class="op">+=</span> <span class="ss">f&quot; - ‚úÖ </span><span class="sc">{</span>batch_success<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(result)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb16-453"><a href="#cb16-453" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(batch_progress)</span>
<span id="cb16-454"><a href="#cb16-454" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb16-455"><a href="#cb16-455" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_file, success, msg <span class="kw">in</span> result:</span>
<span id="cb16-456"><a href="#cb16-456" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> success:</span>
<span id="cb16-457"><a href="#cb16-457" aria-hidden="true" tabindex="-1"></a>                    success_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb16-458"><a href="#cb16-458" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb16-459"><a href="#cb16-459" aria-hidden="true" tabindex="-1"></a>                    failed.append((Path(html_file).name, msg))</span>
<span id="cb16-460"><a href="#cb16-460" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb16-461"><a href="#cb16-461" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verifica√ß√£o de parada entre batches</span></span>
<span id="cb16-462"><a href="#cb16-462" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> _stop_event.is_set():</span>
<span id="cb16-463"><a href="#cb16-463" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb16-464"><a href="#cb16-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-465"><a href="#cb16-465" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb16-466"><a href="#cb16-466" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO POR TECLADO DETECTADA !!!&quot;</span>)</span>
<span id="cb16-467"><a href="#cb16-467" aria-hidden="true" tabindex="-1"></a>        _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb16-468"><a href="#cb16-468" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb16-469"><a href="#cb16-469" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb16-470"><a href="#cb16-470" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Erro no pool principal: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-471"><a href="#cb16-471" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb16-472"><a href="#cb16-472" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb16-473"><a href="#cb16-473" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üßπ LIMPEZA FINAL EM ANDAMENTO...&quot;</span>)</span>
<span id="cb16-474"><a href="#cb16-474" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-475"><a href="#cb16-475" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sinalizar parada para todos</span></span>
<span id="cb16-476"><a href="#cb16-476" aria-hidden="true" tabindex="-1"></a>        _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb16-477"><a href="#cb16-477" aria-hidden="true" tabindex="-1"></a>        _stop_event.<span class="bu">set</span>()</span>
<span id="cb16-478"><a href="#cb16-478" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-479"><a href="#cb16-479" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parar listener</span></span>
<span id="cb16-480"><a href="#cb16-480" aria-hidden="true" tabindex="-1"></a>        listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb16-481"><a href="#cb16-481" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb16-482"><a href="#cb16-482" aria-hidden="true" tabindex="-1"></a>            msg_queue.put(<span class="va">None</span>)</span>
<span id="cb16-483"><a href="#cb16-483" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb16-484"><a href="#cb16-484" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb16-485"><a href="#cb16-485" aria-hidden="true" tabindex="-1"></a>        listener_thread.join(timeout<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb16-486"><a href="#cb16-486" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-487"><a href="#cb16-487" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Terminar pool AGressivamente</span></span>
<span id="cb16-488"><a href="#cb16-488" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> _pool:</span>
<span id="cb16-489"><a href="#cb16-489" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb16-490"><a href="#cb16-490" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üî™ Terminando pool de workers...&quot;</span>)</span>
<span id="cb16-491"><a href="#cb16-491" aria-hidden="true" tabindex="-1"></a>                _pool.terminate()</span>
<span id="cb16-492"><a href="#cb16-492" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb16-493"><a href="#cb16-493" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb16-494"><a href="#cb16-494" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb16-495"><a href="#cb16-495" aria-hidden="true" tabindex="-1"></a>                _pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-496"><a href="#cb16-496" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb16-497"><a href="#cb16-497" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb16-498"><a href="#cb16-498" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-499"><a href="#cb16-499" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final agressiva</span></span>
<span id="cb16-500"><a href="#cb16-500" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üóëÔ∏è  Limpando processos √≥rf√£os...&quot;</span>)</span>
<span id="cb16-501"><a href="#cb16-501" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb16-502"><a href="#cb16-502" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-503"><a href="#cb16-503" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pequena pausa para garantir que tudo foi limpo</span></span>
<span id="cb16-504"><a href="#cb16-504" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb16-505"><a href="#cb16-505" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Limpeza conclu√≠da&quot;</span>)</span>
<span id="cb16-506"><a href="#cb16-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-507"><a href="#cb16-507" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Relat√≥rio DETALHADO (apenas se n√£o foi interrompido abruptamente)</span></span>
<span id="cb16-508"><a href="#cb16-508" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> _should_stop <span class="kw">or</span> success_count <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb16-509"><a href="#cb16-509" aria-hidden="true" tabindex="-1"></a>        elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb16-510"><a href="#cb16-510" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;=&quot;</span><span class="op">*</span><span class="dv">60</span>)</span>
<span id="cb16-511"><a href="#cb16-511" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üìä RELAT√ìRIO FINAL OTIMIZADO:&quot;</span>)</span>
<span id="cb16-512"><a href="#cb16-512" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot; ‚úÖ Sucessos: </span><span class="sc">{</span>success_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-513"><a href="#cb16-513" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot; ‚ùå Falhas: </span><span class="sc">{</span><span class="bu">len</span>(failed)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-514"><a href="#cb16-514" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-515"><a href="#cb16-515" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> failed <span class="kw">and</span> <span class="kw">not</span> _should_stop:</span>
<span id="cb16-516"><a href="#cb16-516" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üìã Arquivos com falha (primeiros 10):&quot;</span>)</span>
<span id="cb16-517"><a href="#cb16-517" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> fname, error <span class="kw">in</span> failed[:<span class="dv">10</span>]:</span>
<span id="cb16-518"><a href="#cb16-518" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;   ‚Ä£ </span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>error<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-519"><a href="#cb16-519" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(failed) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb16-520"><a href="#cb16-520" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(failed) <span class="op">-</span> <span class="dv">10</span><span class="sc">}</span><span class="ss"> falhas&quot;</span>)</span>
<span id="cb16-521"><a href="#cb16-521" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb16-522"><a href="#cb16-522" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> benchmark <span class="kw">and</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb16-523"><a href="#cb16-523" aria-hidden="true" tabindex="-1"></a>            rate_total <span class="op">=</span> <span class="bu">len</span>(html_files) <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb16-524"><a href="#cb16-524" aria-hidden="true" tabindex="-1"></a>            rate_success <span class="op">=</span> success_count <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>) <span class="cf">if</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb16-525"><a href="#cb16-525" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚è±Ô∏è  Tempo total: </span><span class="sc">{</span>elapsed<span class="sc">:.1f}</span><span class="ss">s&quot;</span>)</span>
<span id="cb16-526"><a href="#cb16-526" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_total<span class="sc">:.1f}</span><span class="ss"> PDFs/min (total)&quot;</span>)</span>
<span id="cb16-527"><a href="#cb16-527" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üìà Taxa: </span><span class="sc">{</span>rate_success<span class="sc">:.1f}</span><span class="ss"> PDFs/min (sucessos)&quot;</span>)</span>
<span id="cb16-528"><a href="#cb16-528" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-529"><a href="#cb16-529" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="kw">not</span> _should_stop</span>
<span id="cb16-530"><a href="#cb16-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-531"><a href="#cb16-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-532"><a href="#cb16-532" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-533"><a href="#cb16-533" aria-hidden="true" tabindex="-1"></a><span class="co"># CLI OTIMIZADA</span></span>
<span id="cb16-534"><a href="#cb16-534" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-535"><a href="#cb16-535" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args():</span>
<span id="cb16-536"><a href="#cb16-536" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(</span>
<span id="cb16-537"><a href="#cb16-537" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">&quot;Convers√£o HTML ‚Üí PDF ALTAMENTE OTIMIZADA com INTERRUP√á√ÉO IMEDIATA&quot;</span></span>
<span id="cb16-538"><a href="#cb16-538" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-539"><a href="#cb16-539" aria-hidden="true" tabindex="-1"></a>    group <span class="op">=</span> parser.add_mutually_exclusive_group()</span>
<span id="cb16-540"><a href="#cb16-540" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--force&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Sobrescreve PDFs j√° existentes&quot;</span>)</span>
<span id="cb16-541"><a href="#cb16-541" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--only-new&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, default<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Apenas novos (padr√£o)&quot;</span>)</span>
<span id="cb16-542"><a href="#cb16-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-543"><a href="#cb16-543" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--dry-run&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Simula sem criar arquivos&quot;</span>)</span>
<span id="cb16-544"><a href="#cb16-544" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--source&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_html&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta com arquivos .html&quot;</span>)</span>
<span id="cb16-545"><a href="#cb16-545" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--output&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_pdfs&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta de sa√≠da para PDFs&quot;</span>)</span>
<span id="cb16-546"><a href="#cb16-546" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb16-547"><a href="#cb16-547" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos (padr√£o: 2 otimizado para estabilidade)&quot;</span>)</span>
<span id="cb16-548"><a href="#cb16-548" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--batch-size&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">3</span>, </span>
<span id="cb16-549"><a href="#cb16-549" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Arquivos por batch (padr√£o: 3 para resposta r√°pida)&quot;</span>)</span>
<span id="cb16-550"><a href="#cb16-550" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--no-headless&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra navegador (debug)&quot;</span>)</span>
<span id="cb16-551"><a href="#cb16-551" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--single-file&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Converte apenas um arquivo HTML espec√≠fico&quot;</span>)</span>
<span id="cb16-552"><a href="#cb16-552" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--timeout&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">50</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Timeout por p√°gina (padr√£o: 50 segundos)&quot;</span>)</span>
<span id="cb16-553"><a href="#cb16-553" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--retry-count&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Tentativas por arquivo (padr√£o: 2)&quot;</span>)</span>
<span id="cb16-554"><a href="#cb16-554" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--benchmark&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra tempo total e PDFs/minuto&quot;</span>)</span>
<span id="cb16-555"><a href="#cb16-555" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parser.parse_args()</span>
<span id="cb16-556"><a href="#cb16-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-557"><a href="#cb16-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-558"><a href="#cb16-558" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-559"><a href="#cb16-559" aria-hidden="true" tabindex="-1"></a><span class="co"># Main OTIMIZADA</span></span>
<span id="cb16-560"><a href="#cb16-560" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb16-561"><a href="#cb16-561" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb16-562"><a href="#cb16-562" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configurar handler de EMERG√äNCIA para Ctrl+C</span></span>
<span id="cb16-563"><a href="#cb16-563" aria-hidden="true" tabindex="-1"></a>    signal.signal(signal.SIGINT, emergency_stop_handler)</span>
<span id="cb16-564"><a href="#cb16-564" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-565"><a href="#cb16-565" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args()</span>
<span id="cb16-566"><a href="#cb16-566" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-567"><a href="#cb16-567" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üöÄ PDF GENERATOR - VERS√ÉO ALTAMENTE OTIMIZADA&quot;</span>)</span>
<span id="cb16-568"><a href="#cb16-568" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;!!! EMERGENCY STOP ENABLED - Ctrl+C para PARAR TUDO IMEDIATAMENTE !!!&quot;</span>)</span>
<span id="cb16-569"><a href="#cb16-569" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;=&quot;</span> <span class="op">*</span> <span class="dv">65</span>)</span>
<span id="cb16-570"><a href="#cb16-570" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>args<span class="sc">.</span>workers<span class="sc">}</span><span class="ss"> (OTIMIZADO) | Batch: </span><span class="sc">{</span>args<span class="sc">.</span>batch_size<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-571"><a href="#cb16-571" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÑ Retry: </span><span class="sc">{</span>args<span class="sc">.</span>retry_count<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>args<span class="sc">.</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb16-572"><a href="#cb16-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-573"><a href="#cb16-573" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza inicial agressiva</span></span>
<span id="cb16-574"><a href="#cb16-574" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb16-575"><a href="#cb16-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-576"><a href="#cb16-576" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verifica√ß√µes</span></span>
<span id="cb16-577"><a href="#cb16-577" aria-hidden="true" tabindex="-1"></a>    source_dir <span class="op">=</span> Path(args.source)</span>
<span id="cb16-578"><a href="#cb16-578" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> source_dir.exists():</span>
<span id="cb16-579"><a href="#cb16-579" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Pasta n√£o encontrada: </span><span class="sc">{</span>source_dir<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-580"><a href="#cb16-580" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb16-581"><a href="#cb16-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-582"><a href="#cb16-582" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_playwright_available(headless_test<span class="op">=</span><span class="kw">not</span> args.no_headless):</span>
<span id="cb16-583"><a href="#cb16-583" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Playwright n√£o dispon√≠vel.&quot;</span>)</span>
<span id="cb16-584"><a href="#cb16-584" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   pip install playwright psutil&quot;</span>)</span>
<span id="cb16-585"><a href="#cb16-585" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   playwright install chromium&quot;</span>)</span>
<span id="cb16-586"><a href="#cb16-586" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb16-587"><a href="#cb16-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-588"><a href="#cb16-588" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Executar vers√£o OTIMIZADA</span></span>
<span id="cb16-589"><a href="#cb16-589" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> generate_pdfs_optimized(</span>
<span id="cb16-590"><a href="#cb16-590" aria-hidden="true" tabindex="-1"></a>        source_dir<span class="op">=</span><span class="bu">str</span>(args.source),</span>
<span id="cb16-591"><a href="#cb16-591" aria-hidden="true" tabindex="-1"></a>        output_dir<span class="op">=</span><span class="bu">str</span>(args.output),</span>
<span id="cb16-592"><a href="#cb16-592" aria-hidden="true" tabindex="-1"></a>        workers<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">min</span>(args.workers, <span class="dv">4</span>)),  <span class="co"># Limite m√°ximo de 4 workers para estabilidade</span></span>
<span id="cb16-593"><a href="#cb16-593" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.batch_size),</span>
<span id="cb16-594"><a href="#cb16-594" aria-hidden="true" tabindex="-1"></a>        headless<span class="op">=</span><span class="kw">not</span> args.no_headless,</span>
<span id="cb16-595"><a href="#cb16-595" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span><span class="bu">max</span>(<span class="dv">15</span>, args.timeout),</span>
<span id="cb16-596"><a href="#cb16-596" aria-hidden="true" tabindex="-1"></a>        force_overwrite<span class="op">=</span>args.force,</span>
<span id="cb16-597"><a href="#cb16-597" aria-hidden="true" tabindex="-1"></a>        dry_run<span class="op">=</span>args.dry_run,</span>
<span id="cb16-598"><a href="#cb16-598" aria-hidden="true" tabindex="-1"></a>        single_file<span class="op">=</span>args.single_file,</span>
<span id="cb16-599"><a href="#cb16-599" aria-hidden="true" tabindex="-1"></a>        retry_count<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.retry_count),</span>
<span id="cb16-600"><a href="#cb16-600" aria-hidden="true" tabindex="-1"></a>        benchmark<span class="op">=</span>args.benchmark</span>
<span id="cb16-601"><a href="#cb16-601" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-602"><a href="#cb16-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-603"><a href="#cb16-603" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resultado final</span></span>
<span id="cb16-604"><a href="#cb16-604" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb16-605"><a href="#cb16-605" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ SIMULA√á√ÉO CONCLU√çDA&quot;</span>)</span>
<span id="cb16-606"><a href="#cb16-606" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb16-607"><a href="#cb16-607" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> success:</span>
<span id="cb16-608"><a href="#cb16-608" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üéâ CONVERS√ÉO CONCLU√çDA COM SUCESSO!&quot;</span>)</span>
<span id="cb16-609"><a href="#cb16-609" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb16-610"><a href="#cb16-610" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb16-611"><a href="#cb16-611" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è CONVERS√ÉO INTERROMPIDA OU COM FALHAS&quot;</span>)</span>
<span id="cb16-612"><a href="#cb16-612" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb16-613"><a href="#cb16-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-614"><a href="#cb16-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-615"><a href="#cb16-615" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb16-616"><a href="#cb16-616" aria-hidden="true" tabindex="-1"></a>    multiprocessing.freeze_support()</span>
<span id="cb16-617"><a href="#cb16-617" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-618"><a href="#cb16-618" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handler global para garantir que Ctrl+C sempre funcione</span></span>
<span id="cb16-619"><a href="#cb16-619" aria-hidden="true" tabindex="-1"></a>    original_sigint <span class="op">=</span> signal.getsignal(signal.SIGINT)</span>
<span id="cb16-620"><a href="#cb16-620" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-621"><a href="#cb16-621" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb16-622"><a href="#cb16-622" aria-hidden="true" tabindex="-1"></a>        sys.exit(main())</span>
<span id="cb16-623"><a href="#cb16-623" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb16-624"><a href="#cb16-624" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO GLOBAL DETECTADA !!!&quot;</span>)</span>
<span id="cb16-625"><a href="#cb16-625" aria-hidden="true" tabindex="-1"></a>        emergency_stop_handler(<span class="va">None</span>, <span class="va">None</span>)</span>
<span id="cb16-626"><a href="#cb16-626" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb16-627"><a href="#cb16-627" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üí• ERRO CR√çTICO: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-628"><a href="#cb16-628" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb16-629"><a href="#cb16-629" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb16-630"><a href="#cb16-630" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Restaurar handler original</span></span>
<span id="cb16-631"><a href="#cb16-631" aria-hidden="true" tabindex="-1"></a>        signal.signal(signal.SIGINT, original_sigint)</span></code></pre></div>
<h2 data-number="1.11" id="principais-mudan√ßas"><span class="header-section-number">1.11</span> Principais Mudan√ßas:</h2>
<h3 data-number="1.11.1" id="remo√ß√£o-completa-da-detec√ß√£o-do-conda"><span class="header-section-number">1.11.1</span> 1. <strong>Remo√ß√£o Completa
da Detec√ß√£o do Conda</strong></h3>
<ul>
<li>Eliminada toda a l√≥gica de verifica√ß√£o do ambiente Conda</li>
<li>Removidas as fun√ß√µes <code>check_conda_environment()</code></li>
<li>Removidas as verifica√ß√µes iniciais do ambiente</li>
</ul>
<h3 data-number="1.11.2" id="importa√ß√£o-do-playwright-no-topo"><span class="header-section-number">1.11.2</span> 2. <strong>Importa√ß√£o do
Playwright no Topo</strong></h3>
<ul>
<li>O Playwright √© importado normalmente no in√≠cio do arquivo</li>
<li>Sem overhead de importa√ß√£o tardia</li>
<li>Mais simples e eficiente</li>
</ul>
<h3 data-number="1.11.3" id="mant√©m-todas-as-otimiza√ß√µes"><span class="header-section-number">1.11.3</span> 3. <strong>Mant√©m Todas as
Otimiza√ß√µes</strong></h3>
<ul>
<li>Timeout padr√£o de 50 segundos</li>
<li>Workers: 2, Batch-size: 3</li>
<li>Sistema de interrup√ß√£o robusto via Ctrl+C</li>
<li>Reutiliza√ß√£o de inst√¢ncia do Chromium por processo</li>
<li>Paralelismo seguro com multiprocessing.Pool</li>
<li>Sistema de retry (2 tentativas)</li>
</ul>
<h3 data-number="1.11.4" id="responsabilidade-do-utilizador"><span class="header-section-number">1.11.4</span> 4. <strong>Responsabilidade
do Utilizador</strong></h3>
<ul>
<li>Cabe ao utilizador garantir que est√° no ambiente correto</li>
<li>Mensagem clara se o Playwright n√£o estiver dispon√≠vel</li>
<li>Instru√ß√µes de instala√ß√£o mantidas</li>
</ul>
<p>Agora o script √© mais eficiente e direto, sem verifica√ß√µes
desnecess√°rias, mantendo toda a funcionalidade e performance das vers√µes
anteriores!</p>
<hr />
<p><em>Conversa exportada do DeepSeek</em> <em>Processado em: 23/11/2025
14:36</em></p>

        <script id="fixed-toc-script">
        document.addEventListener('DOMContentLoaded', function() {
            const toc = document.getElementById('TOC');
            if (toc) {
                const tocTitle = toc.querySelector('h2');
                if (tocTitle) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.innerHTML = '‚ò∞';
                    toggleBtn.className = 'toc-toggle-btn';
                    toggleBtn.title = 'Minimizar/Expandir TOC';
                    let isMinimized = false;
                    toggleBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        isMinimized = !isMinimized;
                        if (isMinimized) {
                            toc.classList.add('toc-minimized');
                        } else {
                            toc.classList.remove('toc-minimized');
                        }
                    });
                    tocTitle.appendChild(toggleBtn);
                }
            }
            
            // SCROLLSPY
            const sections = document.querySelectorAll('h1, h2, h3, h4, h5');
            const tocLinks = document.querySelectorAll('#TOC a');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('id');
                        tocLinks.forEach(link => {
                            link.classList.remove('active');
                            if (link.getAttribute('href') === '#' + id) {
                                link.classList.add('active');
                            }
                        });
                    }
                });
            }, { 
                rootMargin: '-20% 0px -60% 0px', 
                threshold: 0 
            });
            
            sections.forEach(section => {
                if (section.id) observer.observe(section);
            });
            
            // Scroll suave
            tocLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        const offsetTop = targetElement.offsetTop - 80;
                        window.scrollTo({ top: offsetTop, behavior: 'smooth' });
                    }
                });
            });
            
            // BOT√ÉO VOLTAR AO TOPO
            const backToTopBtn = document.createElement('button');
            backToTopBtn.className = 'back-to-top-content';
            backToTopBtn.innerHTML = '‚Üë';
            backToTopBtn.title = 'Voltar ao Topo';
            document.body.appendChild(backToTopBtn);
            
            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    backToTopBtn.classList.add('show');
                } else {
                    backToTopBtn.classList.remove('show');
                }
            });
            
            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
        </script>
        
</body>
</html>
