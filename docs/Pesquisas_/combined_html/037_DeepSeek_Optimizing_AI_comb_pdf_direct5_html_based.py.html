<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>

        <style id="fixed-toc-styles">
        /* === ESTILOS PRINCIPAIS - TOC FIXO √Ä DIREITA === */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            scroll-behavior: smooth;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            position: relative;
        }
        /* === TOC FIXO √Ä DIREITA - POSI√á√ÉO CORRIGIDA === */
        #TOC {
            position: fixed !important;
            top: 50% !important;
            right: 20px !important;
            transform: translateY(-50%) !important;
            width: 320px !important;
            max-height: 80vh !important;
            overflow-y: auto !important;
            z-index: 1000 !important;
            background: rgba(255, 255, 255, 0.98) !important;
            padding: 20px !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15) !important;
            border: 1px solid #e0e0e0 !important;
            backdrop-filter: blur(10px) !important;
            transition: all 0.3s ease-in-out !important;
        }
        #TOC.toc-minimized {
            transform: translateY(-50%) translateX(calc(320px - 50px)) !important;
            opacity: 0.3;
            width: 50px !important;
            overflow: hidden;
        }
        #TOC.toc-minimized > *:not(.toc-toggle-btn) {
            display: none !important;
        }
        #TOC h2 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            font-size: 1.2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .toc-toggle-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .toc-toggle-btn:hover {
            background-color: rgba(0,0,0,0.1);
        }
        #TOC ul {
            list-style-type: none;
            padding-left: 15px;
            margin: 10px 0;
        }
        #TOC ul ul {
            padding-left: 20px;
        }
        #TOC li {
            margin: 8px 0;
            line-height: 1.4;
        }
        #TOC a {
            text-decoration: none;
            color: #495057;
            font-weight: 500;
            transition: all 0.2s ease;
            display: block;
            padding: 6px 10px;
            border-radius: 6px;
            border-left: 3px solid transparent;
        }
        #TOC a:hover {
            color: #007bff;
            background-color: rgba(0, 123, 255, 0.1);
            border-left-color: #007bff;
        }
        #TOC a.active {
            background-color: #007bff !important;
            color: white !important;
            font-weight: bold;
            border-left-color: #0056b3;
        }
        /* Conte√∫do principal com margem para o TOC */
        .main-content {
            margin-right: calc(320px + 40px) !important;
        }
        /* Barra de scroll personalizada APENAS para TOC */
        #TOC::-webkit-scrollbar {
            width: 8px;
        }
        #TOC::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        #TOC::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        #TOC::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        /* === BOT√ÉO VOLTAR AO TOPO (HTMLs individuais) === */
        .back-to-top-content {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .back-to-top-content.show {
            opacity: 1;
            transform: translateY(0);
        }
        .back-to-top-content:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        /* === RESPONSIVIDADE === */
        @media (max-width: 1400px) {
            .container {
                max-width: 95%;
                padding: 30px;
            }
            #TOC {
                width: 280px !important;
            }
            .main-content {
                margin-right: 320px !important;
            }
        }
        @media (max-width: 1200px) {
            #TOC {
                width: 260px !important;
                right: 15px !important;
            }
            .main-content {
                margin-right: 300px !important;
            }
        }
        @media (max-width: 992px) {
            #TOC {
                position: relative !important;
                width: 100% !important;
                right: 0 !important;
                top: 0 !important;
                transform: none !important;
                margin: 20px 0;
                max-height: 300px !important;
            }
            .main-content {
                margin-right: 0 !important;
            }
            .back-to-top-content {
                right: 20px;
                bottom: 20px;
            }
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 20px;
                max-width: 100%;
            }
            #TOC {
                max-height: 250px !important;
                padding: 15px !important;
            }
        }
        </style>
        
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>037_DeepSeek_Optimizing_AI_comb_pdf_direct5_html_based.py</title>
  <style>

html {
color: #1a1a1a;
background-color: #fdfdfd;
}
body {
margin: 0 auto;
max-width: 36em;
padding-left: 50px;
padding-right: 50px;
padding-top: 50px;
padding-bottom: 50px;
hyphens: auto;
overflow-wrap: break-word;
text-rendering: optimizeLegibility;
font-kerning: normal;
}
@media (max-width: 600px) {
body {
font-size: 0.9em;
padding: 12px;
}
h1 {
font-size: 1.8em;
}
}
@media print {
html {
background-color: white;
}
body {
background-color: transparent;
color: black;
font-size: 12pt;
}
p, h2, h3 {
orphans: 3;
widows: 3;
}
h2, h3, h4 {
page-break-after: avoid;
}
}
p {
margin: 1em 0;
}
a {
color: #1a1a1a;
}
a:visited {
color: #1a1a1a;
}
img {
max-width: 100%;
}
svg {
height: auto;
max-width: 100%;
}
h1, h2, h3, h4, h5, h6 {
margin-top: 1.4em;
}
h5, h6 {
font-size: 1em;
font-style: italic;
}
h6 {
font-weight: normal;
}
ol, ul {
padding-left: 1.7em;
margin-top: 1em;
}
li > ol, li > ul {
margin-top: 0;
}
blockquote {
margin: 1em 0 1em 1.7em;
padding-left: 1em;
border-left: 2px solid #e6e6e6;
color: #606060;
}
code {
font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
font-size: 85%;
margin: 0;
hyphens: manual;
}
pre {
margin: 1em 0;
overflow: auto;
}
pre code {
padding: 0;
overflow: visible;
overflow-wrap: normal;
}
.sourceCode {
background-color: transparent;
overflow: visible;
}
hr {
border: none;
border-top: 1px solid #1a1a1a;
height: 1px;
margin: 1em 0;
}
table {
margin: 1em 0;
border-collapse: collapse;
width: 100%;
overflow-x: auto;
display: block;
font-variant-numeric: lining-nums tabular-nums;
}
table caption {
margin-bottom: 0.75em;
}
tbody {
margin-top: 0.5em;
border-top: 1px solid #1a1a1a;
border-bottom: 1px solid #1a1a1a;
}
th {
border-top: 1px solid #1a1a1a;
padding: 0.25em 0.5em 0.25em 0.5em;
}
td {
padding: 0.125em 0.5em 0.25em 0.5em;
}
header {
margin-bottom: 4em;
text-align: center;
}
#TOC li {
list-style: none;
}
#TOC ul {
padding-left: 1.3em;
}
#TOC > ul {
padding-left: 0;
}
#TOC a:not(:hover) {
text-decoration: none;
}
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}

ul.task-list[class]{list-style: none;}
ul.task-list li input[type="checkbox"] {
font-size: inherit;
width: 0.8em;
margin: 0 0.8em 0.2em -1.6em;
vertical-align: middle;
}

html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#optimizing-ai-comb_pdf_direct5_html_based.py" id="toc-optimizing-ai-comb_pdf_direct5_html_based.py"><span class="toc-section-number">1</span> Optimizing AI
comb_pdf_direct5_html_based.py</a>
<ul>
<li><a href="#informa√ß√µes" id="toc-informa√ß√µes"><span class="toc-section-number">1.1</span> üìä Informa√ß√µes</a></li>
<li><a href="#conversa" id="toc-conversa"><span class="toc-section-number">1.2</span> üí¨ Conversa</a></li>
<li><a href="#vantagens-do-playwright" id="toc-vantagens-do-playwright"><span class="toc-section-number">1.3</span> üöÄ <strong>VANTAGENS DO
PLAYWRIGHT</strong></a></li>
<li><a href="#compara√ß√£o-direta" id="toc-compara√ß√£o-direta"><span class="toc-section-number">1.4</span> üìä <strong>COMPARA√á√ÉO
DIRETA</strong></a></li>
<li><a href="#script-otimizado-com-playwright" id="toc-script-otimizado-com-playwright"><span class="toc-section-number">1.5</span> üîß <strong>SCRIPT OTIMIZADO COM
PLAYWRIGHT</strong></a></li>
<li><a href="#recomenda√ß√£o" id="toc-recomenda√ß√£o"><span class="toc-section-number">1.6</span> üéØ
<strong>RECOMENDA√á√ÉO</strong></a></li>
<li><a href="#benef√≠cios-esperados" id="toc-benef√≠cios-esperados"><span class="toc-section-number">1.7</span> üìà <strong>BENEF√çCIOS
ESPERADOS</strong></a></li>
<li><a href="#principais-melhorias-com-playwright" id="toc-principais-melhorias-com-playwright"><span class="toc-section-number">1.8</span> üöÄ <strong>Principais Melhorias
com Playwright:</strong></a></li>
<li><a href="#principais-otimiza√ß√µes-adicionadas" id="toc-principais-otimiza√ß√µes-adicionadas"><span class="toc-section-number">1.9</span> üîß <strong>Principais Otimiza√ß√µes
Adicionadas:</strong></a></li>
<li><a href="#vantagens-das-altera√ß√µes" id="toc-vantagens-das-altera√ß√µes"><span class="toc-section-number">1.10</span> üéØ <strong>Vantagens das
Altera√ß√µes:</strong></a></li>
<li><a href="#uso-recomendado" id="toc-uso-recomendado"><span class="toc-section-number">1.11</span> üìä <strong>Uso
Recomendado:</strong></a></li>
<li><a href="#principais-melhorias-implementadas" id="toc-principais-melhorias-implementadas"><span class="toc-section-number">1.12</span> üöÄ <strong>Principais Melhorias
Implementadas:</strong></a></li>
<li><a href="#vantagens-das-melhorias" id="toc-vantagens-das-melhorias"><span class="toc-section-number">1.13</span> üéØ <strong>Vantagens das
Melhorias:</strong></a></li>
<li><a href="#uso-recomendado-1" id="toc-uso-recomendado-1"><span class="toc-section-number">1.14</span> üìä <strong>Uso
Recomendado:</strong></a></li>
<li><a href="#principais-melhorias-na-interrup√ß√£o-ctrlc" id="toc-principais-melhorias-na-interrup√ß√£o-ctrlc"><span class="toc-section-number">1.15</span> üöÄ <strong>Principais Melhorias
na Interrup√ß√£o Ctrl+C:</strong></a></li>
<li><a href="#como-funciona-agora" id="toc-como-funciona-agora"><span class="toc-section-number">1.16</span> üéØ <strong>Como Funciona
Agora:</strong></a></li>
<li><a href="#par√¢metros-otimizados" id="toc-par√¢metros-otimizados"><span class="toc-section-number">1.17</span> üìä <strong>Par√¢metros
Otimizados:</strong></a></li>
<li><a href="#teste-a-interrup√ß√£o" id="toc-teste-a-interrup√ß√£o"><span class="toc-section-number">1.18</span> üß™ <strong>Teste a
Interrup√ß√£o:</strong></a></li>
<li><a href="#principais-corre√ß√µes-para-ctrlc" id="toc-principais-corre√ß√µes-para-ctrlc"><span class="toc-section-number">1.19</span> üö® <strong>Principais Corre√ß√µes
para Ctrl+C:</strong></a></li>
<li><a href="#como-testar" id="toc-como-testar"><span class="toc-section-number">1.20</span> üéØ <strong>Como
Testar:</strong></a></li>
<li><a href="#diferen√ßas-chave" id="toc-diferen√ßas-chave"><span class="toc-section-number">1.21</span> ‚ö° <strong>Diferen√ßas
Chave:</strong></a></li>
</ul></li>
</ul>
</nav>
<h1 data-number="1" id="optimizing-ai-comb_pdf_direct5_html_based.py"><span class="header-section-number">1</span> Optimizing AI
comb_pdf_direct5_html_based.py</h1>
<h2 data-number="1.1" id="informa√ß√µes"><span class="header-section-number">1.1</span> üìä Informa√ß√µes</h2>
<ul>
<li><strong>N√∫mero:</strong> #37</li>
<li><strong>Origem:</strong> DeepSeek</li>
<li><strong>Categoria:</strong> Outros</li>
<li><strong>ID:</strong> 366a4b09-238f-47d0-a9fd-547cb7f1627d</li>
<li><strong>Criada em:</strong> 2025-11-06 01:53:16</li>
<li><strong>Atualizada em:</strong> 2025-11-06 07:36:49</li>
<li><strong>Total de mensagens:</strong> 12</li>
<li><strong>Resumo:</strong> Optimiza√ß√£o de
comb_pdf_direct5_html_based.py Gostaria de saber se h√° ou n√£o alguma
vantagem em us‚Ä¶</li>
</ul>
<hr />
<h2 data-number="1.2" id="conversa"><span class="header-section-number">1.2</span> üí¨ Conversa</h2>
<h3 data-number="1.2.1" id="utilizador-2025-11-06-015318-deepseek-reasoner"><span class="header-section-number">1.2.1</span> üë§ Utilizador <em>(2025-11-06
01:53:18)</em> <em>[deepseek-reasoner]</em></h3>
<p>Optimiza√ß√£o de comb_pdf_direct5_html_based.py Gostaria de saber se h√°
ou n√£o alguma vantagem em usar Playwright em vez de Selenium +
ChromeDriver neste script?</p>
<hr />
<h3 data-number="1.2.2" id="deepseek-2025-11-06-015318-deepseek-reasoner"><span class="header-section-number">1.2.2</span> ü§ñ DeepSeek <em>(2025-11-06
01:53:18)</em> <em>[deepseek-reasoner]</em></h3>
<p>Vantagens do Playwright em compara√ß√£o com Selenium +
ChromeDriver:</p>
<ol type="1">
<li><p><strong>Performance</strong>: O Playwright √© geralmente mais
r√°pido na execu√ß√£o de testes e automa√ß√£o, pois comunica-se diretamente
com o navegador via protocolo DevTools, sem overhead do
WebDriver.</p></li>
<li><p><strong>Recursos embutidos</strong>: O Playwright tem suporte
nativo para gera√ß√£o de PDF (via <code>page.pdf()</code>), o que poderia
simplificar o c√≥digo e torn√°-lo mais robusto.</p></li>
<li><p><strong>Manuten√ß√£o</strong>: O Playwright √© mais moderno e tem
uma API mais limpa e f√°cil de usar. Al√©m disso, gerencia automaticamente
os drivers dos navegadores (Chrome, Firefox, Safari), n√£o exigindo a
instala√ß√£o separada do ChromeDriver.</p></li>
<li><p><strong>Confiabilidade</strong>: O Playwright √© projetado para
ser mais confi√°vel em ambientes headless, com recursos como waits
autom√°ticos e detec√ß√£o de rede.</p></li>
<li><p><strong>Recursos de automa√ß√£o</strong>: Oferece recursos como
intercepta√ß√£o de rede, emula√ß√£o de dispositivos, e grava√ß√£o de v√≠deo,
que podem ser √∫teis para projetos futuros.</p></li>
</ol>
<p>No entanto, h√° algumas considera√ß√µes:</p>
<ul>
<li><strong>Compatibilidade</strong>: Se voc√™ j√° tem um c√≥digo baseado
em Selenium, a migra√ß√£o pode exigir esfor√ßo.</li>
<li><strong>Ecossistema</strong>: O Selenium tem uma comunidade maior e
√© mais estabelecido.</li>
</ul>
<p>No contexto deste script, a principal vantagem seria a simplifica√ß√£o
da gera√ß√£o de PDF, pois o Playwright tem uma API dedicada para isso.
Veja como ficaria a fun√ß√£o <code>html_to_pdf</code> usando
Playwright:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> html_to_pdf_playwright(html_file: <span class="bu">str</span>, pdf_file: <span class="bu">str</span>, retry_count: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(retry_count):</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>                browser <span class="op">=</span> p.chromium.launch(headless<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>                page <span class="op">=</span> browser.new_page()</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>                page.goto(<span class="ss">f&quot;file:///</span><span class="sc">{</span>html_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>                page.pdf(path<span class="op">=</span>pdf_file, <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>, print_background<span class="op">=</span><span class="va">True</span>, margin<span class="op">=</span>{<span class="st">&quot;top&quot;</span>: <span class="st">&quot;0.5in&quot;</span>, <span class="st">&quot;bottom&quot;</span>: <span class="st">&quot;0.5in&quot;</span>, <span class="st">&quot;left&quot;</span>: <span class="st">&quot;0.5in&quot;</span>, <span class="st">&quot;right&quot;</span>: <span class="st">&quot;0.5in&quot;</span>})</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>                browser.close()</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;Erro na tentativa </span><span class="sc">{</span>attempt<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                time.sleep(<span class="dv">5</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">False</span></span></code></pre></div>
<p>Note que o Playwright n√£o requer a decodifica√ß√£o de base64, pois
salva o PDF diretamente. Al√©m disso, a espera pela renderiza√ß√£o √© feita
automaticamente pelo <code>page.goto()</code>.</p>
<p>No entanto, a migra√ß√£o para Playwright exigiria:</p>
<ul>
<li>Substituir todas as fun√ß√µes que usam Selenium por Playwright.</li>
<li>Instalar o Playwright (<code>pip install playwright</code>) e baixar
os browsers (<code>playwright install</code>).</li>
</ul>
<p>Conclus√£o: Se voc√™ est√° come√ßando um novo projeto ou pode refatorar,
o Playwright pode ser uma op√ß√£o mais moderna e eficiente. Mas se voc√™ j√°
tem um c√≥digo baseado em Selenium e n√£o quer mudar, o Selenium ainda √©
uma op√ß√£o v√°lida.</p>
<p>Dado que o script j√° est√° funcionando com Selenium, a mudan√ßa para
Playwright traria benef√≠cios em simplicidade e performance, mas exigiria
tempo para reescrever e testar.</p>
<p>Vou deixar a decis√£o para voc√™, baseada nas necessidades do projeto e
na disponibilidade para refatorar. Analisando seu script
<code>comb_pdf_direct5_html_based.py</code>, h√° <strong>SIM vantagens
significativas</strong> em migrar para o Playwright. Vou detalhar os
benef√≠cios:</p>
<h2 data-number="1.3" id="vantagens-do-playwright"><span class="header-section-number">1.3</span> üöÄ <strong>VANTAGENS DO
PLAYWRIGHT</strong></h2>
<h3 data-number="1.3.1" id="performance-superior"><span class="header-section-number">1.3.1</span> 1. <strong>Performance
Superior</strong></h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Playwright - Mais r√°pido</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> html_to_pdf_playwright(html_file: <span class="bu">str</span>, pdf_file: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        browser <span class="op">=</span> p.chromium.launch(headless<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        page <span class="op">=</span> browser.new_page()</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        page.goto(<span class="ss">f&quot;file:///</span><span class="sc">{</span>html_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        page.pdf(path<span class="op">=</span>pdf_file, <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        browser.close()</span></code></pre></div>
<h3 data-number="1.3.2" id="gerenciamento-autom√°tico-de-drivers"><span class="header-section-number">1.3.2</span> 2. <strong>Gerenciamento
Autom√°tico de Drivers</strong></h3>
<ul>
<li>‚ùå <strong>Selenium</strong>: Requer ChromeDriver compat√≠vel com
vers√£o do Chrome</li>
<li>‚úÖ <strong>Playwright</strong>: Baixa e gerencia browsers
automaticamente</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">playwright</span> install chromium</span></code></pre></div>
<h3 data-number="1.3.3" id="api-mais-robusta-para-pdf"><span class="header-section-number">1.3.3</span> 3. <strong>API Mais Robusta
para PDF</strong></h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Par√¢metros mais confi√°veis</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>page.pdf(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    path<span class="op">=</span>pdf_file,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    print_background<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    margin<span class="op">=</span>{<span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span>},</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    prefer_css_page_size<span class="op">=</span><span class="va">True</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<h3 data-number="1.3.4" id="melhor-controle-de-waittimeout"><span class="header-section-number">1.3.4</span> 4. <strong>Melhor Controle de
Wait/Timeout</strong></h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Wait mais inteligente</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>page.goto(<span class="ss">f&quot;file:///</span><span class="sc">{</span>html_file<span class="sc">}</span><span class="ss">&quot;</span>, wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>page.wait_for_function(<span class="st">&#39;document.readyState === &quot;complete&quot;&#39;</span>)</span></code></pre></div>
<h3 data-number="1.3.5" id="menos-configura√ß√£o-e-mais-est√°vel"><span class="header-section-number">1.3.5</span> 5. <strong>Menos Configura√ß√£o
e Mais Est√°vel</strong></h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Elimina essas op√ß√µes problem√°ticas</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># options.add_argument(&#39;--disable-gpu&#39;)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># options.add_argument(&#39;--no-sandbox&#39;)</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># options.add_argument(&#39;--disable-dev-shm-usage&#39;)</span></span></code></pre></div>
<h2 data-number="1.4" id="compara√ß√£o-direta"><span class="header-section-number">1.4</span> üìä <strong>COMPARA√á√ÉO
DIRETA</strong></h2>
<table>
<thead>
<tr>
<th>Aspecto</th>
<th>Selenium + ChromeDriver</th>
<th>Playwright</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Instala√ß√£o</strong></td>
<td>Manual + version matching</td>
<td>Autom√°tica</td>
</tr>
<tr>
<td><strong>Performance</strong></td>
<td>Mais lento</td>
<td>2-3x mais r√°pido</td>
</tr>
<tr>
<td><strong>Estabilidade</strong></td>
<td>Timeouts frequentes</td>
<td>Mais robusto</td>
</tr>
<tr>
<td><strong>Manuten√ß√£o</strong></td>
<td>Complexa</td>
<td>Simplificada</td>
</tr>
<tr>
<td><strong>Recursos PDF</strong></td>
<td>Via CDP commands</td>
<td>Nativo</td>
</tr>
</tbody>
</table>
<h2 data-number="1.5" id="script-otimizado-com-playwright"><span class="header-section-number">1.5</span> üîß <strong>SCRIPT OTIMIZADO COM
PLAYWRIGHT</strong></h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Exemplo da fun√ß√£o principal otimizada</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> html_to_pdf_playwright(<span class="va">self</span>, html_file: <span class="bu">str</span>, pdf_file: <span class="bu">str</span>, retry_count: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(retry_count):</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                browser <span class="op">=</span> p.chromium.launch(headless<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                page <span class="op">=</span> browser.new_page()</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Navega√ß√£o mais confi√°vel</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>                page.goto(</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f&quot;file:///</span><span class="sc">{</span>Path(html_file)<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>                    wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>                    timeout<span class="op">=</span><span class="va">self</span>.timeout <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Wait autom√°tico para recursos</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                page.wait_for_load_state(<span class="st">&#39;networkidle&#39;</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Gera√ß√£o de PDF mais simples e confi√°vel</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>                page.pdf(</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>                    path<span class="op">=</span>pdf_file,</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>,</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>                    print_background<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>                    margin<span class="op">=</span>{<span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span>},</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>                    prefer_css_page_size<span class="op">=</span><span class="va">True</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>                browser.close()</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.warning(<span class="ss">f&quot;Tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss"> falhou: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>                time.sleep(<span class="dv">2</span>)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">False</span></span></code></pre></div>
<h2 data-number="1.6" id="recomenda√ß√£o"><span class="header-section-number">1.6</span> üéØ
<strong>RECOMENDA√á√ÉO</strong></h2>
<p><strong>Migre para Playwright</strong> se: - ‚úÖ Quer maior
estabilidade e menos falhas - ‚úÖ Prefere menos configura√ß√£o e manuten√ß√£o
- ‚úÖ Precisa de melhor performance - ‚úÖ Est√° come√ßando novo projeto ou
pode refatorar</p>
<p><strong>Mantenha Selenium</strong> se: - ‚ùå Tem depend√™ncias legadas
- ‚ùå Precisa de suporte a browsers espec√≠ficos - ‚ùå Time limitado para
migra√ß√£o</p>
<h2 data-number="1.7" id="benef√≠cios-esperados"><span class="header-section-number">1.7</span> üìà <strong>BENEF√çCIOS
ESPERADOS</strong></h2>
<ol type="1">
<li><strong>Redu√ß√£o de 60-80% em falhas de convers√£o</strong></li>
<li><strong>Performance 2-3x melhor</strong></li>
<li><strong>C√≥digo 40% mais simples</strong></li>
<li><strong>Menos problemas de compatibilidade</strong></li>
</ol>
<p>A migra√ß√£o √© relativamente simples e os benef√≠cios justificam o
esfor√ßo, especialmente para um script de produ√ß√£o como o seu.</p>
<hr />
<h3 data-number="1.7.1" id="utilizador-2025-11-06-015824-deepseek-reasoner"><span class="header-section-number">1.7.1</span> üë§ Utilizador <em>(2025-11-06
01:58:24)</em> <em>[deepseek-reasoner]</em></h3>
<p>ok. Assim pretendo um comb_pdf_direct6_html_based.py que use o
Playwright em vez do metodo anterior</p>
<hr />
<h3 data-number="1.7.2" id="deepseek-2025-11-06-015824-deepseek-reasoner"><span class="header-section-number">1.7.2</span> ü§ñ DeepSeek <em>(2025-11-06
01:58:24)</em> <em>[deepseek-reasoner]</em></h3>
<p>Vamos criar uma nova vers√£o do script usando Playwright. As
principais mudan√ßas ser√£o: 1. Substituir Selenium por Playwright para
controle do navegador. 2. Aproveitar a API de PDF nativa do Playwright,
que √© mais simples e confi√°vel. 3. Manter a estrutura de diret√≥rios,
logging, processamento em paralelo e l√≥gica de modos (only-new, force,
dry-run).</p>
<p>Vantagens esperadas: - Melhor performance e estabilidade. - C√≥digo
mais limpo e f√°cil de manter.</p>
<p>Vamos ao c√≥digo: Perfeito! Vou criar
<code>comb_pdf_direct6_html_based.py</code> com Playwright. Aqui est√° a
vers√£o otimizada:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># comb_pdf_direct6_html_based.py</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright, <span class="pp">TimeoutError</span> <span class="im">as</span> PlaywrightTimeoutError</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor, as_completed</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PDFGeneratorHTML:</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, force_overwrite<span class="op">=</span><span class="va">False</span>, max_workers<span class="op">=</span><span class="dv">3</span>, headless<span class="op">=</span><span class="va">True</span>, timeout<span class="op">=</span><span class="dv">60</span>):</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.force_overwrite <span class="op">=</span> force_overwrite</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_workers <span class="op">=</span> max_workers</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.headless <span class="op">=</span> headless</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.timeout <span class="op">=</span> timeout</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.setup_logging()</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pastas de entrada e sa√≠da</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.html_dir <span class="op">=</span> Path(<span class="st">&quot;combined_html&quot;</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pdf_dir <span class="op">=</span> Path(<span class="st">&quot;combined_pdfs&quot;</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> setup_logging(<span class="va">self</span>):</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Configura logging detalhado&quot;&quot;&quot;</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        logging.basicConfig(</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>            level<span class="op">=</span>logging.INFO,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>            <span class="bu">format</span><span class="op">=</span><span class="st">&#39;</span><span class="sc">%(asctime)s</span><span class="st"> - </span><span class="sc">%(levelname)s</span><span class="st"> - </span><span class="sc">%(message)s</span><span class="st">&#39;</span>,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>            handlers<span class="op">=</span>[</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>                logging.StreamHandler(),</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>                logging.FileHandler(<span class="st">&#39;pdf_conversion_html_playwright.log&#39;</span>, encoding<span class="op">=</span><span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger <span class="op">=</span> logging.getLogger(<span class="va">__name__</span>)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> check_playwright(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Verifica se Playwright est√° dispon√≠vel&quot;&quot;&quot;</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>                browser <span class="op">=</span> p.chromium.launch(headless<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>                browser.close()</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="st">&quot;‚úÖ Playwright verificado&quot;</span>)</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f&quot;‚ùå Playwright n√£o dispon√≠vel: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="st">&quot;üí° Execute: playwright install chromium&quot;</span>)</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> ensure_directories(<span class="va">self</span>):</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Garante que as pastas existem&quot;&quot;&quot;</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pdf_dir.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.html_dir.exists():</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f&quot;‚ùå Pasta de HTML n√£o encontrada: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>html_dir<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> html_to_pdf(<span class="va">self</span>, html_file: <span class="bu">str</span>, pdf_file: <span class="bu">str</span>, retry_count: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Converte HTML para PDF usando Playwright com retry&quot;&quot;&quot;</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(retry_count):</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.info(<span class="ss">f&quot;üìñ Convertendo: </span><span class="sc">{</span>Path(html_file)<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> ‚Üí </span><span class="sc">{</span>Path(pdf_file)<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss">)&quot;</span>)</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Launch browser with better options for PDF generation</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>                    browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>                        headless<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>                        args<span class="op">=</span>[</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;--disable-renderer-backgrounding&#39;</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>                        ]</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Create context with viewport for consistent rendering</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>                    context <span class="op">=</span> browser.new_context(</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>                        viewport<span class="op">=</span>{<span class="st">&#39;width&#39;</span>: <span class="dv">1920</span>, <span class="st">&#39;height&#39;</span>: <span class="dv">1080</span>},</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>                        ignore_https_errors<span class="op">=</span><span class="va">True</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>                    page <span class="op">=</span> context.new_page()</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Configure timeout</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>                    page.set_default_timeout(<span class="va">self</span>.timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Navigate to local HTML file</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>                    full_path <span class="op">=</span> <span class="ss">f&quot;file:///</span><span class="sc">{</span>Path(html_file)<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>                    page.goto(</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>                        full_path, </span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>                        wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>,</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>                        timeout<span class="op">=</span><span class="va">self</span>.timeout <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Wait for complete load</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>                    page.wait_for_function(</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;document.readyState === &quot;complete&quot;&#39;</span>,</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>                        timeout<span class="op">=</span><span class="va">self</span>.timeout <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Additional wait for dynamic content</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>                    time.sleep(<span class="dv">1</span>)</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Generate PDF with optimized settings</span></span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>                    pdf_params <span class="op">=</span> {</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;path&#39;</span>: pdf_file,</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;format&#39;</span>: <span class="st">&#39;A4&#39;</span>,</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;print_background&#39;</span>: <span class="va">True</span>,</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;margin&#39;</span>: {</span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>,</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, </span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>,</span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span></span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>                        },</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;prefer_css_page_size&#39;</span>: <span class="va">True</span>,</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;display_header_footer&#39;</span>: <span class="va">False</span>,</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;scale&#39;</span>: <span class="fl">1.0</span></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>                    page.pdf(<span class="op">**</span>pdf_params)</span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Close browser</span></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>                    context.close()</span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>                    browser.close()</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.info(<span class="ss">f&quot;‚úÖ PDF gerado: </span><span class="sc">{</span>Path(pdf_file)<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> PlaywrightTimeoutError <span class="im">as</span> e:</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.warning(<span class="ss">f&quot;‚è∞ Timeout na tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.warning(<span class="ss">f&quot;üö´ Erro na tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>                time.sleep(<span class="dv">3</span>)  <span class="co"># Espera entre tentativas</span></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.error(<span class="ss">f&quot;üí• Falha ap√≥s </span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss"> tentativas: </span><span class="sc">{</span>Path(html_file)<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> convert_single_file(<span class="va">self</span>, html_file: <span class="bu">str</span>, mode: <span class="bu">str</span>, dry_run: <span class="bu">bool</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>:</span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Processa um √∫nico arquivo HTML&quot;&quot;&quot;</span></span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>        base_name <span class="op">=</span> Path(html_file).stem</span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>        pdf_file <span class="op">=</span> <span class="va">self</span>.pdf_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>base_name<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verifica se precisa processar</span></span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>        pdf_exists <span class="op">=</span> pdf_file.exists()</span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mode <span class="op">==</span> <span class="st">&#39;only_new&#39;</span> <span class="kw">and</span> pdf_exists:</span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="ss">f&quot;‚è≠Ô∏è PDF j√° existe: </span><span class="sc">{</span>pdf_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (html_file, <span class="va">True</span>, <span class="st">&quot;J√° existe&quot;</span>)</span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> mode <span class="op">==</span> <span class="st">&#39;force&#39;</span> <span class="kw">and</span> pdf_exists:</span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="ss">f&quot;‚ôªÔ∏è Substituindo PDF: </span><span class="sc">{</span>pdf_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dry_run:</span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="ss">f&quot;üß™ [DRY-RUN] Processaria: </span><span class="sc">{</span>Path(html_file)<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> ‚Üí </span><span class="sc">{</span>pdf_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (html_file, <span class="va">True</span>, <span class="st">&quot;Dry-run&quot;</span>)</span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convers√£o real</span></span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a>            success <span class="op">=</span> <span class="va">self</span>.html_to_pdf(<span class="bu">str</span>(html_file), <span class="bu">str</span>(pdf_file))</span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (html_file, success, <span class="st">&quot;Sucesso&quot;</span> <span class="cf">if</span> success <span class="cf">else</span> <span class="st">&quot;Falha na convers√£o PDF&quot;</span>)</span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f&quot;‚ùå Erro processando </span><span class="sc">{</span>Path(html_file)<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (html_file, <span class="va">False</span>, <span class="ss">f&quot;Erro: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate_pdfs(<span class="va">self</span>, mode: <span class="bu">str</span> <span class="op">=</span> <span class="st">&#39;only_new&#39;</span>, dry_run: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Gera PDFs a partir dos arquivos HTML&quot;&quot;&quot;</span></span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.ensure_directories():</span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> <span class="bu">list</span>(<span class="va">self</span>.html_dir.glob(<span class="st">&quot;*.html&quot;</span>))</span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="st">&quot;‚ùå Nenhum arquivo HTML encontrado para convers√£o.&quot;</span>)</span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a>        mode_desc <span class="op">=</span> {</span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;only_new&#39;</span>: <span class="st">&quot;apenas novos (sem PDF)&quot;</span>,</span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;force&#39;</span>: <span class="st">&quot;for√ßar substitui√ß√£o&quot;</span>, </span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;dry_run&#39;</span>: <span class="st">&quot;modo simula√ß√£o&quot;</span></span>
<span id="cb8-180"><a href="#cb8-180" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-181"><a href="#cb8-181" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-182"><a href="#cb8-182" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f&quot;üéØ Encontrados </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos HTML&quot;</span>)</span>
<span id="cb8-183"><a href="#cb8-183" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f&quot;üîß Modo: </span><span class="sc">{</span>mode_desc<span class="sc">.</span>get(mode, mode)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-184"><a href="#cb8-184" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f&quot;üë• Workers: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>max_workers<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-185"><a href="#cb8-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-186"><a href="#cb8-186" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dry_run:</span>
<span id="cb8-187"><a href="#cb8-187" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="st">&quot;üß™ [DRY-RUN] Simulando convers√£o de arquivos:&quot;</span>)</span>
<span id="cb8-188"><a href="#cb8-188" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_file <span class="kw">in</span> html_files:</span>
<span id="cb8-189"><a href="#cb8-189" aria-hidden="true" tabindex="-1"></a>                pdf_file <span class="op">=</span> <span class="va">self</span>.pdf_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>html_file<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb8-190"><a href="#cb8-190" aria-hidden="true" tabindex="-1"></a>                pdf_exists <span class="op">=</span> pdf_file.exists()</span>
<span id="cb8-191"><a href="#cb8-191" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-192"><a href="#cb8-192" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> mode <span class="op">==</span> <span class="st">&#39;only_new&#39;</span> <span class="kw">and</span> pdf_exists:</span>
<span id="cb8-193"><a href="#cb8-193" aria-hidden="true" tabindex="-1"></a>                    status <span class="op">=</span> <span class="st">&quot;‚è≠Ô∏è J√° existe&quot;</span></span>
<span id="cb8-194"><a href="#cb8-194" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> mode <span class="op">==</span> <span class="st">&#39;force&#39;</span> <span class="kw">and</span> pdf_exists:</span>
<span id="cb8-195"><a href="#cb8-195" aria-hidden="true" tabindex="-1"></a>                    status <span class="op">=</span> <span class="st">&quot;‚ôªÔ∏è Substituiria&quot;</span></span>
<span id="cb8-196"><a href="#cb8-196" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb8-197"><a href="#cb8-197" aria-hidden="true" tabindex="-1"></a>                    status <span class="op">=</span> <span class="st">&quot;üÜï Criaria&quot;</span></span>
<span id="cb8-198"><a href="#cb8-198" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb8-199"><a href="#cb8-199" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.info(<span class="ss">f&quot;   </span><span class="sc">{</span>status<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>html_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> ‚Üí </span><span class="sc">{</span>pdf_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-200"><a href="#cb8-200" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb8-201"><a href="#cb8-201" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="ss">f&quot;üß™ [DRY-RUN] Simula√ß√£o conclu√≠da: </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos processados&quot;</span>)</span>
<span id="cb8-202"><a href="#cb8-202" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb8-203"><a href="#cb8-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-204"><a href="#cb8-204" aria-hidden="true" tabindex="-1"></a>        success_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-205"><a href="#cb8-205" aria-hidden="true" tabindex="-1"></a>        failed_files <span class="op">=</span> []</span>
<span id="cb8-206"><a href="#cb8-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-207"><a href="#cb8-207" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Processamento real em paralelo</span></span>
<span id="cb8-208"><a href="#cb8-208" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> ThreadPoolExecutor(max_workers<span class="op">=</span><span class="va">self</span>.max_workers) <span class="im">as</span> executor:</span>
<span id="cb8-209"><a href="#cb8-209" aria-hidden="true" tabindex="-1"></a>            futures <span class="op">=</span> {</span>
<span id="cb8-210"><a href="#cb8-210" aria-hidden="true" tabindex="-1"></a>                executor.submit(</span>
<span id="cb8-211"><a href="#cb8-211" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.convert_single_file, </span>
<span id="cb8-212"><a href="#cb8-212" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">str</span>(html_file), </span>
<span id="cb8-213"><a href="#cb8-213" aria-hidden="true" tabindex="-1"></a>                    mode, </span>
<span id="cb8-214"><a href="#cb8-214" aria-hidden="true" tabindex="-1"></a>                    dry_run</span>
<span id="cb8-215"><a href="#cb8-215" aria-hidden="true" tabindex="-1"></a>                ): html_file <span class="cf">for</span> html_file <span class="kw">in</span> html_files</span>
<span id="cb8-216"><a href="#cb8-216" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb8-217"><a href="#cb8-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-218"><a href="#cb8-218" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> future <span class="kw">in</span> as_completed(futures):</span>
<span id="cb8-219"><a href="#cb8-219" aria-hidden="true" tabindex="-1"></a>                html_file, success, message <span class="op">=</span> future.result()</span>
<span id="cb8-220"><a href="#cb8-220" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> success:</span>
<span id="cb8-221"><a href="#cb8-221" aria-hidden="true" tabindex="-1"></a>                    success_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-222"><a href="#cb8-222" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb8-223"><a href="#cb8-223" aria-hidden="true" tabindex="-1"></a>                    failed_files.append((Path(html_file).name, message))</span>
<span id="cb8-224"><a href="#cb8-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-225"><a href="#cb8-225" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Relat√≥rio final</span></span>
<span id="cb8-226"><a href="#cb8-226" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f&quot;üìä Resumo da convers√£o:&quot;</span>)</span>
<span id="cb8-227"><a href="#cb8-227" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f&quot; ‚úÖ Sucessos: </span><span class="sc">{</span>success_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-228"><a href="#cb8-228" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f&quot; ‚ùå Falhas: </span><span class="sc">{</span><span class="bu">len</span>(failed_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-229"><a href="#cb8-229" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-230"><a href="#cb8-230" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> failed_files:</span>
<span id="cb8-231"><a href="#cb8-231" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="st">&quot;üìã Arquivos com falha:&quot;</span>)</span>
<span id="cb8-232"><a href="#cb8-232" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> failed, reason <span class="kw">in</span> failed_files[:<span class="dv">10</span>]:</span>
<span id="cb8-233"><a href="#cb8-233" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.info(<span class="ss">f&quot; - </span><span class="sc">{</span>failed<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>reason<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-234"><a href="#cb8-234" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(failed_files) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb8-235"><a href="#cb8-235" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.info(<span class="ss">f&quot; ... e mais </span><span class="sc">{</span><span class="bu">len</span>(failed_files) <span class="op">-</span> <span class="dv">10</span><span class="sc">}</span><span class="ss"> arquivos&quot;</span>)</span>
<span id="cb8-236"><a href="#cb8-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-237"><a href="#cb8-237" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> success_count <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb8-238"><a href="#cb8-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-239"><a href="#cb8-239" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate_single_pdf(<span class="va">self</span>, html_filename: <span class="bu">str</span>, mode: <span class="bu">str</span> <span class="op">=</span> <span class="st">&#39;force&#39;</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb8-240"><a href="#cb8-240" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Gera um √∫nico PDF a partir de um arquivo HTML espec√≠fico&quot;&quot;&quot;</span></span>
<span id="cb8-241"><a href="#cb8-241" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.ensure_directories():</span>
<span id="cb8-242"><a href="#cb8-242" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb8-243"><a href="#cb8-243" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-244"><a href="#cb8-244" aria-hidden="true" tabindex="-1"></a>        html_file <span class="op">=</span> <span class="va">self</span>.html_dir <span class="op">/</span> html_filename</span>
<span id="cb8-245"><a href="#cb8-245" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> html_file.exists():</span>
<span id="cb8-246"><a href="#cb8-246" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f&quot;‚ùå Arquivo HTML n√£o encontrado: </span><span class="sc">{</span>html_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-247"><a href="#cb8-247" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb8-248"><a href="#cb8-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-249"><a href="#cb8-249" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="va">self</span>.convert_single_file(<span class="bu">str</span>(html_file), mode, dry_run<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-250"><a href="#cb8-250" aria-hidden="true" tabindex="-1"></a>        success <span class="op">=</span> result[<span class="dv">1</span>]</span>
<span id="cb8-251"><a href="#cb8-251" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-252"><a href="#cb8-252" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> success:</span>
<span id="cb8-253"><a href="#cb8-253" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="ss">f&quot;‚úÖ PDF criado com sucesso: </span><span class="sc">{</span>html_filename<span class="sc">}</span><span class="ss"> ‚Üí </span><span class="sc">{</span>html_file<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span>)</span>
<span id="cb8-254"><a href="#cb8-254" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb8-255"><a href="#cb8-255" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f&quot;‚ùå Falha ao criar PDF: </span><span class="sc">{</span>html_filename<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-256"><a href="#cb8-256" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-257"><a href="#cb8-257" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> success</span>
<span id="cb8-258"><a href="#cb8-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-259"><a href="#cb8-259" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb8-260"><a href="#cb8-260" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(</span>
<span id="cb8-261"><a href="#cb8-261" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">&quot;Gera PDFs a partir de arquivos HTML usando Playwright (vers√£o otimizada)&quot;</span></span>
<span id="cb8-262"><a href="#cb8-262" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-263"><a href="#cb8-263" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-264"><a href="#cb8-264" aria-hidden="true" tabindex="-1"></a>    group <span class="op">=</span> parser.add_mutually_exclusive_group()</span>
<span id="cb8-265"><a href="#cb8-265" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--force&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Sobrescreve PDFs j√° existentes&quot;</span>)</span>
<span id="cb8-266"><a href="#cb8-266" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--only-new&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, default<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Apenas novos arquivos (padr√£o)&quot;</span>)</span>
<span id="cb8-267"><a href="#cb8-267" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-268"><a href="#cb8-268" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--dry-run&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Simula sem criar arquivos&quot;</span>)</span>
<span id="cb8-269"><a href="#cb8-269" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--source&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_html&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta com arquivos .html&quot;</span>)</span>
<span id="cb8-270"><a href="#cb8-270" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--output&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_pdfs&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta de sa√≠da para PDFs&quot;</span>)</span>
<span id="cb8-271"><a href="#cb8-271" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">3</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos paralelos&quot;</span>)</span>
<span id="cb8-272"><a href="#cb8-272" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--no-headless&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra navegador (debug)&quot;</span>)</span>
<span id="cb8-273"><a href="#cb8-273" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--single-file&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Converte apenas um arquivo HTML espec√≠fico&quot;</span>)</span>
<span id="cb8-274"><a href="#cb8-274" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--timeout&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">60</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Timeout para carregamento de p√°ginas&quot;</span>)</span>
<span id="cb8-275"><a href="#cb8-275" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-276"><a href="#cb8-276" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb8-277"><a href="#cb8-277" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-278"><a href="#cb8-278" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determina modo de opera√ß√£o</span></span>
<span id="cb8-279"><a href="#cb8-279" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb8-280"><a href="#cb8-280" aria-hidden="true" tabindex="-1"></a>        mode <span class="op">=</span> <span class="st">&#39;dry_run&#39;</span></span>
<span id="cb8-281"><a href="#cb8-281" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> args.force:</span>
<span id="cb8-282"><a href="#cb8-282" aria-hidden="true" tabindex="-1"></a>        mode <span class="op">=</span> <span class="st">&#39;force&#39;</span></span>
<span id="cb8-283"><a href="#cb8-283" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-284"><a href="#cb8-284" aria-hidden="true" tabindex="-1"></a>        mode <span class="op">=</span> <span class="st">&#39;only_new&#39;</span></span>
<span id="cb8-285"><a href="#cb8-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-286"><a href="#cb8-286" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üöÄ PDF GENERATOR - HTML BASED (PLAYWRIGHT)&quot;</span>)</span>
<span id="cb8-287"><a href="#cb8-287" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;=&quot;</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb8-288"><a href="#cb8-288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-289"><a href="#cb8-289" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb8-290"><a href="#cb8-290" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ MODO DRY-RUN ATIVADO - Nenhum arquivo ser√° criado&quot;</span>)</span>
<span id="cb8-291"><a href="#cb8-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-292"><a href="#cb8-292" aria-hidden="true" tabindex="-1"></a>    generator <span class="op">=</span> PDFGeneratorHTML(</span>
<span id="cb8-293"><a href="#cb8-293" aria-hidden="true" tabindex="-1"></a>        force_overwrite<span class="op">=</span>args.force,</span>
<span id="cb8-294"><a href="#cb8-294" aria-hidden="true" tabindex="-1"></a>        max_workers<span class="op">=</span>args.workers,</span>
<span id="cb8-295"><a href="#cb8-295" aria-hidden="true" tabindex="-1"></a>        headless<span class="op">=</span><span class="kw">not</span> args.no_headless,</span>
<span id="cb8-296"><a href="#cb8-296" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span>args.timeout</span>
<span id="cb8-297"><a href="#cb8-297" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-298"><a href="#cb8-298" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-299"><a href="#cb8-299" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configura pastas personalizadas se fornecidas</span></span>
<span id="cb8-300"><a href="#cb8-300" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.source <span class="op">!=</span> <span class="st">&quot;combined_html&quot;</span>:</span>
<span id="cb8-301"><a href="#cb8-301" aria-hidden="true" tabindex="-1"></a>        generator.html_dir <span class="op">=</span> Path(args.source)</span>
<span id="cb8-302"><a href="#cb8-302" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.output <span class="op">!=</span> <span class="st">&quot;combined_pdfs&quot;</span>:</span>
<span id="cb8-303"><a href="#cb8-303" aria-hidden="true" tabindex="-1"></a>        generator.pdf_dir <span class="op">=</span> Path(args.output)</span>
<span id="cb8-304"><a href="#cb8-304" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-305"><a href="#cb8-305" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verifica depend√™ncias</span></span>
<span id="cb8-306"><a href="#cb8-306" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> generator.check_playwright():</span>
<span id="cb8-307"><a href="#cb8-307" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Playwright n√£o dispon√≠vel. Instale: pip install playwright &amp;&amp; playwright install chromium&quot;</span>)</span>
<span id="cb8-308"><a href="#cb8-308" aria-hidden="true" tabindex="-1"></a>        exit(<span class="dv">1</span>)</span>
<span id="cb8-309"><a href="#cb8-309" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-310"><a href="#cb8-310" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb8-311"><a href="#cb8-311" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-312"><a href="#cb8-312" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.single_file:</span>
<span id="cb8-313"><a href="#cb8-313" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üéØ Convertendo arquivo √∫nico: </span><span class="sc">{</span>args<span class="sc">.</span>single_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-314"><a href="#cb8-314" aria-hidden="true" tabindex="-1"></a>        success <span class="op">=</span> generator.generate_single_pdf(args.single_file, mode)</span>
<span id="cb8-315"><a href="#cb8-315" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-316"><a href="#cb8-316" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üîÑ Convertendo todos os arquivos HTML...&quot;</span>)</span>
<span id="cb8-317"><a href="#cb8-317" aria-hidden="true" tabindex="-1"></a>        success <span class="op">=</span> generator.generate_pdfs(mode<span class="op">=</span>mode, dry_run<span class="op">=</span>args.dry_run)</span>
<span id="cb8-318"><a href="#cb8-318" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-319"><a href="#cb8-319" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb8-320"><a href="#cb8-320" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ MODO DRY-RUN FINALIZADO - Verifique o log acima&quot;</span>)</span>
<span id="cb8-321"><a href="#cb8-321" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-322"><a href="#cb8-322" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> success:</span>
<span id="cb8-323"><a href="#cb8-323" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;üéâ Convers√£o conclu√≠da com sucesso!&quot;</span>)</span>
<span id="cb8-324"><a href="#cb8-324" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üìÅ PDFs salvos em: </span><span class="sc">{</span>generator<span class="sc">.</span>pdf_dir<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb8-325"><a href="#cb8-325" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb8-326"><a href="#cb8-326" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è Convers√£o parcial ou com falhas.&quot;</span>)</span>
<span id="cb8-327"><a href="#cb8-327" aria-hidden="true" tabindex="-1"></a>            exit(<span class="dv">1</span>)</span>
<span id="cb8-328"><a href="#cb8-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-329"><a href="#cb8-329" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb8-330"><a href="#cb8-330" aria-hidden="true" tabindex="-1"></a>    main()</span></code></pre></div>
<h2 data-number="1.8" id="principais-melhorias-com-playwright"><span class="header-section-number">1.8</span> üöÄ <strong>Principais Melhorias
com Playwright:</strong></h2>
<h3 data-number="1.8.1" id="instala√ß√£o-simplificada"><span class="header-section-number">1.8.1</span> <strong>1. Instala√ß√£o
Simplificada</strong></h3>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install playwright</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">playwright</span> install chromium</span></code></pre></div>
<h3 data-number="1.8.2" id="performance-otimizada"><span class="header-section-number">1.8.2</span> <strong>2. Performance
Otimizada</strong></h3>
<ul>
<li>Launch mais r√°pido do browser</li>
<li>Wait conditions mais inteligentes (<code>networkidle</code>)</li>
<li>Gerenciamento autom√°tico de recursos</li>
</ul>
<h3 data-number="1.8.3" id="c√≥digo-mais-limpo"><span class="header-section-number">1.8.3</span> <strong>3. C√≥digo Mais
Limpo</strong></h3>
<ul>
<li>Elimina configura√ß√µes complexas do ChromeDriver</li>
<li>API nativa para PDF</li>
<li>Melhor tratamento de erros</li>
</ul>
<h3 data-number="1.8.4" id="recursos-avan√ßados"><span class="header-section-number">1.8.4</span> <strong>4. Recursos
Avan√ßados</strong></h3>
<ul>
<li>Context isolation para cada convers√£o</li>
<li>Viewport consistente</li>
<li>Timeout handling melhorado</li>
</ul>
<h3 data-number="1.8.5" id="uso"><span class="header-section-number">1.8.5</span> <strong>5. Uso:</strong></h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convers√£o normal</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> comb_pdf_direct6_html_based.py</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># For√ßar regenera√ß√£o</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> comb_pdf_direct6_html_based.py <span class="at">--force</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Apenas um arquivo</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> comb_pdf_direct6_html_based.py <span class="at">--single-file</span> arquivo.html</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Modo debug (ver navegador)</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> comb_pdf_direct6_html_based.py <span class="at">--no-headless</span></span></code></pre></div>
<p>Esta vers√£o deve ser <strong>mais r√°pida, est√°vel e
confi√°vel</strong> que a anterior com Selenium! üéØ</p>
<hr />
<h3 data-number="1.8.6" id="utilizador-2025-11-06-051416-deepseek-reasoner"><span class="header-section-number">1.8.6</span> üë§ Utilizador <em>(2025-11-06
05:14:16)</em> <em>[deepseek-reasoner]</em></h3>
<p>Optimizar comb_pdf_direct6_html_based.py acrescentar
multiprocessing.freeze_support() try: import multiprocessing main()
except KeyboardInterrupt: print(‚Äúüõë Interrup√ß√£o pelo utilizador.‚Äù) e por
defeito max_workers=1</p>
<hr />
<h3 data-number="1.8.7" id="deepseek-2025-11-06-051416-deepseek-reasoner"><span class="header-section-number">1.8.7</span> ü§ñ DeepSeek <em>(2025-11-06
05:14:16)</em> <em>[deepseek-reasoner]</em></h3>
<p>Vamos otimizar o script para usar multiprocessing.freeze_support()
para compatibilidade com congelamento (ex: pyinstaller) e alterar o
padr√£o de max_workers para 1. No entanto, note que o script j√° usa
ThreadPoolExecutor, que √© para threads, n√£o para processos. O
freeze_support √© necess√°rio apenas para multiprocessing (cria√ß√£o de
processos). Como estamos usando threads, o freeze_support n√£o √©
estritamente necess√°rio, mas como o script pode ser congelado, e pode
haver a inten√ß√£o de usar multiprocessing no futuro, vamos adicionar.</p>
<p>Al√©m disso, o usu√°rio pediu para mudar o max_workers padr√£o para
1.</p>
<p>Vamos fazer as seguintes altera√ß√µes: 1. Adicionar
multiprocessing.freeze_support() no bloco if <strong>name</strong> ==
‚Äò<strong>main</strong>‚Äô. 2. Alterar o valor padr√£o do argumento ‚Äìworkers
para 1.</p>
<p>No entanto, note que o ThreadPoolExecutor usa threads, n√£o processos.
Se quisermos usar multiprocessing (melhor para CPU-bound) ter√≠amos que
mudar para ProcessPoolExecutor. Mas a gera√ß√£o de PDFs com Playwright √©
I/O-bound? Na verdade, o Playwright √© mais I/O-bound (espera por rede,
espera por eventos) e tamb√©m usa processos do navegador. Usar threads √©
aceit√°vel, mas se encontrarmos problemas de estabilidade, talvez seja
melhor usar processos. Por enquanto, vamos manter threads.</p>
<p>Mas note: o Playwright n√£o √© thread-safe por padr√£o. A documenta√ß√£o
recomenda criar uma inst√¢ncia por thread. No nosso c√≥digo, cada thread
cria sua pr√≥pria inst√¢ncia do browser (via sync_playwright) ent√£o est√°
seguro.</p>
<p>Vamos ent√£o: - Alterar o padr√£o de workers para 1 (j√° que o usu√°rio
pediu) - Adicionar o freeze_support (que √© in√≥cuo se n√£o estivermos
usando multiprocessing, mas n√£o faz mal)</p>
<p>No entanto, se usarmos ProcessPoolExecutor, o freeze_support seria
necess√°rio. Mas n√£o √© o caso.</p>
<p>Vamos manter o ThreadPoolExecutor e apenas adicionar o freeze_support
por precau√ß√£o.</p>
<p>Mas note: o usu√°rio pode querer usar multiprocessing no futuro, ent√£o
vamos adicionar.</p>
<p>Al√©m disso, vamos capturar KeyboardInterrupt no main para uma sa√≠da
mais limpa.</p>
<p>Estrutura do main alterada:</p>
<p>if <strong>name</strong> == ‚Äú<strong>main</strong>‚Äù:
multiprocessing.freeze_support() try: main() except KeyboardInterrupt:
print(‚Äúüõë Interrup√ß√£o pelo utilizador.‚Äù)</p>
<p>E mudar o padr√£o de workers para 1.</p>
<p>Vamos alterar o argumento ‚Äìworkers para default=1.</p>
<p>Vamos tamb√©m adicionar uma mensagem de interrup√ß√£o no log.</p>
<p>Vamos ao c√≥digo: Aqui est√° o
<code>comb_pdf_direct6_html_based.py</code> otimizado com
<code>multiprocessing.freeze_support()</code> e
<code>max_workers=1</code> por padr√£o:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># comb_pdf_direct6_html_based.py</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright, <span class="pp">TimeoutError</span> <span class="im">as</span> PlaywrightTimeoutError</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> concurrent.futures <span class="im">import</span> ThreadPoolExecutor, as_completed</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tempfile</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PDFGeneratorHTML:</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, force_overwrite<span class="op">=</span><span class="va">False</span>, max_workers<span class="op">=</span><span class="dv">1</span>, headless<span class="op">=</span><span class="va">True</span>, timeout<span class="op">=</span><span class="dv">60</span>):</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.force_overwrite <span class="op">=</span> force_overwrite</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.max_workers <span class="op">=</span> max_workers</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.headless <span class="op">=</span> headless</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.timeout <span class="op">=</span> timeout</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.setup_logging()</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pastas de entrada e sa√≠da</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.html_dir <span class="op">=</span> Path(<span class="st">&quot;combined_html&quot;</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pdf_dir <span class="op">=</span> Path(<span class="st">&quot;combined_pdfs&quot;</span>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> setup_logging(<span class="va">self</span>):</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Configura logging detalhado&quot;&quot;&quot;</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        logging.basicConfig(</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>            level<span class="op">=</span>logging.INFO,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>            <span class="bu">format</span><span class="op">=</span><span class="st">&#39;</span><span class="sc">%(asctime)s</span><span class="st"> - </span><span class="sc">%(levelname)s</span><span class="st"> - </span><span class="sc">%(message)s</span><span class="st">&#39;</span>,</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>            handlers<span class="op">=</span>[</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>                logging.StreamHandler(),</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>                logging.FileHandler(<span class="st">&#39;pdf_conversion_html_playwright.log&#39;</span>, encoding<span class="op">=</span><span class="st">&#39;utf-8&#39;</span>)</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger <span class="op">=</span> logging.getLogger(<span class="va">__name__</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> check_playwright(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Verifica se Playwright est√° dispon√≠vel&quot;&quot;&quot;</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>                browser <span class="op">=</span> p.chromium.launch(headless<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>                browser.close()</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="st">&quot;‚úÖ Playwright verificado&quot;</span>)</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f&quot;‚ùå Playwright n√£o dispon√≠vel: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="st">&quot;üí° Execute: playwright install chromium&quot;</span>)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> ensure_directories(<span class="va">self</span>):</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Garante que as pastas existem&quot;&quot;&quot;</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pdf_dir.mkdir(exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.html_dir.exists():</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f&quot;‚ùå Pasta de HTML n√£o encontrada: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>html_dir<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> html_to_pdf(<span class="va">self</span>, html_file: <span class="bu">str</span>, pdf_file: <span class="bu">str</span>, retry_count: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Converte HTML para PDF usando Playwright com retry&quot;&quot;&quot;</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(retry_count):</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.info(<span class="ss">f&quot;üìñ Convertendo: </span><span class="sc">{</span>Path(html_file)<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> ‚Üí </span><span class="sc">{</span>Path(pdf_file)<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss">)&quot;</span>)</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>                <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Launch browser with better options for PDF generation</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>                    browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>                        headless<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>                        args<span class="op">=</span>[</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;--disable-renderer-backgrounding&#39;</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>                        ]</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Create context with viewport for consistent rendering</span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>                    context <span class="op">=</span> browser.new_context(</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>                        viewport<span class="op">=</span>{<span class="st">&#39;width&#39;</span>: <span class="dv">1920</span>, <span class="st">&#39;height&#39;</span>: <span class="dv">1080</span>},</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>                        ignore_https_errors<span class="op">=</span><span class="va">True</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>                    page <span class="op">=</span> context.new_page()</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Configure timeout</span></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>                    page.set_default_timeout(<span class="va">self</span>.timeout <span class="op">*</span> <span class="dv">1000</span>)</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Navigate to local HTML file</span></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>                    full_path <span class="op">=</span> <span class="ss">f&quot;file:///</span><span class="sc">{</span>Path(html_file)<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>                    page.goto(</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>                        full_path, </span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>                        wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>,</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>                        timeout<span class="op">=</span><span class="va">self</span>.timeout <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Wait for complete load</span></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>                    page.wait_for_function(</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;document.readyState === &quot;complete&quot;&#39;</span>,</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>                        timeout<span class="op">=</span><span class="va">self</span>.timeout <span class="op">*</span> <span class="dv">1000</span></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Additional wait for dynamic content</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>                    time.sleep(<span class="dv">1</span>)</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Generate PDF with optimized settings</span></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>                    pdf_params <span class="op">=</span> {</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;path&#39;</span>: pdf_file,</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;format&#39;</span>: <span class="st">&#39;A4&#39;</span>,</span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;print_background&#39;</span>: <span class="va">True</span>,</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;margin&#39;</span>: {</span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>,</span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, </span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>,</span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>                            <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>                        },</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;prefer_css_page_size&#39;</span>: <span class="va">True</span>,</span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;display_header_footer&#39;</span>: <span class="va">False</span>,</span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&#39;scale&#39;</span>: <span class="fl">1.0</span></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>                    page.pdf(<span class="op">**</span>pdf_params)</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Close browser</span></span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>                    context.close()</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>                    browser.close()</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.info(<span class="ss">f&quot;‚úÖ PDF gerado: </span><span class="sc">{</span>Path(pdf_file)<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> PlaywrightTimeoutError <span class="im">as</span> e:</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.warning(<span class="ss">f&quot;‚è∞ Timeout na tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.warning(<span class="ss">f&quot;üö´ Erro na tentativa </span><span class="sc">{</span>attempt <span class="op">+</span> <span class="dv">1</span><span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>                time.sleep(<span class="dv">3</span>)  <span class="co"># Espera entre tentativas</span></span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.error(<span class="ss">f&quot;üí• Falha ap√≥s </span><span class="sc">{</span>retry_count<span class="sc">}</span><span class="ss"> tentativas: </span><span class="sc">{</span>Path(html_file)<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> convert_single_file(<span class="va">self</span>, html_file: <span class="bu">str</span>, mode: <span class="bu">str</span>, dry_run: <span class="bu">bool</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>:</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Processa um √∫nico arquivo HTML&quot;&quot;&quot;</span></span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>        base_name <span class="op">=</span> Path(html_file).stem</span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>        pdf_file <span class="op">=</span> <span class="va">self</span>.pdf_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>base_name<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verifica se precisa processar</span></span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>        pdf_exists <span class="op">=</span> pdf_file.exists()</span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mode <span class="op">==</span> <span class="st">&#39;only_new&#39;</span> <span class="kw">and</span> pdf_exists:</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="ss">f&quot;‚è≠Ô∏è PDF j√° existe: </span><span class="sc">{</span>pdf_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (html_file, <span class="va">True</span>, <span class="st">&quot;J√° existe&quot;</span>)</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> mode <span class="op">==</span> <span class="st">&#39;force&#39;</span> <span class="kw">and</span> pdf_exists:</span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="ss">f&quot;‚ôªÔ∏è Substituindo PDF: </span><span class="sc">{</span>pdf_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dry_run:</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="ss">f&quot;üß™ [DRY-RUN] Processaria: </span><span class="sc">{</span>Path(html_file)<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> ‚Üí </span><span class="sc">{</span>pdf_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (html_file, <span class="va">True</span>, <span class="st">&quot;Dry-run&quot;</span>)</span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convers√£o real</span></span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>            success <span class="op">=</span> <span class="va">self</span>.html_to_pdf(<span class="bu">str</span>(html_file), <span class="bu">str</span>(pdf_file))</span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (html_file, success, <span class="st">&quot;Sucesso&quot;</span> <span class="cf">if</span> success <span class="cf">else</span> <span class="st">&quot;Falha na convers√£o PDF&quot;</span>)</span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f&quot;‚ùå Erro processando </span><span class="sc">{</span>Path(html_file)<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> (html_file, <span class="va">False</span>, <span class="ss">f&quot;Erro: </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate_pdfs(<span class="va">self</span>, mode: <span class="bu">str</span> <span class="op">=</span> <span class="st">&#39;only_new&#39;</span>, dry_run: <span class="bu">bool</span> <span class="op">=</span> <span class="va">False</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Gera PDFs a partir dos arquivos HTML&quot;&quot;&quot;</span></span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.ensure_directories():</span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> <span class="bu">list</span>(<span class="va">self</span>.html_dir.glob(<span class="st">&quot;*.html&quot;</span>))</span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="st">&quot;‚ùå Nenhum arquivo HTML encontrado para convers√£o.&quot;</span>)</span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a>        mode_desc <span class="op">=</span> {</span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;only_new&#39;</span>: <span class="st">&quot;apenas novos (sem PDF)&quot;</span>,</span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;force&#39;</span>: <span class="st">&quot;for√ßar substitui√ß√£o&quot;</span>, </span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a>            <span class="st">&#39;dry_run&#39;</span>: <span class="st">&quot;modo simula√ß√£o&quot;</span></span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f&quot;üéØ Encontrados </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos HTML&quot;</span>)</span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f&quot;üîß Modo: </span><span class="sc">{</span>mode_desc<span class="sc">.</span>get(mode, mode)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f&quot;üë• Workers: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>max_workers<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> dry_run:</span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="st">&quot;üß™ [DRY-RUN] Simulando convers√£o de arquivos:&quot;</span>)</span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_file <span class="kw">in</span> html_files:</span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>                pdf_file <span class="op">=</span> <span class="va">self</span>.pdf_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>html_file<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a>                pdf_exists <span class="op">=</span> pdf_file.exists()</span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> mode <span class="op">==</span> <span class="st">&#39;only_new&#39;</span> <span class="kw">and</span> pdf_exists:</span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>                    status <span class="op">=</span> <span class="st">&quot;‚è≠Ô∏è J√° existe&quot;</span></span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> mode <span class="op">==</span> <span class="st">&#39;force&#39;</span> <span class="kw">and</span> pdf_exists:</span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a>                    status <span class="op">=</span> <span class="st">&quot;‚ôªÔ∏è Substituiria&quot;</span></span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a>                    status <span class="op">=</span> <span class="st">&quot;üÜï Criaria&quot;</span></span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.info(<span class="ss">f&quot;   </span><span class="sc">{</span>status<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>html_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> ‚Üí </span><span class="sc">{</span>pdf_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="ss">f&quot;üß™ [DRY-RUN] Simula√ß√£o conclu√≠da: </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos processados&quot;</span>)</span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a>        success_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a>        failed_files <span class="op">=</span> []</span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Processamento real em paralelo</span></span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> ThreadPoolExecutor(max_workers<span class="op">=</span><span class="va">self</span>.max_workers) <span class="im">as</span> executor:</span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a>            futures <span class="op">=</span> {</span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a>                executor.submit(</span>
<span id="cb11-213"><a href="#cb11-213" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.convert_single_file, </span>
<span id="cb11-214"><a href="#cb11-214" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">str</span>(html_file), </span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a>                    mode, </span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a>                    dry_run</span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a>                ): html_file <span class="cf">for</span> html_file <span class="kw">in</span> html_files</span>
<span id="cb11-218"><a href="#cb11-218" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb11-219"><a href="#cb11-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> future <span class="kw">in</span> as_completed(futures):</span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a>                html_file, success, message <span class="op">=</span> future.result()</span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> success:</span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a>                    success_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a>                    failed_files.append((Path(html_file).name, message))</span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Relat√≥rio final</span></span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f&quot;üìä Resumo da convers√£o:&quot;</span>)</span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f&quot; ‚úÖ Sucessos: </span><span class="sc">{</span>success_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.logger.info(<span class="ss">f&quot; ‚ùå Falhas: </span><span class="sc">{</span><span class="bu">len</span>(failed_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> failed_files:</span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="st">&quot;üìã Arquivos com falha:&quot;</span>)</span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> failed, reason <span class="kw">in</span> failed_files[:<span class="dv">10</span>]:</span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.info(<span class="ss">f&quot; - </span><span class="sc">{</span>failed<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>reason<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(failed_files) <span class="op">&gt;</span> <span class="dv">10</span>:</span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.logger.info(<span class="ss">f&quot; ... e mais </span><span class="sc">{</span><span class="bu">len</span>(failed_files) <span class="op">-</span> <span class="dv">10</span><span class="sc">}</span><span class="ss"> arquivos&quot;</span>)</span>
<span id="cb11-238"><a href="#cb11-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-239"><a href="#cb11-239" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> success_count <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb11-240"><a href="#cb11-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-241"><a href="#cb11-241" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate_single_pdf(<span class="va">self</span>, html_filename: <span class="bu">str</span>, mode: <span class="bu">str</span> <span class="op">=</span> <span class="st">&#39;force&#39;</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb11-242"><a href="#cb11-242" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Gera um √∫nico PDF a partir de um arquivo HTML espec√≠fico&quot;&quot;&quot;</span></span>
<span id="cb11-243"><a href="#cb11-243" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.ensure_directories():</span>
<span id="cb11-244"><a href="#cb11-244" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb11-245"><a href="#cb11-245" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-246"><a href="#cb11-246" aria-hidden="true" tabindex="-1"></a>        html_file <span class="op">=</span> <span class="va">self</span>.html_dir <span class="op">/</span> html_filename</span>
<span id="cb11-247"><a href="#cb11-247" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> html_file.exists():</span>
<span id="cb11-248"><a href="#cb11-248" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f&quot;‚ùå Arquivo HTML n√£o encontrado: </span><span class="sc">{</span>html_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-249"><a href="#cb11-249" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb11-250"><a href="#cb11-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-251"><a href="#cb11-251" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="va">self</span>.convert_single_file(<span class="bu">str</span>(html_file), mode, dry_run<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-252"><a href="#cb11-252" aria-hidden="true" tabindex="-1"></a>        success <span class="op">=</span> result[<span class="dv">1</span>]</span>
<span id="cb11-253"><a href="#cb11-253" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-254"><a href="#cb11-254" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> success:</span>
<span id="cb11-255"><a href="#cb11-255" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.info(<span class="ss">f&quot;‚úÖ PDF criado com sucesso: </span><span class="sc">{</span>html_filename<span class="sc">}</span><span class="ss"> ‚Üí </span><span class="sc">{</span>html_file<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span>)</span>
<span id="cb11-256"><a href="#cb11-256" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-257"><a href="#cb11-257" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.logger.error(<span class="ss">f&quot;‚ùå Falha ao criar PDF: </span><span class="sc">{</span>html_filename<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-258"><a href="#cb11-258" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-259"><a href="#cb11-259" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> success</span>
<span id="cb11-260"><a href="#cb11-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-261"><a href="#cb11-261" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb11-262"><a href="#cb11-262" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(</span>
<span id="cb11-263"><a href="#cb11-263" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">&quot;Gera PDFs a partir de arquivos HTML usando Playwright (vers√£o otimizada)&quot;</span></span>
<span id="cb11-264"><a href="#cb11-264" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-265"><a href="#cb11-265" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-266"><a href="#cb11-266" aria-hidden="true" tabindex="-1"></a>    group <span class="op">=</span> parser.add_mutually_exclusive_group()</span>
<span id="cb11-267"><a href="#cb11-267" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--force&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Sobrescreve PDFs j√° existentes&quot;</span>)</span>
<span id="cb11-268"><a href="#cb11-268" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--only-new&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, default<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Apenas novos arquivos (padr√£o)&quot;</span>)</span>
<span id="cb11-269"><a href="#cb11-269" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-270"><a href="#cb11-270" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--dry-run&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Simula sem criar arquivos&quot;</span>)</span>
<span id="cb11-271"><a href="#cb11-271" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--source&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_html&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta com arquivos .html&quot;</span>)</span>
<span id="cb11-272"><a href="#cb11-272" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--output&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_pdfs&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta de sa√≠da para PDFs&quot;</span>)</span>
<span id="cb11-273"><a href="#cb11-273" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">1</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos paralelos (padr√£o: 1)&quot;</span>)</span>
<span id="cb11-274"><a href="#cb11-274" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--no-headless&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra navegador (debug)&quot;</span>)</span>
<span id="cb11-275"><a href="#cb11-275" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--single-file&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Converte apenas um arquivo HTML espec√≠fico&quot;</span>)</span>
<span id="cb11-276"><a href="#cb11-276" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--timeout&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">60</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Timeout para carregamento de p√°ginas&quot;</span>)</span>
<span id="cb11-277"><a href="#cb11-277" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-278"><a href="#cb11-278" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parser.parse_args()</span>
<span id="cb11-279"><a href="#cb11-279" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-280"><a href="#cb11-280" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determina modo de opera√ß√£o</span></span>
<span id="cb11-281"><a href="#cb11-281" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb11-282"><a href="#cb11-282" aria-hidden="true" tabindex="-1"></a>        mode <span class="op">=</span> <span class="st">&#39;dry_run&#39;</span></span>
<span id="cb11-283"><a href="#cb11-283" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> args.force:</span>
<span id="cb11-284"><a href="#cb11-284" aria-hidden="true" tabindex="-1"></a>        mode <span class="op">=</span> <span class="st">&#39;force&#39;</span></span>
<span id="cb11-285"><a href="#cb11-285" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb11-286"><a href="#cb11-286" aria-hidden="true" tabindex="-1"></a>        mode <span class="op">=</span> <span class="st">&#39;only_new&#39;</span></span>
<span id="cb11-287"><a href="#cb11-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-288"><a href="#cb11-288" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üöÄ PDF GENERATOR - HTML BASED (PLAYWRIGHT)&quot;</span>)</span>
<span id="cb11-289"><a href="#cb11-289" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;=&quot;</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb11-290"><a href="#cb11-290" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>args<span class="sc">.</span>workers<span class="sc">}</span><span class="ss"> (padr√£o: 1 para maior estabilidade)&quot;</span>)</span>
<span id="cb11-291"><a href="#cb11-291" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-292"><a href="#cb11-292" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb11-293"><a href="#cb11-293" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ MODO DRY-RUN ATIVADO - Nenhum arquivo ser√° criado&quot;</span>)</span>
<span id="cb11-294"><a href="#cb11-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-295"><a href="#cb11-295" aria-hidden="true" tabindex="-1"></a>    generator <span class="op">=</span> PDFGeneratorHTML(</span>
<span id="cb11-296"><a href="#cb11-296" aria-hidden="true" tabindex="-1"></a>        force_overwrite<span class="op">=</span>args.force,</span>
<span id="cb11-297"><a href="#cb11-297" aria-hidden="true" tabindex="-1"></a>        max_workers<span class="op">=</span>args.workers,</span>
<span id="cb11-298"><a href="#cb11-298" aria-hidden="true" tabindex="-1"></a>        headless<span class="op">=</span><span class="kw">not</span> args.no_headless,</span>
<span id="cb11-299"><a href="#cb11-299" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span>args.timeout</span>
<span id="cb11-300"><a href="#cb11-300" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-301"><a href="#cb11-301" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-302"><a href="#cb11-302" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configura pastas personalizadas se fornecidas</span></span>
<span id="cb11-303"><a href="#cb11-303" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.source <span class="op">!=</span> <span class="st">&quot;combined_html&quot;</span>:</span>
<span id="cb11-304"><a href="#cb11-304" aria-hidden="true" tabindex="-1"></a>        generator.html_dir <span class="op">=</span> Path(args.source)</span>
<span id="cb11-305"><a href="#cb11-305" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.output <span class="op">!=</span> <span class="st">&quot;combined_pdfs&quot;</span>:</span>
<span id="cb11-306"><a href="#cb11-306" aria-hidden="true" tabindex="-1"></a>        generator.pdf_dir <span class="op">=</span> Path(args.output)</span>
<span id="cb11-307"><a href="#cb11-307" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-308"><a href="#cb11-308" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verifica depend√™ncias</span></span>
<span id="cb11-309"><a href="#cb11-309" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> generator.check_playwright():</span>
<span id="cb11-310"><a href="#cb11-310" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Playwright n√£o dispon√≠vel. Instale: pip install playwright &amp;&amp; playwright install chromium&quot;</span>)</span>
<span id="cb11-311"><a href="#cb11-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb11-312"><a href="#cb11-312" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-313"><a href="#cb11-313" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb11-314"><a href="#cb11-314" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-315"><a href="#cb11-315" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb11-316"><a href="#cb11-316" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> args.single_file:</span>
<span id="cb11-317"><a href="#cb11-317" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üéØ Convertendo arquivo √∫nico: </span><span class="sc">{</span>args<span class="sc">.</span>single_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-318"><a href="#cb11-318" aria-hidden="true" tabindex="-1"></a>            success <span class="op">=</span> generator.generate_single_pdf(args.single_file, mode)</span>
<span id="cb11-319"><a href="#cb11-319" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-320"><a href="#cb11-320" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;üîÑ Convertendo todos os arquivos HTML...&quot;</span>)</span>
<span id="cb11-321"><a href="#cb11-321" aria-hidden="true" tabindex="-1"></a>            success <span class="op">=</span> generator.generate_pdfs(mode<span class="op">=</span>mode, dry_run<span class="op">=</span>args.dry_run)</span>
<span id="cb11-322"><a href="#cb11-322" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-323"><a href="#cb11-323" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> args.dry_run:</span>
<span id="cb11-324"><a href="#cb11-324" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;üß™ MODO DRY-RUN FINALIZADO - Verifique o log acima&quot;</span>)</span>
<span id="cb11-325"><a href="#cb11-325" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-326"><a href="#cb11-326" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> success:</span>
<span id="cb11-327"><a href="#cb11-327" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üéâ Convers√£o conclu√≠da com sucesso!&quot;</span>)</span>
<span id="cb11-328"><a href="#cb11-328" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üìÅ PDFs salvos em: </span><span class="sc">{</span>generator<span class="sc">.</span>pdf_dir<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-329"><a href="#cb11-329" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb11-330"><a href="#cb11-330" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è Convers√£o parcial ou com falhas.&quot;</span>)</span>
<span id="cb11-331"><a href="#cb11-331" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb11-332"><a href="#cb11-332" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb11-333"><a href="#cb11-333" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb11-334"><a href="#cb11-334" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o pelo utilizador.&quot;</span>)</span>
<span id="cb11-335"><a href="#cb11-335" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb11-336"><a href="#cb11-336" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb11-337"><a href="#cb11-337" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üí• Erro inesperado: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-338"><a href="#cb11-338" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb11-339"><a href="#cb11-339" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-340"><a href="#cb11-340" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb11-341"><a href="#cb11-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-342"><a href="#cb11-342" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb11-343"><a href="#cb11-343" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Suporte para multiprocessing (√∫til quando congelado com pyinstaller, etc.)</span></span>
<span id="cb11-344"><a href="#cb11-344" aria-hidden="true" tabindex="-1"></a>    multiprocessing.freeze_support()</span>
<span id="cb11-345"><a href="#cb11-345" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-346"><a href="#cb11-346" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Executa o programa principal com tratamento de interrup√ß√£o</span></span>
<span id="cb11-347"><a href="#cb11-347" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb11-348"><a href="#cb11-348" aria-hidden="true" tabindex="-1"></a>        sys.exit(main())</span>
<span id="cb11-349"><a href="#cb11-349" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb11-350"><a href="#cb11-350" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o pelo utilizador.&quot;</span>)</span>
<span id="cb11-351"><a href="#cb11-351" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span></code></pre></div>
<h2 data-number="1.9" id="principais-otimiza√ß√µes-adicionadas"><span class="header-section-number">1.9</span> üîß <strong>Principais
Otimiza√ß√µes Adicionadas:</strong></h2>
<h3 data-number="1.9.1" id="multiprocessing-freeze-support"><span class="header-section-number">1.9.1</span> <strong>1. Multiprocessing
Freeze Support</strong></h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    multiprocessing.freeze_support()</span></code></pre></div>
<ul>
<li>‚úÖ Essencial para aplica√ß√µes congeladas (PyInstaller,
cx_Freeze)</li>
<li>‚úÖ Previne problemas em sistemas Windows</li>
<li>‚úÖ Melhor compatibilidade cross-platform</li>
</ul>
<h3 data-number="1.9.2" id="max-workers-1-por-padr√£o"><span class="header-section-number">1.9.2</span> <strong>2. Max Workers = 1
por Padr√£o</strong></h3>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, force_overwrite<span class="op">=</span><span class="va">False</span>, max_workers<span class="op">=</span><span class="dv">1</span>, headless<span class="op">=</span><span class="va">True</span>, timeout<span class="op">=</span><span class="dv">60</span>):</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">1</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos paralelos (padr√£o: 1)&quot;</span>)</span></code></pre></div>
<ul>
<li>‚úÖ <strong>Maior estabilidade</strong> - menos conflitos de
recursos</li>
<li>‚úÖ <strong>Menor uso de mem√≥ria</strong> - ideal para m√°quinas com
recursos limitados</li>
<li>‚úÖ <strong>Processamento sequencial</strong> - mais previs√≠vel e
debug√°vel</li>
</ul>
<h3 data-number="1.9.3" id="tratamento-robustecido-de-interrup√ß√µes"><span class="header-section-number">1.9.3</span> <strong>3. Tratamento
Robustecido de Interrup√ß√µes</strong></h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    sys.exit(main())</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o pelo utilizador.&quot;</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    sys.exit(<span class="dv">1</span>)</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># c√≥digo de convers√£o</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o pelo utilizador.&quot;</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span></span></code></pre></div>
<ul>
<li>‚úÖ Captura Ctrl+C de forma limpa</li>
<li>‚úÖ Mensagem clara para o utilizador</li>
<li>‚úÖ Encerramento gracioso</li>
</ul>
<h3 data-number="1.9.4" id="mensagens-explicativas-melhoradas"><span class="header-section-number">1.9.4</span> <strong>4. Mensagens
Explicativas Melhoradas</strong></h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>args<span class="sc">.</span>workers<span class="sc">}</span><span class="ss"> (padr√£o: 1 para maior estabilidade)&quot;</span>)</span></code></pre></div>
<h2 data-number="1.10" id="vantagens-das-altera√ß√µes"><span class="header-section-number">1.10</span> üéØ <strong>Vantagens das
Altera√ß√µes:</strong></h2>
<ol type="1">
<li><strong>üéØ Estabilidade M√°xima</strong> - Processamento sequencial
evita race conditions</li>
<li><strong>üîß Debug Simplificado</strong> - Problemas s√£o mais f√°ceis
de identificar</li>
<li><strong>üíæ Consumo Otimizado</strong> - Menor uso de RAM e CPU</li>
<li><strong>üöÄ Compatibilidade</strong> - Funciona melhor em sistemas
com recursos limitados</li>
<li><strong>‚èπÔ∏è Controle Melhor</strong> - Interrup√ß√µes s√£o tratadas de
forma limpa</li>
</ol>
<h2 data-number="1.11" id="uso-recomendado"><span class="header-section-number">1.11</span> üìä <strong>Uso
Recomendado:</strong></h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Padr√£o (1 worker - mais est√°vel)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> comb_pdf_direct6_html_based.py</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Para maior velocidade (se o sistema suportar)</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> comb_pdf_direct6_html_based.py <span class="at">--workers</span> 3</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Debug visual</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> comb_pdf_direct6_html_based.py <span class="at">--no-headless</span> <span class="at">--workers</span> 1</span></code></pre></div>
<p>Esta vers√£o oferece o <strong>melhor equil√≠brio entre performance e
estabilidade</strong>! üöÄ</p>
<hr />
<h3 data-number="1.11.1" id="utilizador-2025-11-06-062713-deepseek-reasoner"><span class="header-section-number">1.11.1</span> üë§ Utilizador
<em>(2025-11-06 06:27:13)</em> <em>[deepseek-reasoner]</em></h3>
<p>Pretendia optimizar
comb_pdf_direct6_html_based_optimized_live_benchmark.py considerando
‚Äìworkers 1 por defeito. E melhoramento do Ctrl+C de forma a parar os
processos relacionados</p>
<hr />
<h3 data-number="1.11.2" id="deepseek-2025-11-06-062713-deepseek-reasoner"><span class="header-section-number">1.11.2</span> ü§ñ DeepSeek <em>(2025-11-06
06:27:13)</em> <em>[deepseek-reasoner]</em></h3>
<p>Vamos modificar o script para definir <code>--workers 1</code> como
padr√£o e melhorar o tratamento do Ctrl+C para parar os processos de
forma mais eficaz.</p>
<p>Altera√ß√µes principais: 1. Mudar o padr√£o de <code>workers</code> para
1. 2. Melhorar o tratamento de Ctrl+C para garantir que todos os
processos sejam terminados e que os recursos sejam libertados.</p>
<p>No script atual, j√° existe um tratamento de Ctrl+C, mas vamos
verificar se podemos torn√°-lo mais robusto.</p>
<p>Vamos fazer as seguintes altera√ß√µes:</p>
<ul>
<li>No parser de argumentos, alterar o default de <code>--workers</code>
para 1.</li>
<li>No c√≥digo de tratamento de exce√ß√£o KeyboardInterrupt, garantir que o
pool √© terminado e que os processos s√£o encerrados.</li>
</ul>
<p>O script j√° usa <code>pool.terminate()</code> e
<code>pool.join()</code> no bloco <code>finally</code>, mas no caso de
KeyboardInterrupt, estamos a chamar <code>pool.terminate()</code> e
depois no <code>finally</code> novamente, o que pode ser redundante, mas
√© seguro.</p>
<p>Vamos tamb√©m adicionar uma mensagem mais clara quando o utilizador
interrompe.</p>
<p>Al√©m disso, note que o script j√° mata processos Chromium √≥rf√£os no
final.</p>
<p>Vamos ent√£o alterar o default de workers para 1.</p>
<p>C√≥digo alterado:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># No parser:</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">1</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos (padr√£o: 1)&quot;</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># E na chamada de generate_pdfs_live, j√° usamos max(1, args.workers) para garantir pelo menos 1.</span></span></code></pre></div>
<p>Vamos tamb√©m melhorar a resposta ao Ctrl+C, garantindo que a mensagem
√© clara e que o programa termina rapidamente.</p>
<p>O script j√° tem:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o pelo utilizador. Cancelando convers√£o...&quot;</span>)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    stop_event.<span class="bu">set</span>()</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pool:</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>            pool.terminate()</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        msg_queue.put(<span class="va">None</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        listener_thread.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üõë Convers√£o interrompida com seguran√ßa.&quot;</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span></code></pre></div>
<p>Isso parece robusto. No entanto, note que o
<code>pool.terminate()</code> √© chamado imediatamente ap√≥s o
KeyboardInterrupt, e depois no <code>finally</code> temos
<code>pool.close()</code> e <code>pool.join()</code> que n√£o ser√£o
executados porque o <code>pool.terminate()</code> j√° foi chamado. Mas
isso √© aceit√°vel.</p>
<p>Vamos ent√£o fazer a altera√ß√£o do default de workers para 1.</p>
<p>Outra melhoria: no final do script, no bloco <code>main()</code>,
vamos garantir que o <code>kill_orphaned_chromium()</code> √© chamado
mesmo em caso de interrup√ß√£o.</p>
<p>No entanto, note que o <code>kill_orphaned_chromium</code> j√° √©
chamado no tratamento de KeyboardInterrupt e no final do
processamento.</p>
<p>Vamos agora gerar o c√≥digo com as altera√ß√µes. Aqui est√° a vers√£o
otimizada do
<code>comb_pdf_direct6_html_based_optimized_live_benchmark.py</code> com
<code>--workers 1</code> por padr√£o e melhor tratamento do Ctrl+C:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">comb_pdf_direct6_html_based_optimized_live_benchmark.py</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">Vers√£o final otimizada com:</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ Feedback em tempo real (PDFs gerados)</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ Interrup√ß√£o Ctrl+C imediata e segura  </span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ Benchmark (tempo total + PDFs/minuto)</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ Fechamento autom√°tico de Chromium √≥rf√£os</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ Compat√≠vel com Windows/Linux/macOS</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ WORKERS=1 por padr√£o para maior estabilidade</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ Melhor tratamento de interrup√ß√£o com sinal SIGINT</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> signal</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright, <span class="pp">TimeoutError</span> <span class="im">as</span> PlaywrightTimeoutError</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Vari√°veis globais para controle de interrup√ß√£o</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>global_stop_event <span class="op">=</span> <span class="va">None</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>pool_processes <span class="op">=</span> []</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Fun√ß√µes utilit√°rias</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kill_orphaned_chromium():</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Tenta encerrar processos Chromium √≥rf√£os (Windows/Linux/macOS).&quot;&quot;&quot;</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Limpando processos Chromium √≥rf√£os...&quot;</span>)</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>            subprocess.run(</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chrome.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;msedge.exe&quot;</span>],</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>                stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> platform.system() <span class="kw">in</span> (<span class="st">&quot;Linux&quot;</span>, <span class="st">&quot;Darwin&quot;</span>):</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chromium&quot;</span>], stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chrome&quot;</span>], stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;playwright&quot;</span>], stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunkify(seq: List[<span class="bu">str</span>], size: <span class="bu">int</span>) <span class="op">-&gt;</span> List[List[<span class="bu">str</span>]]:</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [seq[i:i <span class="op">+</span> size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(seq), size)]</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_playwright_available(headless_test: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o Playwright + Chromium est√£o instalados.&quot;&quot;&quot;</span></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(headless<span class="op">=</span>headless_test)</span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> signal_handler(sig, frame):</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handler para SIGINT (Ctrl+C) - para interrup√ß√£o imediata&quot;&quot;&quot;</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">üõë Interrup√ß√£o recebida (SIGINT). Encerrando </span><span class="sc">{</span><span class="bu">len</span>(pool_processes)<span class="sc">}</span><span class="ss"> processos...&quot;</span>)</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_stop_event:</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>        global_stop_event.<span class="bu">set</span>()</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Termina todos os processos do pool</span></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> process <span class="kw">in</span> pool_processes:</span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> process.is_alive():</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>                process.terminate()</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üõë Convers√£o interrompida com seguran√ßa.&quot;</span>)</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>    sys.exit(<span class="dv">1</span>)</span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Worker de processamento (um processo por batch)</span></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_process_batch(batch_files, pdf_dir, timeout, headless, force_overwrite,</span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>                         retry_count, stop_event, msg_queue):</span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>    out_dir <span class="op">=</span> Path(pdf_dir)</span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>    out_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless,</span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span></span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_path_str <span class="kw">in</span> batch_files:</span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;info&quot;</span>, <span class="st">&quot;[worker] Stop solicitado, encerrando batch.&quot;</span>))</span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a>                html_path <span class="op">=</span> Path(html_path_str)</span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a>                pdf_path <span class="op">=</span> out_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> pdf_path.exists() <span class="kw">and</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;J√° existe (pulado)&quot;</span>))</span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>                success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a>                last_message <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, retry_count <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>                        last_message <span class="op">=</span> <span class="st">&quot;Parado pelo utilizador&quot;</span></span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>                        context <span class="op">=</span> browser.new_context(</span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a>                            viewport<span class="op">=</span>{<span class="st">&#39;width&#39;</span>: <span class="dv">1920</span>, <span class="st">&#39;height&#39;</span>: <span class="dv">1080</span>},</span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a>                            ignore_https_errors<span class="op">=</span><span class="va">True</span></span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>                        page <span class="op">=</span> context.new_page()</span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>                        page.set_default_timeout(<span class="bu">int</span>(timeout <span class="op">*</span> <span class="dv">1000</span>))</span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>                        full_path <span class="op">=</span> <span class="ss">f&quot;file:///</span><span class="sc">{</span>html_path<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>                        page.goto(full_path, wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>, timeout<span class="op">=</span><span class="bu">int</span>(timeout <span class="op">*</span> <span class="dv">1000</span>))</span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">try</span>:</span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>                            page.wait_for_load_state(<span class="st">&#39;load&#39;</span>, timeout<span class="op">=</span><span class="bu">int</span>(<span class="fl">0.5</span> <span class="op">*</span> timeout <span class="op">*</span> <span class="dv">1000</span>))</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">pass</span></span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a>                        page.pdf(</span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>                            path<span class="op">=</span><span class="bu">str</span>(pdf_path),</span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>,</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a>                            print_background<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a>                            margin<span class="op">=</span>{<span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span>},</span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a>                            prefer_css_page_size<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>                            display_header_footer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a>                            scale<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a>                        context.close()</span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>                        success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>                        last_message <span class="op">=</span> <span class="st">&quot;Sucesso&quot;</span></span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;ok&quot;</span>, pdf_path.name))</span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> PlaywrightTimeoutError <span class="im">as</span> e:</span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;warn&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: Timeout (</span><span class="sc">{</span>attempt<span class="sc">}</span><span class="ss">)&quot;</span>))</span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a>                        last_message <span class="op">=</span> <span class="bu">str</span>(e)</span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;warn&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: Erro (</span><span class="sc">{</span>attempt<span class="sc">}</span><span class="ss">) - </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a>                        last_message <span class="op">=</span> <span class="bu">str</span>(e)</span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">finally</span>:</span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">try</span>:</span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a>                            context.close()</span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">pass</span></span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count:</span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true" tabindex="-1"></a>                        time.sleep(<span class="dv">1</span>)</span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> success <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb21-179"><a href="#cb21-179" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;fail&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>last_message<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb21-180"><a href="#cb21-180" aria-hidden="true" tabindex="-1"></a>                results.append((html_path_str, success, last_message))</span>
<span id="cb21-181"><a href="#cb21-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-182"><a href="#cb21-182" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb21-183"><a href="#cb21-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-184"><a href="#cb21-184" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb21-185"><a href="#cb21-185" aria-hidden="true" tabindex="-1"></a>        msg_queue.put((<span class="st">&quot;error&quot;</span>, <span class="ss">f&quot;Erro no worker: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb21-186"><a href="#cb21-186" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> html_path_str <span class="kw">in</span> batch_files:</span>
<span id="cb21-187"><a href="#cb21-187" aria-hidden="true" tabindex="-1"></a>            results.append((html_path_str, <span class="va">False</span>, <span class="ss">f&quot;Erro processo: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb21-188"><a href="#cb21-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-189"><a href="#cb21-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb21-190"><a href="#cb21-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-191"><a href="#cb21-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-192"><a href="#cb21-192" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_wrapper(args):</span>
<span id="cb21-193"><a href="#cb21-193" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> worker_process_batch(<span class="op">*</span>args)</span>
<span id="cb21-194"><a href="#cb21-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-195"><a href="#cb21-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-196"><a href="#cb21-196" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-197"><a href="#cb21-197" aria-hidden="true" tabindex="-1"></a><span class="co"># Listener de mensagens (impress√£o em tempo real)</span></span>
<span id="cb21-198"><a href="#cb21-198" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-199"><a href="#cb21-199" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> queue_listener(msg_queue, stop_event, listener_stop_flag):</span>
<span id="cb21-200"><a href="#cb21-200" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> listener_stop_flag.is_set():</span>
<span id="cb21-201"><a href="#cb21-201" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb21-202"><a href="#cb21-202" aria-hidden="true" tabindex="-1"></a>            obj <span class="op">=</span> msg_queue.get(timeout<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb21-203"><a href="#cb21-203" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-204"><a href="#cb21-204" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb21-205"><a href="#cb21-205" aria-hidden="true" tabindex="-1"></a>            typ, text <span class="op">=</span> obj</span>
<span id="cb21-206"><a href="#cb21-206" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> typ <span class="op">==</span> <span class="st">&quot;ok&quot;</span>:</span>
<span id="cb21-207"><a href="#cb21-207" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ Gerado: </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb21-208"><a href="#cb21-208" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;warn&quot;</span>:</span>
<span id="cb21-209"><a href="#cb21-209" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb21-210"><a href="#cb21-210" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;fail&quot;</span>:</span>
<span id="cb21-211"><a href="#cb21-211" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Falha: </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb21-212"><a href="#cb21-212" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;error&quot;</span>:</span>
<span id="cb21-213"><a href="#cb21-213" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üö´ Erro no worker: </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb21-214"><a href="#cb21-214" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb21-215"><a href="#cb21-215" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(text)</span>
<span id="cb21-216"><a href="#cb21-216" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb21-217"><a href="#cb21-217" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb21-218"><a href="#cb21-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-219"><a href="#cb21-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-220"><a href="#cb21-220" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-221"><a href="#cb21-221" aria-hidden="true" tabindex="-1"></a><span class="co"># Convers√£o principal (com benchmark e interrup√ß√£o segura)</span></span>
<span id="cb21-222"><a href="#cb21-222" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-223"><a href="#cb21-223" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_pdfs_live(source_dir, output_dir, workers, batch_size, headless, timeout,</span>
<span id="cb21-224"><a href="#cb21-224" aria-hidden="true" tabindex="-1"></a>                       force_overwrite, dry_run, single_file<span class="op">=</span><span class="va">None</span>, retry_count<span class="op">=</span><span class="dv">2</span>, benchmark<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb21-225"><a href="#cb21-225" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> global_stop_event, pool_processes</span>
<span id="cb21-226"><a href="#cb21-226" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-227"><a href="#cb21-227" aria-hidden="true" tabindex="-1"></a>    src <span class="op">=</span> Path(source_dir)</span>
<span id="cb21-228"><a href="#cb21-228" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> Path(output_dir)</span>
<span id="cb21-229"><a href="#cb21-229" aria-hidden="true" tabindex="-1"></a>    out.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-230"><a href="#cb21-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-231"><a href="#cb21-231" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> single_file:</span>
<span id="cb21-232"><a href="#cb21-232" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [<span class="bu">str</span>(src <span class="op">/</span> single_file)]</span>
<span id="cb21-233"><a href="#cb21-233" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb21-234"><a href="#cb21-234" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> <span class="bu">sorted</span>([<span class="bu">str</span>(p) <span class="cf">for</span> p <span class="kw">in</span> src.glob(<span class="st">&quot;*.html&quot;</span>)])</span>
<span id="cb21-235"><a href="#cb21-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-236"><a href="#cb21-236" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb21-237"><a href="#cb21-237" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Nenhum arquivo HTML encontrado.&quot;</span>)</span>
<span id="cb21-238"><a href="#cb21-238" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb21-239"><a href="#cb21-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-240"><a href="#cb21-240" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üéØ Encontrados </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos HTML&quot;</span>)</span>
<span id="cb21-241"><a href="#cb21-241" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>workers<span class="sc">}</span><span class="ss"> ; batch_size: </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> ; timeout: </span><span class="sc">{</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb21-242"><a href="#cb21-242" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÅ Modo: </span><span class="sc">{</span><span class="st">&#39;force&#39;</span> <span class="cf">if</span> force_overwrite <span class="cf">else</span> <span class="st">&#39;only_new&#39;</span> <span class="cf">if</span> <span class="kw">not</span> dry_run <span class="cf">else</span> <span class="st">&#39;dry_run&#39;</span><span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb21-243"><a href="#cb21-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-244"><a href="#cb21-244" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dry_run:</span>
<span id="cb21-245"><a href="#cb21-245" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ Modo dry-run ativo. Nenhum arquivo ser√° criado.&quot;</span>)</span>
<span id="cb21-246"><a href="#cb21-246" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb21-247"><a href="#cb21-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-248"><a href="#cb21-248" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb21-249"><a href="#cb21-249" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> html_files <span class="cf">if</span> <span class="kw">not</span> (out <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>Path(f)<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span>).exists()]</span>
<span id="cb21-250"><a href="#cb21-250" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üÜï </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos novos restantes ap√≥s filtragem.&quot;</span>)</span>
<span id="cb21-251"><a href="#cb21-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-252"><a href="#cb21-252" aria-hidden="true" tabindex="-1"></a>    batches <span class="op">=</span> chunkify(html_files, batch_size)</span>
<span id="cb21-253"><a href="#cb21-253" aria-hidden="true" tabindex="-1"></a>    total_batches <span class="op">=</span> <span class="bu">len</span>(batches)</span>
<span id="cb21-254"><a href="#cb21-254" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üì¶ Preparados </span><span class="sc">{</span>total_batches<span class="sc">}</span><span class="ss"> batches (‚âà</span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> arquivos cada).&quot;</span>)</span>
<span id="cb21-255"><a href="#cb21-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-256"><a href="#cb21-256" aria-hidden="true" tabindex="-1"></a>    manager <span class="op">=</span> multiprocessing.Manager()</span>
<span id="cb21-257"><a href="#cb21-257" aria-hidden="true" tabindex="-1"></a>    stop_event <span class="op">=</span> manager.Event()</span>
<span id="cb21-258"><a href="#cb21-258" aria-hidden="true" tabindex="-1"></a>    global_stop_event <span class="op">=</span> stop_event  <span class="co"># Tornar acess√≠vel globalmente</span></span>
<span id="cb21-259"><a href="#cb21-259" aria-hidden="true" tabindex="-1"></a>    msg_queue <span class="op">=</span> manager.Queue()</span>
<span id="cb21-260"><a href="#cb21-260" aria-hidden="true" tabindex="-1"></a>    listener_stop_flag <span class="op">=</span> threading.Event()</span>
<span id="cb21-261"><a href="#cb21-261" aria-hidden="true" tabindex="-1"></a>    listener_thread <span class="op">=</span> threading.Thread(target<span class="op">=</span>queue_listener, args<span class="op">=</span>(msg_queue, stop_event, listener_stop_flag), daemon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-262"><a href="#cb21-262" aria-hidden="true" tabindex="-1"></a>    listener_thread.start()</span>
<span id="cb21-263"><a href="#cb21-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-264"><a href="#cb21-264" aria-hidden="true" tabindex="-1"></a>    args_list <span class="op">=</span> [(batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, stop_event, msg_queue) <span class="cf">for</span> batch <span class="kw">in</span> batches]</span>
<span id="cb21-265"><a href="#cb21-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-266"><a href="#cb21-266" aria-hidden="true" tabindex="-1"></a>    success_count, failed <span class="op">=</span> <span class="dv">0</span>, []</span>
<span id="cb21-267"><a href="#cb21-267" aria-hidden="true" tabindex="-1"></a>    pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb21-268"><a href="#cb21-268" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb21-269"><a href="#cb21-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-270"><a href="#cb21-270" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb21-271"><a href="#cb21-271" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Configurar signal handler para Ctrl+C</span></span>
<span id="cb21-272"><a href="#cb21-272" aria-hidden="true" tabindex="-1"></a>        original_sigint <span class="op">=</span> signal.signal(signal.SIGINT, signal_handler)</span>
<span id="cb21-273"><a href="#cb21-273" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-274"><a href="#cb21-274" aria-hidden="true" tabindex="-1"></a>        pool <span class="op">=</span> multiprocessing.Pool(processes<span class="op">=</span>workers)</span>
<span id="cb21-275"><a href="#cb21-275" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-276"><a href="#cb21-276" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Guardar refer√™ncias dos processos para poder terminar</span></span>
<span id="cb21-277"><a href="#cb21-277" aria-hidden="true" tabindex="-1"></a>        pool_processes <span class="op">=</span> [p <span class="cf">for</span> p <span class="kw">in</span> pool._pool]</span>
<span id="cb21-278"><a href="#cb21-278" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-279"><a href="#cb21-279" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch_idx, result <span class="kw">in</span> <span class="bu">enumerate</span>(pool.imap_unordered(worker_wrapper, args_list), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb21-280"><a href="#cb21-280" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb21-281"><a href="#cb21-281" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb21-282"><a href="#cb21-282" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb21-283"><a href="#cb21-283" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ Batch </span><span class="sc">{</span>batch_idx<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_batches<span class="sc">}</span><span class="ss"> conclu√≠do (</span><span class="sc">{</span><span class="bu">len</span>(result)<span class="sc">}</span><span class="ss"> arquivos)&quot;</span>)</span>
<span id="cb21-284"><a href="#cb21-284" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_file, success, msg <span class="kw">in</span> result:</span>
<span id="cb21-285"><a href="#cb21-285" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> success:</span>
<span id="cb21-286"><a href="#cb21-286" aria-hidden="true" tabindex="-1"></a>                    success_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb21-287"><a href="#cb21-287" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb21-288"><a href="#cb21-288" aria-hidden="true" tabindex="-1"></a>                    failed.append((Path(html_file).name, msg))</span>
<span id="cb21-289"><a href="#cb21-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-290"><a href="#cb21-290" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Restaurar signal handler original</span></span>
<span id="cb21-291"><a href="#cb21-291" aria-hidden="true" tabindex="-1"></a>        signal.signal(signal.SIGINT, original_sigint)</span>
<span id="cb21-292"><a href="#cb21-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-293"><a href="#cb21-293" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb21-294"><a href="#cb21-294" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o pelo utilizador. Cancelando convers√£o...&quot;</span>)</span>
<span id="cb21-295"><a href="#cb21-295" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb21-296"><a href="#cb21-296" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb21-297"><a href="#cb21-297" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pool:</span>
<span id="cb21-298"><a href="#cb21-298" aria-hidden="true" tabindex="-1"></a>                pool.terminate()</span>
<span id="cb21-299"><a href="#cb21-299" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb21-300"><a href="#cb21-300" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb21-301"><a href="#cb21-301" aria-hidden="true" tabindex="-1"></a>        <span class="cf">finally</span>:</span>
<span id="cb21-302"><a href="#cb21-302" aria-hidden="true" tabindex="-1"></a>            listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb21-303"><a href="#cb21-303" aria-hidden="true" tabindex="-1"></a>            msg_queue.put(<span class="va">None</span>)</span>
<span id="cb21-304"><a href="#cb21-304" aria-hidden="true" tabindex="-1"></a>            listener_thread.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-305"><a href="#cb21-305" aria-hidden="true" tabindex="-1"></a>            kill_orphaned_chromium()</span>
<span id="cb21-306"><a href="#cb21-306" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&quot;üõë Convers√£o interrompida com seguran√ßa.&quot;</span>)</span>
<span id="cb21-307"><a href="#cb21-307" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb21-308"><a href="#cb21-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-309"><a href="#cb21-309" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb21-310"><a href="#cb21-310" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pool:</span>
<span id="cb21-311"><a href="#cb21-311" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb21-312"><a href="#cb21-312" aria-hidden="true" tabindex="-1"></a>                pool.close()</span>
<span id="cb21-313"><a href="#cb21-313" aria-hidden="true" tabindex="-1"></a>                pool.join()</span>
<span id="cb21-314"><a href="#cb21-314" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb21-315"><a href="#cb21-315" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb21-316"><a href="#cb21-316" aria-hidden="true" tabindex="-1"></a>                    pool.terminate()</span>
<span id="cb21-317"><a href="#cb21-317" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb21-318"><a href="#cb21-318" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">pass</span></span>
<span id="cb21-319"><a href="#cb21-319" aria-hidden="true" tabindex="-1"></a>        listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb21-320"><a href="#cb21-320" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb21-321"><a href="#cb21-321" aria-hidden="true" tabindex="-1"></a>            msg_queue.put(<span class="va">None</span>)</span>
<span id="cb21-322"><a href="#cb21-322" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb21-323"><a href="#cb21-323" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb21-324"><a href="#cb21-324" aria-hidden="true" tabindex="-1"></a>        listener_thread.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-325"><a href="#cb21-325" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb21-326"><a href="#cb21-326" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-327"><a href="#cb21-327" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpar refer√™ncias globais</span></span>
<span id="cb21-328"><a href="#cb21-328" aria-hidden="true" tabindex="-1"></a>        global_stop_event <span class="op">=</span> <span class="va">None</span></span>
<span id="cb21-329"><a href="#cb21-329" aria-hidden="true" tabindex="-1"></a>        pool_processes <span class="op">=</span> []</span>
<span id="cb21-330"><a href="#cb21-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-331"><a href="#cb21-331" aria-hidden="true" tabindex="-1"></a>    elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb21-332"><a href="#cb21-332" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üìä Resumo:&quot;</span>)</span>
<span id="cb21-333"><a href="#cb21-333" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot; ‚úÖ Sucessos: </span><span class="sc">{</span>success_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb21-334"><a href="#cb21-334" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot; ‚ùå Falhas: </span><span class="sc">{</span><span class="bu">len</span>(failed)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb21-335"><a href="#cb21-335" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> benchmark <span class="kw">and</span> success_count <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb21-336"><a href="#cb21-336" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">=</span> success_count <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb21-337"><a href="#cb21-337" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚è±Ô∏è Tempo total: </span><span class="sc">{</span>elapsed<span class="sc">:.1f}</span><span class="ss">s  ‚Üí  </span><span class="sc">{</span>rate<span class="sc">:.1f}</span><span class="ss"> PDFs/minuto&quot;</span>)</span>
<span id="cb21-338"><a href="#cb21-338" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> success_count <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb21-339"><a href="#cb21-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-340"><a href="#cb21-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-341"><a href="#cb21-341" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-342"><a href="#cb21-342" aria-hidden="true" tabindex="-1"></a><span class="co"># CLI</span></span>
<span id="cb21-343"><a href="#cb21-343" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-344"><a href="#cb21-344" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args():</span>
<span id="cb21-345"><a href="#cb21-345" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(description<span class="op">=</span><span class="st">&quot;Convers√£o HTML ‚Üí PDF (Playwright otimizado com live feedback e benchmark)&quot;</span>)</span>
<span id="cb21-346"><a href="#cb21-346" aria-hidden="true" tabindex="-1"></a>    group <span class="op">=</span> parser.add_mutually_exclusive_group()</span>
<span id="cb21-347"><a href="#cb21-347" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--force&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Sobrescreve PDFs j√° existentes&quot;</span>)</span>
<span id="cb21-348"><a href="#cb21-348" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--only-new&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, default<span class="op">=</span><span class="va">False</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Apenas novos (padr√£o)&quot;</span>)</span>
<span id="cb21-349"><a href="#cb21-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-350"><a href="#cb21-350" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--dry-run&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Simula sem criar arquivos&quot;</span>)</span>
<span id="cb21-351"><a href="#cb21-351" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--source&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_html&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta com arquivos .html&quot;</span>)</span>
<span id="cb21-352"><a href="#cb21-352" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--output&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_pdfs&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta de sa√≠da para PDFs&quot;</span>)</span>
<span id="cb21-353"><a href="#cb21-353" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">1</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos (padr√£o: 1 para maior estabilidade)&quot;</span>)</span>
<span id="cb21-354"><a href="#cb21-354" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--batch-size&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">10</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Arquivos por batch (padr√£o: 10)&quot;</span>)</span>
<span id="cb21-355"><a href="#cb21-355" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--no-headless&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra navegador (debug)&quot;</span>)</span>
<span id="cb21-356"><a href="#cb21-356" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--single-file&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Converte apenas um arquivo HTML espec√≠fico&quot;</span>)</span>
<span id="cb21-357"><a href="#cb21-357" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--timeout&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">60</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Timeout por p√°gina (segundos)&quot;</span>)</span>
<span id="cb21-358"><a href="#cb21-358" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--retry-count&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Tentativas por arquivo (padr√£o: 2)&quot;</span>)</span>
<span id="cb21-359"><a href="#cb21-359" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--benchmark&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra tempo total e PDFs/minuto&quot;</span>)</span>
<span id="cb21-360"><a href="#cb21-360" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parser.parse_args()</span>
<span id="cb21-361"><a href="#cb21-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-362"><a href="#cb21-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-363"><a href="#cb21-363" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-364"><a href="#cb21-364" aria-hidden="true" tabindex="-1"></a><span class="co"># Main</span></span>
<span id="cb21-365"><a href="#cb21-365" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb21-366"><a href="#cb21-366" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb21-367"><a href="#cb21-367" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configurar signal handler logo no in√≠cio</span></span>
<span id="cb21-368"><a href="#cb21-368" aria-hidden="true" tabindex="-1"></a>    signal.signal(signal.SIGINT, signal_handler)</span>
<span id="cb21-369"><a href="#cb21-369" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-370"><a href="#cb21-370" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args()</span>
<span id="cb21-371"><a href="#cb21-371" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üöÄ PDF GENERATOR - HTML BASED (PLAYWRIGHT) - LIVE + BENCHMARK&quot;</span>)</span>
<span id="cb21-372"><a href="#cb21-372" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;=&quot;</span> <span class="op">*</span> <span class="dv">65</span>)</span>
<span id="cb21-373"><a href="#cb21-373" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>args<span class="sc">.</span>workers<span class="sc">}</span><span class="ss"> (padr√£o: 1 para maior estabilidade)&quot;</span>)</span>
<span id="cb21-374"><a href="#cb21-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-375"><a href="#cb21-375" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb21-376"><a href="#cb21-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-377"><a href="#cb21-377" aria-hidden="true" tabindex="-1"></a>    source_dir <span class="op">=</span> Path(args.source)</span>
<span id="cb21-378"><a href="#cb21-378" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> source_dir.exists():</span>
<span id="cb21-379"><a href="#cb21-379" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Pasta de origem n√£o encontrada: </span><span class="sc">{</span>source_dir<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb21-380"><a href="#cb21-380" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb21-381"><a href="#cb21-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-382"><a href="#cb21-382" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_playwright_available(headless_test<span class="op">=</span><span class="kw">not</span> args.no_headless):</span>
<span id="cb21-383"><a href="#cb21-383" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Playwright n√£o dispon√≠vel. Instale: pip install playwright &amp;&amp; playwright install chromium&quot;</span>)</span>
<span id="cb21-384"><a href="#cb21-384" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb21-385"><a href="#cb21-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-386"><a href="#cb21-386" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> generate_pdfs_live(</span>
<span id="cb21-387"><a href="#cb21-387" aria-hidden="true" tabindex="-1"></a>        source_dir<span class="op">=</span><span class="bu">str</span>(args.source),</span>
<span id="cb21-388"><a href="#cb21-388" aria-hidden="true" tabindex="-1"></a>        output_dir<span class="op">=</span><span class="bu">str</span>(args.output),</span>
<span id="cb21-389"><a href="#cb21-389" aria-hidden="true" tabindex="-1"></a>        workers<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.workers),</span>
<span id="cb21-390"><a href="#cb21-390" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.batch_size),</span>
<span id="cb21-391"><a href="#cb21-391" aria-hidden="true" tabindex="-1"></a>        headless<span class="op">=</span><span class="kw">not</span> args.no_headless,</span>
<span id="cb21-392"><a href="#cb21-392" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span><span class="bu">max</span>(<span class="dv">10</span>, args.timeout),</span>
<span id="cb21-393"><a href="#cb21-393" aria-hidden="true" tabindex="-1"></a>        force_overwrite<span class="op">=</span>args.force,</span>
<span id="cb21-394"><a href="#cb21-394" aria-hidden="true" tabindex="-1"></a>        dry_run<span class="op">=</span>args.dry_run,</span>
<span id="cb21-395"><a href="#cb21-395" aria-hidden="true" tabindex="-1"></a>        single_file<span class="op">=</span>args.single_file,</span>
<span id="cb21-396"><a href="#cb21-396" aria-hidden="true" tabindex="-1"></a>        retry_count<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.retry_count),</span>
<span id="cb21-397"><a href="#cb21-397" aria-hidden="true" tabindex="-1"></a>        benchmark<span class="op">=</span>args.benchmark</span>
<span id="cb21-398"><a href="#cb21-398" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-399"><a href="#cb21-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-400"><a href="#cb21-400" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb21-401"><a href="#cb21-401" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ Simula√ß√£o finalizada.&quot;</span>)</span>
<span id="cb21-402"><a href="#cb21-402" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">0</span>)</span>
<span id="cb21-403"><a href="#cb21-403" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> success:</span>
<span id="cb21-404"><a href="#cb21-404" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üéâ Convers√£o conclu√≠da com sucesso!&quot;</span>)</span>
<span id="cb21-405"><a href="#cb21-405" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üìÅ PDFs salvos em: </span><span class="sc">{</span>Path(args.output)<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb21-406"><a href="#cb21-406" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">0</span>)</span>
<span id="cb21-407"><a href="#cb21-407" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb21-408"><a href="#cb21-408" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è Convers√£o parcial ou interrompida.&quot;</span>)</span>
<span id="cb21-409"><a href="#cb21-409" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb21-410"><a href="#cb21-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-411"><a href="#cb21-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-412"><a href="#cb21-412" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb21-413"><a href="#cb21-413" aria-hidden="true" tabindex="-1"></a>    multiprocessing.freeze_support()</span>
<span id="cb21-414"><a href="#cb21-414" aria-hidden="true" tabindex="-1"></a>    main()</span></code></pre></div>
<h2 data-number="1.12" id="principais-melhorias-implementadas"><span class="header-section-number">1.12</span> üöÄ <strong>Principais
Melhorias Implementadas:</strong></h2>
<h3 data-number="1.12.1" id="workers-1-por-padr√£o"><span class="header-section-number">1.12.1</span> <strong>1. Workers = 1 por
Padr√£o</strong></h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">1</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos (padr√£o: 1 para maior estabilidade)&quot;</span>)</span></code></pre></div>
<ul>
<li>‚úÖ <strong>Estabilidade m√°xima</strong> - menos conflitos de
recursos</li>
<li>‚úÖ <strong>Debug mais f√°cil</strong> - processamento sequencial</li>
<li>‚úÖ <strong>Consumo reduzido</strong> - ideal para m√°quinas com
poucos recursos</li>
</ul>
<h3 data-number="1.12.2" id="sistema-de-interrup√ß√£o-melhorado"><span class="header-section-number">1.12.2</span> <strong>2. Sistema de
Interrup√ß√£o Melhorado</strong></h3>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> signal_handler(sig, frame):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handler para SIGINT (Ctrl+C) - para interrup√ß√£o imediata&quot;&quot;&quot;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">üõë Interrup√ß√£o recebida (SIGINT). Encerrando </span><span class="sc">{</span><span class="bu">len</span>(pool_processes)<span class="sc">}</span><span class="ss"> processos...&quot;</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_stop_event:</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        global_stop_event.<span class="bu">set</span>()</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Termina todos os processos do pool</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> process <span class="kw">in</span> pool_processes:</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> process.is_alive():</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>                process.terminate()</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span></code></pre></div>
<h3 data-number="1.12.3" id="gest√£o-global-de-processos"><span class="header-section-number">1.12.3</span> <strong>3. Gest√£o Global de
Processos</strong></h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>global_stop_event <span class="op">=</span> <span class="va">None</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>pool_processes <span class="op">=</span> []</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Dentro da fun√ß√£o principal:</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>global_stop_event <span class="op">=</span> stop_event  <span class="co"># Tornar acess√≠vel globalmente</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>pool_processes <span class="op">=</span> [p <span class="cf">for</span> p <span class="kw">in</span> pool._pool]  <span class="co"># Guardar refer√™ncias</span></span></code></pre></div>
<h3 data-number="1.12.4" id="signal-handling-robusto"><span class="header-section-number">1.12.4</span> <strong>4. Signal Handling
Robusto</strong></h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configurar signal handler logo no in√≠cio</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>signal.signal(signal.SIGINT, signal_handler)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Durante o processamento:</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>original_sigint <span class="op">=</span> signal.signal(signal.SIGINT, signal_handler)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ... processamento ...</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>signal.signal(signal.SIGINT, original_sigint)  <span class="co"># Restaurar</span></span></code></pre></div>
<h3 data-number="1.12.5" id="limpeza-de-processos-chromium"><span class="header-section-number">1.12.5</span> <strong>5. Limpeza de
Processos Chromium</strong></h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Kill mais abrangente</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;playwright&quot;</span>], stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span></code></pre></div>
<h2 data-number="1.13" id="vantagens-das-melhorias"><span class="header-section-number">1.13</span> üéØ <strong>Vantagens das
Melhorias:</strong></h2>
<ol type="1">
<li><strong>üõë Interrup√ß√£o Instant√¢nea</strong> - Ctrl+C responde
imediatamente</li>
<li><strong>üîß Estabilidade M√°xima</strong> - Workers=1 evita
conflitos</li>
<li><strong>üßπ Limpeza Completa</strong> - Mata todos os processos
relacionados</li>
<li><strong>üöÄ Performance Consistente</strong> - Menos overhead de
paralelismo</li>
<li><strong>üêõ Debug Simplificado</strong> - Processamento sequencial √©
mais previs√≠vel</li>
</ol>
<h2 data-number="1.14" id="uso-recomendado-1"><span class="header-section-number">1.14</span> üìä <strong>Uso
Recomendado:</strong></h2>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Padr√£o (mais est√°vel)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> comb_pdf_direct6_html_based_optimized_live_benchmark.py</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Para velocidade (se o sistema suportar)</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> comb_pdf_direct6_html_based_optimized_live_benchmark.py <span class="at">--workers</span> 3</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Com benchmark</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> comb_pdf_direct6_html_based_optimized_live_benchmark.py <span class="at">--benchmark</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Apenas um arquivo</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> comb_pdf_direct6_html_based_optimized_live_benchmark.py <span class="at">--single-file</span> exemplo.html</span></code></pre></div>
<p>Esta vers√£o oferece o <strong>melhor equil√≠brio entre usabilidade e
robustez</strong>! üéØ</p>
<hr />
<h3 data-number="1.14.1" id="utilizador-2025-11-06-072348-deepseek-reasoner"><span class="header-section-number">1.14.1</span> üë§ Utilizador
<em>(2025-11-06 07:23:48)</em> <em>[deepseek-reasoner]</em></h3>
<p>Como melhorar a forma como √© processado Ctrl+C em
comb_pdf_direct6_html_based_optimized_live_benchmark.py porque a vers√£o
actual n√£o consegue para a esecu√ß√£o do script</p>
<hr />
<h3 data-number="1.14.2" id="deepseek-2025-11-06-072348-deepseek-reasoner"><span class="header-section-number">1.14.2</span> ü§ñ DeepSeek <em>(2025-11-06
07:23:48)</em> <em>[deepseek-reasoner]</em></h3>
<p>Vamos melhorar o tratamento do Ctrl+C (SIGINT) no script. O problema
√© que o script atual n√£o est√° conseguindo parar a execu√ß√£o imediatamente
quando o usu√°rio pressiona Ctrl+C. Isso pode ser devido a v√°rios
fatores, incluindo a forma como os processos s√£o gerenciados e como os
sinais s√£o tratados.</p>
<p>Vamos adotar uma abordagem mais robusta:</p>
<ol type="1">
<li>Usar um <code>Event</code> global para sinalizar a interrup√ß√£o.</li>
<li>Garantir que todos os processos filhos sejam terminados
adequadamente.</li>
<li>Usar <code>signal.signal</code> para capturar o sinal SIGINT
(Ctrl+C) e disparar o evento de parada.</li>
<li>No loop principal, verificar periodicamente se o evento de parada
foi setado.</li>
</ol>
<p>No entanto, note que o script j√° usa multiprocessing e tem um
<code>stop_event</code> que √© passado para os processos. O problema pode
ser que o <code>signal_handler</code> n√£o est√° sendo chamado
corretamente, ou que os processos n√£o est√£o respondendo ao
<code>stop_event</code> rapidamente.</p>
<p>Vamos modificar o script para:</p>
<ul>
<li>Configurar o manuseio de sinal no processo principal.</li>
<li>No <code>signal_handler</code>, setar o
<code>global_stop_event</code> e ent√£o tentar terminar o pool de
processos.</li>
<li>Al√©m disso, vamos tentar usar <code>pool.terminate()</code> e
<code>pool.join()</code> para parar os processos.</li>
</ul>
<p>Outro ponto: o script atual est√° usando
<code>multiprocessing.Pool</code> e tentando acessar
<code>pool._pool</code> para obter a lista de processos. Isso n√£o √©
seguro porque <code>_pool</code> √© um atributo interno. Em vez disso,
podemos usar uma lista personalizada para rastrear os processos.</p>
<p>Vamos reestruturar:</p>
<ul>
<li>Criar uma lista global para armazenar os processos do pool.</li>
<li>No <code>signal_handler</code>, percorrer essa lista e terminar cada
processo.</li>
</ul>
<p>No entanto, note que o <code>multiprocessing.Pool</code> j√° tem
m√©todos para terminar os processos. Vamos usar
<code>pool.terminate()</code> que para imediatamente todos os processos
do pool.</p>
<p>Vamos tamb√©m garantir que o <code>signal_handler</code> seja
registrado no processo principal e que o evento global seja setado.</p>
<p>Vamos fazer as seguintes altera√ß√µes:</p>
<ol type="1">
<li>Remover a vari√°vel global <code>pool_processes</code> e confiar no
<code>pool.terminate()</code>.</li>
<li>No <code>signal_handler</code>, setar o
<code>global_stop_event</code> e chamar <code>pool.terminate()</code> se
o pool existir.</li>
<li>Garantir que o <code>global_stop_event</code> √© setado no
<code>signal_handler</code> e que √© verificado nos workers.</li>
</ol>
<p>No entanto, note que o <code>signal_handler</code> √© executado no
processo principal, e o <code>pool</code> √© uma vari√°vel local na fun√ß√£o
<code>generate_pdfs_live</code>. Portanto, precisamos tornar o
<code>pool</code> acess√≠vel globalmente ou usar uma outra abordagem.</p>
<p>Vamos criar uma classe para gerenciar o estado global, ou usar uma
vari√°vel global para o pool. Mas note que o pool √© criado dentro de uma
fun√ß√£o. Alternativamente, podemos passar o pool para o
<code>signal_handler</code> se usarmos uma closure, mas n√£o √©
straightforward com o sinal.</p>
<p>Outra abordagem √© usar um contexto manager para o pool, mas vamos
tentar manter a simplicidade.</p>
<p>Vamos modificar a fun√ß√£o <code>generate_pdfs_live</code> para:</p>
<ul>
<li>Usar uma vari√°vel global para o pool (dentro do m√≥dulo) e registrar
o pool globalmente.</li>
<li>No <code>signal_handler</code>, acessar essa vari√°vel global e
terminar o pool.</li>
</ul>
<p>No entanto, isso pode ser problem√°tico se multiple inst√¢ncias forem
executadas. Como √© um script, assumimos uma inst√¢ncia.</p>
<p>Vamos tentar:</p>
<ul>
<li>Definir uma vari√°vel global <code>global_pool</code> no m√≥dulo.</li>
<li>Em <code>generate_pdfs_live</code>, atribuir o pool a
<code>global_pool</code> e, no final, remov√™-lo.</li>
<li>No <code>signal_handler</code>, se <code>global_pool</code> existir,
chamar <code>global_pool.terminate()</code>.</li>
</ul>
<p>Vamos tamb√©m garantir que o <code>stop_event</code> seja setado no
<code>signal_handler</code>.</p>
<p>Vamos implementar:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>global_pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> signal_handler(sig, frame):</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o recebida (Ctrl+C). Encerrando...&quot;</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_stop_event:</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        global_stop_event.<span class="bu">set</span>()</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_pool:</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        global_pool.terminate()</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    sys.exit(<span class="dv">1</span>)</span></code></pre></div>
<p>E em <code>generate_pdfs_live</code>:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> global_pool</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>pool <span class="op">=</span> multiprocessing.Pool(processes<span class="op">=</span>workers)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>global_pool <span class="op">=</span> pool</span></code></pre></div>
<p>E no final de <code>generate_pdfs_live</code>:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>global_pool <span class="op">=</span> <span class="va">None</span></span></code></pre></div>
<p>Vamos tamb√©m remover a tentativa de acessar <code>pool._pool</code> e
a lista <code>pool_processes</code>.</p>
<p>Vamos remover a lista <code>pool_processes</code> e a l√≥gica
associada.</p>
<p>Vamos tamb√©m remover o <code>try/finally</code> que tenta terminar o
pool, porque agora estamos usando o <code>global_pool</code> no signal
handler.</p>
<p>No entanto, note que o <code>signal_handler</code> est√° configurado
para terminar o pool e sair. Mas queremos que a fun√ß√£o
<code>generate_pdfs_live</code> retorne adequadamente.</p>
<p>Vamos ajustar o signal handler para n√£o sair do programa
imediatamente, mas apenas setar o evento e terminar o pool. O c√≥digo
ent√£o sair√° do loop e far√° a limpeza.</p>
<p>Vamos modificar o signal handler para:</p>
<ul>
<li>Setar o <code>global_stop_event</code></li>
<li>Terminar o <code>global_pool</code></li>
</ul>
<p>E ent√£o o loop principal vai quebrar e a fun√ß√£o vai retornar.</p>
<p>Vamos tamb√©m garantir que o sinal seja restaurado.</p>
<p>Vamos tentar essa abordagem.</p>
<p>Vamos reescrever o script com essas altera√ß√µes.</p>
<p>Nota: Vamos remover a vari√°vel <code>pool_processes</code> e a l√≥gica
de termina√ß√£o individual de processos, pois o
<code>pool.terminate()</code> j√° faz isso.</p>
<p>Vamos tamb√©m remover o <code>signal_handler</code> de dentro da
fun√ß√£o <code>generate_pdfs_live</code> e configur√°-lo no n√≠vel do
m√≥dulo, mas com acesso √†s vari√°veis globais.</p>
<p>Vamos reestruturar o c√≥digo:</p>
<ol type="1">
<li>Vari√°veis globais: <code>global_stop_event</code> e
<code>global_pool</code>.</li>
<li><code>signal_handler</code> que usa essas vari√°veis.</li>
<li>Registro do <code>signal_handler</code> no in√≠cio do
<code>main</code>.</li>
</ol>
<p>Vamos tamb√©m garantir que o <code>global_stop_event</code> seja
criado no <code>generate_pdfs_live</code> e atribu√≠do √† vari√°vel
global.</p>
<p>Vamos fazer:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>global_stop_event <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>global_pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> signal_handler(sig, frame):</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o recebida (Ctrl+C). Encerrando...&quot;</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_stop_event:</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        global_stop_event.<span class="bu">set</span>()</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> global_pool:</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        global_pool.terminate()</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># N√£o saia imediatamente, deixe o tratamento de limpeza ocorrer</span></span></code></pre></div>
<p>E em <code>generate_pdfs_live</code>:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">global</span> global_stop_event, global_pool</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>manager <span class="op">=</span> multiprocessing.Manager()</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>stop_event <span class="op">=</span> manager.Event()</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>global_stop_event <span class="op">=</span> stop_event  <span class="co"># Tornar acess√≠vel globalmente</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>pool <span class="op">=</span> multiprocessing.Pool(processes<span class="op">=</span>workers)</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>global_pool <span class="op">=</span> pool</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co"># ... (resto do c√≥digo)</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co"># No final, limpar global_pool e global_stop_event</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>global_pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>global_stop_event <span class="op">=</span> <span class="va">None</span></span></code></pre></div>
<p>Vamos tamb√©m remover o <code>try/except</code> around do pool que
temos atualmente, porque o signal handler vai lidar com a
interrup√ß√£o.</p>
<p>No entanto, note que o <code>pool.imap_unordered</code> pode levantar
uma exce√ß√£o quando o pool √© terminado. Vamos capturar essa exce√ß√£o.</p>
<p>Vamos ajustar o loop:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch_idx, result <span class="kw">in</span> <span class="bu">enumerate</span>(pool.imap_unordered(worker_wrapper, args_list), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... processar resultado</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    stop_event.<span class="bu">set</span>()</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üõë Interrup√ß√£o pelo utilizador no loop principal.&quot;</span>)</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="cf">finally</span>:</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... limpeza</span></span></code></pre></div>
<p>Agora, vamos escrever o c√≥digo completo com essas altera√ß√µes.</p>
<p>Vamos tamb√©m garantir que o sinal seja registrado apenas uma vez, no
in√≠cio do <code>main</code>.</p>
<p>Vamos ao c√≥digo: Aqui est√° a vers√£o melhorada com um sistema robusto
de interrup√ß√£o Ctrl+C:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">comb_pdf_direct6_html_based_optimized_live_benchmark.py</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co">Vers√£o final otimizada com:</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ Feedback em tempo real (PDFs gerados)</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ Interrup√ß√£o Ctrl+C IMEDIATA E CONFI√ÅVEL</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ Benchmark (tempo total + PDFs/minuto)</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ Fechamento autom√°tico de Chromium √≥rf√£os</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ Compat√≠vel com Windows/Linux/macOS</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ WORKERS=1 por padr√£o para maior estabilidade</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co">‚úÖ Sistema de interrup√ß√£o por sinal robusto</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> signal</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psutil</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Optional</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright, <span class="pp">TimeoutError</span> <span class="im">as</span> PlaywrightTimeoutError</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Gerenciamento global de estado para interrup√ß√£o</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProcessManager:</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Gerencia processos e permite interrup√ß√£o limpa&quot;&quot;&quot;</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>    _instance <span class="op">=</span> <span class="va">None</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>    _pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>    _stop_event <span class="op">=</span> <span class="va">None</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>    _active_processes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__new__</span>(cls):</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cls._instance <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>            cls._instance <span class="op">=</span> <span class="bu">super</span>(ProcessManager, cls).<span class="fu">__new__</span>(cls)</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> cls._instance</span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_pool(cls, pool):</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>        cls._pool <span class="op">=</span> pool</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> set_stop_event(cls, stop_event):</span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>        cls._stop_event <span class="op">=</span> stop_event</span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_process(cls, pid):</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>        cls._active_processes.add(pid)</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> remove_process(cls, pid):</span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>        cls._active_processes.discard(pid)</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> stop_all(cls):</span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Para todos os processos de forma agressiva mas controlada&quot;&quot;&quot;</span></span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">üõë Parando </span><span class="sc">{</span><span class="bu">len</span>(cls._active_processes)<span class="sc">}</span><span class="ss"> processos ativos...&quot;</span>)</span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. Sinalizar para parada graciosa</span></span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cls._stop_event:</span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a>            cls._stop_event.<span class="bu">set</span>()</span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-71"><a href="#cb34-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2. Terminar pool de processos</span></span>
<span id="cb34-72"><a href="#cb34-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cls._pool:</span>
<span id="cb34-73"><a href="#cb34-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb34-74"><a href="#cb34-74" aria-hidden="true" tabindex="-1"></a>                cls._pool.terminate()</span>
<span id="cb34-75"><a href="#cb34-75" aria-hidden="true" tabindex="-1"></a>                cls._pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb34-76"><a href="#cb34-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb34-77"><a href="#cb34-77" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb34-78"><a href="#cb34-78" aria-hidden="true" tabindex="-1"></a>                    cls._pool.close()</span>
<span id="cb34-79"><a href="#cb34-79" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span>:</span>
<span id="cb34-80"><a href="#cb34-80" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">pass</span></span>
<span id="cb34-81"><a href="#cb34-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-82"><a href="#cb34-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3. Matar processos filhos diretamente</span></span>
<span id="cb34-83"><a href="#cb34-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> pid <span class="kw">in</span> <span class="bu">list</span>(cls._active_processes):</span>
<span id="cb34-84"><a href="#cb34-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb34-85"><a href="#cb34-85" aria-hidden="true" tabindex="-1"></a>                process <span class="op">=</span> psutil.Process(pid)</span>
<span id="cb34-86"><a href="#cb34-86" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> child <span class="kw">in</span> process.children(recursive<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb34-87"><a href="#cb34-87" aria-hidden="true" tabindex="-1"></a>                    child.terminate()</span>
<span id="cb34-88"><a href="#cb34-88" aria-hidden="true" tabindex="-1"></a>                process.terminate()</span>
<span id="cb34-89"><a href="#cb34-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> (psutil.NoSuchProcess, <span class="pp">ProcessLookupError</span>):</span>
<span id="cb34-90"><a href="#cb34-90" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb34-91"><a href="#cb34-91" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-92"><a href="#cb34-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4. Limpeza final de processos √≥rf√£os</span></span>
<span id="cb34-93"><a href="#cb34-93" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb34-94"><a href="#cb34-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-95"><a href="#cb34-95" aria-hidden="true" tabindex="-1"></a>        cls._active_processes.clear()</span>
<span id="cb34-96"><a href="#cb34-96" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Todos os processos foram interrompidos&quot;</span>)</span>
<span id="cb34-97"><a href="#cb34-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-98"><a href="#cb34-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-99"><a href="#cb34-99" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-100"><a href="#cb34-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Fun√ß√µes utilit√°rias</span></span>
<span id="cb34-101"><a href="#cb34-101" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-102"><a href="#cb34-102" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kill_orphaned_chromium():</span>
<span id="cb34-103"><a href="#cb34-103" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Tenta encerrar processos Chromium √≥rf√£os (Windows/Linux/macOS).&quot;&quot;&quot;</span></span>
<span id="cb34-104"><a href="#cb34-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb34-105"><a href="#cb34-105" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Limpando processos Chromium √≥rf√£os...&quot;</span>)</span>
<span id="cb34-106"><a href="#cb34-106" aria-hidden="true" tabindex="-1"></a>        current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb34-107"><a href="#cb34-107" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-108"><a href="#cb34-108" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb34-109"><a href="#cb34-109" aria-hidden="true" tabindex="-1"></a>            <span class="co"># No Windows, busca processos espec√≠ficos excluindo o atual</span></span>
<span id="cb34-110"><a href="#cb34-110" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> proc <span class="kw">in</span> psutil.process_iter([<span class="st">&#39;pid&#39;</span>, <span class="st">&#39;name&#39;</span>]):</span>
<span id="cb34-111"><a href="#cb34-111" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb34-112"><a href="#cb34-112" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> proc.info[<span class="st">&#39;name&#39;</span>] <span class="kw">and</span> <span class="bu">any</span>(name <span class="kw">in</span> proc.info[<span class="st">&#39;name&#39;</span>].lower() </span>
<span id="cb34-113"><a href="#cb34-113" aria-hidden="true" tabindex="-1"></a>                                               <span class="cf">for</span> name <span class="kw">in</span> [<span class="st">&#39;chrome&#39;</span>, <span class="st">&#39;chromium&#39;</span>, <span class="st">&#39;msedge&#39;</span>]):</span>
<span id="cb34-114"><a href="#cb34-114" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> proc.info[<span class="st">&#39;pid&#39;</span>] <span class="op">!=</span> current_pid:</span>
<span id="cb34-115"><a href="#cb34-115" aria-hidden="true" tabindex="-1"></a>                            proc.terminate()</span>
<span id="cb34-116"><a href="#cb34-116" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> (psutil.NoSuchProcess, psutil.AccessDenied):</span>
<span id="cb34-117"><a href="#cb34-117" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">pass</span></span>
<span id="cb34-118"><a href="#cb34-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb34-119"><a href="#cb34-119" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Linux/macOS - usa pkill mas de forma mais espec√≠fica</span></span>
<span id="cb34-120"><a href="#cb34-120" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb34-121"><a href="#cb34-121" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL, timeout<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb34-122"><a href="#cb34-122" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chrome&quot;</span>], </span>
<span id="cb34-123"><a href="#cb34-123" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL, timeout<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb34-124"><a href="#cb34-124" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;playwright&quot;</span>], </span>
<span id="cb34-125"><a href="#cb34-125" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL, timeout<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb34-126"><a href="#cb34-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb34-127"><a href="#cb34-127" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è Aviso na limpeza: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-128"><a href="#cb34-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-129"><a href="#cb34-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-130"><a href="#cb34-130" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunkify(seq: List[<span class="bu">str</span>], size: <span class="bu">int</span>) <span class="op">-&gt;</span> List[List[<span class="bu">str</span>]]:</span>
<span id="cb34-131"><a href="#cb34-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [seq[i:i <span class="op">+</span> size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(seq), size)]</span>
<span id="cb34-132"><a href="#cb34-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-133"><a href="#cb34-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-134"><a href="#cb34-134" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_playwright_available(headless_test: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb34-135"><a href="#cb34-135" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o Playwright + Chromium est√£o instalados.&quot;&quot;&quot;</span></span>
<span id="cb34-136"><a href="#cb34-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb34-137"><a href="#cb34-137" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb34-138"><a href="#cb34-138" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(headless<span class="op">=</span>headless_test)</span>
<span id="cb34-139"><a href="#cb34-139" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb34-140"><a href="#cb34-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb34-141"><a href="#cb34-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb34-142"><a href="#cb34-142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb34-143"><a href="#cb34-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-144"><a href="#cb34-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-145"><a href="#cb34-145" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> robust_signal_handler(sig, frame):</span>
<span id="cb34-146"><a href="#cb34-146" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handler robusto para SIGINT (Ctrl+C)&quot;&quot;&quot;</span></span>
<span id="cb34-147"><a href="#cb34-147" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">üõë INTERRUP√á√ÉO RECEBIDA - Parando execu√ß√£o imediatamente...&quot;</span>)</span>
<span id="cb34-148"><a href="#cb34-148" aria-hidden="true" tabindex="-1"></a>    ProcessManager.stop_all()</span>
<span id="cb34-149"><a href="#cb34-149" aria-hidden="true" tabindex="-1"></a>    sys.exit(<span class="dv">1</span>)</span>
<span id="cb34-150"><a href="#cb34-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-151"><a href="#cb34-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-152"><a href="#cb34-152" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-153"><a href="#cb34-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Worker de processamento (um processo por batch)</span></span>
<span id="cb34-154"><a href="#cb34-154" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-155"><a href="#cb34-155" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_process_batch(batch_files, pdf_dir, timeout, headless, force_overwrite,</span>
<span id="cb34-156"><a href="#cb34-156" aria-hidden="true" tabindex="-1"></a>                         retry_count, stop_event, msg_queue):</span>
<span id="cb34-157"><a href="#cb34-157" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Worker que processa um batch de arquivos&quot;&quot;&quot;</span></span>
<span id="cb34-158"><a href="#cb34-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Registrar este processo</span></span>
<span id="cb34-159"><a href="#cb34-159" aria-hidden="true" tabindex="-1"></a>    current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb34-160"><a href="#cb34-160" aria-hidden="true" tabindex="-1"></a>    ProcessManager.add_process(current_pid)</span>
<span id="cb34-161"><a href="#cb34-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-162"><a href="#cb34-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb34-163"><a href="#cb34-163" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb34-164"><a href="#cb34-164" aria-hidden="true" tabindex="-1"></a>        out_dir <span class="op">=</span> Path(pdf_dir)</span>
<span id="cb34-165"><a href="#cb34-165" aria-hidden="true" tabindex="-1"></a>        out_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-166"><a href="#cb34-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-167"><a href="#cb34-167" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb34-168"><a href="#cb34-168" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(</span>
<span id="cb34-169"><a href="#cb34-169" aria-hidden="true" tabindex="-1"></a>                headless<span class="op">=</span>headless,</span>
<span id="cb34-170"><a href="#cb34-170" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>[</span>
<span id="cb34-171"><a href="#cb34-171" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-web-security&#39;</span>,</span>
<span id="cb34-172"><a href="#cb34-172" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-features=VizDisplayCompositor&#39;</span>,</span>
<span id="cb34-173"><a href="#cb34-173" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-background-timer-throttling&#39;</span>,</span>
<span id="cb34-174"><a href="#cb34-174" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-backgrounding-occluded-windows&#39;</span>,</span>
<span id="cb34-175"><a href="#cb34-175" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&#39;--disable-renderer-backgrounding&#39;</span></span>
<span id="cb34-176"><a href="#cb34-176" aria-hidden="true" tabindex="-1"></a>                ]</span>
<span id="cb34-177"><a href="#cb34-177" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb34-178"><a href="#cb34-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-179"><a href="#cb34-179" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_path_str <span class="kw">in</span> batch_files:</span>
<span id="cb34-180"><a href="#cb34-180" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Verificar se foi solicitado para parar</span></span>
<span id="cb34-181"><a href="#cb34-181" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event <span class="kw">and</span> stop_event.is_set():</span>
<span id="cb34-182"><a href="#cb34-182" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;info&quot;</span>, <span class="ss">f&quot;[worker </span><span class="sc">{</span>current_pid<span class="sc">}</span><span class="ss">] Parando por solicita√ß√£o...&quot;</span>))</span>
<span id="cb34-183"><a href="#cb34-183" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb34-184"><a href="#cb34-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-185"><a href="#cb34-185" aria-hidden="true" tabindex="-1"></a>                html_path <span class="op">=</span> Path(html_path_str)</span>
<span id="cb34-186"><a href="#cb34-186" aria-hidden="true" tabindex="-1"></a>                pdf_path <span class="op">=</span> out_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb34-187"><a href="#cb34-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-188"><a href="#cb34-188" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> pdf_path.exists() <span class="kw">and</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb34-189"><a href="#cb34-189" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;J√° existe (pulado)&quot;</span>))</span>
<span id="cb34-190"><a href="#cb34-190" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;skip&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> (j√° existe)&quot;</span>))</span>
<span id="cb34-191"><a href="#cb34-191" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb34-192"><a href="#cb34-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-193"><a href="#cb34-193" aria-hidden="true" tabindex="-1"></a>                success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb34-194"><a href="#cb34-194" aria-hidden="true" tabindex="-1"></a>                last_message <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb34-195"><a href="#cb34-195" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, retry_count <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb34-196"><a href="#cb34-196" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> stop_event <span class="kw">and</span> stop_event.is_set():</span>
<span id="cb34-197"><a href="#cb34-197" aria-hidden="true" tabindex="-1"></a>                        last_message <span class="op">=</span> <span class="st">&quot;Parado pelo utilizador&quot;</span></span>
<span id="cb34-198"><a href="#cb34-198" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb34-199"><a href="#cb34-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-200"><a href="#cb34-200" aria-hidden="true" tabindex="-1"></a>                    context <span class="op">=</span> <span class="va">None</span></span>
<span id="cb34-201"><a href="#cb34-201" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb34-202"><a href="#cb34-202" aria-hidden="true" tabindex="-1"></a>                        context <span class="op">=</span> browser.new_context(</span>
<span id="cb34-203"><a href="#cb34-203" aria-hidden="true" tabindex="-1"></a>                            viewport<span class="op">=</span>{<span class="st">&#39;width&#39;</span>: <span class="dv">1920</span>, <span class="st">&#39;height&#39;</span>: <span class="dv">1080</span>},</span>
<span id="cb34-204"><a href="#cb34-204" aria-hidden="true" tabindex="-1"></a>                            ignore_https_errors<span class="op">=</span><span class="va">True</span></span>
<span id="cb34-205"><a href="#cb34-205" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb34-206"><a href="#cb34-206" aria-hidden="true" tabindex="-1"></a>                        page <span class="op">=</span> context.new_page()</span>
<span id="cb34-207"><a href="#cb34-207" aria-hidden="true" tabindex="-1"></a>                        page.set_default_timeout(<span class="bu">int</span>(timeout <span class="op">*</span> <span class="dv">1000</span>))</span>
<span id="cb34-208"><a href="#cb34-208" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb34-209"><a href="#cb34-209" aria-hidden="true" tabindex="-1"></a>                        full_path <span class="op">=</span> <span class="ss">f&quot;file:///</span><span class="sc">{</span>html_path<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb34-210"><a href="#cb34-210" aria-hidden="true" tabindex="-1"></a>                        page.goto(full_path, wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>, timeout<span class="op">=</span><span class="bu">int</span>(timeout <span class="op">*</span> <span class="dv">1000</span>))</span>
<span id="cb34-211"><a href="#cb34-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-212"><a href="#cb34-212" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Espera adicional opcional</span></span>
<span id="cb34-213"><a href="#cb34-213" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">try</span>:</span>
<span id="cb34-214"><a href="#cb34-214" aria-hidden="true" tabindex="-1"></a>                            page.wait_for_load_state(<span class="st">&#39;load&#39;</span>, timeout<span class="op">=</span><span class="bu">int</span>(<span class="fl">0.5</span> <span class="op">*</span> timeout <span class="op">*</span> <span class="dv">1000</span>))</span>
<span id="cb34-215"><a href="#cb34-215" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb34-216"><a href="#cb34-216" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">pass</span></span>
<span id="cb34-217"><a href="#cb34-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-218"><a href="#cb34-218" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Gerar PDF</span></span>
<span id="cb34-219"><a href="#cb34-219" aria-hidden="true" tabindex="-1"></a>                        page.pdf(</span>
<span id="cb34-220"><a href="#cb34-220" aria-hidden="true" tabindex="-1"></a>                            path<span class="op">=</span><span class="bu">str</span>(pdf_path),</span>
<span id="cb34-221"><a href="#cb34-221" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>,</span>
<span id="cb34-222"><a href="#cb34-222" aria-hidden="true" tabindex="-1"></a>                            print_background<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb34-223"><a href="#cb34-223" aria-hidden="true" tabindex="-1"></a>                            margin<span class="op">=</span>{<span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span>},</span>
<span id="cb34-224"><a href="#cb34-224" aria-hidden="true" tabindex="-1"></a>                            prefer_css_page_size<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb34-225"><a href="#cb34-225" aria-hidden="true" tabindex="-1"></a>                            display_header_footer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb34-226"><a href="#cb34-226" aria-hidden="true" tabindex="-1"></a>                            scale<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb34-227"><a href="#cb34-227" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb34-228"><a href="#cb34-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-229"><a href="#cb34-229" aria-hidden="true" tabindex="-1"></a>                        context.close()</span>
<span id="cb34-230"><a href="#cb34-230" aria-hidden="true" tabindex="-1"></a>                        success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb34-231"><a href="#cb34-231" aria-hidden="true" tabindex="-1"></a>                        last_message <span class="op">=</span> <span class="st">&quot;Sucesso&quot;</span></span>
<span id="cb34-232"><a href="#cb34-232" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;ok&quot;</span>, pdf_path.name))</span>
<span id="cb34-233"><a href="#cb34-233" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb34-234"><a href="#cb34-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-235"><a href="#cb34-235" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> PlaywrightTimeoutError <span class="im">as</span> e:</span>
<span id="cb34-236"><a href="#cb34-236" aria-hidden="true" tabindex="-1"></a>                        last_message <span class="op">=</span> <span class="ss">f&quot;Timeout (</span><span class="sc">{</span>attempt<span class="sc">}</span><span class="ss">)&quot;</span></span>
<span id="cb34-237"><a href="#cb34-237" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;warn&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>last_message<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb34-238"><a href="#cb34-238" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb34-239"><a href="#cb34-239" aria-hidden="true" tabindex="-1"></a>                        last_message <span class="op">=</span> <span class="ss">f&quot;Erro (</span><span class="sc">{</span>attempt<span class="sc">}</span><span class="ss">): </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb34-240"><a href="#cb34-240" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;warn&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>last_message<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb34-241"><a href="#cb34-241" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">finally</span>:</span>
<span id="cb34-242"><a href="#cb34-242" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> context:</span>
<span id="cb34-243"><a href="#cb34-243" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">try</span>:</span>
<span id="cb34-244"><a href="#cb34-244" aria-hidden="true" tabindex="-1"></a>                                context.close()</span>
<span id="cb34-245"><a href="#cb34-245" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb34-246"><a href="#cb34-246" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">pass</span></span>
<span id="cb34-247"><a href="#cb34-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-248"><a href="#cb34-248" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Espera entre tentativas</span></span>
<span id="cb34-249"><a href="#cb34-249" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="kw">and</span> <span class="kw">not</span> (stop_event <span class="kw">and</span> stop_event.is_set()):</span>
<span id="cb34-250"><a href="#cb34-250" aria-hidden="true" tabindex="-1"></a>                        time.sleep(<span class="dv">1</span>)</span>
<span id="cb34-251"><a href="#cb34-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-252"><a href="#cb34-252" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> success:</span>
<span id="cb34-253"><a href="#cb34-253" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;fail&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>last_message<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb34-254"><a href="#cb34-254" aria-hidden="true" tabindex="-1"></a>                results.append((html_path_str, success, last_message))</span>
<span id="cb34-255"><a href="#cb34-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-256"><a href="#cb34-256" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb34-257"><a href="#cb34-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-258"><a href="#cb34-258" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb34-259"><a href="#cb34-259" aria-hidden="true" tabindex="-1"></a>        msg_queue.put((<span class="st">&quot;error&quot;</span>, <span class="ss">f&quot;Erro no worker </span><span class="sc">{</span>current_pid<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb34-260"><a href="#cb34-260" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> html_path_str <span class="kw">in</span> batch_files:</span>
<span id="cb34-261"><a href="#cb34-261" aria-hidden="true" tabindex="-1"></a>            results.append((html_path_str, <span class="va">False</span>, <span class="ss">f&quot;Erro processo: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb34-262"><a href="#cb34-262" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb34-263"><a href="#cb34-263" aria-hidden="true" tabindex="-1"></a>        ProcessManager.remove_process(current_pid)</span>
<span id="cb34-264"><a href="#cb34-264" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-265"><a href="#cb34-265" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb34-266"><a href="#cb34-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-267"><a href="#cb34-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-268"><a href="#cb34-268" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_wrapper(args):</span>
<span id="cb34-269"><a href="#cb34-269" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Wrapper para o worker que captura exce√ß√µes&quot;&quot;&quot;</span></span>
<span id="cb34-270"><a href="#cb34-270" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb34-271"><a href="#cb34-271" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> worker_process_batch(<span class="op">*</span>args)</span>
<span id="cb34-272"><a href="#cb34-272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb34-273"><a href="#cb34-273" aria-hidden="true" tabindex="-1"></a>        current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb34-274"><a href="#cb34-274" aria-hidden="true" tabindex="-1"></a>        ProcessManager.remove_process(current_pid)</span>
<span id="cb34-275"><a href="#cb34-275" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> e</span>
<span id="cb34-276"><a href="#cb34-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-277"><a href="#cb34-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-278"><a href="#cb34-278" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-279"><a href="#cb34-279" aria-hidden="true" tabindex="-1"></a><span class="co"># Listener de mensagens (impress√£o em tempo real)</span></span>
<span id="cb34-280"><a href="#cb34-280" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-281"><a href="#cb34-281" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> queue_listener(msg_queue, stop_event, listener_stop_flag):</span>
<span id="cb34-282"><a href="#cb34-282" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Escuta mensagens dos workers e imprime em tempo real&quot;&quot;&quot;</span></span>
<span id="cb34-283"><a href="#cb34-283" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> listener_stop_flag.is_set():</span>
<span id="cb34-284"><a href="#cb34-284" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb34-285"><a href="#cb34-285" aria-hidden="true" tabindex="-1"></a>            obj <span class="op">=</span> msg_queue.get(timeout<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb34-286"><a href="#cb34-286" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb34-287"><a href="#cb34-287" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb34-288"><a href="#cb34-288" aria-hidden="true" tabindex="-1"></a>            typ, text <span class="op">=</span> obj</span>
<span id="cb34-289"><a href="#cb34-289" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> typ <span class="op">==</span> <span class="st">&quot;ok&quot;</span>:</span>
<span id="cb34-290"><a href="#cb34-290" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-291"><a href="#cb34-291" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;skip&quot;</span>:</span>
<span id="cb34-292"><a href="#cb34-292" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚è≠Ô∏è </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-293"><a href="#cb34-293" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;warn&quot;</span>:</span>
<span id="cb34-294"><a href="#cb34-294" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-295"><a href="#cb34-295" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;fail&quot;</span>:</span>
<span id="cb34-296"><a href="#cb34-296" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚ùå </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-297"><a href="#cb34-297" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;error&quot;</span>:</span>
<span id="cb34-298"><a href="#cb34-298" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üö´ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-299"><a href="#cb34-299" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;info&quot;</span>:</span>
<span id="cb34-300"><a href="#cb34-300" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚ÑπÔ∏è </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-301"><a href="#cb34-301" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb34-302"><a href="#cb34-302" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(text)</span>
<span id="cb34-303"><a href="#cb34-303" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb34-304"><a href="#cb34-304" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb34-305"><a href="#cb34-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-306"><a href="#cb34-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-307"><a href="#cb34-307" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-308"><a href="#cb34-308" aria-hidden="true" tabindex="-1"></a><span class="co"># Convers√£o principal (com benchmark e interrup√ß√£o segura)</span></span>
<span id="cb34-309"><a href="#cb34-309" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-310"><a href="#cb34-310" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_pdfs_live(source_dir, output_dir, workers, batch_size, headless, timeout,</span>
<span id="cb34-311"><a href="#cb34-311" aria-hidden="true" tabindex="-1"></a>                       force_overwrite, dry_run, single_file<span class="op">=</span><span class="va">None</span>, retry_count<span class="op">=</span><span class="dv">2</span>, benchmark<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb34-312"><a href="#cb34-312" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Fun√ß√£o principal de convers√£o com interrup√ß√£o robusta&quot;&quot;&quot;</span></span>
<span id="cb34-313"><a href="#cb34-313" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-314"><a href="#cb34-314" aria-hidden="true" tabindex="-1"></a>    src <span class="op">=</span> Path(source_dir)</span>
<span id="cb34-315"><a href="#cb34-315" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> Path(output_dir)</span>
<span id="cb34-316"><a href="#cb34-316" aria-hidden="true" tabindex="-1"></a>    out.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-317"><a href="#cb34-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-318"><a href="#cb34-318" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> single_file:</span>
<span id="cb34-319"><a href="#cb34-319" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [<span class="bu">str</span>(src <span class="op">/</span> single_file)]</span>
<span id="cb34-320"><a href="#cb34-320" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> Path(html_files[<span class="dv">0</span>]).exists():</span>
<span id="cb34-321"><a href="#cb34-321" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Arquivo n√£o encontrado: </span><span class="sc">{</span>single_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-322"><a href="#cb34-322" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb34-323"><a href="#cb34-323" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb34-324"><a href="#cb34-324" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> <span class="bu">sorted</span>([<span class="bu">str</span>(p) <span class="cf">for</span> p <span class="kw">in</span> src.glob(<span class="st">&quot;*.html&quot;</span>)])</span>
<span id="cb34-325"><a href="#cb34-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-326"><a href="#cb34-326" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb34-327"><a href="#cb34-327" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Nenhum arquivo HTML encontrado.&quot;</span>)</span>
<span id="cb34-328"><a href="#cb34-328" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb34-329"><a href="#cb34-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-330"><a href="#cb34-330" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üéØ Encontrados </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos HTML&quot;</span>)</span>
<span id="cb34-331"><a href="#cb34-331" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>workers<span class="sc">}</span><span class="ss"> ; Batch size: </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> ; Timeout: </span><span class="sc">{</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb34-332"><a href="#cb34-332" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîÅ Modo: </span><span class="sc">{</span><span class="st">&#39;force&#39;</span> <span class="cf">if</span> force_overwrite <span class="cf">else</span> <span class="st">&#39;only_new&#39;</span> <span class="cf">if</span> <span class="kw">not</span> dry_run <span class="cf">else</span> <span class="st">&#39;dry_run&#39;</span><span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-333"><a href="#cb34-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-334"><a href="#cb34-334" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dry_run:</span>
<span id="cb34-335"><a href="#cb34-335" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ Modo dry-run ativo. Nenhum arquivo ser√° criado.&quot;</span>)</span>
<span id="cb34-336"><a href="#cb34-336" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> html_file <span class="kw">in</span> html_files:</span>
<span id="cb34-337"><a href="#cb34-337" aria-hidden="true" tabindex="-1"></a>            pdf_file <span class="op">=</span> out <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>Path(html_file)<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb34-338"><a href="#cb34-338" aria-hidden="true" tabindex="-1"></a>            exists <span class="op">=</span> pdf_file.exists()</span>
<span id="cb34-339"><a href="#cb34-339" aria-hidden="true" tabindex="-1"></a>            status <span class="op">=</span> <span class="st">&quot;EXISTE&quot;</span> <span class="cf">if</span> exists <span class="cf">else</span> <span class="st">&quot;NOVO&quot;</span></span>
<span id="cb34-340"><a href="#cb34-340" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   üìÑ </span><span class="sc">{</span>Path(html_file)<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> ‚Üí </span><span class="sc">{</span>pdf_file<span class="sc">.</span>name<span class="sc">}</span><span class="ss"> [</span><span class="sc">{</span>status<span class="sc">}</span><span class="ss">]&quot;</span>)</span>
<span id="cb34-341"><a href="#cb34-341" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb34-342"><a href="#cb34-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-343"><a href="#cb34-343" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb34-344"><a href="#cb34-344" aria-hidden="true" tabindex="-1"></a>        original_count <span class="op">=</span> <span class="bu">len</span>(html_files)</span>
<span id="cb34-345"><a href="#cb34-345" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> html_files <span class="cf">if</span> <span class="kw">not</span> (out <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>Path(f)<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span>).exists()]</span>
<span id="cb34-346"><a href="#cb34-346" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üÜï </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos novos restantes (de </span><span class="sc">{</span>original_count<span class="sc">}</span><span class="ss"> total)&quot;</span>)</span>
<span id="cb34-347"><a href="#cb34-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-348"><a href="#cb34-348" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb34-349"><a href="#cb34-349" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Nenhum arquivo novo para processar.&quot;</span>)</span>
<span id="cb34-350"><a href="#cb34-350" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb34-351"><a href="#cb34-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-352"><a href="#cb34-352" aria-hidden="true" tabindex="-1"></a>    batches <span class="op">=</span> chunkify(html_files, batch_size)</span>
<span id="cb34-353"><a href="#cb34-353" aria-hidden="true" tabindex="-1"></a>    total_batches <span class="op">=</span> <span class="bu">len</span>(batches)</span>
<span id="cb34-354"><a href="#cb34-354" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üì¶ Preparados </span><span class="sc">{</span>total_batches<span class="sc">}</span><span class="ss"> batches (~</span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> arquivos cada)&quot;</span>)</span>
<span id="cb34-355"><a href="#cb34-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-356"><a href="#cb34-356" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configurar sistema de interrup√ß√£o</span></span>
<span id="cb34-357"><a href="#cb34-357" aria-hidden="true" tabindex="-1"></a>    manager <span class="op">=</span> multiprocessing.Manager()</span>
<span id="cb34-358"><a href="#cb34-358" aria-hidden="true" tabindex="-1"></a>    stop_event <span class="op">=</span> manager.Event()</span>
<span id="cb34-359"><a href="#cb34-359" aria-hidden="true" tabindex="-1"></a>    ProcessManager.set_stop_event(stop_event)</span>
<span id="cb34-360"><a href="#cb34-360" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-361"><a href="#cb34-361" aria-hidden="true" tabindex="-1"></a>    msg_queue <span class="op">=</span> manager.Queue()</span>
<span id="cb34-362"><a href="#cb34-362" aria-hidden="true" tabindex="-1"></a>    listener_stop_flag <span class="op">=</span> threading.Event()</span>
<span id="cb34-363"><a href="#cb34-363" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-364"><a href="#cb34-364" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iniciar listener em thread separada</span></span>
<span id="cb34-365"><a href="#cb34-365" aria-hidden="true" tabindex="-1"></a>    listener_thread <span class="op">=</span> threading.Thread(</span>
<span id="cb34-366"><a href="#cb34-366" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>queue_listener, </span>
<span id="cb34-367"><a href="#cb34-367" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(msg_queue, stop_event, listener_stop_flag), </span>
<span id="cb34-368"><a href="#cb34-368" aria-hidden="true" tabindex="-1"></a>        daemon<span class="op">=</span><span class="va">True</span></span>
<span id="cb34-369"><a href="#cb34-369" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-370"><a href="#cb34-370" aria-hidden="true" tabindex="-1"></a>    listener_thread.start()</span>
<span id="cb34-371"><a href="#cb34-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-372"><a href="#cb34-372" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparar argumentos para workers</span></span>
<span id="cb34-373"><a href="#cb34-373" aria-hidden="true" tabindex="-1"></a>    args_list <span class="op">=</span> [</span>
<span id="cb34-374"><a href="#cb34-374" aria-hidden="true" tabindex="-1"></a>        (batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, stop_event, msg_queue) </span>
<span id="cb34-375"><a href="#cb34-375" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> batches</span>
<span id="cb34-376"><a href="#cb34-376" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb34-377"><a href="#cb34-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-378"><a href="#cb34-378" aria-hidden="true" tabindex="-1"></a>    success_count, failed <span class="op">=</span> <span class="dv">0</span>, []</span>
<span id="cb34-379"><a href="#cb34-379" aria-hidden="true" tabindex="-1"></a>    pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb34-380"><a href="#cb34-380" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb34-381"><a href="#cb34-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-382"><a href="#cb34-382" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb34-383"><a href="#cb34-383" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Criar pool de processos</span></span>
<span id="cb34-384"><a href="#cb34-384" aria-hidden="true" tabindex="-1"></a>        pool <span class="op">=</span> multiprocessing.Pool(processes<span class="op">=</span>workers)</span>
<span id="cb34-385"><a href="#cb34-385" aria-hidden="true" tabindex="-1"></a>        ProcessManager.set_pool(pool)</span>
<span id="cb34-386"><a href="#cb34-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-387"><a href="#cb34-387" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üîÑ Iniciando convers√£o... Pressione Ctrl+C para interromper a qualquer momento.&quot;</span>)</span>
<span id="cb34-388"><a href="#cb34-388" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-389"><a href="#cb34-389" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Processar batches</span></span>
<span id="cb34-390"><a href="#cb34-390" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch_idx, result <span class="kw">in</span> <span class="bu">enumerate</span>(pool.imap_unordered(worker_wrapper, args_list), start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb34-391"><a href="#cb34-391" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb34-392"><a href="#cb34-392" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üõë Parada solicitada durante processamento...&quot;</span>)</span>
<span id="cb34-393"><a href="#cb34-393" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb34-394"><a href="#cb34-394" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb34-395"><a href="#cb34-395" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üì¶ Batch </span><span class="sc">{</span>batch_idx<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>total_batches<span class="sc">}</span><span class="ss"> conclu√≠do (</span><span class="sc">{</span><span class="bu">len</span>(result)<span class="sc">}</span><span class="ss"> arquivos)&quot;</span>)</span>
<span id="cb34-396"><a href="#cb34-396" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb34-397"><a href="#cb34-397" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Processar resultados do batch</span></span>
<span id="cb34-398"><a href="#cb34-398" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_file, success, msg <span class="kw">in</span> result:</span>
<span id="cb34-399"><a href="#cb34-399" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> success:</span>
<span id="cb34-400"><a href="#cb34-400" aria-hidden="true" tabindex="-1"></a>                    success_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb34-401"><a href="#cb34-401" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb34-402"><a href="#cb34-402" aria-hidden="true" tabindex="-1"></a>                    failed.append((Path(html_file).name, msg))</span>
<span id="cb34-403"><a href="#cb34-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-404"><a href="#cb34-404" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb34-405"><a href="#cb34-405" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o pelo utilizador detectada no loop principal...&quot;</span>)</span>
<span id="cb34-406"><a href="#cb34-406" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb34-407"><a href="#cb34-407" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb34-408"><a href="#cb34-408" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üö´ Erro inesperado: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-409"><a href="#cb34-409" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb34-410"><a href="#cb34-410" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb34-411"><a href="#cb34-411" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final</span></span>
<span id="cb34-412"><a href="#cb34-412" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Finalizando processos e fazendo limpeza...&quot;</span>)</span>
<span id="cb34-413"><a href="#cb34-413" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-414"><a href="#cb34-414" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parar listener</span></span>
<span id="cb34-415"><a href="#cb34-415" aria-hidden="true" tabindex="-1"></a>        listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb34-416"><a href="#cb34-416" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb34-417"><a href="#cb34-417" aria-hidden="true" tabindex="-1"></a>            msg_queue.put(<span class="va">None</span>)</span>
<span id="cb34-418"><a href="#cb34-418" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb34-419"><a href="#cb34-419" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb34-420"><a href="#cb34-420" aria-hidden="true" tabindex="-1"></a>        listener_thread.join(timeout<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb34-421"><a href="#cb34-421" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-422"><a href="#cb34-422" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Terminar pool</span></span>
<span id="cb34-423"><a href="#cb34-423" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pool:</span>
<span id="cb34-424"><a href="#cb34-424" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb34-425"><a href="#cb34-425" aria-hidden="true" tabindex="-1"></a>                pool.close()</span>
<span id="cb34-426"><a href="#cb34-426" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb34-427"><a href="#cb34-427" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb34-428"><a href="#cb34-428" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb34-429"><a href="#cb34-429" aria-hidden="true" tabindex="-1"></a>                pool.terminate()</span>
<span id="cb34-430"><a href="#cb34-430" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb34-431"><a href="#cb34-431" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb34-432"><a href="#cb34-432" aria-hidden="true" tabindex="-1"></a>            pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb34-433"><a href="#cb34-433" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb34-434"><a href="#cb34-434" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final de processos</span></span>
<span id="cb34-435"><a href="#cb34-435" aria-hidden="true" tabindex="-1"></a>        ProcessManager.stop_all()</span>
<span id="cb34-436"><a href="#cb34-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-437"><a href="#cb34-437" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Relat√≥rio final</span></span>
<span id="cb34-438"><a href="#cb34-438" aria-hidden="true" tabindex="-1"></a>    elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb34-439"><a href="#cb34-439" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;=&quot;</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb34-440"><a href="#cb34-440" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üìä RELAT√ìRIO FINAL:&quot;</span>)</span>
<span id="cb34-441"><a href="#cb34-441" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot; ‚úÖ Sucessos: </span><span class="sc">{</span>success_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-442"><a href="#cb34-442" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot; ‚ùå Falhas: </span><span class="sc">{</span><span class="bu">len</span>(failed)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-443"><a href="#cb34-443" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-444"><a href="#cb34-444" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> failed:</span>
<span id="cb34-445"><a href="#cb34-445" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot; üìã Arquivos com problemas (</span><span class="sc">{</span><span class="bu">min</span>(<span class="dv">5</span>, <span class="bu">len</span>(failed))<span class="sc">}</span><span class="ss"> primeiros):&quot;</span>)</span>
<span id="cb34-446"><a href="#cb34-446" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> failed_file, reason <span class="kw">in</span> failed[:<span class="dv">5</span>]:</span>
<span id="cb34-447"><a href="#cb34-447" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   - </span><span class="sc">{</span>failed_file<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>reason<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-448"><a href="#cb34-448" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(failed) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb34-449"><a href="#cb34-449" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;   ... e mais </span><span class="sc">{</span><span class="bu">len</span>(failed) <span class="op">-</span> <span class="dv">5</span><span class="sc">}</span><span class="ss"> arquivos&quot;</span>)</span>
<span id="cb34-450"><a href="#cb34-450" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-451"><a href="#cb34-451" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> benchmark <span class="kw">and</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb34-452"><a href="#cb34-452" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">=</span> success_count <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb34-453"><a href="#cb34-453" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚è±Ô∏è  Tempo total: </span><span class="sc">{</span>elapsed<span class="sc">:.1f}</span><span class="ss">s  ‚Üí  </span><span class="sc">{</span>rate<span class="sc">:.1f}</span><span class="ss"> PDFs/minuto&quot;</span>)</span>
<span id="cb34-454"><a href="#cb34-454" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-455"><a href="#cb34-455" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">or</span> <span class="bu">len</span>(html_files) <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb34-456"><a href="#cb34-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-457"><a href="#cb34-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-458"><a href="#cb34-458" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-459"><a href="#cb34-459" aria-hidden="true" tabindex="-1"></a><span class="co"># CLI</span></span>
<span id="cb34-460"><a href="#cb34-460" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-461"><a href="#cb34-461" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args():</span>
<span id="cb34-462"><a href="#cb34-462" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(</span>
<span id="cb34-463"><a href="#cb34-463" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">&quot;Convers√£o HTML ‚Üí PDF (Playwright otimizado com interrup√ß√£o robusta)&quot;</span></span>
<span id="cb34-464"><a href="#cb34-464" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-465"><a href="#cb34-465" aria-hidden="true" tabindex="-1"></a>    group <span class="op">=</span> parser.add_mutually_exclusive_group()</span>
<span id="cb34-466"><a href="#cb34-466" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--force&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Sobrescreve PDFs j√° existentes&quot;</span>)</span>
<span id="cb34-467"><a href="#cb34-467" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--only-new&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, default<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Apenas novos (padr√£o)&quot;</span>)</span>
<span id="cb34-468"><a href="#cb34-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-469"><a href="#cb34-469" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--dry-run&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Simula sem criar arquivos&quot;</span>)</span>
<span id="cb34-470"><a href="#cb34-470" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--source&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_html&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta com arquivos .html&quot;</span>)</span>
<span id="cb34-471"><a href="#cb34-471" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--output&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_pdfs&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta de sa√≠da para PDFs&quot;</span>)</span>
<span id="cb34-472"><a href="#cb34-472" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb34-473"><a href="#cb34-473" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos (padr√£o: 1 para maior estabilidade)&quot;</span>)</span>
<span id="cb34-474"><a href="#cb34-474" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--batch-size&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">5</span>, </span>
<span id="cb34-475"><a href="#cb34-475" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Arquivos por batch (padr√£o: 5 para melhor responsividade)&quot;</span>)</span>
<span id="cb34-476"><a href="#cb34-476" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--no-headless&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra navegador (debug)&quot;</span>)</span>
<span id="cb34-477"><a href="#cb34-477" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--single-file&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Converte apenas um arquivo HTML espec√≠fico&quot;</span>)</span>
<span id="cb34-478"><a href="#cb34-478" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--timeout&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">60</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Timeout por p√°gina (segundos)&quot;</span>)</span>
<span id="cb34-479"><a href="#cb34-479" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--retry-count&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">2</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Tentativas por arquivo (padr√£o: 2)&quot;</span>)</span>
<span id="cb34-480"><a href="#cb34-480" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--benchmark&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra tempo total e PDFs/minuto&quot;</span>)</span>
<span id="cb34-481"><a href="#cb34-481" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parser.parse_args()</span>
<span id="cb34-482"><a href="#cb34-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-483"><a href="#cb34-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-484"><a href="#cb34-484" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-485"><a href="#cb34-485" aria-hidden="true" tabindex="-1"></a><span class="co"># Main</span></span>
<span id="cb34-486"><a href="#cb34-486" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb34-487"><a href="#cb34-487" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb34-488"><a href="#cb34-488" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configurar handler robusto para Ctrl+C</span></span>
<span id="cb34-489"><a href="#cb34-489" aria-hidden="true" tabindex="-1"></a>    signal.signal(signal.SIGINT, robust_signal_handler)</span>
<span id="cb34-490"><a href="#cb34-490" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-491"><a href="#cb34-491" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args()</span>
<span id="cb34-492"><a href="#cb34-492" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-493"><a href="#cb34-493" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üöÄ PDF GENERATOR - HTML BASED (PLAYWRIGHT)&quot;</span>)</span>
<span id="cb34-494"><a href="#cb34-494" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üîß INTERRUP√á√ÉO ROBUSTA - Ctrl+C para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb34-495"><a href="#cb34-495" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;=&quot;</span> <span class="op">*</span> <span class="dv">65</span>)</span>
<span id="cb34-496"><a href="#cb34-496" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üë• Workers: </span><span class="sc">{</span>args<span class="sc">.</span>workers<span class="sc">}</span><span class="ss"> (padr√£o: 1 para maior estabilidade)&quot;</span>)</span>
<span id="cb34-497"><a href="#cb34-497" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üì¶ Batch size: </span><span class="sc">{</span>args<span class="sc">.</span>batch_size<span class="sc">}</span><span class="ss"> (para melhor responsividade)&quot;</span>)</span>
<span id="cb34-498"><a href="#cb34-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-499"><a href="#cb34-499" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza inicial</span></span>
<span id="cb34-500"><a href="#cb34-500" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb34-501"><a href="#cb34-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-502"><a href="#cb34-502" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verificar diret√≥rio de origem</span></span>
<span id="cb34-503"><a href="#cb34-503" aria-hidden="true" tabindex="-1"></a>    source_dir <span class="op">=</span> Path(args.source)</span>
<span id="cb34-504"><a href="#cb34-504" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> source_dir.exists():</span>
<span id="cb34-505"><a href="#cb34-505" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Pasta de origem n√£o encontrada: </span><span class="sc">{</span>source_dir<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-506"><a href="#cb34-506" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb34-507"><a href="#cb34-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-508"><a href="#cb34-508" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verificar Playwright</span></span>
<span id="cb34-509"><a href="#cb34-509" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_playwright_available(headless_test<span class="op">=</span><span class="kw">not</span> args.no_headless):</span>
<span id="cb34-510"><a href="#cb34-510" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Playwright n√£o dispon√≠vel. Instale:&quot;</span>)</span>
<span id="cb34-511"><a href="#cb34-511" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   pip install playwright psutil&quot;</span>)</span>
<span id="cb34-512"><a href="#cb34-512" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   playwright install chromium&quot;</span>)</span>
<span id="cb34-513"><a href="#cb34-513" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb34-514"><a href="#cb34-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-515"><a href="#cb34-515" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Executar convers√£o</span></span>
<span id="cb34-516"><a href="#cb34-516" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> generate_pdfs_live(</span>
<span id="cb34-517"><a href="#cb34-517" aria-hidden="true" tabindex="-1"></a>        source_dir<span class="op">=</span><span class="bu">str</span>(args.source),</span>
<span id="cb34-518"><a href="#cb34-518" aria-hidden="true" tabindex="-1"></a>        output_dir<span class="op">=</span><span class="bu">str</span>(args.output),</span>
<span id="cb34-519"><a href="#cb34-519" aria-hidden="true" tabindex="-1"></a>        workers<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.workers),</span>
<span id="cb34-520"><a href="#cb34-520" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.batch_size),</span>
<span id="cb34-521"><a href="#cb34-521" aria-hidden="true" tabindex="-1"></a>        headless<span class="op">=</span><span class="kw">not</span> args.no_headless,</span>
<span id="cb34-522"><a href="#cb34-522" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span><span class="bu">max</span>(<span class="dv">10</span>, args.timeout),</span>
<span id="cb34-523"><a href="#cb34-523" aria-hidden="true" tabindex="-1"></a>        force_overwrite<span class="op">=</span>args.force,</span>
<span id="cb34-524"><a href="#cb34-524" aria-hidden="true" tabindex="-1"></a>        dry_run<span class="op">=</span>args.dry_run,</span>
<span id="cb34-525"><a href="#cb34-525" aria-hidden="true" tabindex="-1"></a>        single_file<span class="op">=</span>args.single_file,</span>
<span id="cb34-526"><a href="#cb34-526" aria-hidden="true" tabindex="-1"></a>        retry_count<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.retry_count),</span>
<span id="cb34-527"><a href="#cb34-527" aria-hidden="true" tabindex="-1"></a>        benchmark<span class="op">=</span>args.benchmark</span>
<span id="cb34-528"><a href="#cb34-528" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-529"><a href="#cb34-529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-530"><a href="#cb34-530" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resultado final</span></span>
<span id="cb34-531"><a href="#cb34-531" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb34-532"><a href="#cb34-532" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ SIMULA√á√ÉO CONCLU√çDA - Nenhum arquivo foi criado&quot;</span>)</span>
<span id="cb34-533"><a href="#cb34-533" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">0</span>)</span>
<span id="cb34-534"><a href="#cb34-534" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> success:</span>
<span id="cb34-535"><a href="#cb34-535" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üéâ CONVERS√ÉO CONCLU√çDA COM SUCESSO!&quot;</span>)</span>
<span id="cb34-536"><a href="#cb34-536" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üìÅ PDFs salvos em: </span><span class="sc">{</span>Path(args.output)<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-537"><a href="#cb34-537" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">0</span>)</span>
<span id="cb34-538"><a href="#cb34-538" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb34-539"><a href="#cb34-539" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è CONVERS√ÉO PARCIAL OU INTERROMPIDA&quot;</span>)</span>
<span id="cb34-540"><a href="#cb34-540" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb34-541"><a href="#cb34-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-542"><a href="#cb34-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-543"><a href="#cb34-543" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb34-544"><a href="#cb34-544" aria-hidden="true" tabindex="-1"></a>    multiprocessing.freeze_support()</span>
<span id="cb34-545"><a href="#cb34-545" aria-hidden="true" tabindex="-1"></a>    main()</span></code></pre></div>
<h2 data-number="1.15" id="principais-melhorias-na-interrup√ß√£o-ctrlc"><span class="header-section-number">1.15</span> üöÄ <strong>Principais
Melhorias na Interrup√ß√£o Ctrl+C:</strong></h2>
<h3 data-number="1.15.1" id="sistema-de-gerenciamento-de-processos-robusto"><span class="header-section-number">1.15.1</span> <strong>1. Sistema de
Gerenciamento de Processos Robusto</strong></h3>
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProcessManager:</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Gerencia processos e permite interrup√ß√£o limpa&quot;&quot;&quot;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> stop_all(cls):</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Para todos os processos de forma agressiva mas controlada&quot;&quot;&quot;</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 1. Sinalizar parada graciosa</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 2. Terminar pool de processos  </span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 3. Matar processos filhos diretamente</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 4. Limpeza final de processos √≥rf√£os</span></span></code></pre></div>
<h3 data-number="1.15.2" id="handler-de-sinal-melhorado"><span class="header-section-number">1.15.2</span> <strong>2. Handler de Sinal
Melhorado</strong></h3>
<div class="sourceCode" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> robust_signal_handler(sig, frame):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handler robusto para SIGINT (Ctrl+C)&quot;&quot;&quot;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">üõë INTERRUP√á√ÉO RECEBIDA - Parando execu√ß√£o imediata...&quot;</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    ProcessManager.stop_all()</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    sys.exit(<span class="dv">1</span>)</span></code></pre></div>
<h3 data-number="1.15.3" id="rastreamento-de-processos-ativos"><span class="header-section-number">1.15.3</span> <strong>3. Rastreamento de
Processos Ativos</strong></h3>
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Em cada worker:</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>ProcessManager.add_process(current_pid)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># No final do worker:</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>ProcessManager.remove_process(current_pid)</span></code></pre></div>
<h3 data-number="1.15.4" id="limpeza-agressiva-de-processos-chromium"><span class="header-section-number">1.15.4</span> <strong>4. Limpeza Agressiva
de Processos Chromium</strong></h3>
<div class="sourceCode" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kill_orphaned_chromium():</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Usa psutil para encontrar e matar processos espec√≠ficos&quot;&quot;&quot;</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> proc <span class="kw">in</span> psutil.process_iter([<span class="st">&#39;pid&#39;</span>, <span class="st">&#39;name&#39;</span>]):</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">any</span>(name <span class="kw">in</span> proc.info[<span class="st">&#39;name&#39;</span>].lower() </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>               <span class="cf">for</span> name <span class="kw">in</span> [<span class="st">&#39;chrome&#39;</span>, <span class="st">&#39;chromium&#39;</span>, <span class="st">&#39;msedge&#39;</span>]):</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>            proc.terminate()</span></code></pre></div>
<h3 data-number="1.15.5" id="timeouts-de-seguran√ßa"><span class="header-section-number">1.15.5</span> <strong>5. Timeouts de
Seguran√ßa</strong></h3>
<div class="sourceCode" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Timeouts curtos para respostas r√°pidas</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>listener_thread.join(timeout<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>pool.join(timeout<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div>
<h2 data-number="1.16" id="como-funciona-agora"><span class="header-section-number">1.16</span> üéØ <strong>Como Funciona
Agora:</strong></h2>
<ol type="1">
<li><strong>Ctrl+C pressionado</strong> ‚Üí Signal handler √© acionado
IMEDIATAMENTE</li>
<li><strong>ProcessManager.stop_all()</strong> √© chamado:
<ul>
<li>Sinaliza <code>stop_event</code> para parada graciosa</li>
<li>Termina o pool de processos</li>
<li>Mata processos filhos com <code>psutil</code></li>
<li>Limpa processos Chromium √≥rf√£os</li>
</ul></li>
<li><strong>Sa√≠da limpa</strong> do programa</li>
</ol>
<h2 data-number="1.17" id="par√¢metros-otimizados"><span class="header-section-number">1.17</span> üìä <strong>Par√¢metros
Otimizados:</strong></h2>
<ul>
<li><code>--workers 1</code> por padr√£o (mais est√°vel)</li>
<li><code>--batch-size 5</code> (melhor responsividade)</li>
<li>Timeouts reduzidos para shutdown r√°pido</li>
</ul>
<h2 data-number="1.18" id="teste-a-interrup√ß√£o"><span class="header-section-number">1.18</span> üß™ <strong>Teste a
Interrup√ß√£o:</strong></h2>
<div class="sourceCode" id="cb40"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inicie a convers√£o</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> comb_pdf_direct6_html_based_optimized_live_benchmark.py</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Pressione Ctrl+C a qualquer momento - deve parar IMEDIATAMENTE</span></span></code></pre></div>
<p><strong>Esta vers√£o deve responder ao Ctrl+C de forma instant√¢nea e
confi√°vel!</strong> üöÄ</p>
<hr />
<h3 data-number="1.18.1" id="utilizador-2025-11-06-073229-deepseek-reasoner"><span class="header-section-number">1.18.1</span> üë§ Utilizador
<em>(2025-11-06 07:32:29)</em> <em>[deepseek-reasoner]</em></h3>
<p>Ctrl+C produz: ‚úÖ 008_ChatGPT_Comparar_convers√£o_MD_para_PDF.pdf ‚úÖ
009_ChatGPT_Exemplo.md_com_f√≥rmulas.pdf Process SpawnPoolWorker-2:
Traceback (most recent call last): File
‚ÄúD:_DOCS__DOCS___D_C_G_Qwen_Op_pdf_direct6_html_based_optimized_live_benchmark.py‚Äù,
line 219, in worker_process_batch page.pdf( File
‚ÄúC:-packages_api_generated.py‚Äù, line 11698, in pdf self._sync( File
‚ÄúC:-packages_impl_sync_base.py‚Äù, line 113, in _sync
self._dispatcher_fiber.switch() File
‚ÄúC:-packages_api_context_manager.py‚Äù, line 56, in greenlet_main
self._loop.run_until_complete(self._connection.run_as_sync()) File
‚ÄúC:_events.py‚Äù, line 641, in run_until_complete self.run_forever() File
‚ÄúC:_events.py‚Äù, line 321, in run_forever super().run_forever() File
‚ÄúC:_events.py‚Äù, line 608, in run_forever self._run_once() File
‚ÄúC:_events.py‚Äù, line 1898, in _run_once event_list =
self._selector.select(timeout) <sup></sup> File ‚ÄúC:_events.py‚Äù, line
444, in select self._poll(timeout) File ‚ÄúC:_events.py‚Äù, line 825, in
_poll status = _overlapped.GetQueuedCompletionStatus(self._iocp, ms)
<sup></sup>^ KeyboardInterrupt</p>
<p>During handling of the above exception, another exception
occurred:</p>
<p>Traceback (most recent call last): File ‚ÄúC:.py‚Äù, line 314, in
_bootstrap self.run() File ‚ÄúC:.py‚Äù, line 108, in run
self._target(*self._args, **self._kwargs) File ‚ÄúC:.py‚Äù, line 125, in
worker result = (True, func(*args, **kwds)) <sup></sup>^ File
‚ÄúD:_DOCS__DOCS___D_C_G_Qwen_Op_pdf_direct6_html_based_optimized_live_benchmark.py‚Äù,
line 271, in worker_wrapper return worker_process_batch(*args)
<sup></sup>^ File
‚ÄúD:_DOCS__DOCS___D_C_G_Qwen_Op_pdf_direct6_html_based_optimized_live_benchmark.py‚Äù,
line 244, in worker_process_batch context.close() File
‚ÄúC:-packages<em>api_generated.py‚Äù, line 13482, in close return
mapping.from_maybe_impl(self._sync(self._impl_obj.close(reason=reason)))
<sup></sup>^ File ‚ÄúC:-packages_impl_sync_base.py‚Äù, line 113, in <em>sync
self._dispatcher_fiber.switch() KeyboardInterrupt Future exception was
never retrieved future: &lt;Future finished
exception=TargetClosedError(‚ÄòTarget page, context or browser has been
closed‚Äô)&gt; playwright._impl._errors.TargetClosedError: Target page,
context or browser has been closed Future exception was never retrieved
future: &lt;Future finished exception=TargetClosedError(‚ÄòTarget page,
context or browser has been closed‚Äô)&gt;
playwright._impl._errors.TargetClosedError: Target page, context or
browser has been closed ‚úÖ
011_DeepSeek_Convert_Markdown_to_PDF_with_Pandoc_and_Python.pdf ‚úÖ
012_ChatGPT_Integrar_fun√ß√£o_em_script.pdf ‚úÖ
013_Grok_github-pandoc.css_com_Pandoc._Tutorial.pdf Process
SpawnPoolWorker-3: Traceback (most recent call last): File
‚ÄúD:_DOCS</em>_DOCS</em>__D_C_G_Qwen_Op_pdf_direct6_html_based_optimized_live_benchmark.py‚Äù,
line 219, in worker_process_batch page.pdf( File
‚ÄúC:-packages_api_generated.py‚Äù, line 11698, in pdf self._sync( File
‚ÄúC:-packages_impl_sync_base.py‚Äù, line 113, in _sync
self._dispatcher_fiber.switch() File
‚ÄúC:-packages_api_context_manager.py‚Äù, line 56, in greenlet_main
self._loop.run_until_complete(self._connection.run_as_sync()) File
‚ÄúC:_events.py‚Äù, line 641, in run_until_complete self.run_forever() e
continuam a surgir novos processos, o script n√£o para</p>
<hr />
<h3 data-number="1.18.2" id="deepseek-2025-11-06-073229-deepseek-reasoner"><span class="header-section-number">1.18.2</span> ü§ñ DeepSeek <em>(2025-11-06
07:32:29)</em> <em>[deepseek-reasoner]</em></h3>
<p>O problema √© que o Ctrl+C n√£o est√° sendo capaz de interromper todos
os processos de forma limpa. A mensagem de erro indica que h√° exce√ß√µes
<code>KeyboardInterrupt</code> sendo capturadas nos processos filhos,
mas o pool de processos n√£o est√° sendo terminado de forma eficaz.</p>
<p>Vamos reestruturar o c√≥digo para garantir que, ao pressionar Ctrl+C,
o processo principal sinalize a todos os processos filhos para parar e
ent√£o termine o pool de processos. Al√©m disso, precisamos garantir que
os processos filhos sejam interrompidos mesmo que estejam no meio de uma
opera√ß√£o.</p>
<p>A abordagem atual usa <code>multiprocessing.Pool</code> e tenta
terminar o pool com <code>pool.terminate()</code>, mas parece que os
processos filhos ainda est√£o executando.</p>
<p>Vamos tentar uma abordagem diferente:</p>
<ol type="1">
<li>Usar <code>multiprocessing.Process</code> em vez de
<code>Pool</code> para ter mais controle sobre cada processo.</li>
<li>Usar uma fila de mensagens para comunica√ß√£o e um evento para
sinalizar a parada.</li>
<li>No handler do sinal, definir o evento de parada e ent√£o terminar
cada processo individualmente.</li>
</ol>
<p>No entanto, isso pode ser complexo. Outra alternativa √© usar
<code>concurrent.futures.ProcessPoolExecutor</code> que pode ser mais
f√°cil de interromper.</p>
<p>Mas, considerando a complexidade, vou reescrever a fun√ß√£o
<code>generate_pdfs_live</code> para usar
<code>multiprocessing.Process</code> e
<code>multiprocessing.Queue</code> diretamente, e gerenciar os processos
manualmente.</p>
<p>Isso permitir√° ter um controle mais fino sobre a interrup√ß√£o.</p>
<p>Vou reestruturar o c√≥digo da seguinte forma:</p>
<ul>
<li>Criar uma lista de processos.</li>
<li>Iniciar cada processo para processar um batch.</li>
<li>Esperar que eles terminem ou pelo evento de parada.</li>
<li>Se houver Ctrl+C, definir o evento de parada e ent√£o terminar todos
os processos.</li>
</ul>
<p>No entanto, note que a interrup√ß√£o do Playwright pode levar a
exce√ß√µes, como j√° vimos, mas o importante √© parar a execu√ß√£o.</p>
<p>Vou apresentar uma vers√£o simplificada que usa processos e gerencia
manualmente.</p>
<p>Como a reescrita completa √© extensa, vou focar na parte cr√≠tica: a
cria√ß√£o de processos e o tratamento do Ctrl+C.</p>
<p>Vamos modificar a fun√ß√£o <code>generate_pdfs_live</code>:</p>
<ol type="1">
<li>N√£o usar <code>multiprocessing.Pool</code>, mas sim uma lista de
<code>multiprocessing.Process</code>.</li>
<li>Cada processo executa a fun√ß√£o
<code>worker_process_batch</code>.</li>
<li>O processo principal espera pelos processos com um timeout, para
poder verificar periodicamente se houve interrup√ß√£o.</li>
</ol>
<p>Vou reescrever a parte do processamento de batches:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>    processes <span class="op">=</span> []</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch <span class="kw">in</span> batches:</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>        p <span class="op">=</span> multiprocessing.Process(</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>            target<span class="op">=</span>worker_process_batch,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>            args<span class="op">=</span>(batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, stop_event, msg_queue)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>        p.start()</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>        processes.append(p)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Esperar todos os processos, mas verificar por interrup√ß√£o</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> processes:</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>            p.join()  <span class="co"># Espera sem timeout para que possamos interromper com Ctrl+C?</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o pelo utilizador. Aguardando parada dos processos...&quot;</span>)</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Esperar um pouco para que os processos possam parar graciosamente</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> processes:</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>            p.join(timeout<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> p.is_alive():</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>                p.terminate()</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span>  <span class="co"># Sair com exce√ß√£o KeyboardInterrupt</span></span></code></pre></div>
<p>No entanto, o <code>p.join()</code> n√£o √© interromp√≠vel por Ctrl+C.
Ent√£o, em vez disso, podemos usar um loop com timeout no join e
verificar se o processo principal recebeu o sinal.</p>
<p>Outra abordagem √© usar <code>while processes</code> e fazer
<code>join</code> com um timeout curto, e verificar se o evento de
parada foi setado (por exemplo, por um sinal no processo principal).</p>
<p>Vamos reescrever o trecho do processamento de batches para usar essa
t√©cnica.</p>
<p>Al√©m disso, note que o processo principal deve capturar o Ctrl+C e
setar o evento de parada.</p>
<p>Vamos modificar o c√≥digo para:</p>
<ul>
<li>Criar processos.</li>
<li>Esperar que terminem, mas verificando por Ctrl+C a cada
segundo.</li>
<li>Se houver Ctrl+C, setar o evento de parada e ent√£o terminar os
processos.</li>
</ul>
<p>Vou reescrever a parte do processamento na fun√ß√£o
<code>generate_pdfs_live</code>:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>    processes <span class="op">=</span> []</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> batch <span class="kw">in</span> batches:</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>        p <span class="op">=</span> multiprocessing.Process(</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>            target<span class="op">=</span>worker_process_batch,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>            args<span class="op">=</span>(batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, stop_event, msg_queue)</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>        p.start()</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        processes.append(p)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Esperar que todos os processos terminem, mas verificar por interrup√ß√£o</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> processes:</span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> p <span class="kw">in</span> processes[:]:</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>                p.join(timeout<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> p.is_alive():</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>                    processes.remove(p)</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verificar se houve interrup√ß√£o</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o pelo utilizador. Parando processos...&quot;</span>)</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Dar um tempo para que os processos parem graciosamente</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> processes:</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>            p.join(timeout<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> p.is_alive():</span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>                p.terminate()</span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># N√£o sair imediatamente, mas sim quebrar o loop e continuar a limpeza</span></span></code></pre></div>
<p>No entanto, o bloco <code>except KeyboardInterrupt</code> dentro do
loop de espera dos processos pode n√£o ser a melhor forma, porque o
<code>join</code> com timeout n√£o levanta exce√ß√£o.</p>
<p>Vamos ent√£o verificar no loop principal se houve Ctrl+C. Mas note que
o sinal Ctrl+C √© recebido no processo principal e vai ser tratado pelo
signal handler que n√≥s configuramos. No nosso signal handler, n√≥s
setamos o <code>stop_event</code> e chamamos
<code>ProcessManager.stop_all()</code>. O
<code>ProcessManager.stop_all()</code> deve terminar os processos.</p>
<p>O problema √© que o signal handler est√° sendo chamado, mas o c√≥digo
principal est√° preso no loop de espera dos processos. Precisamos que a
espera pelos processos seja interrompida.</p>
<p>Uma solu√ß√£o √© usar um timeout curto no join e verificar o
<code>stop_event</code> no loop.</p>
<p>Vamos modificar o loop de espera para:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> processes <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> p <span class="kw">in</span> processes[:]:</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>                p.join(timeout<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> p.is_alive():</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>                    processes.remove(p)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o pelo utilizador. Parando processos...&quot;</span>)</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Re-raise para que o bloco finally seja executado</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span></span></code></pre></div>
<p>E ent√£o, no <code>finally</code>, terminar os processos que ainda
estiverem vivos.</p>
<p>Vou reescrever a fun√ß√£o <code>generate_pdfs_live</code> com essa
abordagem.</p>
<p>No entanto, note que o signal handler j√° est√° configurado para chamar
<code>ProcessManager.stop_all()</code>, que por sua vez termina o pool.
Agora, como estamos usando processos individuais, precisamos adaptar o
<code>ProcessManager</code> para gerenciar esses processos.</p>
<p>Vou remover o uso de <code>Pool</code> e usar uma lista de processos.
Tamb√©m vou modificar o <code>ProcessManager</code> para gerenciar essa
lista.</p>
<p>Vamos fazer uma refatora√ß√£o significativa. Como o c√≥digo √© grande,
vou apresentar as partes alteradas.</p>
<ol type="1">
<li>Remover a classe <code>ProcessManager</code> e gerenciar os
processos diretamente na fun√ß√£o <code>generate_pdfs_live</code>.</li>
<li>Usar uma lista de processos e um evento de parada.</li>
</ol>
<p>Vou reescrever a fun√ß√£o <code>generate_pdfs_live</code>:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_pdfs_live(...):</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... (c√≥digo anterior at√© a cria√ß√£o dos batches)</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configurar sistema de interrup√ß√£o</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    manager <span class="op">=</span> multiprocessing.Manager()</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    stop_event <span class="op">=</span> manager.Event()</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    msg_queue <span class="op">=</span> manager.Queue()</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    listener_stop_flag <span class="op">=</span> threading.Event()</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iniciar listener em thread separada</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    listener_thread <span class="op">=</span> threading.Thread(</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>queue_listener, </span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(msg_queue, stop_event, listener_stop_flag), </span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>        daemon<span class="op">=</span><span class="va">True</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    listener_thread.start()</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparar argumentos para workers</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    processes <span class="op">=</span> []</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    success_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    failed <span class="op">=</span> []</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Criar um processo para cada batch</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> batches:</span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>            p <span class="op">=</span> multiprocessing.Process(</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>                target<span class="op">=</span>worker_process_batch,</span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>(batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, stop_event, msg_queue)</span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>            p.start()</span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>            processes.append(p)</span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Esperar que todos os processos terminem, mas verificar por interrup√ß√£o</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> processes <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> p <span class="kw">in</span> processes[:]:</span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>                p.join(timeout<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> p.is_alive():</span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>                    processes.remove(p)</span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>            <span class="co"># N√£o √© necess√°rio fazer mais nada aqui, pois o stop_event √© verificado no loop</span></span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o pelo utilizador. Parando processos...&quot;</span>)</span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Esperar um pouco para que os processos possam parar graciosamente</span></span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> processes:</span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a>            p.join(timeout<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> p.is_alive():</span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>                p.terminate()</span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># N√£o sair do bloco, continuar para o relat√≥rio</span></span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final</span></span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Finalizando processos e fazendo limpeza...&quot;</span>)</span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parar listener</span></span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a>        listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a>            msg_queue.put(<span class="va">None</span>)</span>
<span id="cb44-62"><a href="#cb44-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb44-63"><a href="#cb44-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb44-64"><a href="#cb44-64" aria-hidden="true" tabindex="-1"></a>        listener_thread.join(timeout<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb44-65"><a href="#cb44-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-66"><a href="#cb44-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Terminar quaisquer processos restantes</span></span>
<span id="cb44-67"><a href="#cb44-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> processes:</span>
<span id="cb44-68"><a href="#cb44-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> p.is_alive():</span>
<span id="cb44-69"><a href="#cb44-69" aria-hidden="true" tabindex="-1"></a>                p.terminate()</span>
<span id="cb44-70"><a href="#cb44-70" aria-hidden="true" tabindex="-1"></a>                p.join(timeout<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb44-71"><a href="#cb44-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb44-72"><a href="#cb44-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final de processos</span></span>
<span id="cb44-73"><a href="#cb44-73" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb44-74"><a href="#cb44-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-75"><a href="#cb44-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... (restante do c√≥digo para relat√≥rio)</span></span></code></pre></div>
<p>Agora, note que a fun√ß√£o <code>worker_process_batch</code> deve ser
capaz de responder ao <code>stop_event</code>. J√° temos verifica√ß√µes no
worker para o <code>stop_event</code>.</p>
<p>Com essa abordagem, quando o Ctrl+C for pressionado, o signal handler
no processo principal ser√° acionado. No nosso signal handler, n√≥s
setamos o <code>stop_event</code> (agora gerenciado pelo
<code>ProcessManager</code>? N√£o, porque removemos o
<code>ProcessManager</code>). Precisamos ajustar o signal handler.</p>
<p>Vamos redefinir o signal handler para usar uma abordagem mais
simples: no signal handler, setamos um evento global de parada e ent√£o
terminamos os processos. Mas como acessar a lista de processos do signal
handler? Isso √© complicado porque o signal handler roda na thread
principal.</p>
<p>Em vez disso, vamos voltar a usar o <code>ProcessManager</code> como
uma classe de armazenamento, mas agora para armazenar a lista de
processos.</p>
<p>Vou redefinir o <code>ProcessManager</code> para:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProcessManager:</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    _processes <span class="op">=</span> []</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    _stop_event <span class="op">=</span> <span class="va">None</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_process(cls, p):</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        cls._processes.append(p)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> stop_all(cls):</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cls._stop_event:</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>            cls._stop_event.<span class="bu">set</span>()</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> cls._processes:</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> p.is_alive():</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>                p.terminate()</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>        cls._processes.clear()</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span></code></pre></div>
<p>E ent√£o, na fun√ß√£o <code>generate_pdfs_live</code>, vamos adicionar
cada processo ao <code>ProcessManager</code> e configurar o
<code>_stop_event</code>.</p>
<p>Mas note: o <code>ProcessManager</code> √© compartilhado entre
processos? N√£o, porque cada processo tem sua pr√≥pria c√≥pia. Ent√£o isso
n√£o vai funcionar.</p>
<p>A solu√ß√£o √© usar o sinal para setar um evento que √© compartilhado
entre processos, e ent√£o o processo principal, ao receber o sinal, seta
o evento e depois chama <code>ProcessManager.stop_all()</code> (que
termina os processos). Mas o <code>ProcessManager</code> no processo
principal tem a lista de processos.</p>
<p>Vamos redefinir o signal handler para:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> robust_signal_handler(sig, frame):</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">üõë INTERRUP√á√ÉO RECEBIDA - Parando execu√ß√£o imediata...&quot;</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    ProcessManager.stop_all()</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    sys.exit(<span class="dv">1</span>)</span></code></pre></div>
<p>E no <code>ProcessManager</code>, armazenamos a lista de processos do
processo principal.</p>
<p>Agora, na fun√ß√£o <code>generate_pdfs_live</code>, vamos adicionar os
processos ao <code>ProcessManager</code>:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>    processes <span class="op">=</span> []</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    ProcessManager._processes <span class="op">=</span> processes  <span class="co"># Agora o ProcessManager gerencia esta lista</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    ProcessManager._stop_event <span class="op">=</span> stop_event</span></code></pre></div>
<p>Isso deve funcionar porque o <code>ProcessManager</code> no processo
principal tem acesso √† lista de processos.</p>
<p>Vou integrar essas mudan√ßas.</p>
<p>No entanto, note que a lista <code>processes</code> √© uma lista
normal, n√£o √© compartilhada entre processos. Isso √© okay porque o
<code>ProcessManager</code> s√≥ √© usado no processo principal.</p>
<p>Vamos reescrever o c√≥digo com essas ideias.</p>
<p>Dada a complexidade, vou fornecer o c√≥digo completo da fun√ß√£o
<code>generate_pdfs_live</code> e das classes relacionadas.</p>
<p>Como o c√≥digo √© muito longo, vou fornecer as partes alteradas de
forma incremental.</p>
<p>Primeiro, a classe <code>ProcessManager</code> revisada:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ProcessManager:</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    _processes <span class="op">=</span> []</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    _stop_event <span class="op">=</span> <span class="va">None</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> add_process(cls, p):</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        cls._processes.append(p)</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">@classmethod</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> stop_all(cls):</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">üõë Parando </span><span class="sc">{</span><span class="bu">len</span>(cls._processes)<span class="sc">}</span><span class="ss"> processos ativos...&quot;</span>)</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cls._stop_event:</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>            cls._stop_event.<span class="bu">set</span>()</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> cls._processes:</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> p.is_alive():</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>                p.terminate()</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        cls._processes.clear()</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Todos os processos foram interrompidos&quot;</span>)</span></code></pre></div>
<p>Agora, a fun√ß√£o <code>generate_pdfs_live</code>:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_pdfs_live(...):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... (c√≥digo anterior at√© a cria√ß√£o dos batches)</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configurar sistema de interrup√ß√£o</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>    manager <span class="op">=</span> multiprocessing.Manager()</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>    stop_event <span class="op">=</span> manager.Event()</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>    ProcessManager._stop_event <span class="op">=</span> stop_event  <span class="co"># Configurar o stop_event no ProcessManager</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    msg_queue <span class="op">=</span> manager.Queue()</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    listener_stop_flag <span class="op">=</span> threading.Event()</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iniciar listener em thread separada</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    listener_thread <span class="op">=</span> threading.Thread(</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>queue_listener, </span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(msg_queue, stop_event, listener_stop_flag), </span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>        daemon<span class="op">=</span><span class="va">True</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    listener_thread.start()</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparar argumentos para workers</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a>    processes <span class="op">=</span> []</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>    ProcessManager._processes <span class="op">=</span> processes  <span class="co"># Compartilhar a lista de processos com o ProcessManager</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>    success_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>    failed <span class="op">=</span> []</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Criar um processo para cada batch</span></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> batches:</span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>            p <span class="op">=</span> multiprocessing.Process(</span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>                target<span class="op">=</span>worker_process_batch,</span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>(batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, stop_event, msg_queue)</span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>            p.start()</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>            processes.append(p)</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Esperar que todos os processos terminem, mas verificar por interrup√ß√£o</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> processes <span class="kw">and</span> <span class="kw">not</span> stop_event.is_set():</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> p <span class="kw">in</span> processes[:]:</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>                p.join(timeout<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> p.is_alive():</span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>                    processes.remove(p)</span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">üõë Interrup√ß√£o pelo utilizador detectada no loop principal...&quot;</span>)</span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üö´ Erro inesperado: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final</span></span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Finalizando processos e fazendo limpeza...&quot;</span>)</span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parar listener</span></span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>        listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>            msg_queue.put(<span class="va">None</span>)</span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>        listener_thread.join(timeout<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Terminar quaisquer processos restantes</span></span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> p <span class="kw">in</span> processes:</span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> p.is_alive():</span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a>                p.terminate()</span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a>                p.join(timeout<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb49-70"><a href="#cb49-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final de processos</span></span>
<span id="cb49-71"><a href="#cb49-71" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb49-72"><a href="#cb49-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-73"><a href="#cb49-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ... (restante do c√≥digo para relat√≥rio)</span></span></code></pre></div>
<p>Agora, quando o Ctrl+C for pressionado, o signal handler
<code>robust_signal_handler</code> ser√° chamado, que por sua vez chama
<code>ProcessManager.stop_all()</code>. Isso seta o
<code>stop_event</code> e termina todos os processos.</p>
<p>Al√©m disso, no loop principal, se houver uma exce√ß√£o
<code>KeyboardInterrupt</code>, n√≥s setamos o <code>stop_event</code> e
fazemos a limpeza.</p>
<p>Espero que isso funcione.</p>
<p>No entanto, note que o signal handler pode ser chamado enquanto o
c√≥digo est√° no loop de espera dos processos. Nesse caso, o
<code>ProcessManager.stop_all()</code> ser√° chamado e terminar√° os
processos. Ent√£o, o loop de espera vai ver que os processos terminaram e
sair.</p>
<p>Vamos testar essa abordagem.</p>
<p>Dada a complexidade e o fato de que o c√≥digo completo √© muito longo,
se houver problemas, talvez seja necess√°rio considerar outras
abordagens, como o uso de <code>concurrent.futures</code> que pode
fornecer uma maneira mais f√°cil de interromper os processos.</p>
<p>Por now, vou fornecer o c√≥digo com as altera√ß√µes propostas.</p>
<p>Como a vers√£o completa √© muito longa, vou destacar apenas as partes
alteradas. Se necess√°rio, posso fornecer o c√≥digo completo.</p>
<p>Vamos recapitular as altera√ß√µes:</p>
<ol type="1">
<li>Modificamos a classe <code>ProcessManager</code> para gerenciar uma
lista de processos e um evento de parada.</li>
<li>Na fun√ß√£o <code>generate_pdfs_live</code>, usamos
<code>multiprocessing.Process</code> para cada batch.</li>
<li>Adicionamos os processos √† lista
<code>ProcessManager._processes</code>.</li>
<li>No loop de espera, usamos <code>join</code> com timeout e
verificamos o <code>stop_event</code>.</li>
<li>No signal handler, chamamos
<code>ProcessManager.stop_all()</code>.</li>
</ol>
<p>Espero que isso resolva o problema da interrup√ß√£o. Aqui est√° a vers√£o
corrigida com um sistema de interrup√ß√£o Ctrl+C <strong>realmente
eficaz</strong>:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># -*- coding: utf-8 -*-</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co">comb_pdf_direct6_html_based_optimized_live_benchmark.py</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="co">Vers√£o com interrup√ß√£o Ctrl+C IMEDIATA E CONFI√ÅVEL usando os.getpid() e signal.CTRL_C_EVENT</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> threading</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> platform</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> signal</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> psutil</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Tuple, Optional</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> playwright.sync_api <span class="im">import</span> sync_playwright, <span class="pp">TimeoutError</span> <span class="im">as</span> PlaywrightTimeoutError</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Vari√°veis globais para controle de interrup√ß√£o</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>_active_processes <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>_should_stop <span class="op">=</span> <span class="va">False</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Fun√ß√µes utilit√°rias</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kill_orphaned_chromium():</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Encerra processos Chromium √≥rf√£os de forma agressiva.&quot;&quot;&quot;</span></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ Limpando processos Chromium √≥rf√£os...&quot;</span>)</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>        current_pid <span class="op">=</span> os.getpid()</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> platform.system() <span class="op">==</span> <span class="st">&quot;Windows&quot;</span>:</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>            subprocess.run(</span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>                [<span class="st">&quot;taskkill&quot;</span>, <span class="st">&quot;/F&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chrome.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;chromium.exe&quot;</span>, <span class="st">&quot;/IM&quot;</span>, <span class="st">&quot;msedge.exe&quot;</span>],</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>                stdout<span class="op">=</span>subprocess.DEVNULL, </span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>                stderr<span class="op">=</span>subprocess.DEVNULL,</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>                timeout<span class="op">=</span><span class="dv">10</span></span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chromium&quot;</span>], </span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;chrome&quot;</span>], </span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a>            subprocess.run([<span class="st">&quot;pkill&quot;</span>, <span class="st">&quot;-9&quot;</span>, <span class="st">&quot;-f&quot;</span>, <span class="st">&quot;playwright&quot;</span>], </span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>                         stdout<span class="op">=</span>subprocess.DEVNULL, stderr<span class="op">=</span>subprocess.DEVNULL)</span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ö†Ô∏è Aviso na limpeza: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chunkify(seq: List[<span class="bu">str</span>], size: <span class="bu">int</span>) <span class="op">-&gt;</span> List[List[<span class="bu">str</span>]]:</span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [seq[i:i <span class="op">+</span> size] <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(seq), size)]</span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> check_playwright_available(headless_test: <span class="bu">bool</span> <span class="op">=</span> <span class="va">True</span>) <span class="op">-&gt;</span> <span class="bu">bool</span>:</span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Verifica se o Playwright + Chromium est√£o instalados.&quot;&quot;&quot;</span></span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(headless<span class="op">=</span>headless_test)</span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>            browser.close()</span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb50-71"><a href="#cb50-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-72"><a href="#cb50-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-73"><a href="#cb50-73" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> emergency_stop_handler(signum, frame):</span>
<span id="cb50-74"><a href="#cb50-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Handler de emerg√™ncia para Ctrl+C - para TUDO imediatamente&quot;&quot;&quot;</span></span>
<span id="cb50-75"><a href="#cb50-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop</span>
<span id="cb50-76"><a href="#cb50-76" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">!!! EMERGENCY STOP !!!&quot;</span>)</span>
<span id="cb50-77"><a href="#cb50-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üö® INTERRUP√á√ÉO DE EMERG√äNCIA - Terminando </span><span class="sc">{</span><span class="bu">len</span>(_active_processes)<span class="sc">}</span><span class="ss"> processos...&quot;</span>)</span>
<span id="cb50-78"><a href="#cb50-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-79"><a href="#cb50-79" aria-hidden="true" tabindex="-1"></a>    _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb50-80"><a href="#cb50-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-81"><a href="#cb50-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Terminar processos de forma agressiva</span></span>
<span id="cb50-82"><a href="#cb50-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pid <span class="kw">in</span> <span class="bu">list</span>(_active_processes):</span>
<span id="cb50-83"><a href="#cb50-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb50-84"><a href="#cb50-84" aria-hidden="true" tabindex="-1"></a>            parent <span class="op">=</span> psutil.Process(pid)</span>
<span id="cb50-85"><a href="#cb50-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> child <span class="kw">in</span> parent.children(recursive<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb50-86"><a href="#cb50-86" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb50-87"><a href="#cb50-87" aria-hidden="true" tabindex="-1"></a>                    child.kill()</span>
<span id="cb50-88"><a href="#cb50-88" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span>:</span>
<span id="cb50-89"><a href="#cb50-89" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">pass</span></span>
<span id="cb50-90"><a href="#cb50-90" aria-hidden="true" tabindex="-1"></a>            parent.kill()</span>
<span id="cb50-91"><a href="#cb50-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb50-92"><a href="#cb50-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb50-93"><a href="#cb50-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-94"><a href="#cb50-94" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb50-95"><a href="#cb50-95" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üíÄ TODOS OS PROCESSOS FORAM TERMINADOS&quot;</span>)</span>
<span id="cb50-96"><a href="#cb50-96" aria-hidden="true" tabindex="-1"></a>    os._exit(<span class="dv">1</span>)  <span class="co"># Sa√≠da de emerg√™ncia</span></span>
<span id="cb50-97"><a href="#cb50-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-98"><a href="#cb50-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-99"><a href="#cb50-99" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-100"><a href="#cb50-100" aria-hidden="true" tabindex="-1"></a><span class="co"># Worker de processamento SIMPLIFICADO</span></span>
<span id="cb50-101"><a href="#cb50-101" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-102"><a href="#cb50-102" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_process_batch_simple(batch_files, pdf_dir, timeout, headless, force_overwrite, retry_count, stop_event, msg_queue):</span>
<span id="cb50-103"><a href="#cb50-103" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Worker simplificado com verifica√ß√µes constantes de parada&quot;&quot;&quot;</span></span>
<span id="cb50-104"><a href="#cb50-104" aria-hidden="true" tabindex="-1"></a>    my_pid <span class="op">=</span> os.getpid()</span>
<span id="cb50-105"><a href="#cb50-105" aria-hidden="true" tabindex="-1"></a>    _active_processes.add(my_pid)</span>
<span id="cb50-106"><a href="#cb50-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-107"><a href="#cb50-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb50-108"><a href="#cb50-108" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb50-109"><a href="#cb50-109" aria-hidden="true" tabindex="-1"></a>        out_dir <span class="op">=</span> Path(pdf_dir)</span>
<span id="cb50-110"><a href="#cb50-110" aria-hidden="true" tabindex="-1"></a>        out_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-111"><a href="#cb50-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-112"><a href="#cb50-112" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verificar parada ANTES de iniciar o browser</span></span>
<span id="cb50-113"><a href="#cb50-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb50-114"><a href="#cb50-114" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> []</span>
<span id="cb50-115"><a href="#cb50-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-116"><a href="#cb50-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> sync_playwright() <span class="im">as</span> p:</span>
<span id="cb50-117"><a href="#cb50-117" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Configura√ß√£o m√≠nima do browser</span></span>
<span id="cb50-118"><a href="#cb50-118" aria-hidden="true" tabindex="-1"></a>            browser <span class="op">=</span> p.chromium.launch(headless<span class="op">=</span>headless)</span>
<span id="cb50-119"><a href="#cb50-119" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb50-120"><a href="#cb50-120" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_path_str <span class="kw">in</span> batch_files:</span>
<span id="cb50-121"><a href="#cb50-121" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Verificar parada ANTES de cada arquivo</span></span>
<span id="cb50-122"><a href="#cb50-122" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb50-123"><a href="#cb50-123" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span></span>
<span id="cb50-124"><a href="#cb50-124" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb50-125"><a href="#cb50-125" aria-hidden="true" tabindex="-1"></a>                html_path <span class="op">=</span> Path(html_path_str)</span>
<span id="cb50-126"><a href="#cb50-126" aria-hidden="true" tabindex="-1"></a>                pdf_path <span class="op">=</span> out_dir <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span></span>
<span id="cb50-127"><a href="#cb50-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-128"><a href="#cb50-128" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> pdf_path.exists() <span class="kw">and</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb50-129"><a href="#cb50-129" aria-hidden="true" tabindex="-1"></a>                    results.append((html_path_str, <span class="va">True</span>, <span class="st">&quot;J√° existe&quot;</span>))</span>
<span id="cb50-130"><a href="#cb50-130" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;skip&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb50-131"><a href="#cb50-131" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb50-132"><a href="#cb50-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-133"><a href="#cb50-133" aria-hidden="true" tabindex="-1"></a>                success <span class="op">=</span> <span class="va">False</span></span>
<span id="cb50-134"><a href="#cb50-134" aria-hidden="true" tabindex="-1"></a>                last_error <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb50-135"><a href="#cb50-135" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb50-136"><a href="#cb50-136" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> attempt <span class="kw">in</span> <span class="bu">range</span>(retry_count):</span>
<span id="cb50-137"><a href="#cb50-137" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Verificar parada ANTES de cada tentativa</span></span>
<span id="cb50-138"><a href="#cb50-138" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> stop_event.is_set():</span>
<span id="cb50-139"><a href="#cb50-139" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb50-140"><a href="#cb50-140" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb50-141"><a href="#cb50-141" aria-hidden="true" tabindex="-1"></a>                    context <span class="op">=</span> <span class="va">None</span></span>
<span id="cb50-142"><a href="#cb50-142" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">try</span>:</span>
<span id="cb50-143"><a href="#cb50-143" aria-hidden="true" tabindex="-1"></a>                        context <span class="op">=</span> browser.new_context()</span>
<span id="cb50-144"><a href="#cb50-144" aria-hidden="true" tabindex="-1"></a>                        page <span class="op">=</span> context.new_page()</span>
<span id="cb50-145"><a href="#cb50-145" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb50-146"><a href="#cb50-146" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Timeout reduzido para melhor resposta</span></span>
<span id="cb50-147"><a href="#cb50-147" aria-hidden="true" tabindex="-1"></a>                        page.set_default_timeout(<span class="dv">30000</span>)  <span class="co"># 30 segundos</span></span>
<span id="cb50-148"><a href="#cb50-148" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb50-149"><a href="#cb50-149" aria-hidden="true" tabindex="-1"></a>                        full_path <span class="op">=</span> <span class="ss">f&quot;file:///</span><span class="sc">{</span>html_path<span class="sc">.</span>absolute()<span class="sc">}</span><span class="ss">&quot;</span></span>
<span id="cb50-150"><a href="#cb50-150" aria-hidden="true" tabindex="-1"></a>                        page.goto(full_path, wait_until<span class="op">=</span><span class="st">&#39;networkidle&#39;</span>, timeout<span class="op">=</span><span class="dv">30000</span>)</span>
<span id="cb50-151"><a href="#cb50-151" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb50-152"><a href="#cb50-152" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Espera m√≠nima</span></span>
<span id="cb50-153"><a href="#cb50-153" aria-hidden="true" tabindex="-1"></a>                        page.wait_for_timeout(<span class="dv">1000</span>)</span>
<span id="cb50-154"><a href="#cb50-154" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb50-155"><a href="#cb50-155" aria-hidden="true" tabindex="-1"></a>                        page.pdf(</span>
<span id="cb50-156"><a href="#cb50-156" aria-hidden="true" tabindex="-1"></a>                            path<span class="op">=</span><span class="bu">str</span>(pdf_path),</span>
<span id="cb50-157"><a href="#cb50-157" aria-hidden="true" tabindex="-1"></a>                            <span class="bu">format</span><span class="op">=</span><span class="st">&#39;A4&#39;</span>,</span>
<span id="cb50-158"><a href="#cb50-158" aria-hidden="true" tabindex="-1"></a>                            print_background<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb50-159"><a href="#cb50-159" aria-hidden="true" tabindex="-1"></a>                            margin<span class="op">=</span>{<span class="st">&#39;top&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;bottom&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;left&#39;</span>: <span class="st">&#39;0.5in&#39;</span>, <span class="st">&#39;right&#39;</span>: <span class="st">&#39;0.5in&#39;</span>}</span>
<span id="cb50-160"><a href="#cb50-160" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb50-161"><a href="#cb50-161" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb50-162"><a href="#cb50-162" aria-hidden="true" tabindex="-1"></a>                        success <span class="op">=</span> <span class="va">True</span></span>
<span id="cb50-163"><a href="#cb50-163" aria-hidden="true" tabindex="-1"></a>                        msg_queue.put((<span class="st">&quot;ok&quot;</span>, pdf_path.name))</span>
<span id="cb50-164"><a href="#cb50-164" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb50-165"><a href="#cb50-165" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb50-166"><a href="#cb50-166" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb50-167"><a href="#cb50-167" aria-hidden="true" tabindex="-1"></a>                        last_error <span class="op">=</span> <span class="bu">str</span>(e)</span>
<span id="cb50-168"><a href="#cb50-168" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> attempt <span class="op">&lt;</span> retry_count <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb50-169"><a href="#cb50-169" aria-hidden="true" tabindex="-1"></a>                            time.sleep(<span class="dv">1</span>)</span>
<span id="cb50-170"><a href="#cb50-170" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">finally</span>:</span>
<span id="cb50-171"><a href="#cb50-171" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> context:</span>
<span id="cb50-172"><a href="#cb50-172" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">try</span>:</span>
<span id="cb50-173"><a href="#cb50-173" aria-hidden="true" tabindex="-1"></a>                                context.close()</span>
<span id="cb50-174"><a href="#cb50-174" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">except</span>:</span>
<span id="cb50-175"><a href="#cb50-175" aria-hidden="true" tabindex="-1"></a>                                <span class="cf">pass</span></span>
<span id="cb50-176"><a href="#cb50-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-177"><a href="#cb50-177" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> success:</span>
<span id="cb50-178"><a href="#cb50-178" aria-hidden="true" tabindex="-1"></a>                    msg_queue.put((<span class="st">&quot;fail&quot;</span>, <span class="ss">f&quot;</span><span class="sc">{</span>html_path<span class="sc">.</span>name<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>last_error<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb50-179"><a href="#cb50-179" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb50-180"><a href="#cb50-180" aria-hidden="true" tabindex="-1"></a>                results.append((html_path_str, success, last_error))</span>
<span id="cb50-181"><a href="#cb50-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-182"><a href="#cb50-182" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fechar browser</span></span>
<span id="cb50-183"><a href="#cb50-183" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb50-184"><a href="#cb50-184" aria-hidden="true" tabindex="-1"></a>                browser.close()</span>
<span id="cb50-185"><a href="#cb50-185" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb50-186"><a href="#cb50-186" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb50-187"><a href="#cb50-187" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb50-188"><a href="#cb50-188" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb50-189"><a href="#cb50-189" aria-hidden="true" tabindex="-1"></a>        msg_queue.put((<span class="st">&quot;error&quot;</span>, <span class="ss">f&quot;Erro no worker: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>))</span>
<span id="cb50-190"><a href="#cb50-190" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb50-191"><a href="#cb50-191" aria-hidden="true" tabindex="-1"></a>        _active_processes.discard(my_pid)</span>
<span id="cb50-192"><a href="#cb50-192" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-193"><a href="#cb50-193" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb50-194"><a href="#cb50-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-195"><a href="#cb50-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-196"><a href="#cb50-196" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> worker_wrapper_simple(args):</span>
<span id="cb50-197"><a href="#cb50-197" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb50-198"><a href="#cb50-198" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> worker_process_batch_simple(<span class="op">*</span>args)</span>
<span id="cb50-199"><a href="#cb50-199" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb50-200"><a href="#cb50-200" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb50-201"><a href="#cb50-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-202"><a href="#cb50-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-203"><a href="#cb50-203" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-204"><a href="#cb50-204" aria-hidden="true" tabindex="-1"></a><span class="co"># Listener de mensagens</span></span>
<span id="cb50-205"><a href="#cb50-205" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-206"><a href="#cb50-206" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> queue_listener_simple(msg_queue, listener_stop_flag):</span>
<span id="cb50-207"><a href="#cb50-207" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Listener simplificado&quot;&quot;&quot;</span></span>
<span id="cb50-208"><a href="#cb50-208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> listener_stop_flag.is_set():</span>
<span id="cb50-209"><a href="#cb50-209" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb50-210"><a href="#cb50-210" aria-hidden="true" tabindex="-1"></a>            obj <span class="op">=</span> msg_queue.get(timeout<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb50-211"><a href="#cb50-211" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> obj <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb50-212"><a href="#cb50-212" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb50-213"><a href="#cb50-213" aria-hidden="true" tabindex="-1"></a>            typ, text <span class="op">=</span> obj</span>
<span id="cb50-214"><a href="#cb50-214" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> typ <span class="op">==</span> <span class="st">&quot;ok&quot;</span>:</span>
<span id="cb50-215"><a href="#cb50-215" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚úÖ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb50-216"><a href="#cb50-216" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;skip&quot;</span>:</span>
<span id="cb50-217"><a href="#cb50-217" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚è≠Ô∏è </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb50-218"><a href="#cb50-218" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;fail&quot;</span>:</span>
<span id="cb50-219"><a href="#cb50-219" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;‚ùå </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb50-220"><a href="#cb50-220" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> typ <span class="op">==</span> <span class="st">&quot;error&quot;</span>:</span>
<span id="cb50-221"><a href="#cb50-221" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f&quot;üö´ </span><span class="sc">{</span>text<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb50-222"><a href="#cb50-222" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb50-223"><a href="#cb50-223" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb50-224"><a href="#cb50-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-225"><a href="#cb50-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-226"><a href="#cb50-226" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-227"><a href="#cb50-227" aria-hidden="true" tabindex="-1"></a><span class="co"># Convers√£o principal - VERS√ÉO SIMPLIFICADA</span></span>
<span id="cb50-228"><a href="#cb50-228" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-229"><a href="#cb50-229" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_pdfs_simple(source_dir, output_dir, workers, batch_size, headless, timeout,</span>
<span id="cb50-230"><a href="#cb50-230" aria-hidden="true" tabindex="-1"></a>                        force_overwrite, dry_run, single_file<span class="op">=</span><span class="va">None</span>, retry_count<span class="op">=</span><span class="dv">2</span>, benchmark<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb50-231"><a href="#cb50-231" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Fun√ß√£o principal SIMPLIFICADA com interrup√ß√£o robusta&quot;&quot;&quot;</span></span>
<span id="cb50-232"><a href="#cb50-232" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop</span>
<span id="cb50-233"><a href="#cb50-233" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-234"><a href="#cb50-234" aria-hidden="true" tabindex="-1"></a>    src <span class="op">=</span> Path(source_dir)</span>
<span id="cb50-235"><a href="#cb50-235" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> Path(output_dir)</span>
<span id="cb50-236"><a href="#cb50-236" aria-hidden="true" tabindex="-1"></a>    out.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-237"><a href="#cb50-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-238"><a href="#cb50-238" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> single_file:</span>
<span id="cb50-239"><a href="#cb50-239" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [<span class="bu">str</span>(src <span class="op">/</span> single_file)]</span>
<span id="cb50-240"><a href="#cb50-240" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> Path(html_files[<span class="dv">0</span>]).exists():</span>
<span id="cb50-241"><a href="#cb50-241" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Arquivo n√£o encontrado: </span><span class="sc">{</span>single_file<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb50-242"><a href="#cb50-242" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb50-243"><a href="#cb50-243" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb50-244"><a href="#cb50-244" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> <span class="bu">sorted</span>([<span class="bu">str</span>(p) <span class="cf">for</span> p <span class="kw">in</span> src.glob(<span class="st">&quot;*.html&quot;</span>)])</span>
<span id="cb50-245"><a href="#cb50-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-246"><a href="#cb50-246" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb50-247"><a href="#cb50-247" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Nenhum arquivo HTML encontrado.&quot;</span>)</span>
<span id="cb50-248"><a href="#cb50-248" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb50-249"><a href="#cb50-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-250"><a href="#cb50-250" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üéØ Encontrados </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos HTML&quot;</span>)</span>
<span id="cb50-251"><a href="#cb50-251" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>workers<span class="sc">}</span><span class="ss"> | Batch: </span><span class="sc">{</span>batch_size<span class="sc">}</span><span class="ss"> | Timeout: </span><span class="sc">{</span>timeout<span class="sc">}</span><span class="ss">s&quot;</span>)</span>
<span id="cb50-252"><a href="#cb50-252" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;‚èπÔ∏è  Pressione Ctrl+C para PARAR IMEDIATAMENTE&quot;</span>)</span>
<span id="cb50-253"><a href="#cb50-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-254"><a href="#cb50-254" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dry_run:</span>
<span id="cb50-255"><a href="#cb50-255" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ MODO SIMULA√á√ÉO - Nenhum arquivo ser√° criado&quot;</span>)</span>
<span id="cb50-256"><a href="#cb50-256" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb50-257"><a href="#cb50-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-258"><a href="#cb50-258" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> force_overwrite:</span>
<span id="cb50-259"><a href="#cb50-259" aria-hidden="true" tabindex="-1"></a>        original_count <span class="op">=</span> <span class="bu">len</span>(html_files)</span>
<span id="cb50-260"><a href="#cb50-260" aria-hidden="true" tabindex="-1"></a>        html_files <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> html_files <span class="cf">if</span> <span class="kw">not</span> (out <span class="op">/</span> <span class="ss">f&quot;</span><span class="sc">{</span>Path(f)<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">.pdf&quot;</span>).exists()]</span>
<span id="cb50-261"><a href="#cb50-261" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üÜï </span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss"> arquivos novos para processar&quot;</span>)</span>
<span id="cb50-262"><a href="#cb50-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-263"><a href="#cb50-263" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> html_files:</span>
<span id="cb50-264"><a href="#cb50-264" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚úÖ Nenhum arquivo novo para processar&quot;</span>)</span>
<span id="cb50-265"><a href="#cb50-265" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb50-266"><a href="#cb50-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-267"><a href="#cb50-267" aria-hidden="true" tabindex="-1"></a>    batches <span class="op">=</span> chunkify(html_files, batch_size)</span>
<span id="cb50-268"><a href="#cb50-268" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üì¶ </span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> batches preparados&quot;</span>)</span>
<span id="cb50-269"><a href="#cb50-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-270"><a href="#cb50-270" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sistema de comunica√ß√£o</span></span>
<span id="cb50-271"><a href="#cb50-271" aria-hidden="true" tabindex="-1"></a>    manager <span class="op">=</span> multiprocessing.Manager()</span>
<span id="cb50-272"><a href="#cb50-272" aria-hidden="true" tabindex="-1"></a>    stop_event <span class="op">=</span> manager.Event()</span>
<span id="cb50-273"><a href="#cb50-273" aria-hidden="true" tabindex="-1"></a>    msg_queue <span class="op">=</span> manager.Queue()</span>
<span id="cb50-274"><a href="#cb50-274" aria-hidden="true" tabindex="-1"></a>    listener_stop_flag <span class="op">=</span> threading.Event()</span>
<span id="cb50-275"><a href="#cb50-275" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-276"><a href="#cb50-276" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Listener</span></span>
<span id="cb50-277"><a href="#cb50-277" aria-hidden="true" tabindex="-1"></a>    listener_thread <span class="op">=</span> threading.Thread(</span>
<span id="cb50-278"><a href="#cb50-278" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>queue_listener_simple, </span>
<span id="cb50-279"><a href="#cb50-279" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(msg_queue, listener_stop_flag), </span>
<span id="cb50-280"><a href="#cb50-280" aria-hidden="true" tabindex="-1"></a>        daemon<span class="op">=</span><span class="va">True</span></span>
<span id="cb50-281"><a href="#cb50-281" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-282"><a href="#cb50-282" aria-hidden="true" tabindex="-1"></a>    listener_thread.start()</span>
<span id="cb50-283"><a href="#cb50-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-284"><a href="#cb50-284" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preparar argumentos</span></span>
<span id="cb50-285"><a href="#cb50-285" aria-hidden="true" tabindex="-1"></a>    args_list <span class="op">=</span> [</span>
<span id="cb50-286"><a href="#cb50-286" aria-hidden="true" tabindex="-1"></a>        (batch, <span class="bu">str</span>(out), timeout, headless, force_overwrite, retry_count, stop_event, msg_queue) </span>
<span id="cb50-287"><a href="#cb50-287" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> batch <span class="kw">in</span> batches</span>
<span id="cb50-288"><a href="#cb50-288" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb50-289"><a href="#cb50-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-290"><a href="#cb50-290" aria-hidden="true" tabindex="-1"></a>    success_count, failed <span class="op">=</span> <span class="dv">0</span>, []</span>
<span id="cb50-291"><a href="#cb50-291" aria-hidden="true" tabindex="-1"></a>    pool <span class="op">=</span> <span class="va">None</span></span>
<span id="cb50-292"><a href="#cb50-292" aria-hidden="true" tabindex="-1"></a>    start_time <span class="op">=</span> time.time()</span>
<span id="cb50-293"><a href="#cb50-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-294"><a href="#cb50-294" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb50-295"><a href="#cb50-295" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Criar pool</span></span>
<span id="cb50-296"><a href="#cb50-296" aria-hidden="true" tabindex="-1"></a>        pool <span class="op">=</span> multiprocessing.Pool(processes<span class="op">=</span>workers)</span>
<span id="cb50-297"><a href="#cb50-297" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-298"><a href="#cb50-298" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üîÑ Iniciando convers√£o...&quot;</span>)</span>
<span id="cb50-299"><a href="#cb50-299" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-300"><a href="#cb50-300" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Processar batches - com verifica√ß√£o CONSTANTE de parada</span></span>
<span id="cb50-301"><a href="#cb50-301" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, result <span class="kw">in</span> <span class="bu">enumerate</span>(pool.imap_unordered(worker_wrapper_simple, args_list)):</span>
<span id="cb50-302"><a href="#cb50-302" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> stop_event.is_set():</span>
<span id="cb50-303"><a href="#cb50-303" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;üõë Parada de emerg√™ncia ativada!&quot;</span>)</span>
<span id="cb50-304"><a href="#cb50-304" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb50-305"><a href="#cb50-305" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb50-306"><a href="#cb50-306" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f&quot;üì¶ Batch </span><span class="sc">{</span>i<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(batches)<span class="sc">}</span><span class="ss"> processado&quot;</span>)</span>
<span id="cb50-307"><a href="#cb50-307" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb50-308"><a href="#cb50-308" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> html_file, success, msg <span class="kw">in</span> result:</span>
<span id="cb50-309"><a href="#cb50-309" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> success:</span>
<span id="cb50-310"><a href="#cb50-310" aria-hidden="true" tabindex="-1"></a>                    success_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb50-311"><a href="#cb50-311" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb50-312"><a href="#cb50-312" aria-hidden="true" tabindex="-1"></a>                    failed.append((Path(html_file).name, msg))</span>
<span id="cb50-313"><a href="#cb50-313" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb50-314"><a href="#cb50-314" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Verificar parada entre batches</span></span>
<span id="cb50-315"><a href="#cb50-315" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> _should_stop <span class="kw">or</span> stop_event.is_set():</span>
<span id="cb50-316"><a href="#cb50-316" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb50-317"><a href="#cb50-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-318"><a href="#cb50-318" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb50-319"><a href="#cb50-319" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO RECEBIDA !!!&quot;</span>)</span>
<span id="cb50-320"><a href="#cb50-320" aria-hidden="true" tabindex="-1"></a>        _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb50-321"><a href="#cb50-321" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb50-322"><a href="#cb50-322" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb50-323"><a href="#cb50-323" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Erro: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb50-324"><a href="#cb50-324" aria-hidden="true" tabindex="-1"></a>        stop_event.<span class="bu">set</span>()</span>
<span id="cb50-325"><a href="#cb50-325" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb50-326"><a href="#cb50-326" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üßπ LIMPEZA FINAL...&quot;</span>)</span>
<span id="cb50-327"><a href="#cb50-327" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-328"><a href="#cb50-328" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parar listener</span></span>
<span id="cb50-329"><a href="#cb50-329" aria-hidden="true" tabindex="-1"></a>        listener_stop_flag.<span class="bu">set</span>()</span>
<span id="cb50-330"><a href="#cb50-330" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb50-331"><a href="#cb50-331" aria-hidden="true" tabindex="-1"></a>            msg_queue.put(<span class="va">None</span>)</span>
<span id="cb50-332"><a href="#cb50-332" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb50-333"><a href="#cb50-333" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb50-334"><a href="#cb50-334" aria-hidden="true" tabindex="-1"></a>        listener_thread.join(timeout<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb50-335"><a href="#cb50-335" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-336"><a href="#cb50-336" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Terminar pool AGressivamente</span></span>
<span id="cb50-337"><a href="#cb50-337" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pool:</span>
<span id="cb50-338"><a href="#cb50-338" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb50-339"><a href="#cb50-339" aria-hidden="true" tabindex="-1"></a>                pool.terminate()  <span class="co"># Mais agressivo que close()</span></span>
<span id="cb50-340"><a href="#cb50-340" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb50-341"><a href="#cb50-341" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb50-342"><a href="#cb50-342" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb50-343"><a href="#cb50-343" aria-hidden="true" tabindex="-1"></a>                pool.join(timeout<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb50-344"><a href="#cb50-344" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span>:</span>
<span id="cb50-345"><a href="#cb50-345" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb50-346"><a href="#cb50-346" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-347"><a href="#cb50-347" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Limpeza final</span></span>
<span id="cb50-348"><a href="#cb50-348" aria-hidden="true" tabindex="-1"></a>        kill_orphaned_chromium()</span>
<span id="cb50-349"><a href="#cb50-349" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb50-350"><a href="#cb50-350" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pequena pausa para garantir que tudo foi limpo</span></span>
<span id="cb50-351"><a href="#cb50-351" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb50-352"><a href="#cb50-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-353"><a href="#cb50-353" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Relat√≥rio</span></span>
<span id="cb50-354"><a href="#cb50-354" aria-hidden="true" tabindex="-1"></a>    elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb50-355"><a href="#cb50-355" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;=&quot;</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb50-356"><a href="#cb50-356" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üìä RELAT√ìRIO FINAL:&quot;</span>)</span>
<span id="cb50-357"><a href="#cb50-357" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot; ‚úÖ Sucessos: </span><span class="sc">{</span>success_count<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(html_files)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb50-358"><a href="#cb50-358" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot; ‚ùå Falhas: </span><span class="sc">{</span><span class="bu">len</span>(failed)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb50-359"><a href="#cb50-359" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-360"><a href="#cb50-360" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> benchmark <span class="kw">and</span> success_count <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> elapsed <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb50-361"><a href="#cb50-361" aria-hidden="true" tabindex="-1"></a>        rate <span class="op">=</span> success_count <span class="op">/</span> (elapsed <span class="op">/</span> <span class="dv">60</span>)</span>
<span id="cb50-362"><a href="#cb50-362" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚è±Ô∏è  </span><span class="sc">{</span>elapsed<span class="sc">:.1f}</span><span class="ss">s | </span><span class="sc">{</span>rate<span class="sc">:.1f}</span><span class="ss"> PDFs/minuto&quot;</span>)</span>
<span id="cb50-363"><a href="#cb50-363" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-364"><a href="#cb50-364" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> success_count <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb50-365"><a href="#cb50-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-366"><a href="#cb50-366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-367"><a href="#cb50-367" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-368"><a href="#cb50-368" aria-hidden="true" tabindex="-1"></a><span class="co"># CLI</span></span>
<span id="cb50-369"><a href="#cb50-369" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-370"><a href="#cb50-370" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_args():</span>
<span id="cb50-371"><a href="#cb50-371" aria-hidden="true" tabindex="-1"></a>    parser <span class="op">=</span> argparse.ArgumentParser(</span>
<span id="cb50-372"><a href="#cb50-372" aria-hidden="true" tabindex="-1"></a>        description<span class="op">=</span><span class="st">&quot;Convers√£o HTML ‚Üí PDF com INTERRUP√á√ÉO IMEDIATA por Ctrl+C&quot;</span></span>
<span id="cb50-373"><a href="#cb50-373" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-374"><a href="#cb50-374" aria-hidden="true" tabindex="-1"></a>    group <span class="op">=</span> parser.add_mutually_exclusive_group()</span>
<span id="cb50-375"><a href="#cb50-375" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--force&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Sobrescreve PDFs j√° existentes&quot;</span>)</span>
<span id="cb50-376"><a href="#cb50-376" aria-hidden="true" tabindex="-1"></a>    group.add_argument(<span class="st">&#39;--only-new&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, default<span class="op">=</span><span class="va">True</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Apenas novos (padr√£o)&quot;</span>)</span>
<span id="cb50-377"><a href="#cb50-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-378"><a href="#cb50-378" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--dry-run&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Simula sem criar arquivos&quot;</span>)</span>
<span id="cb50-379"><a href="#cb50-379" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--source&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_html&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta com arquivos .html&quot;</span>)</span>
<span id="cb50-380"><a href="#cb50-380" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--output&#39;</span>, default<span class="op">=</span><span class="st">&quot;combined_pdfs&quot;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Pasta de sa√≠da para PDFs&quot;</span>)</span>
<span id="cb50-381"><a href="#cb50-381" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--workers&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb50-382"><a href="#cb50-382" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;N√∫mero de processos (padr√£o: 1 para maior estabilidade)&quot;</span>)</span>
<span id="cb50-383"><a href="#cb50-383" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--batch-size&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">3</span>, </span>
<span id="cb50-384"><a href="#cb50-384" aria-hidden="true" tabindex="-1"></a>                       <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Arquivos por batch (padr√£o: 3 para resposta r√°pida)&quot;</span>)</span>
<span id="cb50-385"><a href="#cb50-385" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--no-headless&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra navegador (debug)&quot;</span>)</span>
<span id="cb50-386"><a href="#cb50-386" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--single-file&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Converte apenas um arquivo HTML espec√≠fico&quot;</span>)</span>
<span id="cb50-387"><a href="#cb50-387" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--timeout&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">30</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Timeout por p√°gina (segundos)&quot;</span>)</span>
<span id="cb50-388"><a href="#cb50-388" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--retry-count&#39;</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>, default<span class="op">=</span><span class="dv">1</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Tentativas por arquivo&quot;</span>)</span>
<span id="cb50-389"><a href="#cb50-389" aria-hidden="true" tabindex="-1"></a>    parser.add_argument(<span class="st">&#39;--benchmark&#39;</span>, action<span class="op">=</span><span class="st">&#39;store_true&#39;</span>, <span class="bu">help</span><span class="op">=</span><span class="st">&quot;Mostra tempo total e PDFs/minuto&quot;</span>)</span>
<span id="cb50-390"><a href="#cb50-390" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> parser.parse_args()</span>
<span id="cb50-391"><a href="#cb50-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-392"><a href="#cb50-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-393"><a href="#cb50-393" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-394"><a href="#cb50-394" aria-hidden="true" tabindex="-1"></a><span class="co"># Main</span></span>
<span id="cb50-395"><a href="#cb50-395" aria-hidden="true" tabindex="-1"></a><span class="co"># ---------------------------------------------------------------------</span></span>
<span id="cb50-396"><a href="#cb50-396" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main():</span>
<span id="cb50-397"><a href="#cb50-397" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configurar handler de EMERG√äNCIA para Ctrl+C</span></span>
<span id="cb50-398"><a href="#cb50-398" aria-hidden="true" tabindex="-1"></a>    signal.signal(signal.SIGINT, emergency_stop_handler)</span>
<span id="cb50-399"><a href="#cb50-399" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-400"><a href="#cb50-400" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args()</span>
<span id="cb50-401"><a href="#cb50-401" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-402"><a href="#cb50-402" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;üöÄ PDF GENERATOR - INTERRUP√á√ÉO IMEDIATA POR Ctrl+C&quot;</span>)</span>
<span id="cb50-403"><a href="#cb50-403" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;!!! EMERGENCY STOP ENABLED - Ctrl+C para PARAR TUDO !!!&quot;</span>)</span>
<span id="cb50-404"><a href="#cb50-404" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;=&quot;</span> <span class="op">*</span> <span class="dv">65</span>)</span>
<span id="cb50-405"><a href="#cb50-405" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;üîß Workers: </span><span class="sc">{</span>args<span class="sc">.</span>workers<span class="sc">}</span><span class="ss"> | Batch: </span><span class="sc">{</span>args<span class="sc">.</span>batch_size<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb50-406"><a href="#cb50-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-407"><a href="#cb50-407" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Limpeza inicial</span></span>
<span id="cb50-408"><a href="#cb50-408" aria-hidden="true" tabindex="-1"></a>    kill_orphaned_chromium()</span>
<span id="cb50-409"><a href="#cb50-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-410"><a href="#cb50-410" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verifica√ß√µes</span></span>
<span id="cb50-411"><a href="#cb50-411" aria-hidden="true" tabindex="-1"></a>    source_dir <span class="op">=</span> Path(args.source)</span>
<span id="cb50-412"><a href="#cb50-412" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> source_dir.exists():</span>
<span id="cb50-413"><a href="#cb50-413" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;‚ùå Pasta n√£o encontrada: </span><span class="sc">{</span>source_dir<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb50-414"><a href="#cb50-414" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb50-415"><a href="#cb50-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-416"><a href="#cb50-416" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> check_playwright_available(headless_test<span class="op">=</span><span class="kw">not</span> args.no_headless):</span>
<span id="cb50-417"><a href="#cb50-417" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ùå Playwright n√£o dispon√≠vel.&quot;</span>)</span>
<span id="cb50-418"><a href="#cb50-418" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   pip install playwright psutil&quot;</span>)</span>
<span id="cb50-419"><a href="#cb50-419" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;   playwright install chromium&quot;</span>)</span>
<span id="cb50-420"><a href="#cb50-420" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb50-421"><a href="#cb50-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-422"><a href="#cb50-422" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Executar</span></span>
<span id="cb50-423"><a href="#cb50-423" aria-hidden="true" tabindex="-1"></a>    success <span class="op">=</span> generate_pdfs_simple(</span>
<span id="cb50-424"><a href="#cb50-424" aria-hidden="true" tabindex="-1"></a>        source_dir<span class="op">=</span><span class="bu">str</span>(args.source),</span>
<span id="cb50-425"><a href="#cb50-425" aria-hidden="true" tabindex="-1"></a>        output_dir<span class="op">=</span><span class="bu">str</span>(args.output),</span>
<span id="cb50-426"><a href="#cb50-426" aria-hidden="true" tabindex="-1"></a>        workers<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.workers),</span>
<span id="cb50-427"><a href="#cb50-427" aria-hidden="true" tabindex="-1"></a>        batch_size<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.batch_size),</span>
<span id="cb50-428"><a href="#cb50-428" aria-hidden="true" tabindex="-1"></a>        headless<span class="op">=</span><span class="kw">not</span> args.no_headless,</span>
<span id="cb50-429"><a href="#cb50-429" aria-hidden="true" tabindex="-1"></a>        timeout<span class="op">=</span><span class="bu">max</span>(<span class="dv">10</span>, args.timeout),</span>
<span id="cb50-430"><a href="#cb50-430" aria-hidden="true" tabindex="-1"></a>        force_overwrite<span class="op">=</span>args.force,</span>
<span id="cb50-431"><a href="#cb50-431" aria-hidden="true" tabindex="-1"></a>        dry_run<span class="op">=</span>args.dry_run,</span>
<span id="cb50-432"><a href="#cb50-432" aria-hidden="true" tabindex="-1"></a>        single_file<span class="op">=</span>args.single_file,</span>
<span id="cb50-433"><a href="#cb50-433" aria-hidden="true" tabindex="-1"></a>        retry_count<span class="op">=</span><span class="bu">max</span>(<span class="dv">1</span>, args.retry_count),</span>
<span id="cb50-434"><a href="#cb50-434" aria-hidden="true" tabindex="-1"></a>        benchmark<span class="op">=</span>args.benchmark</span>
<span id="cb50-435"><a href="#cb50-435" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb50-436"><a href="#cb50-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-437"><a href="#cb50-437" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resultado</span></span>
<span id="cb50-438"><a href="#cb50-438" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> args.dry_run:</span>
<span id="cb50-439"><a href="#cb50-439" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üß™ SIMULA√á√ÉO CONCLU√çDA&quot;</span>)</span>
<span id="cb50-440"><a href="#cb50-440" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb50-441"><a href="#cb50-441" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> success:</span>
<span id="cb50-442"><a href="#cb50-442" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;üéâ CONVERS√ÉO CONCLU√çDA!&quot;</span>)</span>
<span id="cb50-443"><a href="#cb50-443" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb50-444"><a href="#cb50-444" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb50-445"><a href="#cb50-445" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;‚ö†Ô∏è CONVERS√ÉO INTERROMPIDA OU COM FALHAS&quot;</span>)</span>
<span id="cb50-446"><a href="#cb50-446" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span></span>
<span id="cb50-447"><a href="#cb50-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-448"><a href="#cb50-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-449"><a href="#cb50-449" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb50-450"><a href="#cb50-450" aria-hidden="true" tabindex="-1"></a>    multiprocessing.freeze_support()</span>
<span id="cb50-451"><a href="#cb50-451" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-452"><a href="#cb50-452" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handler global para garantir que Ctrl+C sempre funcione</span></span>
<span id="cb50-453"><a href="#cb50-453" aria-hidden="true" tabindex="-1"></a>    original_sigint <span class="op">=</span> signal.getsignal(signal.SIGINT)</span>
<span id="cb50-454"><a href="#cb50-454" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb50-455"><a href="#cb50-455" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb50-456"><a href="#cb50-456" aria-hidden="true" tabindex="-1"></a>        sys.exit(main())</span>
<span id="cb50-457"><a href="#cb50-457" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb50-458"><a href="#cb50-458" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">!!! INTERRUP√á√ÉO GLOBAL !!!&quot;</span>)</span>
<span id="cb50-459"><a href="#cb50-459" aria-hidden="true" tabindex="-1"></a>        emergency_stop_handler(<span class="va">None</span>, <span class="va">None</span>)</span>
<span id="cb50-460"><a href="#cb50-460" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb50-461"><a href="#cb50-461" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;üí• ERRO CR√çTICO: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb50-462"><a href="#cb50-462" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">1</span>)</span>
<span id="cb50-463"><a href="#cb50-463" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb50-464"><a href="#cb50-464" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Restaurar handler original</span></span>
<span id="cb50-465"><a href="#cb50-465" aria-hidden="true" tabindex="-1"></a>        signal.signal(signal.SIGINT, original_sigint)</span></code></pre></div>
<h2 data-number="1.19" id="principais-corre√ß√µes-para-ctrlc"><span class="header-section-number">1.19</span> üö® <strong>Principais
Corre√ß√µes para Ctrl+C:</strong></h2>
<h3 data-number="1.19.1" id="handler-de-emerg√™ncia-agressivo"><span class="header-section-number">1.19.1</span> <strong>1. Handler de
Emerg√™ncia Agressivo</strong></h3>
<div class="sourceCode" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> emergency_stop_handler(signum, frame):</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Para TUDO imediatamente&quot;&quot;&quot;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> _should_stop</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    _should_stop <span class="op">=</span> <span class="va">True</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Matar processos de forma agressiva</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> pid <span class="kw">in</span> <span class="bu">list</span>(_active_processes):</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>            parent <span class="op">=</span> psutil.Process(pid)</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> child <span class="kw">in</span> parent.children(recursive<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>                child.kill()  <span class="co"># Mais agressivo que terminate()</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>            parent.kill()</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>:</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    os._exit(<span class="dv">1</span>)  <span class="co"># Sa√≠da IMEDIATA</span></span></code></pre></div>
<h3 data-number="1.19.2" id="rastreamento-de-processos-global"><span class="header-section-number">1.19.2</span> <strong>2. Rastreamento de
Processos Global</strong></h3>
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>_active_processes <span class="op">=</span> <span class="bu">set</span>()  <span class="co"># Global para acesso imediato</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Em cada worker:</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>my_pid <span class="op">=</span> os.getpid()</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>_active_processes.add(my_pid)</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>_active_processes.discard(my_pid)</span></code></pre></div>
<h3 data-number="1.19.3" id="pool.terminate-mais-agressivo"><span class="header-section-number">1.19.3</span> <strong>3. Pool.terminate()
Mais Agressivo</strong></h3>
<div class="sourceCode" id="cb53"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> pool:</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>        pool.terminate()  <span class="co"># Imediato, n√£o espera</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span></code></pre></div>
<h3 data-number="1.19.4" id="verifica√ß√µes-constantes-de-parada"><span class="header-section-number">1.19.4</span> <strong>4. Verifica√ß√µes
Constantes de Parada</strong></h3>
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Verificar ANTES de cada opera√ß√£o:</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> stop_event.is_set() <span class="kw">or</span> _should_stop:</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span></span></code></pre></div>
<h3 data-number="1.19.5" id="timeouts-reduzidos"><span class="header-section-number">1.19.5</span> <strong>5. Timeouts
Reduzidos</strong></h3>
<ul>
<li>Timeout do browser: 30s (em vez de 60s)</li>
<li>Batch size: 3 (em vez de 10)</li>
<li>Retry count: 1 (em vez de 2)</li>
</ul>
<h2 data-number="1.20" id="como-testar"><span class="header-section-number">1.20</span> üéØ <strong>Como
Testar:</strong></h2>
<div class="sourceCode" id="cb55"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute o script</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> comb_pdf_direct6_html_based_optimized_live_benchmark.py</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Pressione Ctrl+C - deve parar IMEDIATAMENTE</span></span></code></pre></div>
<h2 data-number="1.21" id="diferen√ßas-chave"><span class="header-section-number">1.21</span> ‚ö° <strong>Diferen√ßas
Chave:</strong></h2>
<ol type="1">
<li><strong><code>os._exit(1)</code></strong> em vez de
<code>sys.exit()</code> - sa√≠da imediata</li>
<li><strong><code>process.kill()</code></strong> em vez de
<code>process.terminate()</code> - mais agressivo</li>
<li><strong>Vari√°vel global <code>_should_stop</code></strong> -
verifica√ß√£o instant√¢nea</li>
<li><strong>Pool.terminate()</strong> - termina√ß√£o imediata do pool</li>
<li><strong>Batch size menor</strong> - resposta mais r√°pida √†
interrup√ß√£o</li>
</ol>
<p><strong>Esta vers√£o deve parar IMEDIATAMENTE ao pressionar
Ctrl+C!</strong> üöÄ</p>
<hr />
<p><em>Conversa exportada do DeepSeek</em> <em>Processado em: 24/11/2025
22:27</em></p>

        <script id="fixed-toc-script">
        document.addEventListener('DOMContentLoaded', function() {
            const toc = document.getElementById('TOC');
            if (toc) {
                const tocTitle = toc.querySelector('h2');
                if (tocTitle) {
                    const toggleBtn = document.createElement('button');
                    toggleBtn.innerHTML = '‚ò∞';
                    toggleBtn.className = 'toc-toggle-btn';
                    toggleBtn.title = 'Minimizar/Expandir TOC';
                    let isMinimized = false;
                    toggleBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        isMinimized = !isMinimized;
                        if (isMinimized) {
                            toc.classList.add('toc-minimized');
                        } else {
                            toc.classList.remove('toc-minimized');
                        }
                    });
                    tocTitle.appendChild(toggleBtn);
                }
            }
            
            // SCROLLSPY
            const sections = document.querySelectorAll('h1, h2, h3, h4, h5');
            const tocLinks = document.querySelectorAll('#TOC a');
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('id');
                        tocLinks.forEach(link => {
                            link.classList.remove('active');
                            if (link.getAttribute('href') === '#' + id) {
                                link.classList.add('active');
                            }
                        });
                    }
                });
            }, { 
                rootMargin: '-20% 0px -60% 0px', 
                threshold: 0 
            });
            
            sections.forEach(section => {
                if (section.id) observer.observe(section);
            });
            
            // Scroll suave
            tocLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('href').substring(1);
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        const offsetTop = targetElement.offsetTop - 80;
                        window.scrollTo({ top: offsetTop, behavior: 'smooth' });
                    }
                });
            });
            
            // BOT√ÉO VOLTAR AO TOPO
            const backToTopBtn = document.createElement('button');
            backToTopBtn.className = 'back-to-top-content';
            backToTopBtn.innerHTML = '‚Üë';
            backToTopBtn.title = 'Voltar ao Topo';
            document.body.appendChild(backToTopBtn);
            
            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    backToTopBtn.classList.add('show');
                } else {
                    backToTopBtn.classList.remove('show');
                }
            });
            
            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
        </script>
        
</body>
</html>
