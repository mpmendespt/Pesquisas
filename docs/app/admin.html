<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Sistema de Pesquisas</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .users-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .users-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .users-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .status-pending {
            color: #e67e22;
            font-weight: bold;
        }
        .status-approved {
            color: #27ae60;
            font-weight: bold;
        }
        .status-rejected {
            color: #e74c3c;
            font-weight: bold;
        }
        .btn-approve {
            background: #27ae60;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        .btn-reject {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #eee;
        }
        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 5px;
            color: #155724;
        }
    </style>
</head>
<body class="dashboard-page">
    <div class="admin-container">
        <header class="header">
            <h1>⚙️ Painel Administrativo</h1>
            <div class="user-info">
                <span id="userWelcome">Administrador</span>
                <button onclick="logout()" class="btn-secondary">Sair</button>
                <button onclick="goToDashboard()" class="btn-secondary">Voltar ao Dashboard</button>
            </div>
        </header>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div>Total de Usuários</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingUsers">0</div>
                <div>Pendentes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeUsers">0</div>
                <div>Ativos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="verifiedUsers">0</div>
                <div>Email Verificado</div>
            </div>
        </div>
        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="openTab('pending')">Aprovações Pendentes</button>
                <button class="tab-button" onclick="openTab('all')">Todos os Usuários</button>
                <button class="tab-button" onclick="openTab('system')">Sistema</button>
            </div>
            <div id="pending" class="tab-content active">
                <h2>Usuários Aguardando Aprovação</h2>
                <div class="users-table">
                    <div id="pendingUsersList" class="loading">Carregando usuários pendentes...</div>
                </div>
            </div>
            <div id="all" class="tab-content">
                <h2>Todos os Usuários</h2>
                <div class="users-table">
                    <div id="allUsersList" class="loading">Carregando todos os usuários...</div>
                </div>
            </div>
            <div id="system" class="tab-content">
                <h2>Configurações do Sistema</h2>
                <div class="card">
                    <h3>Estatísticas do Worker</h3>
                    <div id="workerStats" class="loading">Carregando estatísticas...</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const WORKER_URL = 'https://worker-ds.mpmendespt.workers.dev';
        
        // Função corrigida para ir ao dashboard
        function goToDashboard() {
            window.location.href = 'index.html'; // docs/app/index.html
        }
        
        // Função corrigida para logout
        function logout() {
            localStorage.removeItem('jwt');
            localStorage.removeItem('user');
            window.location.href = 'login.html'; // docs/app/login.html
        }

        // Verificar se é administrador
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('jwt');
            const userData = localStorage.getItem('user');
            
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            if (userData) {
                const user = JSON.parse(userData);
                if (user.role !== 'admin') {
                    alert('Acesso restrito a administradores!');
                    window.location.href = 'index.html'; // Redireciona para dashboard normal
                    return;
                }
                document.getElementById('userWelcome').textContent = `Admin: ${user.username}`;
            }
            
            loadAdminData();
        });

        async function loadAdminData() {
            await Promise.all([
                loadStats(),
                loadPendingUsers(),
                loadAllUsers(),
                loadWorkerStats()
            ]);
        }

        async function loadStats() {
            try {
                const token = localStorage.getItem('jwt');
                const response = await fetch(`${WORKER_URL}/api/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    const users = data.users;
                    const total = users.length;
                    const pending = users.filter(u => !u.is_approved).length;
                    const active = users.filter(u => u.is_active).length;
                    const verified = users.filter(u => u.is_email_verified).length;
                    
                    document.getElementById('totalUsers').textContent = total;
                    document.getElementById('pendingUsers').textContent = pending;
                    document.getElementById('activeUsers').textContent = active;
                    document.getElementById('verifiedUsers').textContent = verified;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadPendingUsers() {
            try {
                const token = localStorage.getItem('jwt');
                const response = await fetch(`${WORKER_URL}/api/admin/users/pending`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    displayPendingUsers(data.users);
                } else {
                    document.getElementById('pendingUsersList').innerHTML = '<div class="error">Erro ao carregar usuários pendentes</div>';
                }
            } catch (error) {
                document.getElementById('pendingUsersList').innerHTML = '<div class="error">Erro de conexão</div>';
            }
        }

        async function loadAllUsers() {
            try {
                const token = localStorage.getItem('jwt');
                const response = await fetch(`${WORKER_URL}/api/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    displayAllUsers(data.users);
                } else {
                    document.getElementById('allUsersList').innerHTML = '<div class="error">Erro ao carregar usuários</div>';
                }
            } catch (error) {
                document.getElementById('allUsersList').innerHTML = '<div class="error">Erro de conexão</div>';
            }
        }

        function displayPendingUsers(users) {
            if (users.length === 0) {
                document.getElementById('pendingUsersList').innerHTML = '<div class="success">Nenhum usuário pendente</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Data Registro</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            users.forEach(user => {
                html += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${new Date(user.created_at).toLocaleDateString('pt-PT')}</td>
                        <td>
                            <button class="btn-approve" onclick="approveUser(${user.id}, true)">Aprovar</button>
                            <button class="btn-reject" onclick="approveUser(${user.id}, false)">Rejeitar</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            document.getElementById('pendingUsersList').innerHTML = html;
        }

        function displayAllUsers(users) {
            if (users.length === 0) {
                document.getElementById('allUsersList').innerHTML = '<div class="success">Nenhum usuário registrado</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Email Verif.</th>
                            <th>Data Reg.</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            users.forEach(user => {
                const status = user.is_approved ? 
                    (user.is_active ? '<span class="status-approved">Ativo</span>' : '<span class="status-rejected">Inativo</span>') : 
                    '<span class="status-pending">Pendente</span>';
                const emailStatus = user.is_email_verified ? 
                    '<span class="status-approved">✓</span>' : 
                    '<span class="status-pending">✗</span>';
                html += `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>${status}</td>
                        <td>${emailStatus}</td>
                        <td>${new Date(user.created_at).toLocaleDateString('pt-PT')}</td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            document.getElementById('allUsersList').innerHTML = html;
        }

        async function approveUser(userId, approve) {
            if (!confirm(`Tem certeza que deseja ${approve ? 'aprovar' : 'rejeitar'} este usuário?`)) {
                return;
            }
            
            try {
                const token = localStorage.getItem('jwt');
                const response = await fetch(`${WORKER_URL}/api/admin/users/approve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ userId, approve })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`✅ ${result.message}`);
                    loadAdminData(); // Recarregar dados
                } else {
                    const error = await response.json();
                    alert(`❌ Erro: ${error.error || 'Falha na operação'}`);
                }
            } catch (error) {
                alert('❌ Erro de conexão com o servidor');
                console.error('Approve user error:', error);
            }
        }

        async function loadWorkerStats() {
            try {
                const response = await fetch(`${WORKER_URL}/api/health`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('workerStats').innerHTML = `
                        <p><strong>Status:</strong> <span class="status-approved">${data.status}</span></p>
                        <p><strong>Última verificação:</strong> ${new Date(data.timestamp).toLocaleString('pt-PT')}</p>
                        <p><strong>Serviço:</strong> ${data.service}</p>
                        <p><strong>Endpoints disponíveis:</strong></p>
                        <ul>
                            ${data.endpoints.map(endpoint => `<li>${endpoint}</li>`).join('')}
                        </ul>
                    `;
                }
            } catch (error) {
                document.getElementById('workerStats').innerHTML = '<div class="error">Erro ao conectar com o Worker</div>';
                console.error('Worker stats error:', error);
            }
        }

        function openTab(tabName) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover classe active de todos os botões
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Mostrar tab selecionada
            document.getElementById(tabName).classList.add('active');
            
            // Adicionar classe active ao botão clicado
            event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>